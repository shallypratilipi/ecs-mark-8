<!doctype html> <html lang="kn"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"> <!-- MetaTagUtil --> <title data-bind="text: pageTitle"></title> <meta name="description" data-bind="attr: { 'content': pageDescription }"> <!-- ko foreach: { data: appViewModel.metaTags() } --> <meta data-bind="attr: { 'property': $data.property, 'itemprop': $data.itemprop, 'name': $data.name, 'content': $data.content }" /> <!--/ko--> <meta name="apple-mobile-web-app-capable" content="yes"> <meta name="apple-mobile-web-app-status-bar-style" content="black"> <meta name="apple-mobile-web-app-title" content="Pratilipi | ಪ್ರತಿಲಿಪಿ"> <meta name="msapplication-TileImage" content="/logo.png"> <meta name="msapplication-TileColor" content="#D0021B"> <link rel="apple-touch-icon" href="/favicon.png"> <link rel="manifest" href="//kannada.pratilipi.com/pwa-manifest-KANNADA.json"> <script language="javascript"> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-53742841-2', 'pratilipi.com'); ga('set', 'displayFeaturesTask', null); </script> <script> window.fbAsyncInit = function() { FB.init({ appId : "293990794105516", cookie : true, xfbml : true, autoLogAppEvents : false, version : 'v2.10' }); }; (function(d, s, id){ var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) {return;} js = d.createElement(s); js.id = id; js.src = "//connect.facebook.net/en_US/sdk.js"; fjs.parentNode.insertBefore(js, fjs); }(document, 'script', 'facebook-jssdk')); </script><script type="text/javascript"> (function(e,t){var n=e.amplitude||{_q:[],_iq:{}};var r=t.createElement("script") ;r.type="text/javascript";r.async=true ;r.src="https://cdn.amplitude.com/libs/amplitude-4.1.1-min.gz.js" ;r.onload=function(){if(e.amplitude.runQueuedFunctions){ e.amplitude.runQueuedFunctions()}else{ console.log("[Amplitude] Error: could not load SDK")}} ;var i=t.getElementsByTagName("script")[0];i.parentNode.insertBefore(r,i) ;function s(e,t){e.prototype[t]=function(){ this._q.push([t].concat(Array.prototype.slice.call(arguments,0)));return this}} var o=function(){this._q=[];return this} ;var a=["add","append","clearAll","prepend","set","setOnce","unset"] ;for(var u=0;u<a.length;u++){s(o,a[u])}n.Identify=o;var c=function(){this._q=[] ;return this} ;var l=["setProductId","setQuantity","setPrice","setRevenueType","setEventProperties"] ;for(var p=0;p<l.length;p++){s(c,l[p])}n.Revenue=c ;var d=["init","logEvent","logRevenue","setUserId","setUserProperties","setOptOut","setVersionName","setDomain","setDeviceId","setGlobalUserProperties","identify","clearUserProperties","setGroup","logRevenueV2","regenerateDeviceId","logEventWithTimestamp","logEventWithGroups","setSessionId"] ;function v(e){function t(t){e[t]=function(){ e._q.push([t].concat(Array.prototype.slice.call(arguments,0)))}} for(var n=0;n<d.length;n++){t(d[n])}}v(n);n.getInstance=function(e){ e=(!e||e.length===0?"$default_instance":e).toLowerCase() ;if(!n._iq.hasOwnProperty(e)){n._iq[e]={_q:[]};v(n._iq[e])}return n._iq[e]} ;e.amplitude=n})(window,document); var aplitudeInstance = amplitude.getInstance().init("a2af45f6f1b31d716b0f34b3d4101e97", null, { saveEvents: true, includeUtm: true, includeReferrer: true }); </script> <style> @import url(https://www.ptlp.co/resource-all/font/font-kn.css); *:not(.material-icons) { font-family: "Noto Sans Kannada", "Helvetica", "Arial", sans-serif !important; letter-spacing: 0 !important; } .material-heading { line-height: 34px !important; font-size: 24px !important; } .material-title { line-height: 30px !important; font-size: 21px !important; } .material-subtitle-1 { line-height: 26px !important; font-size: 16px !important; } .material-subtitle-2 { line-height: 30px !important; font-size: 16px !important; } .material-body-1 { line-height: 23px !important; font-size: 14px !important; } .material-body-2 { line-height: 26px !important; font-size: 14px !important; } .material-caption { line-height: 20px !important; font-size: 13px !important; } .material-button { line-height: 23px !important; font-size: 14px !important; } @media only screen and (max-width: 767px) { .material-heading { font-size: 24px !important; } .material-title { font-size: 21px !important; } .material-subtitle-1 { font-size: 17px !important; } .material-subtitle-2 { font-size: 17px !important; } .material-body-1 { font-size: 15px !important; } .material-body-2 { font-size: 15px !important; } .material-caption { font-size: 13px !important; } .material-button { font-size: 15px !important; } } .font-xs { font-size: 13px !important; } .font-s { font-size: 14px !important; } .font-m { font-size: 16px !important; } .font-l { font-size: 21px !important; } .font-xl { font-size: 24px !important; } @media only screen and (max-width: 767px) { .font-xs { font-size: 13px !important; } .font-s { font-size: 15px !important; } .font-m { font-size: 17px !important; } .font-l { font-size: 21px !important; } .font-xl { font-size: 24px !important; } } </style> </head> <body> <!-- ko if: ! appViewModel.hideAppShell() --> <div data-bind="component: { name: 'pratilipi-main-layout' }"></div> <!-- /ko --> <!-- ko if: appViewModel.hideAppShell() --> <div data-bind="component: { name: appViewModel.currentView() }"></div> <!-- /ko --> </body> <script src="https://www.ptlp.co/resource-all/pwa/js/jkkrrsh.js"></script> <script> ko.components.register( 'pratilipi-drafts-access-error', { viewModel: function (params) {} , template: `<div class="pratilipi-drafts-access-error mdl-card mdl-card-border mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><div class="left-col"><div style="width: 200px; height: 200px; margin: auto;" class="page-not-found-icon"></div></div><div class="right-col"><div class="material-title">ಬರಹ ಪ್ರಕಟಿತವಾಗಿಲ್ಲ!</div><br/><a href="/" class="material-subtitle-1" style="margin: 16px 0; color: inherit;">Oops, ಈ ಬರಹವನ್ನು ಲೇಖಕರು ಇನ್ನೂ ಪ್ರಕಟಿಸಿಲ್ಲ! ಈ ಲೇಖಕರ ಇತರ ಬರಹಗಳನ್ನು ಓದಲು ಇಲ್ಲಿ ಕ್ಲಿಕ್ ಮಾಡಿ.</a><br/><br/><a class="material-subtitle-1" href="/"><i class="material-icons" style="float: left;">home</i><span>ಹೋಮ್</span></a></div></div>` }); </script> <script> ko.components.register( 'pratilipi-blog-post-page', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); var defaultBlogPost = { blogId: null, blogPostId: null, content: null, creationDateMillis: null, pageUrl: null, title: null, titleEn: null }; this.blogPost = ko.mapping.fromJS( defaultBlogPost, {}, self.blogPost ); this.updateBlogPost = function( blogPost, initialiseObject ) { var updatedBlogPost = JSON.parse( JSON.stringify( initialiseObject ? defaultBlogPost : blogPost ) ); if( initialiseObject && blogPost != null ) { for( var key in blogPost ) if( blogPost.hasOwnProperty( key ) ) updatedBlogPost[ key ] = blogPost[ key ]; } ko.mapping.fromJS( updatedBlogPost, {}, self.blogPost ); MetaTagUtil.setMetaTagsForBlogPost( blogPost ); }; /* Load initial data */ this.initialDataLoaded = ko.observable(); var _handleDataAccessorResponse = function( blogPost, statusCode ) { if( statusCode === 200 ) { self.updateBlogPost( blogPost, true ); if( !self.initialDataLoaded() ) self.initialDataLoaded( true ); } else if( statusCode === 400 || statusCode === 404 ) { /* Invalid slug/blogPostId or Page Not Found */ appViewModel.currentView( LOCATION.PAGE_NOT_FOUND["ko_element"] ); } else if( statusCode === 500 ) { /* Server error */ appViewModel.currentView( LOCATION.SERVER_ERROR["ko_element"] ); } else { /* Unhandled error */ console.log( "UNHANDLED_ERROR :: " + blogPost + " :: " + statusCode ); appViewModel.currentView( LOCATION.SERVER_ERROR["ko_element"] ); } }; this.fetchBlogPost = function() { dataAccessor.getBlogPostByUri( window.location.pathname, _handleDataAccessorResponse ); }; this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.BLOG_POST.ko_element && appViewModel.currentView() != LOCATION.AUTHOR_INTERVIEW_POST.ko_element ) { /* Dispose all observers */ self.locationObserver.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { self.initialDataLoaded( false ); self.fetchBlogPost(); }, 0 ); }, this ); } , template: `<div data-bind="visible: ! initialDataLoaded()" class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mdl-card-border mobile-card"><!-- ko component: "pratilipi-loading-state" --><!-- /ko --></div><div class="pratilipi-blog-post-page" data-bind="visible: initialDataLoaded()" style="flex-grow: 1; width: 100%;"><div class="mdl-card mdl-card-border mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><div class="material-heading blog-post-title" data-bind="text: blogPost.title()"></div><div class="material-body-2 pratilipi-red blog-post-date" data-bind="text: convertDate( blogPost.creationDateMillis() )"></div><div class="material-subtitle-1 blog-post-content" data-bind="html: blogPost.content()"></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-google-login', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.requestOnFlight = params.requestOnFlight; this.isRegister = params.isRegister; this.googleLogin = function() { if( self.requestOnFlight() ) return; var GoogleAuth = gapi.auth2.getAuthInstance(); GoogleAuth.signIn().then( function( googleUser ) { self.requestOnFlight( true ); ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); dataAccessor.loginGoogleUser( googleUser.getAuthResponse().id_token, function( user ) { ToastUtil.toast( "ಯಶಸ್ವಿ!" ); self.triggerFacebookEvent('SIGNUPSUC_GOOGLE_REGISTER'); window.location.href = self.isRegister ? user[ "profilePageUrl" ] : getRetUrl( true ); }, function( error ) { self.requestOnFlight( false ); var message = "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!"; if( error[ "googleIdToken" ] != null ) { message = error[ "googleIdToken" ]; self.triggerFacebookEvent('SIGNUPERR_GOOGLE_REGISTER', JSON.stringify(error), 'googleIdToken'); } else if( error[ "message" ] != null ) { message = error[ "message" ]; self.triggerFacebookEvent('SIGNUPERR_GOOGLE_REGISTER', JSON.stringify(error), 'message'); } ToastUtil.toast( message, 3000, true ); }); }, function( error ) { console.log( JSON.stringify( error, undefined, 2 ) ); self.requestOnFlight( false ); }); }; /* Initialise Google Client App */ var domId = "pratilipi-google-sdk"; if( document.getElementById( domId ) == null ) { var googleAuth2 = document.createElement( 'script' ); googleAuth2.setAttribute( "src", "https://apis.google.com/js/api:client.js" ); googleAuth2.setAttribute( "id", domId ); googleAuth2.onload = function() { gapi.load( 'auth2', function() { auth2 = gapi.auth2.init({ client_id: '659873510744-kfim969enh181h4gbctffrjg5j47tfuq.apps.googleusercontent.com', cookiepolicy: 'single_host_origin', }); }); }; document.body.appendChild( googleAuth2 ); } /** * Facebook events */ this.triggerFacebookEvent = function(eventName, value, parentId) { switch (eventName) { case 'SIGNUPERR_GOOGLE_REGISTER': FacebookEventTriggerUtil.triggerFacebookEventByName('SIGNUPERR_GOOGLE_REGISTER'); break; case 'SIGNUPSUC_GOOGLE_REGISTER': FacebookEventTriggerUtil.triggerFacebookEventByName('SIGNUPSUC_GOOGLE_REGISTER'); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; } , template: `<button onclick="ga_CA( 'Login', 'G-Login' )"data-bind="{ click: googleLogin, disable: requestOnFlight }"type="submit"class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect pratilipi-white-button pratilipi-fb-blue-button login-button"><div class="sprites-icon login-sprite-icon-24 google-login-icon"></div>ಗೂಗಲ್'ನೊಂದಿಗೆ ಸೈನ್ ಇನ್</button>` }); </script> <script> ko.components.register( 'pratilipi-main-layout', { viewModel: function() {} , template: `<div class="mdl-layout mdl-js-layout" data-bind="event: { scroll: appViewModel.notifyOfScrollEvent }"><!-- ko component: "pratilipi-navigation-drawer" --><!-- /ko --><!-- ko if: isAndroid() --><!-- ko component: "pratilipi-android-strip" --><!-- /ko --><!-- /ko --><!-- ko component: "pratilipi-header" --><!-- /ko --><!-- ko component: "pratilipi-write" --><!-- /ko --><main class="mdl-layout__content" data-bind="event: { scroll: appViewModel.notifyOfScrollEvent }"><div class="body-layout-row"><div class="body-layout-nav"><!-- ko component: "pratilipi-navigation-aside" --><!-- /ko --></div><div class="body-layout-content"><div class="mdl-grid mobile-grid"style="flex-grow: 1;"data-bind="component: { name: appViewModel.currentView() }"></div></div></div><!-- ko component: "pratilipi-footer" --><!-- /ko --></main></div>` }); </script> <script> ko.components.register( 'pratilipi-current-event', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); var defaultEvent = { "eventId": null, "name": null, "nameEn": null, "language": null, "pageUrl": null, "bannerImageUrl": null, }; this.event = ko.mapping.fromJS( defaultEvent, {}, self.event ); this.isLoading = ko.observable(); this.updateEvent = function( event ) { if( event == null ) event = defaultEvent; ko.mapping.fromJS( event, {}, self.event ); MetaTagUtil.setMetaTagsForEvent( ko.mapping.toJS( self.event ) ); }; this.fetchEvent = function() { self.isLoading( true ); dataAccessor.getEventList( function( eventListResponse ) { if( eventListResponse == null ) return; self.isLoading( false ); self.updateEvent( eventListResponse.eventList[0] ); } ); }; this.fetchEvent(); } , template: `<div class="pratilipi-current-event"><div class="pratilipi-red material-subtitle-1">ಸ್ಪರ್ಧೆ</div><div data-bind="visible: isLoading()"style="margin: 12px auto;"class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></div><div data-bind="visible: ! isLoading()"><a data-bind="attr: { href: event.pageUrl() }" onclick="ga_CA( 'Event', 'Open' );"><img data-bind="attr: { src: getImageUrl( event.bannerImageUrl(), 400 ) }" /></a><a data-bind="attr: { href: event.pageUrl() }" onclick="ga_CA( 'Event', 'Open' );"><div class="material-body-1" data-bind="text: event.name()"></div></a></div></div>` }); </script> <script> ko.components.register( 'pratilipi-search-page-v2', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); var pratilipiCursor = null; var authorCursor = null; var pratilipiResultCount = 20; var authorResultCount = 10; var pratilipiNumberFound = null; var authorNumberFound = null; this.pratilipiList = ko.observableArray(); this.authorList = ko.observableArray(); this.updatePratilipiList = function( pratilipiList ) { for( var i = 0; i < pratilipiList.length; i++ ) { if( pratilipiList[i].author.name == null ) pratilipiList[i].author.name = " "; pratilipiList[i].pageUrl += ( pratilipiList[i].pageUrl.indexOf( "?" ) == -1 ? "?" : "&" ) + "searchQuery=" + encodeURIComponent( self.updatedSearchQuery() ); self.pratilipiList.push( ko.mapping.fromJS( pratilipiList[i] ) ); } }; this.updateAuthorList = function( authorList ) { for( var i = 0; i < authorList.length; i++ ) { authorList[i].pageUrl += ( authorList[i].pageUrl.indexOf( "?" ) == -1 ? "?" : "&" ) + "searchQuery=" + encodeURIComponent( self.updatedSearchQuery() ); self.authorList.push( ko.mapping.fromJS( authorList[i] ) ); } }; this.hasMorePratilipiContents = ko.observable( true ); this.hasMoreAuthorContents = ko.observable( true ); /* Loaded state */ /* * 4 Possible values for 'loadedState' * INITIAL * LOADED_EMPTY * LOADED * FAILED * * */ this.loadedState = ko.observable( "INITIAL" ); this.isLoading = ko.observable( false ); /* Initial Query loading state */ this.isLoadingPratilipi = ko.observable( false ); this.isLoadingAuthor = ko.observable( false ); this.updatedSearchQuery = ko.observable(); /* For displaying to User */ this.inputFocused = ko.observable( true ); /* 2 way binding */ this.searchQueryObserver = ko.computed( function() { appViewModel.searchQuery(); setTimeout( function() { if( appViewModel.searchQuery() == null || appViewModel.searchQuery().trim() == "" ) { self.loadedState( "INITIAL" ); self.clearAllValues(); } else { self.fetchInitialList(); } }, 0 ); }, this ); this.clearAllValues = function() { self.pratilipiList( [] ); self.authorList( [] ); pratilipiCursor = null; authorCursor = null; pratilipiNumberFound = null; authorNumberFound = null; self.hasMorePratilipiContents( true ); self.hasMoreAuthorContents( true ); }; this.fetchInitialList = function() { self.isLoadingPratilipi( false ); self.isLoadingAuthor( false ); self.isLoading( true ); self.triggerFacebookEvent('SEARCH_SEARCHM_SEARCH', null, appViewModel.searchQuery()); dataAccessor.getInitialSearchResults( appViewModel.searchQuery(), function( searchResponse ) { self.isLoading( false ); self.updatedSearchQuery( appViewModel.searchQuery() ); if( searchResponse == null ) { self.loadedState( "FAILED" ); return; } var pratilipi = searchResponse.pratilipi != null && !isEmpty( searchResponse.pratilipi ) ? searchResponse.pratilipi : { "pratilipiList": [], "pratilipiCursor": null, "pratilipiNumberFound": 0 }; var author = searchResponse.author != null && !isEmpty( searchResponse.author ) ? searchResponse.author : { "authorList": [], "authorCursor": null, "authorNumberFound": 0 }; var pratilipiList = pratilipi.pratilipiList; var authorList = author.authorList; if( pratilipiList.length == 0 && authorList == 0 ) { self.loadedState( "LOADED_EMPTY" ); self.clearAllValues(); return; } self.pratilipiList( [] ); self.authorList( [] ); self.updatePratilipiList( pratilipiList ); self.updateAuthorList( authorList ); pratilipiCursor = pratilipi.pratilipiCursor; authorCursor = author.authorCursor; pratilipiNumberFound = pratilipi.numberFound; authorNumberFound = author.numberFound; self.hasMorePratilipiContents( pratilipiNumberFound != 0 && self.pratilipiList().length < pratilipiNumberFound ); self.hasMoreAuthorContents( authorNumberFound != 0 && self.authorList().length < authorNumberFound ); self.loadedState( "LOADED" ); }); }; this.fetchSubsequentPratilipiList = function() { if( self.isLoadingPratilipi() ) return; self.isLoadingPratilipi( true ); ga_CA( "Pratilipi", "LoadMore" ); dataAccessor.getPratilipiSearchResults( appViewModel.searchQuery(), pratilipiCursor, pratilipiResultCount, function( searchResponse ) { if( searchResponse == null ) { self.isLoadingPratilipi( false ); return; } var pratilipi = searchResponse.pratilipi != null && !isEmpty( searchResponse.pratilipi ) ? searchResponse.pratilipi : { "pratilipiList": {}, "pratilipiCursor": null, "pratilipiNumberFound": 0 }; var pratilipiList = pratilipi.pratilipiList; self.updatePratilipiList( pratilipiList ); pratilipiCursor = pratilipi.pratilipiCursor; pratilipiNumberFound = pratilipi.numberFound; self.hasMorePratilipiContents( pratilipiNumberFound != 0 && self.pratilipiList().length < pratilipiNumberFound ); self.isLoadingPratilipi( false ); }); }; this.fetchSubsequentAuthorList = function() { self.isLoadingAuthor( true ); ga_CA( "Author", "LoadMore" ); dataAccessor.getAuthorSearchResults( appViewModel.searchQuery(), authorCursor, authorResultCount, function( searchResponse ) { if( searchResponse == null ) { self.isLoadingAuthor( false ); return; } var author = searchResponse.author != null && !isEmpty( searchResponse.author ) ? searchResponse.author : { "authorList": {}, "authorCursor": null, "authorNumberFound": 0 }; var authorList = author.authorList; self.updateAuthorList( authorList ); authorCursor = author.authorCursor; authorNumberFound = author.numberFound; self.hasMoreAuthorContents( authorNumberFound != 0 && self.authorList().length < authorNumberFound ); self.isLoadingAuthor( false ); }); }; this.exitSearch = function() { if( appViewModel.searchQuery() != null ) appViewModel.searchQuery( null ); else redirect( getUrlParameter( "retUrl" ) != null ? decodeURIComponent( getUrlParameter( "retUrl" ) ) : "/" ); }; this.placeholderText = ko.computed( function() { var windowsize = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth; return windowsize > 768 ? "ಪುಸ್ತಕಗಳು, ಕಥೆಗಳು, ಕವಿತೆಗಳು ಮತ್ತು ಇನ್ನಿತರ ಪ್ರಕಾರದ ಬರಹಗಳಿಗಾಗಿ ಹುಡುಕಾಟ ನಡೆಸಿ" : "ಹುಡುಕಿ"; }, this ); this.pageScrollObserver = ko.computed( function() { if( ( appViewModel.scrollTop() / $( ".js-pratilipi-list-grid" ).height() ) > 0.6 ) { setTimeout( function() { self.fetchSubsequentPratilipiList(); }, 100 ); /* locationObserver and pageScrollObserver will be triggered at once. */ } }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.SEARCH_V2.ko_element ) { /* Dispose all observers */ self.pageScrollObserver.dispose(); self.placeholderText.dispose(); self.searchQueryObserver.dispose(); self.locationObserver.dispose(); return; } else { setTimeout( function() { MetaTagUtil.setMetaTagsForSearch(); }); } }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName, parentId, value) { switch (eventName) { case 'CLICKCATEGORY_SEARCHM_SEARCH': FacebookEventTriggerUtil.triggerFacebookEventByNameAndParentId(eventName, parentId ); break; case 'LANDED_SEARCHM_SEARCH': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; case 'SEARCH_SEARCHM_SEARCH': FacebookEventTriggerUtil.triggerFacebookEventByNameAndValue(eventName, value); break; case 'UNFOLLOW_AUTHORDETAIL_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndValue('UNFOLLOW_AUTHORDETAIL_BOOK', self.pratilipi, self.author.user.followCount ? self.author.user.followCount() : 0, self.author.user.userId ? self.author.user.userId() : 0); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.triggerCategoryClick = function(categoryLink) { self.triggerFacebookEvent('CLICKCATEGORY_SEARCHM_SEARCH', categoryLink); return true; }; self.triggerFacebookEvent('LANDED_SEARCHM_SEARCH'); } , template: `<div class="mdl-layout mdl-js-layout pratilipi-search-page"><div class="pratilipi-search-header mdl-card-border"><div class="header"><button data-bind="click: exitSearch"onclick="ga_CA( 'Search', 'Back' )"class="mdl-button mdl-js-button mdl-button--icon exit-search-button"><i class="material-icons">arrow_back</i></button><input type="text" data-bind="{ value: appViewModel.searchQuery, hasFocus: inputFocused, attr: { placeholder: placeholderText } }" /><button class="search-button"onclick="ga_CA( 'Search', 'SearchIconClick' )"data-bind="visible: ! isLoading()"><i class="material-icons">search</i></button><span data-bind="visible: isLoading()"class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active search-loading-spinner"></span></div></div><div class="mdl-layout__content" data-bind="event: { scroll: appViewModel.notifyOfScrollEvent }"><div class="body mdl-card-border"><div class="mdl-grid default-result" data-bind="visible: loadedState() == 'INITIAL'"><div class="mdl-cell mdl-cell--6-col"><!-- ko component: "pratilipi-search-trends" --><!-- /ko --></div><div class="mdl-cell mdl-cell--6-col mdl-layout--large-screen-only"><!-- ko component: "pratilipi-current-event" --><!-- /ko --></div></div><!--<div class="mdl-grid search-results-incomplete"><div class="mdl-cell mdl-cell--6-col"><div class="material-subtitle-1 result-title">Author Matches</div><div class="result-entries"><a class="result-link material-body-1" href="#">Jaganath Sharma</a><a class="result-link material-body-1" href="#">Jaganath Mishra</a><a class="result-link material-body-1" href="#">Jagal</a></div></div><div class="mdl-cell mdl-cell--6-col"><div class="material-subtitle-1 result-title">Content Matches</div><div class="result-entries"><a class="result-link material-body-1" href="#">Jaganath Sharma</a><a class="result-link material-body-1" href="#">Jaganath Mishra</a><a class="result-link material-body-1" href="#">Jagal</a></div></div></div>--><div class="search-results-complete" data-bind="visible: loadedState() == 'LOADED'"><div class="mdl-grid" style="padding-top: 0; padding-bottom: 0;"><div class="mdl-cell mdl-cell--12-col search-results-heading"data-bind="text: 'ಹುಡುಕಾಟದ ಫಲಿತಾಂಶಗಳು : $query'.replace( '$query', updatedSearchQuery() )"></div></div><!-- ko if: authorList().length > 0 --><div class="mdl-grid author-results"><div class="mdl-cell mdl-cell--12-col"><div class="material-subtitle-1">ಬರಹಗಾರರು</div></div><div class="pratilipi-carousel" data-bind="carousel: true"><div class="carousel-wrapper"><div class="carousel"><ul data-bind="foreach: { data: authorList, as: 'author' }, visible: authorList().length > 0"><li data-bind="component: {name: 'pratilipi-author-card',params: { author: author }}"></li></ul></div></div><button action="prev" onclick="ga_CA( 'Author', 'ShowLess' )"><i class="material-icons">keyboard_arrow_left</i></button><button action="next" onclick="ga_CA( 'Author', 'ShowMore' )"><i class="material-icons">keyboard_arrow_right</i></button></div></div><!-- /ko --><!-- ko if: pratilipiList().length > 0 --><div class="pratilipi-results"><div class="mdl-grid" style="padding-top: 0; padding-bottom: 0;"><div class="mdl-cell mdl-cell--12-col"><div class="material-subtitle-1">ಬರಹಗಳು</div></div></div><div data-bind="foreach: { data: pratilipiList, as: 'pratilipi' }, visible: pratilipiList().length > 0"class="mdl-grid pratilipi-list-grid js-pratilipi-list-grid mobile-card"><div class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><!-- ko component: {name: "pratilipi-pratilipi-card",params: { pratilipi: pratilipi, hideLibraryButton: true }} --><!-- /ko --></div></div><div class="load-more-container" data-bind="visible: hasMorePratilipiContents() && pratilipiList().length > 0"><button data-bind="{ click: fetchSubsequentPratilipiList, visible: ! isLoadingPratilipi() }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">ಇನ್ನಷ್ಟು ವಿಷಯಗಳನ್ನು ಲೋಡ್ ಮಾಡಿ</button><span data-bind="visible: isLoadingPratilipi()" class="initial-data-loading-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div></div><!-- /ko --></div><div class="mdl-grid search-loaded-empty" data-bind="visible: loadedState() == 'LOADED_EMPTY'"><div class="mdl-cell mdl-cell--12-col material-subtitle-1">ಕ್ಷಮಿಸಿ! ನಿಮ್ಮ ಹುಡುಕಾಟದ ಪ್ರಶ್ನೆಗಳಿಗೆ ಯಾವುದೇ ಫಲಿತಾಂಶ ಲಭ್ಯವಿಲ್ಲ.</div></div><div class="mdl-grid search-load-failed" data-bind="visible: loadedState() == 'FAILED'"><div class="mdl-cell mdl-cell--12-col material-subtitle-1">ಹುಡುಕಾಟದ ಫಲಿತಾಂಶಗಳು ಲೋಡ್ ಆಗುವಲ್ಲಿ ವಿಫಲಗೊಂಡಿವೆ! ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಲು ದಯವಿಟ್ಟು ಇಲ್ಲಿ ಕ್ಲಿಕ್ ಮಾಡಿ!</div></div><div class="mdl-grid explore-categories" data-bind="visible: loadedState() == 'INITIAL' || loadedState() == 'LOADED_EMPTY' || loadedState() == 'FAILED'"><div class="mdl-cell mdl-cell--12-col pratilipi-red material-subtitle-1" data-bind="text: loadedState() == 'INITIAL' ? 'ಪ್ರಭೇದಗಳನ್ನು ಶೋಧಿಸಿ' : 'ಈ ಪ್ರಭೇದಗಳ ಶೋಧನೆಯನ್ನು ಪ್ರಯತ್ನಿಸಿ'"></div><a href="/love" data-bind="click: triggerCategoryClick.bind(this, '/love')" class="mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--12-col-phone image-bk"style="background-image: url('https://0.ptlp.co/resource-all/android-category-banners/romance.jpg');" onclick="ga_CA( 'Search-Category', 'Open-romance' );"><span class="link-name material-subtitle-1">ಪ್ರೀತಿ</span></a><a href="/horror" data-bind="click: triggerCategoryClick.bind(this, '/horror')" class="mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--12-col-phone image-bk"style="background-image: url('https://0.ptlp.co/resource-all/android-category-banners/horror.jpg');" onclick="ga_CA( 'Search-Category', 'Open-horror' );"><span class="link-name material-subtitle-1">ಹಾರರ್</span></a><a href="/comedy" data-bind="click: triggerCategoryClick.bind(this, '/comedy')" class="mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--12-col-phone image-bk"style="background-image: url('https://0.ptlp.co/resource-all/android-category-banners/comedy.jpg');" onclick="ga_CA( 'Search-Category', 'Open-satire' );"><span class="link-name material-subtitle-1">ಹಾಸ್ಯ</span></a><a href="/relationship" data-bind="click: triggerCategoryClick.bind(this, '/relationship')" class="mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--12-col-phone image-bk"style="background-image: url('https://0.ptlp.co/resource-all/android-category-banners/event_friendship.jpg');" onclick="ga_CA( 'Search-Category', 'Open-family' );"><span class="link-name material-subtitle-1">ಬಂಧುತ್ವ</span></a><a href="/women" data-bind="click: triggerCategoryClick.bind(this, '/women')" class="mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--12-col-phone image-bk"style="background-image: url('https://0.ptlp.co/resource-all/android-category-banners/event_women.jpg');" onclick="ga_CA( 'Search-Category', 'Open-women' );"><span class="link-name material-subtitle-1">ಮಹಿಳೆ</span></a><a href="/dhaaraavaahi" data-bind="click: triggerCategoryClick.bind(this, '/dhaaraavaahi')" class="mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--12-col-phone image-bk"style="background-image: url('https://0.ptlp.co/resource-all/android-category-banners/novels.jpg');" onclick="ga_CA( 'Search-Category', 'Open-serials' );"><span class="link-name material-subtitle-1">ಧಾರಾವಾಹಿ</span></a><a href="/nonfiction" data-bind="click: triggerCategoryClick.bind(this, '/nonfiction')" class="mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--12-col-phone image-bk"style="background-image: url('https://0.ptlp.co/resource-all/android-category-banners/articles.jpg');" onclick="ga_CA( 'Search-Category', 'Open-articles' );"><span class="link-name material-subtitle-1">ಲೇಖನಗಳು</span></a><a href="/poems" data-bind="click: triggerCategoryClick.bind(this, '/poems')" class="mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--12-col-phone image-bk"style="background-image: url('https://0.ptlp.co/resource-all/android-category-banners/poems.jpg');" onclick="ga_CA( 'Search-Category', 'Open-poetry' );"><span class="link-name material-subtitle-1">ಕವಿತೆಗಳು</span></a><a href="/society" data-bind="click: triggerCategoryClick.bind(this, '/society')" class="mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--12-col-phone image-bk"style="background-image: url('https://0.ptlp.co/resource-all/android-category-banners/social.jpg');" onclick="ga_CA( 'Search-Category', 'Open-social' );"><span class="link-name material-subtitle-1">ಸಮಾಜ</span></a><a href="/science" data-bind="click: triggerCategoryClick.bind(this, '/science')" class="mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--12-col-phone image-bk"style="background-image: url('https://0.ptlp.co/resource-all/android-category-banners/scifi.jpg');" onclick="ga_CA( 'Search-Category', 'Open-educational' );"><span class="link-name material-subtitle-1">ವಿಜ್ಞಾನ</span></a><a href="/life" data-bind="click: triggerCategoryClick.bind(this, '/life')" class="mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--12-col-phone image-bk"style="background-image: url('https://0.ptlp.co/resource-all/android-category-banners/monsoon.jpg');" onclick="ga_CA( 'Search-Category', 'Open-life' );"><span class="link-name material-subtitle-1">ಜೀವನ</span></a><a href="/cinema" data-bind="click: triggerCategoryClick.bind(this, '/cinema')" class="mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--12-col-phone image-bk"style="background-image: url('https://0.ptlp.co/resource-all/android-category-banners/movies.jpg');" onclick="ga_CA( 'Search-Category', 'Open-cinema' );"><span class="link-name material-subtitle-1">ಸಿನಿಮಾ</span></a><a href="/inspirational" data-bind="click: triggerCategoryClick.bind(this, '/inspirational')" class="mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--12-col-phone image-bk"style="background-image: url('https://0.ptlp.co/resource-all/android-category-banners/inspirational.jpg');" onclick="ga_CA( 'Search-Category', 'Open-inspirational' );"><span class="link-name material-subtitle-1">ಸ್ಫೂರ್ತಿದಾಯಕ</span></a><a href="/otherstories" data-bind="click: triggerCategoryClick.bind(this, '/otherstories')" class="mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--12-col-phone image-bk"style="background-image: url('https://0.ptlp.co/resource-all/android-category-banners/fiction.jpg');" onclick="ga_CA( 'Search-Category', 'Open-other-stories' );"><span class="link-name material-subtitle-1">ಕಥೆಗಳು</span></a><a href="/books" data-bind="click: triggerCategoryClick.bind(this, '/books')" class="mdl-cell mdl-cell--3-col mdl-cell--4-col-tablet mdl-cell--12-col-phone image-bk"style="background-image: url('https://0.ptlp.co/resource-all/android-category-banners/event_generic3.jpg');" onclick="ga_CA( 'Search-Category', 'Open-books' );"><span class="link-name material-subtitle-1">ಸಮಗ್ರ</span></a></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-search-page', { viewModel: function() { var self = this; var cursor = null; var resultCount = 20; var dataAccessor = new DataAccessor(); this.searchTitle = ko.observable(); this.isListPage = ko.observable(); /* TODO: Remove this once we are rid of search pages in navigation */ this.pratilipiList = ko.observableArray(); this.hasMoreContents = ko.observable( true ); /* Loading state */ /* * 4 Possible values for 'loadingState' * LOADING * LOADED_EMPTY * LOADED * FAILED * * */ this.loadingState = ko.observable(); this.updatePratilipiList = function( pratilipiList ) { for( var i = 0; i < pratilipiList.length; i++ ) self.pratilipiList.push( ko.mapping.fromJS( pratilipiList[i] ) ); }; this.fetchPratilipiList = function() { if( self.loadingState() == "LOADING" || ! self.hasMoreContents() ) return; self.loadingState( "LOADING" ); dataAccessor.getPratilipiListBySearchQuery( appViewModel.searchQuery(), cursor, null, resultCount, function( pratilipiListResponse ) { if( pratilipiListResponse == null ) { self.loadingState( "FAILED" ); return; } var loadMore = self.pratilipiList().length != 0; var pratilipiList = pratilipiListResponse.pratilipiList; self.updatePratilipiList( pratilipiList ); cursor = pratilipiListResponse.cursor; self.loadingState( self.pratilipiList().length > 0 || pratilipiList.length > 0 ? "LOADED" : "LOADED_EMPTY" ); self.hasMoreContents( pratilipiList.length == resultCount && cursor != null ); if( loadMore ) ga_CA( 'Pratilipi', 'LoadMore' ); }); }; var listsearchTitleMap = { '/love': 'ಪ್ರೀತಿ', '/horror': 'ಹಾರರ್', '/comedy': 'ಹಾಸ್ಯ', '/relationship': 'ಬಂಧುತ್ವ', '/women': 'ಮಹಿಳೆ', '/dhaaraavaahi': 'ಧಾರಾವಾಹಿ', '/nonfiction': 'ಲೇಖನಗಳು', '/poems': 'ಕವಿತೆಗಳು', '/society': 'ಸಮಾಜ', '/science': 'ವಿಜ್ಞಾನ', '/life': 'ಜೀವನ', '/cinema': 'ಸಿನಿಮಾ', '/inspirational': 'ಸ್ಫೂರ್ತಿದಾಯಕ', '/otherstories': 'ಕಥೆಗಳು', '/books': 'ಸಮಗ್ರ', '/event/ನಗು-ನಗುತಾ-ನಲೀ-ನಲಿ-ic59tqb4yv': 'ನಗು ನಗುತಾ ನಲೀ ನಲಿ...', '/most-read': 'ಓದುಗರ ಆಯ್ಕೆ', '/newcontents': 'ಹೊಸ ಬರಹಗಳು', '/classic-sahitya': 'ವಚನಗಳು', '/event': 'ಸ್ಪರ್ಧೆಗಳು', '/blog': 'ಬ್ಲಾಗ್&#39;ಗಳು', }; this.searchQueryUpdated = function() { /* Setting searchTitle for search pages coming from navigation */ self.searchTitle( listsearchTitleMap[ "/search?q=" + appViewModel.searchQuery() ] != null ? listsearchTitleMap[ "/search?q=" + appViewModel.searchQuery() ] : "ಹುಡುಕಾಟದ ಫಲಿತಾಂಶಗಳು" ); self.isListPage( listsearchTitleMap[ "/search?q=" + appViewModel.searchQuery() ] != null ); self.pratilipiList( [] ); cursor = null; self.loadingState( null ); self.hasMoreContents( true ); self.fetchPratilipiList(); }; this.searchQueryObserver = ko.computed( function() { if( appViewModel.searchQuery() == null ) return; setTimeout( function() { self.searchQueryUpdated(); ga_CAV( 'Header', 'Search', appViewModel.searchQuery() ); }, 0 ); }, this ); this.pageScrollObserver = ko.computed( function() { if( ( appViewModel.scrollTop() / $( ".js-pratilipi-list-grid" ).height() ) > 0.6 ) { setTimeout( function() { self.fetchPratilipiList(); }, 100 ); /* locationObserver and pageScrollObserver will be triggered at once. */ } }, this ); this.getLoadingStateText = ko.computed( function() { return "ಹುಡುಕಾಟ ನಡೆಸಲಾಗುತ್ತಿದೆ : $query".replace( "$query", appViewModel.searchQuery() ); }); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.SEARCH.ko_element ) { /* Dispose all observers */ self.getLoadingStateText.dispose(); self.locationObserver.dispose(); self.pageScrollObserver.dispose(); self.searchQueryObserver.dispose(); return; } }, this ); } , template: `<div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card generic-list-page"><div data-bind="html: searchTitle()"class="load-more-container mdl-card-border material-heading"style="margin-top: 0;"></div><div data-bind="foreach: { data: pratilipiList, as: 'pratilipi' }, visible: pratilipiList().length > 0"class="mdl-grid pratilipi-list-grid js-pratilipi-list-grid mobile-card"><div class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><!-- ko component: {name: "pratilipi-pratilipi-card",params: { pratilipi: pratilipi }} --><!-- /ko --></div></div><div class="load-more-container mdl-card-border" data-bind="visible: loadingState() == 'LOADING'"><div class="search-loading-state" data-bind="visible: pratilipiList().length == 0"><!-- ko component: {name: "pratilipi-loading-state",params: { customText: isListPage() ? null : getLoadingStateText() }} --><!-- /ko --></div><span data-bind="visible: pratilipiList().length > 0" class="initial-data-loading-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div><div class="load-more-container mdl-card-border material-subtitle-1" data-bind="visible: loadingState() == 'FAILED' && pratilipiList().length == 0"><a style="cursor: pointer; color: #555;" data-bind="click: fetchPratilipiList">ಹುಡುಕಾಟದ ಫಲಿತಾಂಶಗಳು ಲೋಡ್ ಆಗುವಲ್ಲಿ ವಿಫಲಗೊಂಡಿವೆ! ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಲು ದಯವಿಟ್ಟು ಇಲ್ಲಿ ಕ್ಲಿಕ್ ಮಾಡಿ!</a></div><div class="load-more-container mdl-card-border" data-bind="visible: hasMoreContents() && ( loadingState() == 'LOADED' || loadingState() == 'FAILED' ) && pratilipiList().length > 0"><button data-bind="{ click: fetchPratilipiList }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">ಇನ್ನಷ್ಟು ವಿಷಯಗಳನ್ನು ಲೋಡ್ ಮಾಡಿ</button></div><div class="load-more-container mdl-card-border material-subtitle-1" data-bind="visible: loadingState() == 'LOADED_EMPTY'">ಕ್ಷಮಿಸಿ! ನಿಮ್ಮ ಹುಡುಕಾಟದ ಪ್ರಶ್ನೆಗಳಿಗೆ ಯಾವುದೇ ಫಲಿತಾಂಶ ಲಭ್ಯವಿಲ್ಲ.</div></div>` }); </script> <script> ko.components.register( 'pratilipi-header', { viewModel: function( params ) { var self = this; var openWriteDialog = function() { $( "#pratilipiWrite" ).modal(); }; this.search = function( formElement ) { if( appViewModel.searchQuery() && appViewModel.searchQuery().trim().length && window.location.pathname != "/search" ) redirect( "/search?q=" + appViewModel.searchQuery() ); }; this.redirectToSearch = function() { self.triggerFacebookEvent('GOSEARCH_HEADER_GLOBAL'); redirect( "/search?retUrl=" + encodeURIComponent( window.location.pathname ) ); }; this.openMenuNavigationDrawer = function() { self.triggerFacebookEvent('LANDED_TOPICS_GLOBAL'); if( !( typeof( componentHandler ) == 'undefined' ) ) { componentHandler.upgradeAllRegistered(); } document.querySelector( '.mdl-layout' ).MaterialLayout.toggleDrawer(); }; this.write = function() { self.triggerFacebookEvent('WRITENEWBOOK_HEADER_GLOBAL'); if( isMobile() ) { ToastUtil.toast( "ಪ್ರತಿಲಿಪಿಯಲ್ಲಿ ಬರೆಯಲು ದಯವಿಟ್ಟು ಆ್ಯoಡ್ರಾಯ್ಡ್ ಆ್ಯಪ್ ಮೂಲಕ ಲಾಗಿನ್ ಆಗಿ", 5000 ); return; } if( appViewModel.user.isGuest() ) { goToLoginPage( { "action": "write" }, { "message": "WRITE" } ); } else { openWriteDialog(); } }; this.headerTabchange = function() { var tab_id = $(event.currentTarget).attr('data-tab'); $(".header-tab-menu li").removeClass("active"); $(event.currentTarget).addClass("active"); $(".header-tab-content").hide(); $("#" + tab_id).show(); }; /* Loading Notifications */ var notificationContainer = $( ".js-pratilipi-header #notificationContainer" ); var notificationTitle = $( ".js-pratilipi-header #notificationTitle" ); var notificationTab = $( ".js-pratilipi-header .header-tab-menu" ); var notificationsBody = $( ".js-pratilipi-header #notificationsBody" ); var notificationLink = $( ".js-pratilipi-header #notificationLink" ); var notificationFooter = $( ".js-pratilipi-header #notificationFooter" ); var viewMoreNotificationLink = $( ".js-pratilipi-header #notificationFooter a" ); notificationLink.click( function() { resetFbNotificationCount(); self.triggerFacebookEvent('EXPANDNOTIFS_HEADER_GLOBAL'); var windowsize = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth; if( windowsize < 768 ) { redirect( "/notifications" ); } else { notificationContainer.fadeToggle(50); } return false; }); $( document ).click( function() { notificationContainer.hide(); } ); /* notificationContainer.click( function(e) { e.stopPropagation(); } ); */ notificationTitle.click( function(e) { e.stopPropagation(); } ); notificationTab.click( function(e) { e.stopPropagation(); } ); notificationsBody.click( function(e) { notificationContainer.hide(); } ); viewMoreNotificationLink.click( function(e) { notificationContainer.hide(); } ); this.userObserver = ko.computed( function() { if( ! appViewModel.user.isGuest() ) { if( getUrlParameter( 'action' ) == "write" ) openWriteDialog(); if( getUrlParameter( 'action' ) == "notifications" ) notificationLink.click(); } }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName, value) { switch (eventName) { case 'GOLANGUAGE_HEADER_GLOBAL': FacebookEventTriggerUtil.triggerFacebookEventByNameAndValue(eventName, value); break; case 'GOHOME_HEADER_GLOBAL': case 'GOLIBRARY_HEADER_GLOBAL': case 'GOLOGIN_HEADER_GLOBAL': case 'GOMYPROFILE_HEADER_GLOBAL': case 'GONOTIFPAGE_HEADER_GLOBAL': case 'GOSEARCH_HEADER_GLOBAL': case 'WRITENEWBOOK_HEADER_GLOBAL': case 'LANDED_TOPICS_GLOBAL': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; case 'EXPANDNOTIFS_HEADER_GLOBAL': FacebookEventTriggerUtil.triggerFacebookEventByNameAndValue(eventName, appViewModel.notificationCount()); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.triggerGoHomeEvent = function() { self.triggerFacebookEvent('GOHOME_HEADER_GLOBAL'); return true; }; this.triggerGoLanguageEvent = function(language) { self.triggerFacebookEvent('GOLANGUAGE_HEADER_GLOBAL', language); return true; }; this.triggerGoLibraryEvent = function() { self.triggerFacebookEvent('GOLIBRARY_HEADER_GLOBAL'); return true; }; this.triggerGoLoginPageEvent = function() { self.triggerFacebookEvent('GOLOGIN_HEADER_GLOBAL'); return true; }; this.triggerGoMyProfileEvent = function() { self.triggerFacebookEvent('GOMYPROFILE_HEADER_GLOBAL'); return true; }; this.triggerGoNotifPageEvent = function() { self.triggerFacebookEvent('GONOTIFPAGE_HEADER_GLOBAL'); return true; }; } , template: `<header class="pratilipi-header js-pratilipi-header mdl-layout__header mdl-layout__header--scroll"><div class="mdl-layout__header-row parent-container row-one"><a data-bind="click: triggerGoHomeEvent" href="/"><span class="sprites-icon pratilipi-logo-icon"></span></a><button onclick="ga_CA( 'Header', 'Get Languages' )"id="pratilipi-header-pratilipi-dropdown" class="pratilipi-text hidden-xs"><span class="font-m">ಪ್ರತಿಲಿಪಿ</span><i class="material-icons">arrow_drop_down</i></button><ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect language-ul" for="pratilipi-header-pratilipi-dropdown"><li class="mdl-menu__item" data-bind="click: triggerGoLanguageEvent.bind(this, 'हिंदी')" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://hindi.pratilipi.com'; return false;">हिंदी</li><li class="mdl-menu__item" data-bind="click: triggerGoLanguageEvent.bind(this, 'ગુજરાતી')" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://gujarati.pratilipi.com'; return false;">ગુજરાતી</li><li class="mdl-menu__item" data-bind="click: triggerGoLanguageEvent.bind(this, 'தமிழ்')" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://tamil.pratilipi.com'; return false;">தமிழ்</li><li class="mdl-menu__item" data-bind="click: triggerGoLanguageEvent.bind(this, 'मराठी')" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://marathi.pratilipi.com'; return false;">मराठी</li><li class="mdl-menu__item" data-bind="click: triggerGoLanguageEvent.bind(this, 'മലയാളം')" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://malayalam.pratilipi.com'; return false;">മലയാളം</li><li class="mdl-menu__item" data-bind="click: triggerGoLanguageEvent.bind(this, 'বাংলা')" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://bengali.pratilipi.com'; return false;">বাংলা</li><li class="mdl-menu__item" data-bind="click: triggerGoLanguageEvent.bind(this, 'తెలుగు')" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://telugu.pratilipi.com'; return false;">తెలుగు</li><li class="mdl-menu__item" style="background: #eee;">ಕನ್ನಡ</li></ul><div class="header-icons-holder menu-icon-holder"><button data-bind="event: { click: openMenuNavigationDrawer }" class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">menu</i></button></div><div class="search-bar-holder hidden-xs"><form action="javascript:void(0);" data-bind="submit: search"><div class="mdl-textfield mdl-js-textfield"><input placeholder="ಪುಸ್ತಕಗಳು, ಕಥೆಗಳು, ಕವಿತೆಗಳು ಮತ್ತು ಇನ್ನಿತರ ಪ್ರಕಾರದ ಬರಹಗಳಿಗಾಗಿ ಹುಡುಕಾಟ ನಡೆಸಿ" class="mdl-textfield__input font-s" type="text" id="pratilipi-header-search" data-bind="value: appViewModel.searchQuery, event: { click: redirectToSearch }" /><i data-bind="event: { click: search }" class="material-icons search">search</i></div></form></div><div class="header-icons-holder"><button onclick="ga_CA( 'Header', 'Write' )"data-bind="click: write"class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">create</i></button></div><div class="header-icons-holder"><a onclick="ga_CA( 'Header', 'Library' )"data-bind="attr: { 'href': appViewModel.user.isGuest() ? '/login?retUrl=%2Flibrary&message=LIBRARY' : '/library' }, click: triggerGoLibraryEvent"class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">library_books</i></a></div><div class="header-icons-holder"><a onclick="ga_CA( 'Header', 'Notification' )"data-bind="visible: appViewModel.user.isGuest()"href="/login?retUrl=%2Fnotifications&message=NOTIFICATIONS"class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">notifications</i></a><span onclick="ga_CA( 'Header', 'Notification' )"id="notificationLink"style="position: absolute; margin-left: -12px; margin-top: -12px;"class="material-icons mdl-badge--overlap mdl-badge--no-background"data-bind="{ attr: { 'data-badge': ( appViewModel.notificationCount() > 99 ? '99+' : appViewModel.notificationCount() ) },css: { 'mdl-badge': ( appViewModel.notificationCount() > 0 ) },visible: ! appViewModel.user.isGuest() }"><i class="material-icons">notifications</i><!-- ko if: appViewModel.pendingUnreadMessages && appViewModel.pendingUnreadMessages() --><span class="message-notification"></span><!-- /ko --></span><div id="notificationContainer"><ul class="header-tab-menu"><li data-bind="click: headerTabchange" class="active" data-tab="header_notifications">ಸೂಚನೆ</li><li data-bind="click: headerTabchange" data-tab="header_messages">ಸಂದೇಶಗಳು<!-- ko if: appViewModel.pendingUnreadMessages && appViewModel.pendingUnreadMessages() --><span class="message-dot"></span><!-- /ko --></li></ul><div class="header-tab-content" id="header_notifications"><div id="notificationTitle">ಸೂಚನೆ</div><div id="notificationsBody" class="notifications"><!-- ko component: {name: "pratilipi-notification-list",params: { resultCount: 10,notificationsPageBehaviour: false,listenToFirebase: true }} --><!-- /ko --></div><div id="notificationFooter"><a style="display: block; margin: 10px;" data-bind="click: triggerGoNotifPageEvent" href="/notifications">ಇನ್ನೂ ಹೆಚ್ಚು ತೋರಿಸಿ...</a></div></div><!-- ko if: !appViewModel.user.isGuest() --><div class="header-tab-content" id="header_messages"><!-- ko component: {name: "pratilipi-message-notification-list",params: { resultCount: 20,notificationsPageBehaviour: true }} --><!-- /ko --></div><!-- /ko --></div></div><div class="desktop-signin-button-holder hidden-xs"><div data-bind="visible: appViewModel.user.userId() == null" style="margin: auto; padding-left: 8px;"><!-- <span class="user-loading-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span> --><div class="user-loading-spinner"></div></div><a onclick="ga_CA( 'Header', 'Login' )"data-bind="{ attr: { 'href': '/login?retUrl=' + encodeURIComponent( window.location.pathname ) }, visible: appViewModel.user.userId() != null && appViewModel.user.isGuest(), click: triggerGoLoginPageEvent }"class="sign-in-button mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect hidden-xs"><i class="material-icons">account_circle</i><span class="font-s">ಸೈನ್ ಇನ್ ಆಗಿ</span></a><a onclick="ga_CA( 'Header', 'User' )"data-bind="{ visible: appViewModel.user.userId() != null && !appViewModel.user.isGuest(),attr: { 'href': appViewModel.user.profilePageUrl() }, click: triggerGoMyProfileEvent }"class="user-profile hidden-xs"><img class="img-circle user-dp"data-bind="attr: { 'src': getImageUrl( appViewModel.user.profileImageUrl(), 48 ) }" /><span class="font-s" data-bind="text: appViewModel.user.displayName()"></span></a></div><div class="header-icons-holder visible-xs"><div data-bind="visible: appViewModel.user.userId() == null" style="margin: auto; padding-left: 8px;"><span class="user-loading-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div><a onclick="ga_CA( 'Header', 'Login' )"data-bind="{ visible: appViewModel.user.userId() != null && appViewModel.user.isGuest(),attr: { 'href': '/login?retUrl=' + encodeURIComponent( window.location.pathname ) } }"class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">account_circle</i></a><a onclick="ga_CA( 'Header', 'User' )"data-bind="{ visible: appViewModel.user.userId() != null && !appViewModel.user.isGuest(),attr: { 'href': appViewModel.user.profilePageUrl() } }"class="mdl-button mdl-js-button mdl-button--icon"><img class="img-circle user-dp" data-bind="attr: { 'src': getImageUrl( appViewModel.user.profileImageUrl(), 48 ) }" /></a></div></div><div class="mdl-layout__header-row parent-container row-two hidden-sm hidden-md hidden-lg"><button onclick="ga_CA( 'Header', 'Get Languages' )"id="pratilipi-header-pratilipi-dropdown-mobile"class="pratilipi-text"><span class="font-m">ಪ್ರತಿಲಿಪಿ</span><i class="material-icons">arrow_drop_down</i></button><ul class="mdl-menu mdl-js-menu mdl-js-ripple-effect language-ul" for="pratilipi-header-pratilipi-dropdown-mobile"><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://hindi.pratilipi.com'; return false;">हिंदी</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://gujarati.pratilipi.com'; return false;">ગુજરાતી</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://tamil.pratilipi.com'; return false;">தமிழ்</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://marathi.pratilipi.com'; return false;">मराठी</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://malayalam.pratilipi.com'; return false;">മലയാളം</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://bengali.pratilipi.com'; return false;">বাংলা</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://telugu.pratilipi.com'; return false;">తెలుగు</li><li class="mdl-menu__item" style="background: #eee;">ಕನ್ನಡ</li></ul><form action="javascript:void(0);" data-bind="submit: search"><div class="mdl-textfield mdl-js-textfield"><input placeholder="ಹುಡುಕಿ" class="mdl-textfield__input font-s" type="text" id="pratilipi-header-search-mobile" data-bind="value: appViewModel.searchQuery, event: { click: redirectToSearch }" /><i data-bind="event: { click: search }" class="material-icons search">search</i></div></form></div></header>` }); </script> <script> ko.components.register( 'pratilipi-static-page', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.initialDataLoaded = ko.observable( false ); this.title = ko.observable(); this.content = ko.observable(); this.fetchStaticContent = function() { dataAccessor.getPageContent( window.location.pathname.substring(1).replace( "/", "_" ), function( pageContent ) { self.title( pageContent.title ); self.content( pageContent.content ); self.initialDataLoaded( true ); MetaTagUtil.setMetaTagsForStatic( pageContent ); }); }; this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.STATIC.ko_element ) { /* Dispose all observers */ self.locationObserver.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { self.initialDataLoaded( false ); self.fetchStaticContent(); }, 0 ); }, this ); } , template: `<div data-bind="visible: ! initialDataLoaded()" class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><span class="initial-data-loading-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div><div data-bind="visible: initialDataLoaded()" style="flex-grow: 1; width: 100%;"><div class="mdl-card mdl-card-border mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><div style="margin-top: 0; " class="load-more-container material-heading" data-bind="text: title()"></div><div style="border-top: 1px solid lightgrey; padding: 16px;" class="material-subtitle-1 load-more-container" data-bind="html: content()"></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-forgot-password-page', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); this.userEmail = ko.observable(); this.requestOnFlight = ko.observable( false ); this.emailHasBeenMutedBefore = ko.observable(false); this.userEmailChangeDetector = ko.computed(function() { if (!self.userEmail() || self.userEmail().length === 0) { return false; } else if (self.emailHasBeenMutedBefore()) { return false; } self.triggerFacebookEvent('TYPELOGINFIELD_EMAIL_FORGOTP'); self.emailHasBeenMutedBefore(true); return true; }); this.forgotPassword = function() { if( self.requestOnFlight() ) return; if( self.userEmail() == null || self.userEmail().trim() == "" ) { ToastUtil.toast( "ದಯವಿಟ್ಟು ನಿಮ್ಮ ಇಮೇಲ್ ನಮೂದಿಸಿ" ); return; } if( ! validateEmail( self.userEmail() ) ) { ToastUtil.toast( "ದಯವಿಟ್ಟು ಸರಿಯಾಗಿರುವ ಇಮೇಲ್'ಅನ್ನು ನಮೂದಿಸಿ" ); return; } self.requestOnFlight( true ); dataAccessor.forgotPassword( self.userEmail(), function() { ToastUtil.toastUp( "ನಿಮ್ಮ ಇ-ಮೇಲ್ ಐಡಿಗೆ ಒಂದು ಮೇಲ್ ಕಳುಹಿಸಲಾಗಿರುತ್ತದೆ." ); self.triggerFacebookEvent('REQUESTPASSWORD_EMAIL_FORGOTP'); setTimeout( function() { window.location.href = getRetUrl( true ); }, 5000 ); } , function( error ) { var message = "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!"; if( error[ "email" ] != null ) message = error[ "email" ]; else if( error[ "message" ] != null ) message = error[ "message" ]; ToastUtil.toast( message, 2000, true ); } ); }; this.forgotPasswordButtonEnabled = ko.computed( function() { return self.userEmail() != null && self.userEmail().trim() != "" && ! self.requestOnFlight(); }, self ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.FORGOT_PASSWORD.ko_element ) { /* Clear All Fields */ self.userEmail( null ); /* Dispose all observers */ self.locationObserver.dispose(); return; } else { setTimeout(function() { MetaTagUtil.setMetaTagsForForgotPassword(); }); } appViewModel.currentLocation(); }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName, value, parentId) { switch (eventName) { case 'REQUESTPASSWORD_EMAIL_FORGOTP': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; case 'TYPELOGINFIELD_EMAIL_FORGOTP': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; case 'LANDED_FORGOTPM_FORGOTP': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; self.triggerFacebookEvent('LANDED_FORGOTPM_FORGOTP'); } , template: `<div class="pratilipi-login-container"><span class="sprites-icon pratilipi-logo-icon"></span><div class="pratilipi-heading material-title">ಪಾಸ್ವರ್ಡ್ ಮರೆತಿರುವಿರಾ?</div><div class="pratilipi-content-container"><p class="material-body-1" style="margin: 15px 0;">ದಯವಿಟ್ಟು ನೀವು ಸೈನ್ ಅಪ್ ಆಗಿರುವ ಇ-ಮೇಲ್ ವಿಳಾಸವನ್ನು ದಾಖಲಿಸಿ. ನಿಮ್ಮ ಪಾಸ್ವರ್ಡ್ ರೀಸೆಟ್ ಗೊಳಿಸಲು ನಾವು ನಿಮಗೆ ಒಂದು ಲಿಂಕ್ ಕಳುಹಿಸುತ್ತೇವೆ.</p><form id="reset_password_form" class="pratilipi-content-container margin-zero"><input type="email" data-bind="mdlFloatingInput: { label: 'ಇ-ಮೇಲ್', value: userEmail, id: 'pratilipi_forgot_password_page_user_email' }, valueUpdate: ['input']" /><button data-bind="{ click: forgotPassword, enable: forgotPasswordButtonEnabled }"type="submit"class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored pratilipi-red-button login-button">ಪಾಸ್ವರ್ಡ್ ರೀಸೆಟ್ ಮಾಡಿ</button><div data-bind="visible: requestOnFlight"class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; margin: auto;"></div><div class="member-login material-body-2"><a data-bind="attr: { href: '/login?retUrl=' + getRetUrl() }" class="pratilipi-blue">ಸೈನ್ ಇನ್ ಆಗಲು</a></div></form></div></div>` }); </script> <script> ko.components.register( 'pratilipi-reader-read-in-app-helper', { viewModel: function(params) { var self = this; var gaComponentName = "ReadInAppHelper"; var readInAppHelper = $("#reader-read-in-app-helper"); var readInAppTs = "readInAppTimeStamp"; var initialised = false; self.pratilipi = params.pratilipi; var initAppBanner = function() { if (shouldShowReadHelper()) self.triggerFacebookEvent('VIEWANDROID_OPENAPP_READER'); if (initialised) return; readInAppHelper.show(); initialised = true; ga_CA(gaComponentName, 'show'); }; self.closeBanner = function() { ga_CA(gaComponentName, 'close'); readInAppHelper.hide(); setCookie(readInAppTs, new Date().getTime(), 10, '/'); self.triggerFacebookEvent('DISMISS_OPENAPP_READER'); }; self.downloadApp = function() { ga_CA(gaComponentName, 'click'); readInAppHelper.hide(); setCookie(readInAppTs, new Date().getTime(), 10, '/'); self.triggerFacebookEvent('GETANDROID_OPENAPP_READER'); openInNewTab(getAndroidIntentUri({ 'utm_source': 'web_reader', 'utm_medium': gaComponentName })); }; this.triggerFacebookEvent = function (eventName) { switch (eventName) { case 'DISMISS_OPENAPP_READER': FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('DISMISS_OPENAPP_READER', self.pratilipi ); break; case 'GETANDROID_OPENAPP_READER': FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('GETANDROID_OPENAPP_READER', self.pratilipi ); break; case 'VIEWANDROID_OPENAPP_READER': FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('VIEWANDROID_OPENAPP_READER', self.pratilipi ); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.locationObserver = ko.computed( function() { appViewModel.currentLocation(); if( appViewModel.currentView() != LOCATION.READER.ko_element ) { self.locationObserver.dispose(); } setTimeout(function() { initAppBanner(); }); }, this); } , template: `<div class="reader-read-in-app-helper" id="reader-read-in-app-helper"><div class="download-in-app-helper"><button class="read-in-app-close" data-bind="click: closeBanner"><i class="material-icons">close</i></button><p class="read-in-app-text" data-bind="click: downloadApp">ಅಪ್ಲಿಕೇಶನ್ನಿನಲ್ಲಿ ಓದಿರಿ</p></div></div>` }); </script> <script> ko.components.register( 'pratilipi-image', { viewModel: function( params ) { var self = this; this.src = typeof( params.src ) == "string" ? ko.observable( params.src ) : params.src; this.width = params.width; this.mobWidth = params.mobWidth != null ? params.mobWidth : self.width; this.height = params.height != null ? params.height : params.width; this.mobHeight = params.mobHeight != null ? params.mobHeight : self.height; this.imageCircle = params.imageCircle != null ? params.imageCircle : false; this.alt = params.alt != null ? params.alt : "ಪ್ರತಿಲಿಪಿ"; this.isSmallImageLoaded = ko.observable(); this.isLargeImageLoaded = ko.observable(); this._onSmallImageLoad = function() { self.isSmallImageLoaded( true ); }; this._onLargeImageLoad = function() { self.isLargeImageLoaded( true ); }; this.wt = ko.observable(); this.ht = ko.observable(); this.setDimension = function() { self.wt( $(window).width() < 480 ? self.mobWidth : self.width ); self.ht( $(window).width() < 480 ? self.mobHeight : self.height ); }; /* Hack for mozilla - setTimeout executes after image is loaded. need to call this method only after first time */ var firstTime = true; this.srcObserver = ko.computed( function() { if( self.src() == null ) return; if( firstTime ) { firstTime = false; return; } setTimeout( function() { self.isSmallImageLoaded( false ); self.isLargeImageLoaded( false ); }, 0 ); }, this ); self.setDimension(); $(window).on( 'resize', function() { self.setDimension(); } ); } , template: `<div class="pratilipi-image" data-bind="style: { 'width': wt() + 'px', 'height': ht() + 'px', 'borderRadius': imageCircle ? '999px' : '0' }"><img class="img-small" data-bind="attr: { 'src': getImageUrl( src(), wt(), true ) },event: { load: _onSmallImageLoad }, css: { 'loaded': isSmallImageLoaded() }"><!-- ko if: isSmallImageLoaded() --><img class="img-large" data-bind="lazyload: getImageUrl( src(), wt(), false ),event: { load: _onLargeImageLoad }, css: { 'loaded': isLargeImageLoaded() }, attr: { 'alt': alt }"><!-- /ko --></div>` }); </script> <script> ko.components.register( 'pratilipi-reader-footer', { viewModel: function( params ) { var self = this; this.pratilipi = params.pratilipi; this.userPratilipi = params.userPratilipi; this.openSettings = params.openSettings; this.switchLibraryState = params.switchLibraryState; this.sharePratilipi = params.sharePratilipi; this.canOpenNavigationModal = params.canOpenNavigationModal; this.openNavigationModal = params.openNavigationModal; } , template: `<div class="pratilipi-reader-footer"><div class="menu-option-holder"><div class="menu-option"><button class="mdl-button mdl-js-button mdl-button--icon" data-bind="click: openNavigationModal, enable: canOpenNavigationModal"><i class="material-icons">list</i></button></div><div class="menu-option"><button onclick="ga_CA( 'Pratilipi', 'Settings' );" class="mdl-button mdl-js-button mdl-button--icon" data-bind="click: openSettings"><i class="material-icons">settings</i></button></div><div class="menu-option"><button onclick="ga_CA( 'Pratilipi', 'AddToLibrary' );" class="mdl-button mdl-js-button mdl-button--icon" data-bind="click: switchLibraryState,disable: pratilipi.state() != 'PUBLISHED' || pratilipi.author.authorId() == appViewModel.user.author.authorId()"><i data-bind="css: { 'pratilipi-red': userPratilipi.addedToLib() }" class="material-icons">bookmark</i></button></div><div class="menu-option"><button onclick="ga_CA( 'Pratilipi', 'Share' );" class="mdl-button mdl-js-button mdl-button--icon" data-bind="click: sharePratilipi"><i class="material-icons">share</i></button></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-search-trends', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); this.keywordList = ko.observableArray(); this.isLoading = ko.observable( false ); this.keywordClicked = function( vm, e ) { var keyword = $( e.currentTarget ).attr( 'data-val' ); var index = $( e.currentTarget ).attr( 'data-index' ); ga_CAV( "Search", "TrendingSearch", index ); appViewModel.searchQuery( keyword ); self.triggerFacebookEvent('SEARCH_TRENDSEARCH_SEARCH', keyword); }; this.fetchSearchTrends = function() { Array.prototype.clean = function( deleteValue ) { for( var i = 0; i < this.length; i++ ) { if( this[i] == deleteValue ) { this.splice(i, 1); i--; } } return this; }; self.isLoading( true ); dataAccessor.getTrendingSearchKeywords( function( response ) { if( response == null || isEmpty( response ) ) { return; } var keywordList = response.trending_keywords.clean( undefined ); self.keywordList( keywordList ); self.isLoading( false ); }); }; this.fetchSearchTrends(); /** * Facebook events */ this.triggerFacebookEvent = function(eventName, value) { switch (eventName) { case 'SEARCH_TRENDSEARCH_SEARCH': FacebookEventTriggerUtil.triggerFacebookEventByNameAndValue(eventName, value); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; } , template: `<div class="pratilipi-search-trends"><div class="pratilipi-red material-subtitle-1">ಟ್ರೆಂಡಿಂಗ್</div><div data-bind="visible: isLoading()"style="margin: 12px auto;"class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></div><div class="hashtags" data-bind="visible: ! isLoading() && keywordList().length > 0, foreach: { data: keywordList, as: 'keyword' }"><a href="#" class="hashtag" data-bind="{ text: '#' + keyword,click: $parent.keywordClicked,attr: { 'id': 'js-search-trend-' + $index(), 'data-val': keyword, 'data-index': $index() } }"></a></div></div>` }); </script> <script> ko.components.register( 'pratilipi-pratilipi-card-v2', { viewModel: function( params ) { var self = this; this.pratilipi = params.pratilipi; this.openPratilipi = function( vm ) { self.triggerFacebookEvent('CLICKBOOK'); if( this.pratilipi.meta.recommendationType() ) { /* ga_CAV( 'Pratilipi', 'OpenRecommendation-' + this.pratilipi.meta.recommendationType(), vm.pratilipi.ga_index() ); */ ga_CAV( "RECOMMENDBOOK", "CLICK", vm.pratilipi.ga_index() ); } else{ ga_CA( 'Pratilipi', 'Open' ); } return true; }; this.cardSummary = ko.computed( function() { return ( self.pratilipi.cardSummary && self.pratilipi.cardSummary().trim() != "" ) ? self.pratilipi.cardSummary().trim() : null; }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName) { switch (eventName) { case 'CLICKBOOK': if (getLocation().fb_screen_name === 'USER') { FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId('CLICKBOOK_PUBLISHED_USER', self.pratilipi, self.pratilipi.author.authorId() ); } else if (getLocation().fb_screen_name === 'MYPROFILE') { FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId('CLICKBOOK_PUBLISHED_MYPROFILE', self.pratilipi, self.pratilipi.author.authorId() ); } else if (getLocation().fb_screen_name === 'EVENT') { FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId('CLICKBOOK_EVENTRIES_EVENT', self.pratilipi, self.pratilipi.author.authorId() ); } else if (getLocation().fb_screen_name === 'HOME') { FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId('CLICKBOOK_COLLECTIONS_HOME', self.pratilipi, self.pratilipi.author.authorId() ); } else if (getLocation().fb_screen_name === 'LIBRARY') { FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId('READBOOK_LIBRARYM_LIBRARY', self.pratilipi, self.pratilipi.author.authorId() ); } else if (getLocation().fb_screen_name === 'CATEGORY') { FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId('CLICKBOOK_CATEGORYM_CATEGORY', self.pratilipi, self.pratilipi.author.authorId() ); } else if (getLocation().fb_screen_name === 'BOOK') { FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiParentIdAndRecommendationMeta('CLICKBOOK_RECOMMENDBOOK_BOOK', self.pratilipi, self.pratilipi.author.authorId(), { 'UI_POSITION': self.pratilipi.ga_index(), 'ALGORITHM_ID': self.pratilipi.meta.algorithmId(), 'UI_TYPE': self.pratilipi.meta.recommendationType() }); } else if (getLocation().fb_screen_name === 'READER') { FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiParentIdAndRecommendationMeta('CLICKBOOK_RECOMMENDBOOK_READER', self.pratilipi, self.pratilipi.author.authorId(), { 'UI_POSITION': self.pratilipi.ga_index(), 'ALGORITHM_ID': self.pratilipi.meta.algorithmId(), 'UI_TYPE': self.pratilipi.meta.recommendationType() }); } break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; } , template: `<a class="pratilipi-pratilipi-card-v2" data-bind="attr: { href: pratilipi.readPageUrl() }, event: { click: openPratilipi }"><div class="reco-container" data-bind="{ css: { 'shadow-with-summary': (cardSummary() != null), 'shadow-without-summary': (cardSummary() == null) },style: {'background-image': 'url(' + getImageUrl( pratilipi.coverImageUrl(), 500, false ) + ')','background-repeat': 'no-repeat','background-size': 'cover','background-position': 'center center','color': 'white' }}"><div data-bind="text: pratilipi.displayTitle()" class="pratilipi-title material-title"></div><div class="info-container" style="top: 40px;"><div class="reads-holder" data-bind="visible: pratilipi.averageRating() > 0"><i class="material-icons font-xs" style="margin-left: 2px; width: 20px">star_rate</i><span class="font-xs" data-bind="text: roundOffToOneDecimal( pratilipi.averageRating() )"></span></div><div class="reads-holder" data-bind="visible: pratilipi.readCount() > 0"><i class="material-icons font-xs" style="margin-left: 2px; width: 20px">remove_red_eye</i><span class="font-xs" data-bind="text: abbrNum( pratilipi.readCount(), 0 )"></span></div></div><!-- Refer _font-styles.ftl for ftl variables --><!-- ko if: ( cardSummary() != null ) --><div class="summary material-body-1 height-92-px" data-bind="text: cardSummary()"></div><!-- /ko --><!--<div style="bottom: 0;height: 4em;background: linear-gradient(rgba(0, 0, 0, 0) 0%,rgba(0, 0, 0, 1) 100%);position: absolute;width: 100%;"></div>--></div></a>` }); </script> <script> ko.components.register( 'pratilipi-pratilipi-card-mini', { viewModel: function( params ) { var self = this; this.pratilipi = params.pratilipi; this.openPratilipi = function( vm ) { self.triggerFacebookEvent('CLICKBOOK'); if( this.pratilipi.meta.recommendationType() ) { ga_CAV( 'Pratilipi', 'OpenRecommendation-' + this.pratilipi.meta.recommendationType(), vm.pratilipi.ga_index() ); } else{ ga_CA( 'Pratilipi', 'Open' ); } return true; }; this.titleDisplay = ko.computed( function() { return self.pratilipi.displayTitle ? self.pratilipi.displayTitle() : self.pratilipi.title(); }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName) { switch (eventName) { case 'CLICKBOOK': if (getLocation().fb_screen_name === 'USER') { FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId('CLICKBOOK_PUBLISHED_USER', self.pratilipi, self.pratilipi.author.authorId() ); } else if (getLocation().fb_screen_name === 'MYPROFILE') { FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId('CLICKBOOK_PUBLISHED_MYPROFILE', self.pratilipi, self.pratilipi.author.authorId() ); } else if (getLocation().fb_screen_name === 'EVENT') { FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId('CLICKBOOK_EVENTRIES_EVENT', self.pratilipi, self.pratilipi.author.authorId() ); } else if (getLocation().fb_screen_name === 'HOME') { FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId('CLICKBOOK_COLLECTIONS_HOME', self.pratilipi, self.pratilipi.author.authorId() ); } else if (getLocation().fb_screen_name === 'LIBRARY') { FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId('READBOOK_LIBRARYM_LIBRARY', self.pratilipi, self.pratilipi.author.authorId() ); } else if (getLocation().fb_screen_name === 'CATEGORY') { FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId('CLICKBOOK_CATEGORYM_CATEGORY', self.pratilipi, self.pratilipi.author.authorId() ); } else if (getLocation().fb_screen_name === 'BOOK') { FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiParentIdAndRecommendationMeta('CLICKBOOK_RECOMMENDBOOK_BOOK', self.pratilipi, self.pratilipi.author.authorId(), { 'UI_POSITION': self.pratilipi.ga_index(), 'ALGORITHM_ID': self.pratilipi.meta.algorithmId(), 'UI_TYPE': self.pratilipi.meta.recommendationType() }); } else if (getLocation().fb_screen_name === 'READER') { FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiParentIdAndRecommendationMeta('CLICKBOOK_RECOMMENDBOOK_READER', self.pratilipi, self.pratilipi.author.authorId(), { 'UI_POSITION': self.pratilipi.ga_index(), 'ALGORITHM_ID': self.pratilipi.meta.algorithmId(), 'UI_TYPE': self.pratilipi.meta.recommendationType() }); } break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; } , template: `<div class="pratilipi-pratilipi-card-mini"><a data-bind="attr: { href: pratilipi.pageUrl() }, event: { click: openPratilipi }"><div class="pratilipi-cover-image-holder"><pratilipi-image params="{ src: pratilipi.coverImageUrl,width: 100,height: 150,alt: titleDisplay(),mobWidth: 70,mobHeight: 105 }"></pratilipi-image></div><div class="pratilipi-meta-holder"><div class="pratilipi-title font-m" data-bind="text: titleDisplay()"></div><div class="reads-holder" data-bind="visible: pratilipi.readCount() > 0"><span class="font-xs" data-bind="text: abbrNum( pratilipi.readCount(), 0 )"></span><i class="material-icons font-xs" style="margin-left: 2px;">remove_red_eye</i></div></div></a></div>` }); </script> <script> ko.components.register( 'pratilipi-author-info', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); /* Setting Local Variables */ this.author = params.author; this.userAuthor = params.userAuthor; this.updateAuthor = params.updateAuthor; this.updateUserAuthor = params.updateUserAuthor; this.showMessageButton = ko.observable(false); this.authorDisplayName = ko.computed( function() { return self.author.fullName() != null ? self.author.fullName() : self.author.fullNameEn(); }, this ); /* Follow/Unfollow Author */ this.followRequestOnFlight = ko.observable( false ); this.followOrUnfollowAuthor = function() { if( appViewModel.user.isGuest() ) { self.triggerFacebookEvent('FOLLOW_USERM_USER'); goToLoginPage( null, { "message": "FOLLOW" } ); return; } if( self.followRequestOnFlight() ) return; self.followRequestOnFlight( true ); ToastUtil.toast( "ಯಶಸ್ವಿ!" ); var switchState = function() { self.updateAuthor( { "followCount": self.userAuthor.following() ? self.author.followCount() - 1 : self.author.followCount() + 1 } ); self.updateUserAuthor( { "following": ! self.userAuthor.following() } ); }; if (self.userAuthor.following()) { self.triggerFacebookEvent('UNFOLLOW_USERM_USER'); } else { self.triggerFacebookEvent('FOLLOW_USERM_USER'); } switchState(); dataAccessor.followOrUnfollowAuthor( self.author.authorId(), self.userAuthor.following(), function( userAuthor ) { self.followRequestOnFlight( false ); ga_CA( 'Author', userAuthor.following ? 'Follow' : 'UnFollow' ); }, function( error ) { self.followRequestOnFlight( false ); switchState(); ToastUtil.toast( error[ "message" ] != null ? error[ "message" ] : "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!", 3000, true ); }); }; /* Can Follow and Settings Link */ this.canFollow = ko.observable( false ); this.settingsLink = ko.observable( "/settings" ); this.shouldShowMessageButton = function() { debugger; if (self.author.user == undefined || self.author.user.userId == undefined || self.author.user.userId() == undefined ) { return false; } else if (appViewModel.user.userId() == self.author.user.userId()) { return false; } else { return true; } }; this.authorObserver = ko.computed( function() { self.showMessageButton( self.shouldShowMessageButton() ); if( self.author.authorId() == null && self.author.user.userId() == null ) return; /* self.author.user.userId() => null for fictional Authors */ self.canFollow( appViewModel.user.userId() != self.author.user.userId() ); if( self.author.hasAccessToUpdate() && appViewModel.user.userId() != self.author.user.userId() ) /* AEEs */ self.settingsLink( "/settings?authorId=" + self.author.authorId() + "&userId=" + self.author.user.userId() ); else self.settingsLink( "/settings" ); }, this ); /* Share Author */ this.shareAuthor = function() { if (getLocation().fb_screen_name === 'USER') { ShareUtil.shareAuthor( self.author, null, null, 'USERM_USER' ); } else if (getLocation().fb_screen_name === 'MYPROFILE') { ShareUtil.shareAuthor( self.author, null, null, 'MYPROFILEM_MYPROFILE' ); } else { ShareUtil.shareAuthor( self.author ); } ga_CA( appViewModel.isUserPage() ? 'User' : 'Author', 'Share' ); self.triggerFacebookEvent('CLICKSHRUSER'); }; /* Image Upload */ this.imageUploaded = ko.observable( false ); this.chooseImageFile = function() { document.getElementById( 'uploadAuthorImageInput' ).value= null; document.getElementById( "uploadAuthorImageInput" ).click(); }; this.uploadAuthorImage = function( vm, evt ) { var files = evt.target.files; var file = files[0]; self.imageUploaded( true ); document.getElementById( "uploadAuthorImageForm" ).submit(); if (self.author.imageUrl().endsWith('author/image')) { self.triggerFacebookEvent('NEWUSERINFO_PROFILEPIC_MYPROFILE'); } else { self.triggerFacebookEvent('UPDATEUSERINFO_PROFILEPIC_MYPROFILE'); } }; this.iframeLoaded = function( vm, evt ) { if( ! self.imageUploaded() ) return; var response = JSON.parse( evt.currentTarget.contentDocument.body.innerText ); if( response[ "coverImageUrl" ] != null ) { /* Success Callback */ self.updateAuthor( { "profileImageUrl": response[ "coverImageUrl" ] } ); self.author.imageUrl(response[ "coverImageUrl" ]); ToastUtil.toast( "ಯಶಸ್ವಿ!", 3000 ); } else if( response[ "message" ] != null ) { ToastUtil.toast( response[ "message" ], 3000 ); } self.imageUploaded( false ); }; /* Cover Upload */ this.coverUploaded = ko.observable( false ); this.chooseCoverFile = function() { document.getElementById( 'uploadAuthorCoverInput' ).value= null; document.getElementById( "uploadAuthorCoverInput" ).click(); }; this.uploadAuthorCover = function( vm, evt ) { var files = evt.target.files; var file = files[0]; self.coverUploaded( true ); document.getElementById( "uploadAuthorCoverForm" ).submit(); if (self.author.coverImageUrl().endsWith('author/cover')) { self.triggerFacebookEvent('NEWUSERINFO_COVERPIC_MYPROFILE'); } else { self.triggerFacebookEvent('UPDATEUSERINFO_COVERPIC_MYPROFILE'); } }; this.coverIframeLoaded = function( vm, evt ) { if( ! self.coverUploaded() ) return; var response = JSON.parse( evt.currentTarget.contentDocument.body.innerText ); if( response[ "coverImageUrl" ] != null ) { /* Success Callback */ self.updateAuthor( { "coverImageUrl": response[ "coverImageUrl" ] } ); self.author.coverImageUrl(response[ "coverImageUrl" ]); ToastUtil.toast( "ಯಶಸ್ವಿ!", 3000 ); } else if( response[ "message" ] != null ) { ToastUtil.toast( response[ "message" ], 3000 ); } self.coverUploaded( false ); }; this.getReadCountText = ko.computed( function() { return "$read_count ಜನರಿಂದ ಓದಲ್ಪಟ್ಟಿದ್ದಾರೆ".replace( "$read_count", formatReadCount( self.author.totalReadCount() ) ); }, this ); /* UI Helpers */ this.focusPublishedContentSection = function() { var targetDiv = $( '.js-pratilipi-author-info' ); appViewModel.scrollToTop( $( ".js-author-published-contents" ).position().top + $( ".js-pratilipi-header" ).height() ); self.triggerFacebookEvent('CLICKSTATS', 'PUBLISHED'); }; /** * Facebook events */ this.triggerFacebookEvent = function(eventName, value) { switch (eventName) { case 'CLICKSHRUSER': if (getLocation().fb_screen_name === 'USER') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndParentId('CLICKSHRUSER_USERM_USER', self.author.authorId() ); } else if (getLocation().fb_screen_name === 'MYPROFILE') { FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue('CLICKSHRUSER_MYPROFILEM_MYPROFILE', self.author.authorId(), value ); } break; case 'CLICKSTATS': if (getLocation().fb_screen_name === 'USER') { FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue('CLICKSTATS_USERM_USER', self.author.authorId(), value ); } else if (getLocation().fb_screen_name === 'MYPROFILE') { FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue('CLICKSTATS_MYPROFILEM_MYPROFILE', self.author.authorId(), value ); } break; case 'FOLLOW_USERM_USER': case 'UNFOLLOW_USERM_USER': FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue(eventName, self.author.authorId(), self.author.followCount() ); break; case 'CLICKSETTINGS_MYPROFILEM_MYPROFILE': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; case 'LANDED': if (getLocation().fb_screen_name === 'MYPROFILE') { FacebookEventTriggerUtil.triggerFacebookEventByName('LANDED_MYPROFILEM_MYPROFILE'); } else if (getLocation().fb_screen_name === 'USER') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndParentId('LANDED_USERM_USER', self.author.authorId()); } break; case 'NEWUSERINFO_PROFILEPIC_MYPROFILE': case 'UPDATEUSERINFO_PROFILEPIC_MYPROFILE': case 'NEWUSERINFO_COVERPIC_MYPROFILE': case 'UPDATEUSERINFO_COVERPIC_MYPROFILE': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; case 'LANDED_FOLLOWERS': if (getLocation().fb_screen_name === 'USER') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndParentId('LANDED_FOLLOWERS_USER', self.author.authorId() ); } else if (getLocation().fb_screen_name === 'MYPROFILE') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndParentId('LANDED_FOLLOWERS_MYPROFILE', self.author.authorId() ); } break; case 'LANDED_FOLLOWINGS': if (getLocation().fb_screen_name === 'USER') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndParentId('LANDED_FOLLOWINGS_USER', self.author.authorId() ); } else if (getLocation().fb_screen_name === 'MYPROFILE') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndParentId('LANDED_FOLLOWINGS_MYPROFILE', self.author.authorId() ); } break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.triggerStatsClickEvent = function(value) { self.triggerFacebookEvent('CLICKSTATS', value); return true; }; this.triggerSettingsClickEvent = function() { self.triggerFacebookEvent('CLICKSETTINGS_MYPROFILEM_MYPROFILE'); return true; }; self.triggerFacebookEvent('LANDED'); $('#pratilipi-author-follows-followers').on('shown.bs.modal', function() { self.triggerFacebookEvent('LANDED_FOLLOWERS'); }); $('#pratilipi-author-follows-following').on('shown.bs.modal', function() { self.triggerFacebookEvent('LANDED_FOLLOWINGS'); }); this.redirectToMessages = function() { debugger; if(appViewModel.p2p2pChat == undefined) { appViewModel.p2pChat = {}; } appViewModel.p2pChat.sourcePagePath = window.location.pathname; console.log("Other User details. User Id ", self.userAuthor.user.userId(), " User Display Name : ", self.userAuthor.displayName()," User Profile Url : ", self.userAuthor.imageUrl()); var redirectUrl = "messages/" + self.userAuthor.user.userId(); if(appViewModel.p2pChat == undefined) { appViewModel.p2pChat = {}; } appViewModel.p2pChat.userDetails = {userId : self.userAuthor.user.userId(), displayName : self.userAuthor.displayName(), profileImageUrl : self.userAuthor.imageUrl(), profileUrl : self.userAuthor.pageUrl()}; redirect(redirectUrl); }; } , template: `<div class="pratilipi-author-info js-pratilipi-author-info mdl-card mdl-card-border mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><div class="author-cover-image-holder"><div class="author-cover-image"data-bind="attr: { 'alt': authorDisplayName() },css: { 'image-loading': coverUploaded() },style: { backgroundImage: 'url(' + author.coverImageUrl() + ')' }"></div><div data-bind="visible: coverUploaded()" class="cover-spinner-container"><span class="image-uploaded-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div><button onclick="ga_CA( 'User', 'UserCoverImageChange' )"class="upload-cover-button mdl-button mdl-js-button mdl-button--fab"data-bind="{ click: chooseCoverFile,visible: author.hasAccessToUpdate() && ! coverUploaded() }"><i class="material-icons">camera_alt</i></button><form id="uploadAuthorCoverForm"style="position: absolute; top: -1000px;"method="post"enctype="multipart/form-data"data-bind="{ attr: { 'action': '/api/author/cover?authorId=' + author.authorId() }, uniqueName: true }"target="author_cover_upload_target"><input id="uploadAuthorCoverInput"data-bind="{ event: { change: uploadAuthorCover }, uniqueName: true }"type="file"accept="image/*"></form><iframe id="author_cover_upload_target"name="author_cover_upload_target"style="display: none;"data-bind="event: { load: coverIframeLoaded }"></iframe></div><div class="author-meta-holder"><div class="author-profile-image-holder"><img class="author-profile-image"data-bind="attr: { 'src': getImageUrl( author.profileImageUrl(), 200 ), 'alt': authorDisplayName() },css: { 'image-loading': imageUploaded() }" /><div data-bind="visible: imageUploaded()" class="spinner-container"><span class="image-uploaded-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div><button onclick="ga_CA( 'User', 'UserProfileImageChange' )"class="upload-image-button mdl-button mdl-js-button mdl-button--fab"data-bind="{ click: chooseImageFile,visible: author.hasAccessToUpdate() && ! imageUploaded() }"><i class="material-icons">camera_alt</i></button><form id="uploadAuthorImageForm"style="position: absolute; top: -1000px;"method="post"enctype="multipart/form-data"data-bind="{ attr: { 'action': '/api/author/image?authorId=' + author.authorId() }, uniqueName: true }"target="author_upload_target"><input id="uploadAuthorImageInput"data-bind="{ event: { change: uploadAuthorImage }, uniqueName: true }"type="file"accept="image/*"></form><iframe id="author_upload_target"name="author_upload_target"style="display: none;"data-bind="event: { load: iframeLoaded }"></iframe></div><div class="author-meta"><div class="first-line"><div class="author-name-desktop material-heading" data-bind="text: authorDisplayName()"></div><div class="pull-right"><!-- ko if: showMessageButton --><a data-bind="click: function() { redirectToMessages(); }" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin small-button"><i class="material-icons">message</i></a><!-- /ko --><button data-bind="{ text: userAuthor.following() ? 'ಈಗಾಗಲೇ ಹಿಂಬಾಲಿಸುತ್ತಿದ್ದೀರಿ' : 'ಹಿಂಬಾಲಿಸಿ',click: followOrUnfollowAuthor,visible: canFollow(),disable: followRequestOnFlight() }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin font-m"></button><a onclick="ga_CA( 'User', 'Settings' )"data-bind="visible: author.hasAccessToUpdate(), attr: { 'href': settingsLink() }, click: triggerSettingsClickEvent"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin small-button"><i class="material-icons material-icons-16">settings</i></a><!-- GA events sent from Js for sharing --><button data-bind="click: shareAuthor"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin small-button"><i class="material-icons material-icons-16">share</i></button></div></div><div class="author-summary-desktop"><div class="author-read-count material-subtitle-1"data-bind="{ visible: author.totalReadCount() > 0, text: getReadCountText(), css: { 'pratilipi-red': appViewModel.user.author.authorId() == author.authorId() } }"></div><div class="author-summary material-subtitle-1" onclick="ga_CA( 'Author', 'LoadMore' )" data-bind="seeMoreText: { value: author.summary(), lines: 1 }"></div></div></div></div><div class="author-meta-holder-mobile"><div class="author-name-mobile material-heading" data-bind="text: authorDisplayName()"></div><div class="author-read-count material-subtitle-1"data-bind="{ visible: author.totalReadCount() > 0, text: getReadCountText(), css: { 'pratilipi-red': appViewModel.user.author.authorId() == author.authorId() } }"></div><div class="author-summary material-subtitle-1" onclick="ga_CA( 'Author', 'LoadMore' )" data-bind="seeMoreText: { value: author.summary(), lines: 1 }"></div></div><div class="mdl-cell mdl-cell--12-col padding-zero"><hr class="margin-zero"></div><div class="author-stats-holder"><div class="mdl-cell mdl-cell--4-col"data-bind="css: { 'clickable-element': author.contentPublished() > 0 }, click: focusPublishedContentSection"><div class="material-subtitle-1" data-bind="text: author.contentPublished()"></div><div class="material-body-1">ಪ್ರಕಟಿತ</div></div><div class="mdl-cell mdl-cell--4-col"data-bind="attr: { 'data-toggle': author.followCount() > 0 ? 'modal' : '' }, css: { 'clickable-element': author.followCount() > 0 }, click: triggerStatsClickEvent.bind(this, 'FOLLOWERS')"data-target="#pratilipi-author-follows-followers"><div class="material-subtitle-1" data-bind="text: author.followCount()"></div><div class="material-body-1">ಹಿಂಬಾಲಕರು</div></div><div class="mdl-cell mdl-cell--4-col clickable-element"data-bind="attr: { 'data-toggle': author.user.followCount() > 0 ? 'modal' : '' }, css: { 'clickable-element': author.user.followCount() > 0 }, click: triggerStatsClickEvent.bind(this, 'FOLLOWING')"data-target="#pratilipi-author-follows-following"><div class="material-subtitle-1" data-bind="text: author.user.followCount()"></div><div class="material-body-1">ಹಿಂಬಾಲಿಸುತ್ತಿರುವಿರಿ</div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-navigation-aside', { viewModel: function() { var self = this; this.highLightNavigationEntry = function() { $( ".js-navigation-aside a" ).each( function( index, element ) { $( element ).css( "font-weight", "400" ); if( window.location.pathname == "/search" ) { if( $( element ).attr( 'href' ) == "/search?q=" + appViewModel.searchQuery() ) $( element ).css( "font-weight", "700" ); } else if( $( element ).attr( 'href' ) == window.location.pathname ) { $( element ).css( "font-weight", "700" ); } }); }; this.navigationObserver = ko.computed( function() { appViewModel.searchQuery(); appViewModel.currentLocation(); setTimeout( function() { self.highLightNavigationEntry(); }, 0 ); }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName, value) { switch (eventName) { case 'CLICKCATEGORY_TOPICS_GLOBAL': FacebookEventTriggerUtil.triggerFacebookEventByNameAndValue(eventName, value); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.triggerGoCategoryEvent = function(categoryLink) { self.triggerFacebookEvent('CLICKCATEGORY_TOPICS_GLOBAL', categoryLink); return true; }; } , template: `<div class="pratilipi-navigation-aside js-navigation-aside"><h6 class="pratilipi-red font-l">ಪ್ರಭೇದಗಳು</h6><a onclick="ga_CA( 'Navigation-romance', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಪ್ರೀತಿ')" href="/love">ಪ್ರೀತಿ</a><a onclick="ga_CA( 'Navigation-horror', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಹಾರರ್')" href="/horror">ಹಾರರ್</a><a onclick="ga_CA( 'Navigation-satire', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಹಾಸ್ಯ')" href="/comedy">ಹಾಸ್ಯ</a><a onclick="ga_CA( 'Navigation-family', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಬಂಧುತ್ವ')" href="/relationship">ಬಂಧುತ್ವ</a><a onclick="ga_CA( 'Navigation-women', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಮಹಿಳೆ')" href="/women">ಮಹಿಳೆ</a><a onclick="ga_CA( 'Navigation-serials', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಧಾರಾವಾಹಿ')" href="/dhaaraavaahi">ಧಾರಾವಾಹಿ</a><a onclick="ga_CA( 'Navigation-articles', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಲೇಖನಗಳು')" href="/nonfiction">ಲೇಖನಗಳು</a><a onclick="ga_CA( 'Navigation-poetry', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಕವಿತೆಗಳು')" href="/poems">ಕವಿತೆಗಳು</a><a onclick="ga_CA( 'Navigation-social', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಸಮಾಜ')" href="/society">ಸಮಾಜ</a><a onclick="ga_CA( 'Navigation-educational', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ವಿಜ್ಞಾನ')" href="/science">ವಿಜ್ಞಾನ</a><a onclick="ga_CA( 'Navigation-life', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಜೀವನ')" href="/life">ಜೀವನ</a><a onclick="ga_CA( 'Navigation-cinema', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಸಿನಿಮಾ')" href="/cinema">ಸಿನಿಮಾ</a><a onclick="ga_CA( 'Navigation-inspirational', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಸ್ಫೂರ್ತಿದಾಯಕ')" href="/inspirational">ಸ್ಫೂರ್ತಿದಾಯಕ</a><a onclick="ga_CA( 'Navigation-other-stories', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಕಥೆಗಳು')" href="/otherstories">ಕಥೆಗಳು</a><a onclick="ga_CA( 'Navigation-books', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಸಮಗ್ರ')" href="/books">ಸಮಗ್ರ</a><h6 class="pratilipi-red font-l">ಪ್ರಖ್ಯಾತ ಬರಹಗಳು</h6><a onclick="ga_CA( 'Navigation-event-comedy', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ನಗು ನಗುತಾ ನಲೀ ನಲಿ...')" href="/event/ನಗು-ನಗುತಾ-ನಲೀ-ನಲಿ-ic59tqb4yv">ನಗು ನಗುತಾ ನಲೀ ನಲಿ...</a><a onclick="ga_CA( 'Navigation-most-read', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಓದುಗರ ಆಯ್ಕೆ')" href="/most-read">ಓದುಗರ ಆಯ್ಕೆ</a><a onclick="ga_CA( 'Navigation-newly-published', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಹೊಸ ಬರಹಗಳು')" href="/newcontents">ಹೊಸ ಬರಹಗಳು</a><a onclick="ga_CA( 'Navigation-classics', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ವಚನಗಳು')" href="/classic-sahitya">ವಚನಗಳು</a><a onclick="ga_CA( 'Navigation-online-events', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಸ್ಪರ್ಧೆಗಳು')" href="/event">ಸ್ಪರ್ಧೆಗಳು</a><a onclick="ga_CA( 'Navigation-blogs', 'Open' )" class="font-s" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಬ್ಲಾಗ್'ಗಳು')" href="/blog">ಬ್ಲಾಗ್'ಗಳು</a></div>` }); </script> <script> ko.components.register( 'pratilipi-pagenotfound-page', { viewModel: function() {} , template: `<div class="page-notfound-page mdl-card mdl-card-border mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><div class="left-col"><div style="width: 200px; height: 200px; margin: auto;" class="page-not-found-icon"></div></div><div class="right-col"><div class="material-title">ಪುಟ ಸಿಗಲಿಲ್ಲ!</div><br/><a href="/" class="material-subtitle-1" style="margin: 16px 0; color: inherit;">ಕ್ಷಮಿಸಿ, ನೀವು ತಪ್ಪಾದ ಪುಟಕ್ಕೆ ಬಂದಿರುವಿರಿ! ಇಲ್ಲಿ ಕ್ಲಿಕ್ ಮಾಡುವ ಮೂಲಕ ನೀವು ಏಕೆ ನಿಮ್ಮ ಮೆಚ್ಚಿನ ಕಥೆಗಳನ್ನು ಹುಡುಕಬಾರದು</a><br/><br/><a class="material-subtitle-1" href="/"><i class="material-icons" style="float: left;">home</i><span>ಹೋಮ್</span></a></div></div>` }); </script> <script> ko.components.register( 'pratilipi-review-list', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); /* Params */ this.pratilipi = params.pratilipi; this.userPratilipi = params.userPratilipi; this.updatePratilipi = params.updatePratilipi; this.updateUserPratilipi = params.updateUserPratilipi; /* Constants */ var firstLoadReviewCount = 5; var subsequentLoadReviewCount = 10; /* ReviewList and LoadingState */ this.reviewList = ko.observableArray(); this.totalReviewCount = ko.observable(); var cursor = null; /* * 4 Possible values for 'loadingState' * LOADING * LOADED_EMPTY * LOADED * FAILED * * */ this.loadingState = ko.observable(); /* Booleans */ this.addOrDeleteReviewRequestOnFlight = ko.observable( false ); /* User Inputs */ this.ratingInput = ko.observable(); this.reviewInput = ko.observable(); var originalReview = self.userPratilipi.review(); var originalRating = self.userPratilipi.rating(); /* Functions */ /* Review List */ this.addToReviewList = function( review ) { /* Updating review doesn't change the reviewDate. Going date-wise chronological order, update the same review if already present */ var hasUpdatedReview = review.userPratilipiId == self.userPratilipi.userPratilipiId() && self.userPratilipi.review() != null; if( hasUpdatedReview ) { for( var i = 0; i < self.reviewList().length; i++ ) { if( review.userPratilipiId == self.reviewList()[i].userPratilipiId() ) { self.reviewList()[i].rating( review.rating ); self.reviewList()[i].review( review.review ); break; } } } else if( review.review != null ) { self.reviewList.unshift( ko.mapping.fromJS( review ) ); self.totalReviewCount( self.totalReviewCount() + 1 ); } }; this.deleteFromReviewList = function( review ) { self.reviewList.remove( function( item ) { return item.userPratilipiId() == self.userPratilipi.userPratilipiId(); }); self.totalReviewCount( self.totalReviewCount() - 1 ); }; this.pushToReviewList = function( revList ) { for( var i = 0; i < revList.length; i++ ) self.reviewList.push( ko.mapping.fromJS( revList[i] ) ); }; this._fetchReviewList = function( reviewCount ) { if( self.loadingState() == "LOADING" ) return; self.loadingState( "LOADING" ); dataAccessor.getReviewList( self.pratilipi.pratilipiId(), cursor, null, reviewCount, function( reviewListResponse ) { if( reviewListResponse == null ) { self.loadingState( "FAILED" ); return; } var reviewList = reviewListResponse[ "reviewList" ]; cursor = reviewListResponse[ "cursor" ]; self.pushToReviewList( reviewList ); self.loadingState( self.reviewList().length > 0 ? "LOADED" : "LOADED_EMPTY" ); self.totalReviewCount( reviewListResponse[ "numberFound" ] ); }); }; this.loadInitialReviews = function() { self.reviewList( [] ); cursor = null; self.loadingState( null ); self.totalReviewCount( 0 ); self._fetchReviewList( firstLoadReviewCount ); }; this.loadMoreReviews = function() { self._fetchReviewList( subsequentLoadReviewCount ); }; /* Add/Edit Review Modal */ var reviewInputDialog = $( '#pratilipi-review-input-dialog' ); this.openReviewModal = function() { if( appViewModel.user.isGuest() ) { self.triggerFacebookEvent('RATE_RATEREV_BOOK', null, null, self.ratingInput()); goToLoginPage( { "action": "openReviewModal", "ratingInput": self.ratingInput() } ); return; } reviewInputDialog.modal( 'show' ); }; this.closeReviewModal = function() { reviewInputDialog.modal( 'hide' ); self.ratingInput( self.userPratilipi.rating() ); self.reviewInput( self.userPratilipi.review() ); }; /* Clicking anywhere outside the screen */ reviewInputDialog.on( 'hidden.bs.modal', function(e) { self.closeReviewModal(); }); /* Delete Review Modal */ var deleteReviewConfirmationDialog = $( '#pratilipi-review-delete-confirmation-dialog' ); this.openDeleteReviewModal = function() { self.closeReviewModal(); self.triggerFacebookEvent('EDITREVIEW_RATEREV_BOOK', 'DELETE', self.userPratilipi.userPratilipiId()); deleteReviewConfirmationDialog.modal( 'show' ); }; this.closeDeleteReviewModal = function() { deleteReviewConfirmationDialog.modal( 'hide' ); self.openReviewModal(); }; /* Clicking anywhere outside the screen */ deleteReviewConfirmationDialog.on( 'hidden.bs.modal', function(e) { self.closeDeleteReviewModal(); }); /* Update Pratilipi Objects */ this.updatePratilipiObject = function( userPratilipi ) { /* check if its a new rating or updated rating, and calculate average rating accordingly and update values.*/ var pratilipi = {}; var oldRating = self.userPratilipi.rating(); var newRating = userPratilipi.rating; var ratingCount = self.pratilipi.ratingCount() != null ? self.pratilipi.ratingCount() : 0; var averageRating = self.pratilipi.averageRating() != null ? self.pratilipi.averageRating() : 0; var totalRating = ratingCount * averageRating; if( self.userPratilipi.rating() == 0 ) { /* Added a rating */ pratilipi[ "ratingCount" ] = ++ratingCount; } pratilipi[ "averageRating" ] = ( totalRating - oldRating + newRating ) / ratingCount; self.updatePratilipi( pratilipi ); }; /* Create/Update Review */ this.createOrUpdateReview = function() { if( self.addOrDeleteReviewRequestOnFlight() ) return; self.addOrDeleteReviewRequestOnFlight( true ); ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); dataAccessor.createOrUpdateReview( self.pratilipi.pratilipiId(), self.ratingInput(), self.reviewInput(), function( review ) { if( review.reviewState != "PUBLISHED" || review.review == null || review.review.trim() == "" ) review.review = null; if( review.rating == null ) review.rating = 0; if (self.userPratilipi.rating() == 0 && review.rating != 0) { self.triggerFacebookEvent('RATE_RATEREV_BOOK', null, null, self.ratingInput()); } else if (self.userPratilipi.rating() && review.rating != self.userPratilipi.rating()){ self.triggerFacebookEvent('EDITRATE_RATEREV_BOOK', 'UPDATE', null, self.ratingInput()); } if (self.userPratilipi.review() && review.review && self.userPratilipi.review().trim() != review.review.trim()) { self.triggerFacebookEvent('EDITREVIEW_RATEREV_BOOK', 'UPDATE', review.userPratilipiId); } else if (!self.userPratilipi.review() && review.review) { self.triggerFacebookEvent('REVIEW_RATEREV_BOOK', null, review.userPratilipiId); } /* Update reviewList Array first and then userPratilipi Object * We need to know whether user has added/edited his/her review * */ self.addToReviewList( review ); /* Update Pratilipi Object first and then userPratilipi Object * We need old rating to update in Pratilipi object * */ self.updatePratilipiObject( review ); self.updateUserPratilipi( review ); self.addOrDeleteReviewRequestOnFlight( false ); self.closeReviewModal(); ToastUtil.toast( "ಯಶಸ್ವಿ!" ); }, function( error ) { self.addOrDeleteReviewRequestOnFlight( false ); ToastUtil.toast( "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!" ); }); }; /* Delete Review */ this.deleteReview = function( review ) { if( self.addOrDeleteReviewRequestOnFlight() ) return; self.addOrDeleteReviewRequestOnFlight( true ); ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); dataAccessor.deleteReview( self.pratilipi.pratilipiId(), function( review ) { self.deleteFromReviewList( review ); self.updateUserPratilipi( review ); self.addOrDeleteReviewRequestOnFlight( false ); deleteReviewConfirmationDialog.modal( 'hide' ); ToastUtil.toast( "ಯಶಸ್ವಿ!" ); }, function( error ) { self.addOrDeleteReviewRequestOnFlight( false ); ToastUtil.toast( "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!" ); } ); }; this.submitReview = function() { if( self.ratingInput() == self.userPratilipi.rating() && self.userPratilipi.review() != null && self.userPratilipi.review().trim() != "" && self.reviewInput() != null && self.reviewInput().trim() == "" ) { self.deleteReview(); } else { self.createOrUpdateReview(); } /* self.createOrUpdateReview(); */ }; /* Computed Observables */ this.hasMoreReviews = ko.computed( function() { return self.reviewList().length < self.totalReviewCount() && self.loadingState() == "LOADED"; }, this ); this.hasAccessToReview = ko.computed( function() { return appViewModel.user.isGuest() || self.userPratilipi.hasAccessToReview(); }, this ); this.canSubmitReview = ko.computed( function() { return self.ratingInput() != 0 && ! self.addOrDeleteReviewRequestOnFlight(); }, this ); this.pratilipiIdObserver = ko.computed( function() { if( self.pratilipi.pratilipiId() == null ) return; setTimeout( function() { self.loadInitialReviews(); }, 0 ); }, this ); this.userPratilipiMetaObserver = ko.computed( function() { self.ratingInput( self.userPratilipi.rating() ); self.reviewInput( self.userPratilipi.review() ); }, this ); this.userObserver = ko.computed( function() { if( ! appViewModel.user.isGuest() && getUrlParameter( 'action' ) == "openReviewModal" ) { if( getUrlParameter( "ratingInput" ) != null && getUrlParameter( "ratingInput" ) > 0 ) { self.ratingInput( parseInt( getUrlParameter( "ratingInput" ) ) ); } self.openReviewModal(); } }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName, state, parentId, value) { switch (eventName) { case 'EDITREVIEW_RATEREV_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiStateAndParentId(eventName, self.pratilipi, state, parentId ); break; case 'REVIEW_RATEREV_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId(eventName, self.pratilipi, parentId ); break; case 'EDITRATE_RATEREV_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiStateAndValue(eventName, self.pratilipi, state, value ); break; case 'RATE_RATEREV_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndValue(eventName, self.pratilipi, value ); break; case 'VIEWED_RATEREV_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi(eventName, self.pratilipi ); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.pratilipiObserver = ko.computed( function() { self.pratilipi.pratilipiId(); self.pratilipiReviewViewEventTriggered = ko.observable(false); $( window ).scroll(function() { if (FacebookEventTriggerUtil.isScrolledIntoView($('.pratilipi-review-list'), false) && !self.pratilipiReviewViewEventTriggered()) { self.triggerFacebookEvent('VIEWED_RATEREV_BOOK'); self.pratilipiReviewViewEventTriggered(true); } }); }, this); } , template: `<div class="mdl-card mdl-card-border mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card pratilipi-review-list"><div class="mdl-grid" style="margin: 0;"><h3 class="mdl-cell mdl-cell--12-col material-title">ಪ್ರತಿಕ್ರಿಯೆಗಳು</h3><div data-bind="visible: hasAccessToReview()" class="mdl-cell mdl-cell--12-col mdl-card__supporting-text padding-zero"><div class="mdl-grid padding-zero mdl-grid--no-spacing"><div class="mdl-cell--6-col mdl-cell--4-col-tablet padding-zero"><pratilipi-rating-input onclick="ga_CA( 'Review', 'Rating Init' )" params="{ rating: ratingInput }" data-bind="click: openReviewModal"></pratilipi-rating-input></div><div class="mdl-cell--6-col mdl-cell--4-col-tablet padding-zero"><button data-bind="{ click: openReviewModal,text: userPratilipi.review() != null ? 'ಪ್ರತಿಕ್ರಿಯೆಯನ್ನು ಎಡಿಟ್ ಮಾಡಿ' : 'ಪ್ರತಿಕ್ರಿಯೆ ಬರೆಯಿರಿ' }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect pull-right write-review-button"></button></div></div></div><div class="mdl-cell mdl-cell--12-col mdl-card__supporting-text padding-zero "><ul class="demo-list-three mdl-list" style="margin: 0;" data-bind="visible: reviewList().length > 0"><!-- ko foreach: reviewList --><li data-bind="component: {name: 'pratilipi-review',params: { review: $data, pratilipiId: $parent.pratilipi.pratilipiId(), pratilipi: $parent.pratilipi } }"class="mdl-list__item padding-zero display-block"></li><!-- /ko --><li data-bind="visible: hasMoreReviews()"><div class="show-more"><button onclick="ga_CA( 'Review', 'Load Reviews' )"data-bind="click: loadMoreReviews"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">ಇನ್ನೂ ಹೆಚ್ಚು ತೋರಿಸಿ</button></div></li></ul><div data-bind="visible: loadingState() == 'LOADING'" class="text-center"><span class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div><div class="mdl-cell mdl-cell--12-col mdl-card__supporting-text padding-zero material-subtitle-2"data-bind="visible: loadingState() == 'LOADED_EMPTY' && reviewList().length == 0,text: hasAccessToReview() ? 'ಪ್ರತಿಕ್ರಿಯೆ ಬರೆಯಲು ಮೊದಲಿಗರಾಗಿ' : 'ಈ ಬರಹಕ್ಕೆ ಯಾವ ಪ್ರತಿಕ್ರಿಯೆಗಳೂ ಇಲ್ಲ'"></div></div></div></div><div class="modal common-modal fade" id="pratilipi-review-input-dialog" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button data-bind="click: closeReviewModal" class="mdl-button mdl-js-button mdl-button--icon close"><i class="material-icons">close</i></button><h6 class="modal-title">ರೇಟಿಂಗ್ ಮತ್ತು ರಿವ್ಯೂ</h6></div><div class="modal-body"><pratilipi-rating-input style="color: rgba(0,0,0,0.54);" params="{ rating: ratingInput }"></pratilipi-rating-input><textarea data-bind="{ mdlFloatingInput: { label: 'ಪ್ರತಿಕ್ರಿಯೆ ಬರೆಯಿರಿ', value: reviewInput, id: 'pratilipi_review_list_review_input' }, valueUpdate: ['input'], transliterate: true }" rows= "3"></textarea></div><div class="modal-footer"><button data-bind="click: openDeleteReviewModal, visible: userPratilipi.review() != null && userPratilipi.reviewState() != 'DELETED'"class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin pull-left"><i style="font-size: 20px; margin-right: 4px;" class="material-icons">delete</i><span class="material-button">ಪ್ರತಿಕ್ರಿಯೆಯನ್ನು ಡಿಲೀಟ್ ಮಾಡಿ</span></button><button onclick="ga_CA( 'Review', 'Cancel Rating' )"data-bind="click: closeReviewModal"class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin">ರದ್ದುಗೊಳಿಸಿ</button><button onclick="ga_CA( 'Review', 'Add Rating' )"data-bind="click: submitReview, enable: canSubmitReview"class="mdl-button mdl-js-button mdl-button--colored mdl-js-ripple-effect mdl-button--raised">ಸಂರಕ್ಷಿಸಿ</button></div></div></div></div><div class="modal common-modal fade" id="pratilipi-review-delete-confirmation-dialog" tabindex="-1" role="dialog" aria-labelledby="pratilipi-review-delete-confirmation-dialog"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button data-bind="click: closeDeleteReviewModal" class="mdl-button mdl-js-button mdl-button--icon close"><i class="material-icons">close</i></button><h6 class="modal-title">ಪ್ರತಿಕ್ರಿಯೆಯನ್ನು ಡಿಲೀಟ್ ಮಾಡಿ</h6></div><div class="modal-body"><div class="material-subtitle-2">ನಿಸ್ಸಂದೇಹವಾಗಿ ನೀವು ನಿಮ್ಮ ಪ್ರತಿಕ್ರಿಯೆಯನ್ನು ಡಿಲೀಟ್ ಮಾಡುವಿರಾ?</div></div><div class="modal-footer"><button data-bind="click: deleteReview" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin pull-left">ಹೌದು, ಪ್ರತಿಕ್ರಿಯೆಯನ್ನು ಡಿಲೀಟ್ ಮಾಡಿ!</button><button data-bind="click: closeDeleteReviewModal" class="mdl-button mdl-js-button mdl-button--colored mdl-js-ripple-effect mdl-button--raised">ಇಲ್ಲ, ಬೇಡ!</button></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-login-page', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); this.requestOnFlight = ko.observable( false ); this.userEmail = ko.observable(); this.userPassword = ko.observable(); this.emailHasBeenMutedBefore = ko.observable(false); this.passwordHasBeenMutedBefore = ko.observable(false); this.emailChangeDetector = ko.computed(function() { if (!self.userEmail() || self.userEmail().length === 0) { return false; } else if (self.emailHasBeenMutedBefore()) { return false; } self.triggerFacebookEvent('TYPELOGINFIELD_EMAIL_LOGIN'); self.emailHasBeenMutedBefore(true); return true; }); this.passwordNameChangeDetector = ko.computed(function() { if (!self.userPassword() || self.userPassword().length === 0) { return false; } else if (self.passwordHasBeenMutedBefore()) { return false; } self.triggerFacebookEvent('TYPELOGINFIELD_PASSWORD_LOGIN'); self.passwordHasBeenMutedBefore(true); return true; }); this.login = function() { if( self.requestOnFlight() ) return; if( self.userEmail() == null || self.userEmail().trim() == "" ) { ToastUtil.toast( "ದಯವಿಟ್ಟು ನಿಮ್ಮ ಇಮೇಲ್ ನಮೂದಿಸಿ." ); return; } if( self.userPassword() == null || self.userPassword().trim() == "" ) { ToastUtil.toast( "ದಯವಿಟ್ಟು ನಿಮ್ಮ ಪಾಸ್ವರ್ಡ್ ನಮೂದಿಸಿ" ); return; } if( ! validateEmail( self.userEmail() ) ) { ToastUtil.toast( "ದಯವಿಟ್ಟು ಸರಿಯಾಗಿರುವ ಇಮೇಲ್'ಅನ್ನು ನಮೂದಿಸಿ" ); return; } self.requestOnFlight( true ); ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); dataAccessor.loginUser( self.userEmail(), self.userPassword(), function( user ) { ToastUtil.toast( "ಯಶಸ್ವಿ!" ); self.triggerFacebookEvent('SIGNINSUC_EMAIL_LOGIN'); window.location.href = getRetUrl( true ); }, function( error ) { self.requestOnFlight( false ); var message = "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!"; if( error[ "email" ] != null ){ message = error[ "email" ]; self.triggerFacebookEvent('SIGNINERR_EMAIL_LOGIN', JSON.stringify(error), 'EMAIL'); } else if( error[ "password" ] != null ){ message = error[ "password" ]; self.triggerFacebookEvent('SIGNINERR_EMAIL_LOGIN', JSON.stringify(error), 'PASSWORD'); } else if( error[ "message" ] != null ){ message = error[ "message" ]; self.triggerFacebookEvent('SIGNINERR_EMAIL_LOGIN', JSON.stringify(error), 'MESSAGE'); } ToastUtil.toast( message, 3000, true ); }); }; this.loginButtonEnabled = ko.computed( function() { return self.userEmail() != null && self.userEmail().trim() != "" && self.userPassword() != null && self.userPassword().trim() != "" && ! self.requestOnFlight(); }, this ); this.userObservser = ko.computed( function() { if( appViewModel.user.userId() == null || appViewModel.user.userId() == 0 ) return; setTimeout( function() { ToastUtil.toastUp( "<a href='" + getRetUrl( true ) + "'>ನೀವು ಈಗಾಗಲೇ ಲಾಗಿನ್ ಆಗಿರುವಿರಿ, ಹಿಂದಕ್ಕೆ ಹೋಗಲು ದಯವಿಟ್ಟು ಇಲ್ಲಿ ಕ್ಲಿಕ್ ಮಾಡಿ!</a>" ); }, 0 ); }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.LOGIN.ko_element ) { /* Clear All Fields */ self.userEmail( null ); self.userPassword( null ); /* Dispose all observers */ self.locationObserver.dispose(); self.userObservser.dispose(); return; } else { setTimeout(function() { MetaTagUtil.setMetaTagsForLogin(); }); } appViewModel.currentLocation(); }, this ); if( getUrlParameter( "message" ) != null ) { var type = getUrlParameter( "message" ); var message = null; if( type == "NOTIFICATIONS" ) message = "ನೀವು ಹಿಂಬಾಲಿಸುತ್ತಿರುವ ವ್ಯಕ್ತಿಗಳಿಂದ ಸೂಚನೆಗಳನ್ನು ಪಡೆಯಲು ದಯವಿಟ್ಟು ಲಾಗಿನ್ ಆಗಿ"; else if( type == "LIBRARY" ) message = "ನಿಮ್ಮ ಪುಸ್ತಕ ಭಂಡಾರದಲ್ಲಿ ಅನಿಯಮಿತ ಬರಹಗಳನ್ನು ಸಂರಕ್ಷಿಸಲು ದಯವಿಟ್ಟು ಲಾಗಿನ್ ಆಗಿ"; else if( type == "WRITE" ) message = "ಪ್ರತಿಲಿಪಿಯಲ್ಲಿ ಬರೆಯಲು ದಯವಿಟ್ಟು ಆ್ಯoಡ್ರಾಯ್ಡ್ ಆ್ಯಪ್ ಮೂಲಕ ಲಾಗಿನ್ ಆಗಿ"; else if( type == "FOLLOW" ) message = "ಈ ಲೇಖಕರನ್ನು ಹಿಂಬಾಲಿಸಲು ದಯವಿಟ್ಟು ಲಾಗಿನ್ ಆಗಿ"; if( message != null ) ToastUtil.toast( message, 4000 ); } /** * Facebook events */ this.triggerFacebookEvent = function(eventName, value, parentId) { switch (eventName) { case 'SIGNINERR_EMAIL_LOGIN': FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue('SIGNINERR_EMAIL_LOGIN', parentId, value ); break; case 'SIGNINSUC_EMAIL_LOGIN': FacebookEventTriggerUtil.triggerFacebookEventByName('SIGNINSUC_EMAIL_LOGIN'); break; case 'TYPELOGINFIELD_EMAIL_LOGIN': FacebookEventTriggerUtil.triggerFacebookEventByName('TYPELOGINFIELD_EMAIL_LOGIN'); break; case 'TYPELOGINFIELD_PASSWORD_LOGIN': FacebookEventTriggerUtil.triggerFacebookEventByName('TYPELOGINFIELD_PASSWORD_LOGIN'); break; case 'LANDED_LOGINM_LOGIN': FacebookEventTriggerUtil.triggerFacebookEventByName('LANDED_LOGINM_LOGIN'); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; self.triggerFacebookEvent('LANDED_LOGINM_LOGIN'); } , template: `<div class="pratilipi-login-page"><div class="pratilipi-login-container"><span class="sprites-icon pratilipi-logo-icon"></span><div class="pratilipi-heading material-title">ಸೈನ್ ಇನ್ ಆಗಿ</div><div class="pratilipi-content-container"><!-- ko component: {name: "pratilipi-facebook-login",params: { requestOnFlight: $data.requestOnFlight,isRegister: false }} --><!-- /ko --><!-- ko component: {name: "pratilipi-google-login",params: { requestOnFlight: $data.requestOnFlight,isRegister: false }} --><!-- /ko --></div><p class="login-or margin-zero">ಅಥವಾ</p><form id="login_form" class="pratilipi-content-container margin-zero"><input type="email" data-bind="mdlFloatingInput: { label: 'ಇ-ಮೇಲ್', value: userEmail, id: 'pratilipi_login_page_user_email' }, valueUpdate: ['input']" /><input type="password" data-bind="mdlFloatingInput: { label: 'ಪಾಸ್ವರ್ಡ್', value: userPassword, id: 'pratilipi_login_page_user_password' }, valueUpdate: ['input']" /><div class="forgot-password-holder"><a data-bind="attr: { href: '/forgot-password?retUrl=' + getRetUrl() }" class="forgot-password-link pull-right material-body-2">ಪಾಸ್ವರ್ಡ್ ಮರೆತಿರುವಿರಾ?</a></div><div class="clearfix"></div><button onclick="ga_CA( 'Login', 'Email-Login' )"data-bind="{ click: login, enable: loginButtonEnabled }"type="submit"class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored pratilipi-red-button login-button">ಸೈನ್ ಇನ್ ಆಗಲು</button></form><div class="sign-up-link material-body-1">ಹೊಸಬರೇ?&nbsp;&nbsp;<a data-bind="attr: { href: '/register?retUrl=' + getRetUrl() }" class="pratilipi-red">ಪ್ರತಿಲಿಪಿಗೆ ಸೈನ್ ಅಪ್ ಆಗಿ</a></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-pratilipi-card', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.pratilipi = params.pratilipi; this.hideLibraryButton = params.hideLibraryButton != null ? params.hideLibraryButton : false; this.canRemoveFromLibrary = params.canRemoveFromLibrary != null ? params.canRemoveFromLibrary : true; /* Default set to true */ this.redirectToReaderOnClick = params.redirectToReaderOnClick != null ? params.redirectToReaderOnClick : false; this.showCategoryButton = params.showCategoryButton != null ? params.showCategoryButton : false; /* Default set to false */ this.libraryButtonVisible = ko.observable( false ); this.shareButtonVisible = ko.observable( false ); this.libraryRequestOnFlight = ko.observable( false ); this.updatePratilipi = function( pratilipi ) { ko.mapping.fromJS( pratilipi, {}, self.pratilipi ); }; this.percentageRead = ko.computed( function() { return ( self.pratilipi.userPratilipi && self.pratilipi.userPratilipi.percentageRead ) ? self.pratilipi.userPratilipi.percentageRead() : 0; }, this); this.titleDisplay = ko.computed( function() { return self.pratilipi.displayTitle ? self.pratilipi.displayTitle() : self.pratilipi.title(); }, this ); this.nameDisplay = ko.computed( function() { return self.pratilipi.author.displayName ? self.pratilipi.author.displayName() : ( self.pratilipi.author.name() || "" ); }, this ); this.switchLibraryState = function() { if( ! self.canRemoveFromLibrary && self.pratilipi.addedToLib() ) return; self.libraryRequestOnFlight( true ); var getAddedToLibMessage = function( addedToLib ) { var text = addedToLib ? "ನೀವು $pratilipiTitle ಬರಹವನ್ನು ಗ್ರಂಥಾಲಯಕ್ಕೆ ಸೇರಿಸಿದ್ದೀರಿ" : "ನೀವು $pratilipiTitle ಬರಹವನ್ನು ಗ್ರಂಥಾಲಯದಿಂದ ತೆಗೆದುಹಾಕಿದ್ದೀರಿ"; var title = self.titleDisplay().substring( 0, 10 ) + ( self.titleDisplay().length > 10 ? "..." : "" ); return text.replace( "$pratilipiTitle", title ); }; var addedToLib = ! self.pratilipi.addedToLib(); if( addedToLib ) { /* Toast only for remove action */ ToastUtil.toast( getAddedToLibMessage( addedToLib ), 3000 ); self.triggerFacebookEvent('LIBRARYADD'); } else { ToastUtil.toastCallBack( getAddedToLibMessage( addedToLib ), 4000, "", self.switchLibraryState ); self.triggerFacebookEvent('LIBRARYREMOVE'); } self.updatePratilipi( { "addedToLib": addedToLib } ); dataAccessor.addOrRemoveFromLibrary( self.pratilipi.pratilipiId(), addedToLib, function( userPratilipi ) { self.libraryRequestOnFlight( false ); }, function( error ) { self.libraryRequestOnFlight( false ); self.updatePratilipi( { "addedToLib": ! addedToLib } ); var message = "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!"; if( error[ "message" ] != null ) message = error[ "message" ]; ToastUtil.toast( message, 3000, true ); }); }; this.addToOrRemoveFromLibrary = function( vm, evt ) { evt.stopPropagation(); if( appViewModel.user.isGuest() ) { self.triggerFacebookEvent('LIBRARYADD'); goToLoginPage( null, { "message": "LIBRARY" } ); return; } self.switchLibraryState(); }; this.sharePratilipi = function( vm, evt ) { evt.stopPropagation(); if (getLocation().fb_screen_name === 'CATEGORY') { ShareUtil.sharePratilipi( self.pratilipi, null, 'CATEGORYM_CATEGORY' ); } else if (getLocation().fb_screen_name === 'EVENT') { ShareUtil.sharePratilipi( self.pratilipi, null, 'EVENTRIES_EVENT' ); } else if (getLocation().fb_screen_name === 'HOME') { ShareUtil.sharePratilipi( self.pratilipi, null, 'COLLECTIONS_HOME' ); } else if (getLocation().fb_screen_name === 'LIBRARY') { ShareUtil.sharePratilipi( self.pratilipi, null, 'LIBRARYM_LIBRARY' ); } else if (getLocation().fb_screen_name === 'MYPROFILE') { ShareUtil.sharePratilipi( self.pratilipi, null, 'PUBLISHED_MYPROFILE' ); } else if (getLocation().fb_screen_name === 'USER') { ShareUtil.sharePratilipi( self.pratilipi, null, 'PUBLISHED_USER' ); } else { ShareUtil.sharePratilipi( self.pratilipi, null ); } self.triggerFacebookEvent('CLICKSHRBOOK'); }; this.userObserver = ko.computed( function() { self.libraryButtonVisible( appViewModel.user.author.authorId() != self.pratilipi.author.authorId() ); }, this ); this.pratilipiMetaObserver = ko.computed( function() { self.shareButtonVisible( self.pratilipi.state == null || self.pratilipi.state() == "PUBLISHED" ); }, this ); this.showCategoryModal = function() { $( '#addCategory-'+self.pratilipi.pratilipiId() ).modal(); }; setTimeout( function() { if( typeof( componentHandler ) !== 'undefined' ) componentHandler.upgradeDom(); }, 0 ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName) { switch (eventName) { case 'CLICKBOOK': if (getLocation().fb_screen_name === 'USER') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('CLICKBOOK_PUBLISHED_USER', self.pratilipi ); } else if (getLocation().fb_screen_name === 'MYPROFILE') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('CLICKBOOK_PUBLISHED_MYPROFILE', self.pratilipi ); } else if (getLocation().fb_screen_name === 'EVENT') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('CLICKBOOK_EVENTRIES_EVENT', self.pratilipi ); } else if (getLocation().fb_screen_name === 'HOME') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('CLICKBOOK_COLLECTIONS_HOME', self.pratilipi ); } else if (getLocation().fb_screen_name === 'LIBRARY') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('READBOOK_LIBRARYM_LIBRARY', self.pratilipi ); } else if (getLocation().fb_screen_name === 'CATEGORY') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('CLICKBOOK_CATEGORYM_CATEGORY', self.pratilipi ); } break; case 'CLICKSHRBOOK': if (getLocation().fb_screen_name === 'USER') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('CLICKSHRBOOK_PUBLISHED_USER', self.pratilipi ); } else if (getLocation().fb_screen_name === 'MYPROFILE') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('CLICKSHRBOOK_PUBLISHED_MYPROFILE', self.pratilipi ); } else if (getLocation().fb_screen_name === 'EVENT') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('CLICKSHRBOOK_EVENTRIES_EVENT', self.pratilipi ); } else if (getLocation().fb_screen_name === 'HOME') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('CLICKSHRBOOK_COLLECTIONS_HOME', self.pratilipi ); } else if (getLocation().fb_screen_name === 'LIBRARY') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('CLICKSHRBOOK_LIBRARYM_LIBRARY', self.pratilipi ); } else if (getLocation().fb_screen_name === 'CATEGORY') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('CLICKSHRBOOK_CATEGORYM_CATEGORY', self.pratilipi ); } break; case 'LIBRARYADD': if (getLocation().fb_screen_name === 'USER') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('LIBRARYADD_PUBLISHED_USER', self.pratilipi ); } else if (getLocation().fb_screen_name === 'EVENT') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('LIBRARYADD_EVENTRIES_EVENT', self.pratilipi ); } else if (getLocation().fb_screen_name === 'HOME') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('LIBRARYADD_COLLECTIONS_HOME', self.pratilipi ); } else if (getLocation().fb_screen_name === 'CATEGORY') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('LIBRARYADD_CATEGORYM_CATEGORY', self.pratilipi ); } break; case 'LIBRARYREMOVE': if (getLocation().fb_screen_name === 'USER') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('LIBRARYREMOVE_PUBLISHED_USER', self.pratilipi ); } else if (getLocation().fb_screen_name === 'EVENT') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('LIBRARYREMOVE_EVENTRIES_EVENT', self.pratilipi ); } else if (getLocation().fb_screen_name === 'HOME') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('LIBRARYREMOVE_COLLECTIONS_HOME', self.pratilipi ); } else if (getLocation().fb_screen_name === 'LIBRARY') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('LIBRARYREMOVE_LIBRARYM_LIBRARY', self.pratilipi ); } else if (getLocation().fb_screen_name === 'CATEGORY') { FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('LIBRARYREMOVE_CATEGORYM_CATEGORY', self.pratilipi ); } break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.triggerClickPratilipiEvent = function() { self.triggerFacebookEvent('CLICKBOOK'); return true; } } , template: `<a onclick="ga_CA( 'Pratilipi', 'Open' )"class="pratilipi-pratilipi-card mdl-card mdl-card-border"data-bind="attr: { href: redirectToReaderOnClick ? pratilipi.readPageUrl() : pratilipi.pageUrl() }, click: triggerClickPratilipiEvent"><span class="pratilipi-cover-image-holder"><pratilipi-image params="{ src: pratilipi.coverImageUrl,width: 100,height: 150,alt: titleDisplay(),mobWidth: 70,mobHeight: 105 }"></pratilipi-image></span><span class="pratilipi-meta-holder"><!-- Author Rahul : Single line title when category button is visible --><span class="pratilipi-title mdl-card__title" data-bind="visible: showCategoryButton && pratilipi.hasAccessToUpdate()"><span class="font-l single-line" data-bind="text: titleDisplay()"></span></span><span class="pratilipi-title mdl-card__title " data-bind="visible: !(showCategoryButton && pratilipi.hasAccessToUpdate())"><span class="font-l" data-bind="text: titleDisplay()"></span></span><!-- End --><span class="author-name mdl-card__title"><span class="material-subtitle-2" data-bind="text: nameDisplay()"></span></span><span class="pratilipi-card-meta-reads-rating-holder"><span class="meta-holder reads-holder" data-bind="visible: pratilipi.readCount() > 0"><span class="material-body-1" data-bind="text: abbrNum( pratilipi.readCount(), 0 )"></span><i class="material-icons material-body-1">remove_red_eye</i></span><span class="meta-holder rating-holder" data-bind="visible: pratilipi.averageRating() > 0"><span class="material-body-1" data-bind="text: roundOffToOneDecimal( pratilipi.averageRating() )"></span><i class="material-icons material-body-1">star_rate</i></span></span><span class="pratilipi-card-footer-icons-holder"><!-- ko if: appViewModel.isTestEnvironment && showCategoryButton && pratilipi.hasAccessToUpdate() --><button data-bind="visible: pratilipi.tags() != null || pratilipi.suggestedTags() != null, click: showCategoryModal"class="edit-category-button">ಪ್ರಭೇದ ಎಡಿಟ್ ಮಾಡಿ</button><button data-bind="visible: pratilipi.tags() == null && pratilipi.suggestedTags() == null, click: showCategoryModal"class="add-category-button">ಇಲ್ಲಿ ಟೈಪ್ ಮಾಡಿ</button><!-- /ko --><button onclick="ga_CA( 'Pratilipi', 'Share' )"data-bind="click: sharePratilipi, visible: shareButtonVisible()"class="library-button mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">share</i></button><!-- ko if: ! hideLibraryButton --><button onclick="ga_CA( 'Pratilipi', 'Add To Library' )"data-bind="{ disable: libraryRequestOnFlight(), click: addToOrRemoveFromLibrary, visible: libraryButtonVisible() }"class="share-button mdl-button mdl-js-button mdl-button--icon"><i class="material-icons" data-bind="{ text: pratilipi.addedToLib() ? 'bookmark' : 'bookmark_border',css: { 'pratilipi-red': pratilipi.addedToLib() } }"></i></button><!-- /ko --><span id="percentage-read-bar" class="mdl-progress" data-bind="if: percentageRead() > 0"><span class="progressbar bar bar1" data-bind="style: { width: percentageRead() + '%' }"></span><span class="bufferbar bar bar2" style="width: 100%;"></span><span class="auxbar bar bar3" style="width: 0%;"></span></span></span></span></a><!-- ko if: appViewModel.isTestEnvironment && showCategoryButton && pratilipi.hasAccessToUpdate() --><div class="modal fade" role="dialog"data-bind="attr: {'id':'addCategory-'+pratilipi.pratilipiId()}"><div class="modal-dialog pratilipi-add-category" role="document"><div class="modal-content"><div class="modal-body"><!-- ko component: {name: "pratilipi-tags",params: {pratilipi: pratilipi, isShownInModal: true}} --><!-- /ko --></div></div></div></div><!-- /ko -->` }); </script> <script> ko.components.register( 'pratilipi-navigation-drawer', { viewModel: function() { var self = this; this.highLightNavigationEntry = function() { $( ".js-navigation-drawer a" ).each( function( index, element ) { $( element ).css( "font-weight", "400" ); if( window.location.pathname == "/search" ) { if( $( element ).attr( 'href' ) == "/search?q=" + appViewModel.searchQuery() ) $( element ).css( "font-weight", "700" ); } else if( $( element ).attr( 'href' ) == window.location.pathname ) { $( element ).css( "font-weight", "700" ); } }); }; this.navigationObserver = ko.computed( function() { appViewModel.searchQuery(); appViewModel.currentLocation(); setTimeout( function() { self.highLightNavigationEntry(); }, 0 ); }, this ); $( ".js-navigation-drawer a" ).click( function() { document.querySelector( '.mdl-layout' ).MaterialLayout.toggleDrawer(); }); /** * Facebook events */ this.triggerFacebookEvent = function(eventName, value) { switch (eventName) { case 'CLICKCATEGORY_TOPICS_GLOBAL': FacebookEventTriggerUtil.triggerFacebookEventByNameAndValue(eventName, value); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.triggerGoCategoryEvent = function(categoryLink) { self.triggerFacebookEvent('CLICKCATEGORY_TOPICS_GLOBAL', categoryLink); return true; }; } , template: `<div class="mdl-layout__drawer mdl-layout--small-screen-only js-navigation-drawer"><nav class="mdl-navigation pratilipi-navigation-drawer"><h6 class="font-l">ಪ್ರಭೇದಗಳು</h6><a onclick="ga_CA( 'Navigation-romance', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಪ್ರೀತಿ')" class="mdl-navigation__link font-s" href="/love">ಪ್ರೀತಿ</a><a onclick="ga_CA( 'Navigation-horror', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಹಾರರ್')" class="mdl-navigation__link font-s" href="/horror">ಹಾರರ್</a><a onclick="ga_CA( 'Navigation-satire', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಹಾಸ್ಯ')" class="mdl-navigation__link font-s" href="/comedy">ಹಾಸ್ಯ</a><a onclick="ga_CA( 'Navigation-family', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಬಂಧುತ್ವ')" class="mdl-navigation__link font-s" href="/relationship">ಬಂಧುತ್ವ</a><a onclick="ga_CA( 'Navigation-women', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಮಹಿಳೆ')" class="mdl-navigation__link font-s" href="/women">ಮಹಿಳೆ</a><a onclick="ga_CA( 'Navigation-serials', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಧಾರಾವಾಹಿ')" class="mdl-navigation__link font-s" href="/dhaaraavaahi">ಧಾರಾವಾಹಿ</a><a onclick="ga_CA( 'Navigation-articles', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಲೇಖನಗಳು')" class="mdl-navigation__link font-s" href="/nonfiction">ಲೇಖನಗಳು</a><a onclick="ga_CA( 'Navigation-poetry', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಕವಿತೆಗಳು')" class="mdl-navigation__link font-s" href="/poems">ಕವಿತೆಗಳು</a><a onclick="ga_CA( 'Navigation-social', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಸಮಾಜ')" class="mdl-navigation__link font-s" href="/society">ಸಮಾಜ</a><a onclick="ga_CA( 'Navigation-educational', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ವಿಜ್ಞಾನ')" class="mdl-navigation__link font-s" href="/science">ವಿಜ್ಞಾನ</a><a onclick="ga_CA( 'Navigation-life', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಜೀವನ')" class="mdl-navigation__link font-s" href="/life">ಜೀವನ</a><a onclick="ga_CA( 'Navigation-cinema', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಸಿನಿಮಾ')" class="mdl-navigation__link font-s" href="/cinema">ಸಿನಿಮಾ</a><a onclick="ga_CA( 'Navigation-inspirational', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಸ್ಫೂರ್ತಿದಾಯಕ')" class="mdl-navigation__link font-s" href="/inspirational">ಸ್ಫೂರ್ತಿದಾಯಕ</a><a onclick="ga_CA( 'Navigation-other-stories', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಕಥೆಗಳು')" class="mdl-navigation__link font-s" href="/otherstories">ಕಥೆಗಳು</a><a onclick="ga_CA( 'Navigation-books', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಸಮಗ್ರ')" class="mdl-navigation__link font-s" href="/books">ಸಮಗ್ರ</a><h6 class="font-l">ಪ್ರಖ್ಯಾತ ಬರಹಗಳು</h6><a onclick="ga_CA( 'Navigation-event-comedy', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ನಗು ನಗುತಾ ನಲೀ ನಲಿ...')" class="mdl-navigation__link font-s" href="/event/ನಗು-ನಗುತಾ-ನಲೀ-ನಲಿ-ic59tqb4yv">ನಗು ನಗುತಾ ನಲೀ ನಲಿ...</a><a onclick="ga_CA( 'Navigation-most-read', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಓದುಗರ ಆಯ್ಕೆ')" class="mdl-navigation__link font-s" href="/most-read">ಓದುಗರ ಆಯ್ಕೆ</a><a onclick="ga_CA( 'Navigation-newly-published', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಹೊಸ ಬರಹಗಳು')" class="mdl-navigation__link font-s" href="/newcontents">ಹೊಸ ಬರಹಗಳು</a><a onclick="ga_CA( 'Navigation-classics', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ವಚನಗಳು')" class="mdl-navigation__link font-s" href="/classic-sahitya">ವಚನಗಳು</a><a onclick="ga_CA( 'Navigation-online-events', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಸ್ಪರ್ಧೆಗಳು')" class="mdl-navigation__link font-s" href="/event">ಸ್ಪರ್ಧೆಗಳು</a><a onclick="ga_CA( 'Navigation-blogs', 'Open' )" data-bind="click: triggerGoCategoryEvent.bind(this, 'ಬ್ಲಾಗ್'ಗಳು')" class="mdl-navigation__link font-s" href="/blog">ಬ್ಲಾಗ್'ಗಳು</a></nav></div>` }); </script> <script> ko.components.register( 'pratilipi-review', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.review = params.review; this.pratilipi = params.pratilipi; this.isLiked = ko.observable( self.review.isLiked ? self.review.isLiked() : false ); this.likeCount = ko.observable( self.review.likeCount ? self.review.likeCount() : 0 ); this.totalCommentCount = ko.observable( self.review.commentCount ? self.review.commentCount() : 0 ); /* Like / Dislike Review */ this.voteRequestOnFlight = ko.observable( false ); this.likeOrDislikeReview = function() { if( appViewModel.user.isGuest() ) { this.triggerFacebookEvent('LIKE_REVIEWS_BOOK'); goToLoginPage(); return; } if( self.voteRequestOnFlight() ) return; self.voteRequestOnFlight( true ); var toggleIsLiked = function() { self.likeCount( self.isLiked() ? self.likeCount() - 1 : self.likeCount() + 1 ); self.isLiked( ! self.isLiked() ); }; toggleIsLiked(); if (self.isLiked()) { this.triggerFacebookEvent('LIKE_REVIEWS_BOOK'); } else { this.triggerFacebookEvent('UNLIKE_REVIEWS_BOOK'); } dataAccessor.likeOrDislikeReview( self.review.userPratilipiId(), self.isLiked(), function( vote ) { self.voteRequestOnFlight( false ); ga_CA( 'Review', vote.isLiked ? 'Review Like' : 'Review UnLike' ); }, function( error ) { toggleIsLiked(); self.voteRequestOnFlight( false ); ToastUtil.toast( error.message != null ? error.message : "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!" ); }); }; /* CommentList */ this.commentList = ko.observableArray(); this.addToCommentsList = function( comment ) { self.commentList.push( ko.mapping.fromJS( comment ) ); }; this.updateCommentList = function( commentList ) { for( var i = 0; i < commentList.length; i++ ) self.commentList.push( ko.mapping.fromJS( commentList[i] ) ); }; var cursor = null; this.isCommentsLoading = ko.observable(); this.hasMoreContents = ko.observable( false ); /* Constants */ var firstLoadCommentCount = 5; var subsequentLoadCommentCount = 10; this._fetchCommentList = function( resultCount ) { if( self.isCommentsLoading() ) return; self.isCommentsLoading( true ); dataAccessor.getReviewCommentList( self.review.userPratilipiId(), cursor, resultCount, function( commentListResponse ) { if( commentListResponse == null ) { self.hasMoreContents( true ); self.isCommentsLoading( false ); return; } var commentList = commentListResponse.commentList; cursor = commentListResponse.cursor; self.updateCommentList( commentList ); self.isCommentsLoading( false ); self.hasMoreContents( resultCount == commentList.length ); setTimeout( function() { componentHandler.upgradeDom(); }, 0 ); }); }; this.loadMoreComments = function() { self._fetchCommentList( subsequentLoadCommentCount ); }; /* Show / Hide Comments */ this.commentSectionVisible = ko.observable( false ); this.showCommentSection = function() { self.commentSectionVisible( true ); if( self.commentList().length == 0 && self.totalCommentCount() > 0 ) self._fetchCommentList( firstLoadCommentCount ); }; this.hideCommentSection = function() { self.commentSectionVisible( false ); }; this.toggleCommentSection = function() { self.commentSectionVisible() ? self.hideCommentSection() : self.showCommentSection(); }; /* Comment Input */ this.addCommentInput = ko.observable(); this.addCommentInputVisible = ko.observable( false ); this.openAddCommentInput = function() { if( appViewModel.user.isGuest() ) { goToLoginPage(); return; } self.addCommentInput( null ); self.showCommentSection(); self.addCommentInputVisible( true ); }; this.closeAddCommentInput = function() { self.addCommentInputVisible( false ); }; this.toggleAddCommentInput = function() { self.addCommentInputVisible() ? self.closeAddCommentInput() : self.openAddCommentInput(); }; /* Add Comment */ this.addCommentRequestOnFlight = ko.observable( false ); this.submitAddComment = function() { if( self.addCommentRequestOnFlight() ) return; self.addCommentRequestOnFlight( true ); ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); dataAccessor.createOrUpdateReviewComment( self.review.userPratilipiId(), null, self.addCommentInput(), function( comment ) { self.triggerFacebookEvent('COMMENT_REVIEWS_BOOK', null, self.review.userPratilipiId(), comment.commentId); self.addToCommentsList( comment ); self.closeAddCommentInput(); self.addCommentRequestOnFlight( false ); ToastUtil.toast( "ಯಶಸ್ವಿ!" ); }, function( error ) { self.addCommentRequestOnFlight( false ); ToastUtil.toast( error.message != null ? error.message : "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!" ); }); }; /* Delete Comment */ this.deleteComment = function( viewModel ) { var commentId = viewModel.comment.commentId(); ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); dataAccessor.deleteComment( commentId, function( comment ) { ToastUtil.toast( "ಯಶಸ್ವಿ!" ); /* Hack remove delete modal forcibly */ $( '.modal' ).modal( 'hide' ); $( 'body' ).removeClass( 'modal-open' ); $( '.modal-backdrop' ).remove(); self.triggerFacebookEvent('EDITCOMMENT_COMMENTS_BOOK', 'DELETE', commentId); self.commentList.remove( function( item ) { return item.commentId() == comment.commentId; }); self.totalCommentCount( self.totalCommentCount() - 1 ) }, function( error ) { ToastUtil.toast( error.message != null ? error.message : "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!" ); }); }; /* Report review */ this.reportContent = function() { ReportUtil.report( "REVIEW", self.review.userPratilipiId() ); }; /* Computed observables */ this.canSubmitAddComment = ko.computed( function() { return self.addCommentInputVisible() && self.addCommentInput() != null && self.addCommentInput().trim() != "" && ! self.addCommentRequestOnFlight(); }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName, state, parentId, value) { switch (eventName) { case 'CLICKUSER_REVIEWS_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId(eventName, self.pratilipi, self.review.user.userId() ); break; case 'LIKE_REVIEWS_BOOK': case 'UNLIKE_REVIEWS_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiParentIdAndValue(eventName, self.pratilipi, self.review.userPratilipiId(), self.likeCount() ); break; case 'EDITCOMMENT_COMMENTS_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiStateAndParentId(eventName, self.pratilipi, state, parentId ); break; case 'COMMENT_REVIEWS_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiParentIdAndValue(eventName, self.pratilipi, parentId, value); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.triggerClickUserFbEvent = function() { self.triggerFacebookEvent('CLICKUSER_REVIEWS_BOOK'); return true; } } , template: `<div class="pratilipi-review"><div class="review-holder"><div class="review-header"><div class="user-info"><img data-bind="attr: { src: getImageUrl( review.userImageUrl(), 48 ) }" class="mdl-list__item-avatar"><div style="padding: 0 8px;"><a class="reviewer-name material-subtitle-1" data-bind="attr: { href: review.userProfilePageUrl() }, text: review.user.displayName(), click: triggerClickUserFbEvent"></a><br/><div class="rating-block"><pratilipi-rating class="pratilipi-red" params="rating: review.rating"></pratilipi-rating><span class="font-xs review-date" data-bind="text: convertDate( review.reviewDateMillis() )"></span></div></div></div><span class="three-dots"><button class="mdl-button mdl-js-button mdl-button--icon"data-bind="attr: { 'id': 'pratilipi-report-review-' + review.userPratilipiId() }"><i class="material-icons">more_vert</i></button><ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect"data-bind="attr: { 'data-mdl-for': 'pratilipi-report-review-' + review.userPratilipiId() }"><li data-bind="click: reportContent" class="mdl-menu__item">ಸಮಸ್ಯೆ ತಿಳಿಸಿ</li></ul></span></div><div class="review-container material-subtitle-1" data-bind="text: review.review()"></div><div class="review-footer"><span class="like-holder"><span class="font-s" data-bind="visible: likeCount() > 0, text: likeCount()"></span><button data-bind="click: likeOrDislikeReview, disable: voteRequestOnFlight" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"><i class="material-icons material-icons-16" data-bind="css: { 'mdl-color-text--primary': isLiked() }">thumb_up</i></button></span><span class="separator"></span><span class="comment-holder"><span class="font-s" data-bind="visible: totalCommentCount() > 0, text: totalCommentCount()"></span><button onclick="ga_CA( 'Review', 'Add Comment' )"data-bind="click: toggleAddCommentInput"class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"><i class="material-icons material-icons-16">message</i></button></span><span class="separator" data-bind="visible: totalCommentCount() > 0"></span><span class="view-comments-holder"><span class="font-s clickable-element"data-bind="visible: totalCommentCount() > 0,click: toggleCommentSection,text: commentSectionVisible() ? 'ಕಾಮೆಂಟ್ಸ್ ಹೈಡ್ ಮಾಡಿ' : 'ಎಲ್ಲಾ ಪ್ರತಿಕ್ರಿಯೆಗಳನ್ನು ನೋಡಿ'"></span></span></div></div><div class="pratilipi-comment-list" data-bind="visible: commentSectionVisible()"><ul class="mdl-list comment-list-ul"><!-- ko foreach: commentList --><li data-bind="component: {name: 'pratilipi-review-comment',params: { comment: $data, deleteComment: $parent.deleteComment, toggleCommentInput: $parent.toggleAddCommentInput, pratilipi: $parent.pratilipi } }"class="mdl-list__item display-block"></li><!-- /ko --><li data-bind="visible: isCommentsLoading()" class="mdl-list__item left-padding display-block-unimportant text-center"><span class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></li><li data-bind="visible: addCommentInputVisible()" class="mdl-list__item left-padding display-block-unimportant"><div class="user-info"><img data-bind="attr: { src: getImageUrl( appViewModel.user.profileImageUrl(), 48 ) }" class="mdl-list__item-avatar"><div style="padding: 0 8px;"><a class="reviewer-name material-subtitle-1" data-bind="attr: { href: appViewModel.user.profilePageUrl() }, text: appViewModel.user.displayName()"></a><br/><span class="font-xs review-date" data-bind="text: convertDate( new Date() )"></span></div></div><textarea data-bind="{ mdlFloatingInput: { label: 'ಪ್ರತಿಕ್ರಿಯಿಸಲು ಇಲ್ಲಿ ಟೈಪ್ ಮಾಡಿ',value: addCommentInput, id: 'pratilipi-comment-input-' + review.userPratilipiId() },valueUpdate: ['input'],transliterate: true }"></textarea><div style="height: 36px;"><div class="pull-right"><button onclick="ga_CA( 'Review', 'Cancel Comment' )"data-bind="click: closeAddCommentInput"class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin">ರದ್ದುಗೊಳಿಸಿ</button><button onclick="ga_CA( 'Review', 'Submit Comment' )"data-bind="enable: canSubmitAddComment, click: submitAddComment"class="mdl-button mdl-js-button mdl-button--colored mdl-js-ripple-effect mdl-button--raised">ಸಂರಕ್ಷಿಸಿ</button></div></div></li><li class="show-more"data-bind="visible: ! isCommentsLoading() && hasMoreContents()"style="padding-left: 16px;"><button style="padding: 0;" data-bind="click: loadMoreComments" class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">ಇನ್ನೂ ಹೆಚ್ಚು ತೋರಿಸಿ</button></li></ul></div><div data-bind="visible: $index() != ( $parents[1].totalReviewCount() - 1 ) "><hr /></div></div>` }); </script> <script> ko.components.register( 'pratilipi-register-page', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); this.requestOnFlight = ko.observable( false ); this.userName = ko.observable(); this.userEmail = ko.observable(); this.userPassword = ko.observable(); this.agreedTerms = ko.observable( false ); this.nameHasBeenMutedBefore = ko.observable(false); this.emailHasBeenMutedBefore = ko.observable(false); this.passwordHasBeenMutedBefore = ko.observable(false); this.userNameChangeDetector = ko.computed(function() { if (!self.userName() || self.userName().length === 0) { return false; } else if (self.nameHasBeenMutedBefore()) { return false; } self.triggerFacebookEvent('TYPELOGINFIELD_NAME_REGISTER'); self.nameHasBeenMutedBefore(true); return true; }); this.emailChangeDetector = ko.computed(function() { if (!self.userEmail() || self.userEmail().length === 0) { return false; } else if (self.emailHasBeenMutedBefore()) { return false; } self.triggerFacebookEvent('TYPELOGINFIELD_EMAIL_REGISTER'); self.emailHasBeenMutedBefore(true); return true; }); this.passwordNameChangeDetector = ko.computed(function() { if (!self.userPassword() || self.userPassword().length === 0) { return false; } else if (self.passwordHasBeenMutedBefore()) { return false; } self.triggerFacebookEvent('TYPELOGINFIELD_PASSWORD_REGISTER'); self.passwordHasBeenMutedBefore(true); return true; }); this.register = function() { if( self.requestOnFlight() ) return; if( self.userName() == null || self.userName().trim() == "" ) { ToastUtil.toast( "ದಯವಿಟ್ಟು ನಿಮ್ಮ ಹೆಸರನ್ನು ನಮೂದಿಸಿ" ); return; } if( self.userEmail() == null || self.userEmail().trim() == "" ) { ToastUtil.toast( "ದಯವಿಟ್ಟು ನಿಮ್ಮ ಇಮೇಲ್ ನಮೂದಿಸಿ." ); return; } if( self.userPassword() == null || self.userPassword().trim() == "" ) { ToastUtil.toast( "ದಯವಿಟ್ಟು ನಿಮ್ಮ ಪಾಸ್ವರ್ಡ್ ನಮೂದಿಸಿ" ); return; } if( ! validateEmail( self.userEmail() ) ) { ToastUtil.toast( "ದಯವಿಟ್ಟು ಸರಿಯಾಗಿರುವ ಇಮೇಲ್'ಅನ್ನು ನಮೂದಿಸಿ" ); return; } if( ! self.agreedTerms() ) { ToastUtil.toast( "ದಯವಿಟ್ಟು ನಮ್ಮ ನಿಯಮಗಳಿಗೆ ಒಪ್ಪಿಗೆ ಸೂಚಿಸಿ!" ); return; } self.requestOnFlight( true ); ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); dataAccessor.registerUser( self.userName(), self.userEmail(), self.userPassword(), function( user ) { ToastUtil.toast( "ಯಶಸ್ವಿ!" ); self.triggerFacebookEvent('SIGNUPSUC_EMAIL_REGISTER'); window.location.href = user[ "profilePageUrl" ]; }, function( error ) { self.requestOnFlight( false ); var message = "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!"; if( error[ "name" ] != null ){ message = error[ "name" ]; self.triggerFacebookEvent('SIGNUPERR_EMAIL_REGISTER', JSON.stringify(error), 'NAME'); } else if( error[ "email" ] != null ){ message = error[ "email" ]; self.triggerFacebookEvent('SIGNUPERR_EMAIL_REGISTER', JSON.stringify(error), 'EMAIL'); } else if( error[ "password" ] != null ){ message = error[ "password" ]; self.triggerFacebookEvent('SIGNUPERR_EMAIL_REGISTER', JSON.stringify(error), 'PASSWORD'); } else if( error[ "message" ] != null ){ message = error[ "message" ]; self.triggerFacebookEvent('SIGNUPERR_EMAIL_REGISTER', JSON.stringify(error), 'MESSAGE'); } else { self.triggerFacebookEvent('SIGNUPERR_EMAIL_REGISTER', JSON.stringify(error), 'OTHERS'); } ToastUtil.toast( message, 3000, true ); }); }; this.registerButtonEnabled = ko.computed( function() { return self.userName() != null && self.userName().trim() != "" && self.userEmail() != null && self.userEmail().trim() != "" && self.userPassword() != null && self.userPassword().trim() != "" && self.agreedTerms() && ! self.requestOnFlight(); }, self ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.REGISTER.ko_element ) { /* Clear All Fields */ self.userName( null ); self.userEmail( null ); self.userPassword( null ); self.agreedTerms( false ); /* Dispose all observers */ self.locationObserver.dispose(); return; } else { setTimeout(function() { MetaTagUtil.setMetaTagsForRegister(); }); } appViewModel.currentLocation(); }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName, value, parentId) { switch (eventName) { case 'SIGNUPERR_EMAIL_REGISTER': FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue('SIGNUPERR_EMAIL_REGISTER', parentId, value ); break; case 'SIGNUPSUC_EMAIL_REGISTER': FacebookEventTriggerUtil.triggerFacebookEventByName('SIGNUPSUC_EMAIL_REGISTER'); break; case 'TYPELOGINFIELD_EMAIL_REGISTER': FacebookEventTriggerUtil.triggerFacebookEventByName('TYPELOGINFIELD_EMAIL_REGISTER'); break; case 'TYPELOGINFIELD_NAME_REGISTER': FacebookEventTriggerUtil.triggerFacebookEventByName('TYPELOGINFIELD_NAME_REGISTER'); break; case 'TYPELOGINFIELD_PASSWORD_REGISTER': FacebookEventTriggerUtil.triggerFacebookEventByName('TYPELOGINFIELD_PASSWORD_REGISTER'); break; case 'LANDED_REGISTERM_REGISTER': FacebookEventTriggerUtil.triggerFacebookEventByName('LANDED_REGISTERM_REGISTER'); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; self.triggerFacebookEvent('LANDED_REGISTERM_REGISTER'); } , template: `<div class="pratilipi-register-page"><div class="pratilipi-login-container"><span class="sprites-icon pratilipi-logo-icon"></span><div class="pratilipi-heading material-title">ಪ್ರತಿಲಿಪಿಗೆ ಸೈನ್ ಅಪ್ ಆಗಿ</div><div class="pratilipi-content-container"><!-- ko component: {name: "pratilipi-facebook-login",params: { requestOnFlight: $data.requestOnFlight,isRegister: true }} --><!-- /ko --><!-- ko component: {name: "pratilipi-google-login",params: { requestOnFlight: $data.requestOnFlight,isRegister: true }} --><!-- /ko --></div><p class="login-or margin-zero">ಅಥವಾ</p><form id="register_form" class="pratilipi-content-container margin-zero"><input type="text" data-bind="mdlFloatingInput: { label: 'ಪೂರ್ತಿ ಹೆಸರು', value: userName, id: 'pratilipi_register_page_user_name' }, valueUpdate: ['input']" /><input type="email" data-bind="mdlFloatingInput: { label: 'ಇ-ಮೇಲ್', value: userEmail, id: 'pratilipi_register_page_user_email' }, valueUpdate: ['input']" /><input type="password" data-bind="mdlFloatingInput: { label: 'ಪಾಸ್ವರ್ಡ್', value: userPassword, id: 'pratilipi_register_page_user_password' }, valueUpdate: ['input']" /><div class="clearfix"></div><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect terms-conditions" for="agree-terms-conditions"><input data-bind="checked: agreedTerms" type="checkbox" id="agree-terms-conditions" class="mdl-checkbox__input" /><span class="mdl-checkbox__label material-body-2">ನೋಂದಾಯಿಸಿಕೊಳ್ಳುವ ಮೂಲಕ ನೀವು ನಮ್ಮ <a href="/privacy-policy" target="_blank">ಗೌಪ್ಯತಾ ನೀತಿ</a> ಮತ್ತು <a href="/terms-of-service" target="_blank">ನಿಯಮಗಳಿಗೆ</a> ಒಪ್ಪಿಕೊಳ್ಳುತ್ತೀರಿ</span></label><button onclick="ga_CA( 'Signup', 'Email-signup' )"data-bind="{ click: register, enable: registerButtonEnabled }"type="submit"class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored pratilipi-red-button login-button">ಸೈನ್ ಅಪ್!</button><div class="member-login material-body-2"><span class="text-muted">ಈಗಾಗಲೇ ಸದಸ್ಯರಾಗಿರುವಿರಾ?&nbsp;</span><a data-bind="attr: {href: '/login?retUrl=' + getRetUrl() }" class="pratilipi-blue">ಸೈನ್ ಇನ್ ಆಗಲು</a></div></form></div></div>` }); </script> <script> ko.components.register( 'pratilipi-recommendation-carousel', { viewModel: function( params ) { var self = this; var pratilipiId = params.pratilipiId; /* ko observable */ var context = params.context; this.pratilipi = params.pratilipi; this.recommendationLoadFailed = params.recommendationLoadFailed || null; this.algorithmId = null; var resultCount = 6; var dataAccessor = new DataAccessor(); this.title = ko.observable(); this.pratilipiList = ko.observableArray(); this.loadingState = ko.observable(); /* 4 states: INITIAL, LOADING, LOADED, FAILED */ this.recommendationViewEventTriggered; this.updatePratilipiList = function( pratilipiList ) { for( var i = 0; i < pratilipiList.length; i++ ) { if( pratilipiList[i] != null ) { pratilipiList[i]["ga_index"] = i; /* Backfilling algorithmId and summary */ if( ! pratilipiList[i]["meta"]["algorithmId"] && self.algorithmId ) pratilipiList[i]["meta"]["algorithmId"] = self.algorithmId; self.pratilipiList.push( ko.mapping.fromJS( pratilipiList[i] ) ); } } }; this.fetchPratilipiList = function() { if( self.loadingState() == "LOADING" ) return; self.loadingState( "LOADING" ); dataAccessor.getPratilipiRecommendationV2( pratilipiId(), context, resultCount, function( response ) { /* Cant trust recommendations, you know... */ if( response == null || response.pratilipiList == null || response.pratilipiList.length === 0 ) { self.loadingState( "FAILED" ); if( self.recommendationLoadFailed ) { self.recommendationLoadFailed( true ); } return; } /* Don't even try to change the order of the lines below.. TODO: fix the place of algorithmId */ self.algorithmId = ( response.meta && response.meta.algorithmId ) || response.pratilipiList[0].meta.algorithmId; self.title( response.title ); self.updatePratilipiList( response.pratilipiList ); self.loadingState( "LOADED" ); setTimeout( function() { $('.pratilipi-recommendation-carousel').scrollLeft(0); }, 30 ); }); }; this.pratilipiIdObserver = ko.computed( function() { if( pratilipiId() == null ) return; setTimeout( function() { self.title( null ); self.pratilipiList( [] ); self.loadingState( "INITIAL" ); self.recommendationViewEventTriggered = false; self.fetchPratilipiList(); }, 0 ); }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName) { switch (eventName) { case 'VIEWED_RECOMMENDBOOK_BOOK': case 'VIEWED_RECOMMENDBOOK_READER': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndMeta(eventName, self.pratilipi, { 'ALGORITHM_ID': self.algorithmId }); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.scrollTopObserver = ko.computed( function() { appViewModel.scrollTop(); if( appViewModel.currentView() != LOCATION.READER.ko_element && appViewModel.currentView() != LOCATION.PRATILIPI.ko_element ) { self.scrollTopObserver.dispose(); } if( self.loadingState() !== "LOADED" ) return; if( self.recommendationViewEventTriggered ) return; setTimeout( function() { if (FacebookEventTriggerUtil.isScrolledIntoView($('.pratilipi-recommendation-carousel'), true)) { if (getLocation().fb_screen_name === 'READER') { self.triggerFacebookEvent('VIEWED_RECOMMENDBOOK_READER'); } else if (getLocation().fb_screen_name === 'BOOK') { self.triggerFacebookEvent('VIEWED_RECOMMENDBOOK_BOOK'); } /* View event in ga */ ga_CA( "RECOMMENDBOOK", "VIEW" ); self.recommendationViewEventTriggered = true; } }); }, this); } , template: `<div class="pratilipi-recommendation-carousel"><div data-bind="visible: loadingState() == 'LOADING'"style="margin: 25px auto;"class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></div><div class="mdl-grid" style="width: 100%; max-width: 100%; box-sizing: border-box;" data-bind="visible: loadingState() == 'LOADED'"><div class="mdl-cell mdl-cell--12-col material-title" data-bind="text: title()"></div><ul class="pratilipi-recommendation-carousel mdl-grid" data-bind="foreach: { data: pratilipiList, as: 'pratilipi' }, visible: pratilipiList().length > 0"><li class="mdl-cell mdl-cell--4-col-desktop mdl-cell--4-col-tablet mdl-cell--12-col-phone" data-bind="component: { name: 'pratilipi-pratilipi-card-v2', params: { pratilipi: pratilipi } }"></li></ul></div></div>` }); </script> <script> ko.components.register( 'pratilipi-author-leaderboard', { viewModel: function(params) { var self = this; var dataAccessor = new DataAccessor(); var RESULT_COUNT = 20; self.yesterdayTopAuthors = ko.observableArray([]); self.isLoaded = ko.observable(false); self.subHeading = ko.observable(); self.listItemClicked = function(data, event) { console.log(data); window.open(data.pageUrl(),'_blank'); self.FBEvent('CLICK_AUTHOR', data.authorId(), appViewModel.user.author.authorId() == data.authorId ? 'SELF' : 'OTHER'); }; self.sharePratilipi = function( data, event ) { console.log("Share button clicked"); event.stopPropagation(); var eventParams = {}; eventParams['ENVIRONMENT'] = 'GROWTH'; eventParams['PARENT'] = 'TOP AUTHOR'; eventParams['LOCATION'] = 'DESKTOP_RIGHTBAR'; eventParams['EXPERIMENT_ID'] = 'DIA070617A'; var utmParameter = "utm_source=pratilipi_website&utm_medium=top_authors&utm_campaign=author_share"; ShareUtil.shareAuthor( data, utmParameter, eventParams ); }; self.FBEvent = function(event_name, author_id, access_level) { var eventParams = {}; eventParams['ENVIRONMENT'] = 'GROWTH'; eventParams['PARENT'] = 'TOP AUTHOR'; eventParams['CONTENT_LANGUAGE'] = appViewModel.language; eventParams['LOCATION'] = 'DESKTOP_RIGHTBAR'; eventParams['EXPERIMENT_ID'] = 'DIA070617A'; eventParams['SCREEN_NAME'] = getLocation().fb_value; eventParams['USERID'] = appViewModel.user.userId(); if (author_id) eventParams['AUTHOR_ID'] = author_id; if (access_level) eventParams['ACCESS_LEVEL'] = access_level; FB.AppEvents.logEvent(event_name, null, eventParams); }; self.onSuccess = function(data) { /* setting author list. */ ko.mapping.fromJS(data.authorDataList, {}, self.yesterdayTopAuthors); if (self.yesterdayTopAuthors().length > 0) { console.log(self.yesterdayTopAuthors().length); self.isLoaded(true); self.subHeading("( " + data.date + " based on read count on" + " *)"); self.FBEvent('LANDED_PARENT'); } }; if (appViewModel.language == 'HINDI') { /* fetching yesterday's top 10 authors */ dataAccessor.getYesterdayTopAuthors( appViewModel.language, RESULT_COUNT, function(response) { if (response != null) { self.onSuccess(response); } } ); } } , template: `<div class="mdl-card mdl-card-border mdl-cell mdl-cell--4-col-tablet mdl-cell--3-col pratilipi-author-leaderboard"data-bind="visible: isLoaded"><h6 class="material-title" style="font-size:24px !important; text-align:center; margin-bottom:0px">Top Author</h6><span data-bind="text:subHeading()" style="font-size:12px; text-align:center;"></span><div class="padding-zero" style="margin:8px 0px !important"><hr class="margin-zero"></div><ul class="mdl-list author-leaderboard-ul" data-bind="foreach:yesterdayTopAuthors"><li class="mdl-list__item" data-bind="attr: { 'href': pageUrl}, click: $parent.listItemClicked"style="position:relative;"><span data-bind="text: ($index()+1)+'.'" style="padding: 5px;"> </span><div><img class="mdl-list__item-avatar"data-bind="attr: { 'src': imageUrl, 'alt': name}"/></div><div style="padding: 0px 10px; width:45%"><div class="font-m author-name" data-bind="text: name"></div><!--<div>--><!--<span class="meta-holder reads-holder">--><!--<span class="material-body-1" data-bind="text: readCount"></span>--><!--<i class="material-icons material-body-1">remove_red_eye</i>--><!--</span>--><!--</div>--></div><button data-bind="click: $parent.sharePratilipi"class="mdl-button mdl-js-button mdl-button-margin small-button share-button"><i class="material-icons">share</i></button></li></ul><span style="font-size:14px; padding:5px">*Share your content to increase read count</span></div>` }); </script> <script> ko.components.register( 'pratilipi-write', { viewModel: function( params ) { var self = this; this.title = ko.observable( '' ); this.titleEn = ko.observable( '' ); this.type = ko.observable( null ); this.agreedTerms = ko.observable( false ); this.requestOnFlight = ko.observable( false ); this.submit = function() { if( self.requestOnFlight() ) return; if( self.title().trim() == "" ) { ToastUtil.toast( "ದಯವಿಟ್ಟು ಶೀರ್ಷಿಕೆಯನ್ನು ನಮೂದಿಸಿ" ); return; } if( self.type() == null || self.type().trim() == "" ) { ToastUtil.toast( "ದಯವಿಟ್ಟು ಪ್ರಭೇದವನ್ನು ಆಯ್ಕೆಮಾಡಿಕೊಳ್ಳಿ" ); return; } if( ! self.agreedTerms() ) { ToastUtil.toast( "ದಯವಿಟ್ಟು ಕೃತಿಸ್ವಾಮ್ಯ ನೀತಿ ಹಾಗೂ ಸೇವಾ ನಿಯಮಗಳಿಗೆ ಒಪ್ಪಿಗೆ ನೀಡಿ" ); return; } var successCallBack = function( pratilipi ) { ToastUtil.toastUp( "ಯಶಸ್ವಿ!" ); window.location.href = pratilipi.writePageUrl; }; var errorCallBack = function( error, status ) { ToastUtil.toast( error.message != null ? error.message : "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!" ); self.requestOnFlight( false ); }; ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); self.requestOnFlight( true ); var pratilipi = { "title": self.title(), "titleEn": self.titleEn(), "language": "KANNADA", "type": self.type(), "state": "DRAFTED" }; if( appViewModel.pratilipiWriteAuthorId() != null ) pratilipi[ "authorId" ] = appViewModel.pratilipiWriteAuthorId(); var dataAccessor = new DataAccessor(); dataAccessor.createOrUpdatePratilipi( pratilipi, successCallBack, errorCallBack ); }; this.updateType = function() { self.type( document.querySelector( '#pratilipiWrite #pratilipi_write_type' ).getAttribute( "data-val" ) ); }; this.canCreatePratilipi = ko.computed( function() { return self.title() != null && self.title() != "" && self.agreedTerms() && self.type() != null && ! self.requestOnFlight(); }, this ); $( "#pratilipiWrite" ).on( 'hidden.bs.modal', function(e) { appViewModel.pratilipiWriteAuthorId( null ); self.title( null ); self.titleEn( null ); self.type( null ); self.agreedTerms( false ); $( '#pratilipiWrite #agree-terms-conditions' ).parent().removeClass( "is-checked" ); $( '#pratilipiWrite #pratilipi_write_type' ).attr( "data-val", null ); $( '#pratilipiWrite #pratilipi_write_type' ).attr( "value", null ); $( '#pratilipiWrite #pratilipi_write_type' ).val( null ); $( '#pratilipiWrite #pratilipi_write_type' ).parent().removeClass("is-dirty"); getmdlSelect.init( ".getmdl-select" ); }); } , template: `<div class="modal fade pratilipi-write" id="pratilipiWrite" tabindex="-1" role="dialog" aria-labelledby="pratilipi-write"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><span data-dismiss="modal" aria-label="Close" class="material-icons close">close</span><h6 class="material-title">ಶೀರ್ಷಿಕೆ ಸೇರಿಸಿ</h6></div><div class="modal-body"><div class="mdl-textfield mdl-js-textfield getmdl-select getmdl-select__fullwidth getmdl-select__fix-height mdl-textfield--floating-label"><input class="mdl-textfield__input"id="pratilipi_write_language"data-val="KANNADA"value="ಕನ್ನಡ"type="text" readonly tabIndex="-1" /><label class="mdl-textfield__label" for="pratilipi_write_language">ಭಾಷೆ<i class="material-icons dropdown-icon">arrow_drop_down</i></label><ul class="mdl-menu mdl-menu--bottom-left mdl-js-menu dropdown-ul" for="pratilipi_write_language"><a class="mdl-menu__item" href="https://hindi.pratilipi.com/?action=write">हिंदी</a><a class="mdl-menu__item" href="https://gujarati.pratilipi.com/?action=write">ગુજરાતી</a><a class="mdl-menu__item" href="https://tamil.pratilipi.com/?action=write">தமிழ்</a><a class="mdl-menu__item" href="https://marathi.pratilipi.com/?action=write">मराठी</a><a class="mdl-menu__item" href="https://malayalam.pratilipi.com/?action=write">മലയാളം</a><a class="mdl-menu__item" href="https://bengali.pratilipi.com/?action=write">বাংলা</a><a class="mdl-menu__item" href="https://telugu.pratilipi.com/?action=write">తెలుగు</a><li class="mdl-menu__item" style="background: #eee;">ಕನ್ನಡ</li></ul></div><input data-bind="{ mdlFloatingInput: { label: 'ಇಲ್ಲಿ ಶೀರ್ಷಿಕೆ ನಮೂದಿಸಿ *', value: title, id: 'pratilipi_write_title_input' }, valueUpdate: ['input'], transliterate: true }" /><div class="clearfix"></div><input data-bind="mdlFloatingInput: { label: 'ಆಂಗ್ಲ ಭಾಷೆಯಲ್ಲಿ ಶೀರ್ಷಿಕೆಯನ್ನು ಮರು-ನಮೂದಿಸಿ', value: titleEn, id: 'pratilipi_write_title_en_input' }" /><div class="mdl-textfield mdl-js-textfield getmdl-select getmdl-select__fullwidth getmdl-select__fix-height mdl-textfield--floating-label"><input data-bind="event: { change: updateType }"class="mdl-textfield__input"id="pratilipi_write_type"type="text" readonly /><label class="mdl-textfield__label" for="pratilipi_write_type">ವಿಧ ಆರಿಸಿಕೊಳ್ಳಿ*<i class="material-icons dropdown-icon">arrow_drop_down</i></label><ul class="mdl-menu mdl-menu--bottom-left mdl-js-menu dropdown-ul" for="pratilipi_write_type"><li class="mdl-menu__item" data-val="POEM">ಕವಿತೆ</li><li class="mdl-menu__item" data-val="STORY">ಕಥೆ</li><li class="mdl-menu__item" data-val="ARTICLE">ಲೇಖನ</li></ul></div><div class="accept-terms"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect terms-conditions" for="agree-terms-conditions"><input data-bind="checked: agreedTerms" type="checkbox" id="agree-terms-conditions" class="mdl-checkbox__input" /><span class="mdl-checkbox__label font-s">ನಾನು ಕೃತಿಸ್ವಾಮ್ಯ ನೀತಿ ಹಾಗೂ ಸೇವಾ ನಿಯಮಗಳನ್ನು ಒಪ್ಪಿಕೊಳ್ಳುತ್ತೇನೆ</span></label><a class="font-s" target="_blank" href="/terms-of-service">ಕೃತಿಸ್ವಾಮ್ಯ ನೀತಿಯನ್ನು ಇಲ್ಲಿ ಓದಿರಿ</a></div></div><div class="modal-footer"><button onclick="ga_CA( 'Pratilipi', 'Create' )"data-bind="{ click: submit, enable: canCreatePratilipi }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect font-m"type="button">ನಂತರ</button></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-myprofile-page', { viewModel: function() { var self = this; this.userObserver = ko.computed( function() { if( appViewModel.user.userId() == null ) return; setTimeout( function() { if( appViewModel.user.userId() != 0 ) redirect( appViewModel.user.profilePageUrl(), true ); else goToLoginPage( getUrlParameters() ); }, 0 ); }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.MY_PROFILE.ko_element ) { /* Dispose all observers */ self.locationObserver.dispose(); self.userObserver.dispose(); return; } appViewModel.currentLocation(); }, this ); } , template: `<div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mdl-card-border mobile-card"><!-- ko component: "pratilipi-loading-state" --><!-- /ko --></div>` }); </script> <script> ko.components.register( 'pratilipi-video-page', { viewModel: function pratilipiVideoPage(params) { var self = this; var dataAccessor = new DataAccessor(); var defaultVideo = { "videoId": null, "displayTitle": null, "imageUrl": null, "videoUrl": null, "videoEmbedUrl": null, "pageUrl": null, "description": null, "dateCreated": null }; this.initialDataLoaded = ko.observable(); this.video = ko.mapping.fromJS( defaultVideo, {}, self.video ); this.updateVideo = function( video, initialiseObject ) { var updatedVideo = JSON.parse( JSON.stringify( initialiseObject ? defaultVideo : video ) ); if( initialiseObject && video != null ) { for( var key in video ) if( video.hasOwnProperty( key ) ) updatedVideo[ key ] = video[ key ]; } ko.mapping.fromJS( updatedVideo, {}, self.video ); }; this.previousVideo = ko.observable(); this.nextVideo = ko.observable(); this.otherVideosLoadingState = ko.observable(); this.otherVideosList = ko.observableArray(); this.updateOtherVideosList = function( otherVideosList ) { for( var i = 0; i < otherVideosList.length; i++ ) self.otherVideosList.push( ko.mapping.fromJS( otherVideosList[i] ) ); }; var _handleVideoResponse = function( response, statusCode ) { if( statusCode === 200 ) { self.updateVideo( response.data[0], true ); self.previousVideo( response.previous ); self.nextVideo( response.next ); self.initialDataLoaded( true ); /* Fetching other videos of the same category */ self.fetchAllVideoData(); /* MetaTagUtil */ MetaTagUtil.setMetaTagsForVideo( ko.mapping.toJS( self.video ) ); } else if( statusCode === 400 || statusCode === 404 ) { /* Invalid slug or Page Not Found */ appViewModel.currentView( LOCATION.PAGE_NOT_FOUND["ko_element"] ); } else if( statusCode === 500 ) { /* Server error */ appViewModel.currentView( LOCATION.SERVER_ERROR["ko_element"] ); } else { /* Unhandled error */ console.log( "UNHANDLED_ERROR :: " + response + " :: " + statusCode ); appViewModel.currentView( LOCATION.SERVER_ERROR["ko_element"] ); } }; var _handleAllVideoResponse = function( response, statusCode ) { if( statusCode === 200 ) { if( response.data.length > 0 ) { self.updateOtherVideosList( response.data ); self.otherVideosLoadingState( "LOADED" ); /* Resetting carousel position */ $('.pratilipi-video-carousel').scrollLeft(0); } else { self.otherVideosLoadingState( "LOADED_EMPTY" ); } } else { self.otherVideosLoadingState( "FAILED" ); } }; this.fetchInitialData = function() { dataAccessor.getVideo( window.location.pathname.split("/")[2], _handleVideoResponse ); }; this.fetchAllVideoData = function() { dataAccessor.getVideoOtherList( window.location.pathname.split("/")[2], 10, _handleAllVideoResponse ); }; /* Initialising */ this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.VIDEO.ko_element ) { /* Dispose all observers */ self.locationObserver.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { /* Initialising variables */ self.initialDataLoaded( false ); self.otherVideosLoadingState( "LOADING" ); /* Setting variables */ self.updateVideo( {}, true ); /* iframe doesn't load properly */ self.previousVideo( null ); self.nextVideo( null ); self.otherVideosList( [] ); /* Calling functions */ self.fetchInitialData(); }); }, this ); } , template: `<div data-bind="visible: ! initialDataLoaded()" class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mdl-card-border mobile-card"><!-- ko component: "pratilipi-loading-state" --><!-- /ko --></div><div class="pratilipi-video-page mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card" data-bind="visible: initialDataLoaded()"><div class="video-info-container"><div class="video-info-media-container"><!-- ko if: ( video.videoEmbedUrl() != null ) --><div class="iframe-container"><iframe data-bind="attr: { src: getYoutubeVideo( video.videoEmbedUrl() ) }"frameborder="0"allow="autoplay; encrypted-media"allowfullscreen></iframe></div><!-- /ko --></div><div class="video-info-description-container"><div data-bind="text: video.displayTitle()" class="material-title title-padding"></div><div data-bind="text: convertDate( video.dateCreated() )" class="material-body-1"></div><div class="previous-next-link-container"><a data-bind="visible: previousVideo() != null, attr: { href: previousVideo() }" class="previous-link">&lt; ಹಿಂದಿನ ವೀಡಿಯೊ</a><a data-bind="visible: nextVideo() != null, attr: { href: nextVideo() }" class="next-link">ಮುಂದಿನ ವೀಡಿಯೊ &gt;</a></div><div data-bind="html: video.description()" class="material-body-1"></div></div></div><div class="other-video-container" data-bind="visible: otherVideosLoadingState() == 'LOADING' || otherVideosLoadingState() == 'LOADED'"><div data-bind="visible: otherVideosLoadingState() == 'LOADING'" class="mdl-spinner-container"><span class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div><div class="mdl-grid" style="width: 100%; max-width: 100%; box-sizing: border-box; padding: 0;" data-bind="visible: otherVideosLoadingState() == 'LOADED'"><div class="mdl-cell mdl-cell--12-col material-title title-padding" style="margin: 0">ಇತರ ವೀಡಿಯೊಗಳು</div><ul class="pratilipi-video-carousel mdl-grid" data-bind="foreach: { data: otherVideosList, as: 'video' }, visible: otherVideosList().length > 0"><li class="pratilipi-video-card mdl-cell mdl-cell--4-col-desktop mdl-cell--4-col-tablet mdl-cell--12-col-phone"><div class="video-card"><a class="reco-container" data-bind="{style: {'background-image': 'url(' + video.hqImageUrl() + ')','background-repeat': 'no-repeat','background-size': 'cover','background-position': 'center center'},attr: {href: video.pageUrl()}}"></a><div data-bind="text: video.displayTitle()" class="pratilipi-title material-subtitle-1"></div></div></li></ul></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-event-list-page', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); this.eventList = ko.observableArray(); this.isLoading = ko.observable(); this.fetchEventList = function() { self.isLoading( true ); dataAccessor.getEventList( function( eventListResponse, status ) { self.isLoading( false ); if( status !== 200 ) appViewModel.currentView( LOCATION.SERVER_ERROR["ko_element"] ); else self.eventList( eventListResponse.eventList ); }); }; setTimeout(function() { self.fetchEventList(); MetaTagUtil.setMetaTagsForEvents(); }); /** * Facebook events */ this.triggerFacebookEvent = function(eventName, parentId) { switch (eventName) { case 'CLICKEVENT_EVENTLISTM_EVENTLIST': FacebookEventTriggerUtil.triggerFacebookEventByNameAndParentId('CLICKEVENT_EVENTLISTM_EVENTLIST', parentId); break; case 'LANDED_EVENTLISTM_EVENTLIST': FacebookEventTriggerUtil.triggerFacebookEventByName('LANDED_EVENTLISTM_EVENTLIST'); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; self.triggerFacebookEvent('LANDED_EVENTLISTM_EVENTLIST'); this.triggerEventClickEvent = function(event) { self.triggerFacebookEvent('CLICKEVENT_EVENTLISTM_EVENTLIST', event.eventId); return true; }; } , template: `<div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card pratilipi-event-list-page generic-list-page"><div class="load-more-container mdl-card-border material-heading"style="margin-top: 0;">ಕಾರ್ಯಕ್ರಮಗಳು</div><div data-bind="foreach: { data: eventList, as: 'event' }, visible: eventList().length > 0"class="mdl-grid pratilipi-list-grid js-pratilipi-list-grid mobile-card"><div class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><div class="event-container"><a class="event-cover-image"onclick="ga_CA( 'Event', 'Open' )"data-bind="attr: { 'alt': event.name, href: event.pageUrl },style: { backgroundImage: 'url(' + getImageUrl( event.bannerImageUrl, 500 ) + ')' },click: $parent.triggerEventClickEvent"></a><div class="event-meta-container"><a class="material-title event-title"onclick="ga_CA( 'Event', 'Open' )"data-bind="text: event.name, attr: { 'alt': event.name, href: event.pageUrl }"></a><a data-bind="{ attr: { 'href': event.pageUrl } }"onclick="ga_CA( 'Event', 'Open' )"target="_blank"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect small-button pull-right"><i class="material-icons" style="font-size: 20px;">open_in_new</i></a></div></div></div></div><div class="load-more-container mdl-card-border text-center" data-bind="visible: isLoading()"><span data-bind="visible: eventList().length > 0" class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span><pratilipi-loading-state data-bind="visible: eventList().length == 0"></pratilipi-loading-state></div></div>` }); </script> <script> ko.components.register( 'pratilipi-pratilipi-page', { viewModel: function() { var self = this; var defaultPratilipi = { "pratilipiId": null, "title": null, "titleEn": null, "language": null, "author": { "authorId": null,"name": null, "pageUrl": null }, "summary": null, "pageUrl": null, "coverImageUrl": null, "readPageUrl": null, "writePageUrl": null, "type": null, "state": null, "listingDateMillis": null, "wordCount": null, "reviewCount": null, "ratingCount": null, "averageRating": null, "readCount": null, "readingTime" : null, "fbLikeShareCount": null, "hasAccessToUpdate": false, "tags": null, "suggestedTags": null, "userPratilipi": null }; var defaultUserPratilipi = { "userPratilipiId": null, "userId": null, "pratilipiId": null, "userName": null, "userImageUrl": null, "userProfilePageUrl": null, "rating": 0, "review": null, "reviewState": null, "addedToLib": false, "hasAccessToReview": true, "isLiked": false, }; this.pratilipi = ko.mapping.fromJS( defaultPratilipi, {}, self.pratilipi ); this.userPratilipi = ko.mapping.fromJS( defaultUserPratilipi, {}, self.userPratilipi ); this.recommendationLoadFailed = ko.observable( false ); this.updatePratilipi = function( pratilipi, initialiseObject ) { var updatedPratilipi = JSON.parse( JSON.stringify( initialiseObject ? defaultPratilipi : pratilipi ) ); if( initialiseObject && pratilipi != null ) { if( pratilipi.summary != null && pratilipi.summary.trim() == "" ) pratilipi.summary = null; for( var key in pratilipi ) if( pratilipi.hasOwnProperty( key ) ) updatedPratilipi[ key ] = pratilipi[ key ]; if( pratilipi.author != null ) { for( var key in pratilipi.author ) if( pratilipi.author.hasOwnProperty( key ) ) updatedPratilipi.author[ key ] = pratilipi.author[ key ]; } } ko.mapping.fromJS( updatedPratilipi, {}, self.pratilipi ); MetaTagUtil.setMetaTagsForPratilipi( ko.mapping.toJS( self.pratilipi ) ); }; this.updateUserPratilipi = function( userPratilipi, initialiseObject ) { var updatedUserPratilipi = JSON.parse( JSON.stringify( initialiseObject ? defaultUserPratilipi : userPratilipi ) ); if( initialiseObject && userPratilipi != null ) { if( userPratilipi.rating == null ) userPratilipi.rating = 0; if( userPratilipi.review != null && userPratilipi.review.trim() == "" ) userPratilipi.review = null; if( userPratilipi.reviewState != null && userPratilipi.reviewState != "PUBLISHED" ) userPratilipi.review = null; for( var key in userPratilipi ) if( userPratilipi.hasOwnProperty( key ) ) updatedUserPratilipi[ key ] = userPratilipi[ key ]; } ko.mapping.fromJS( updatedUserPratilipi, {}, self.userPratilipi ); }; /* Load initial data */ this.initialDataLoaded = ko.observable( false ); var _handleDataAccessorResponse = function( pratilipi, userPratilipi, statusCode ) { if( statusCode === 200 ) { self.updatePratilipi( pratilipi, true ); self.updateUserPratilipi( userPratilipi, true ); self.triggerFacebookEvent('LANDED_BOOKM_BOOK'); if( !self.initialDataLoaded() ) self.initialDataLoaded( true ); } else if( statusCode === 401 || statusCode === 403 ) { /* Guest user or logged in user(non-author) not allowed to view content */ appViewModel.currentView( LOCATION.DRAFTS_ACCESS_ERROR["ko_element"] ); } else if( statusCode === 400 || statusCode === 404 ) { /* Invalid slug/pratilipiId or Page Not Found */ appViewModel.currentView( LOCATION.PAGE_NOT_FOUND["ko_element"] ); } else if( statusCode === 500 ) { /* Server error */ appViewModel.currentView( LOCATION.SERVER_ERROR["ko_element"] ); } else { /* Unhandled error */ console.log( "UNHANDLED_ERROR :: " + pratilipi + " :: " + userPratilipi + " :: " + statusCode ); appViewModel.currentView( LOCATION.SERVER_ERROR["ko_element"] ); } }; this.fetchPratilipiAndUserPratilipi = function() { var dataAccessor = new DataAccessor(); if( window.location.pathname.startsWith( "/story/" ) ) { dataAccessor.getPratilipiBySlug( window.location.pathname.split("/")[2], true, _handleDataAccessorResponse ); } else { dataAccessor.getPratilipiByUri( window.location.pathname, true, _handleDataAccessorResponse ); } }; /* Landing from Search page */ var searchQuery = getUrlParameter( "searchQuery" ) != null ? decodeURIComponent( getUrlParameter( "searchQuery" ) ) : null; this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.PRATILIPI.ko_element ) { if( appViewModel.currentView() == LOCATION.SEARCH_V2.ko_element && searchQuery != null ) { setTimeout( function() { appViewModel.searchQuery( searchQuery ); }, 50 ); } /* Dispose all observers */ self.locationObserver.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { self.initialDataLoaded( false ); self.fetchPratilipiAndUserPratilipi(); /* Hack remove delete modal forcibly */ $( '.modal' ).modal( 'hide' ); $( 'body' ).removeClass( 'modal-open' ); $( '.modal-backdrop' ).remove(); }, 0 ); }, this ); /** * Facebook events */ this.triggerFacebookEvent = function (eventName) { switch (eventName) { case 'LANDED_BOOKM_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNameExperimentIdAndPratilipi('LANDED_BOOKM_BOOK', 'CONTROL', self.pratilipi ); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; } , template: `<div data-bind="visible: ! initialDataLoaded()" class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mdl-card-border mobile-card"><!-- ko component: "pratilipi-loading-state" --><!-- /ko --></div><div data-bind="visible: initialDataLoaded()" style="flex-grow: 1; width: 100%;"><!-- ko component: {name: "pratilipi-edit-pratilipi",params: { pratilipi: pratilipi,updatePratilipi: $data.updatePratilipi }} --><!-- /ko --><!-- ko component: {name: "pratilipi-pratilipi-info",params: { pratilipi: pratilipi,userPratilipi: userPratilipi,updatePratilipi: $data.updatePratilipi,updateUserPratilipi: $data.updateUserPratilipi }} --><!-- /ko --><!-- ko component: {name: "pratilipi-review-list",params: { pratilipi: pratilipi,userPratilipi: userPratilipi,updatePratilipi: $data.updatePratilipi,updateUserPratilipi: $data.updateUserPratilipi }} --><!-- /ko --><!-- ko if: pratilipi.state() == 'PUBLISHED' --><div data-bind="visible: !recommendationLoadFailed()" class="mdl-card mdl-card-border mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><!-- ko component: {name: "pratilipi-recommendation-carousel",params: { pratilipiId: pratilipi.pratilipiId, context: 'summaryPage', pratilipi: pratilipi, recommendationLoadFailed: recommendationLoadFailed }} --><!-- /ko --></div><!-- /ko --></div>` }); </script> <script> ko.components.register( 'pratilipi-login-component', { viewModel: function pratilipiLoginComponent(params) { var self = this; var dataAccessor = new DataAccessor(); /* UI Bindings */ this.email = ko.observable(); this.emailInvalidMessage = ko.observable(); this.name = ko.observable(); this.nameInvalidMessage = ko.observable(); this.password = ko.observable(); this.passwordInvalidMessage = ko.observable(); this.isAgreedToTerms = ko.observable(); /* Common / Incorrect message at the bottom */ this.errorMessage = ko.observable(); /* Action Bindings */ /* 5 types of screen 1. PRE_LOGIN 2. LOGIN 3. REGISTER 4. RESET_PASSWORD 5. ADD_PASSWORD */ var ScreenEnum = { PRE_LOGIN: 'PRE_LOGIN', LOGIN: 'LOGIN', REGISTER: 'REGISTER', RESET_PASSWORD: 'RESET_PASSWORD', ADD_PASSWORD: 'ADD_PASSWORD' }; this.screen = ko.observable(); this.autoFocus = ko.observable(); this.requestOnFlight = ko.observable( false ); /* Common functions to screens */ self._canSendAJAXCall = function( fields ) { /* requestOnFlight => Straight false */ if( self.requestOnFlight() ) return false; var isValid = true; if( fields ) { /* Email check */ if( fields.indexOf( 'email' ) !== -1 ) { /* Empty email field */ if( self.email() == null || self.email().trim() == "" ) { self.emailInvalidMessage( "ದಯವಿಟ್ಟು ನಿಮ್ಮ ಇಮೇಲ್ ನಮೂದಿಸಿ" ); isValid = false; } /* valid email */ if( ! validateEmail( self.email() ) ) { self.emailInvalidMessage( "ದಯವಿಟ್ಟು ಸರಿಯಾಗಿರುವ ಇಮೇಲ್'ಅನ್ನು ನಮೂದಿಸಿ" ); isValid = false; } } /* Password check */ if( fields.indexOf( 'password' ) !== -1 ) { /* Empty password field */ if( self.password() == null || self.password().trim() == "" ) { self.passwordInvalidMessage( "ದಯವಿಟ್ಟು ನಿಮ್ಮ ಪಾಸ್ವರ್ಡ್ ನಮೂದಿಸಿ" ); isValid = false; } /* valid password */ if( ! validatePassword( self.password() ) ) { self.passwordInvalidMessage( "Password must contain at least 6 characters, no spaces" ); isValid = false; } } /* Name check */ if( fields.indexOf( 'name' ) !== -1 ) { /* Empty name field */ if( self.name() == null || self.name().trim() == "" ) { self.nameInvalidMessage( "ದಯವಿಟ್ಟು ನಿಮ್ಮ ಹೆಸರನ್ನು ನಮೂದಿಸಿ" ); isValid = false; } } /* isAgreedToTerms check */ if( fields.indexOf( 'isAgreedToTerms' ) !== -1 ) { if( ! self.isAgreedToTerms() ) { self.errorMessage( "Please agree to our terms and conditions" ); isValid = false; } } } return isValid; }; this._errorHandler = function( error, statusCode ) { /* 400 */ if( statusCode === 400 ) { var errType = error.error && error.error.length > 0 && error.error[0].type; switch( errType ) { case 'ERR_EMAIL_REQUIRED': self.emailInvalidMessage( "Email Required" ); break; case 'ERR_EMAIL_INVALID': self.emailInvalidMessage( "ದಯವಿಟ್ಟು ಸರಿಯಾಗಿರುವ ಇಮೇಲ್'ಅನ್ನು ನಮೂದಿಸಿ" ); break; case 'ERR_EMAIL_NOT_REGISTERED': var params = getUrlParameters(); params['email'] = encodeURIComponent( self.email() ); params['screen'] = ScreenEnum.REGISTER; redirect( window.location.pathname + '?' + new HttpUtil().formatParams( params ) ); break; case 'ERR_EMAIL_REGISTERED_ALREADY': var params = getUrlParameters(); params['email'] = encodeURIComponent( self.email() ); params['screen'] = ScreenEnum.LOGIN; redirect( window.location.pathname + '?' + new HttpUtil().formatParams( params ) ); setTimeout(function() { self.errorMessage( "The email id is already associated with an account. Please enter password to continue." ); }, 100); break; case 'ERR_PASSWORD_REQUIRED': self.passwordInvalidMessage( "Password Required" ); break; case 'ERR_PASSWORD_INVALID': self.passwordInvalidMessage( "Password must contain at least 6 characters, no spaces" ); break; case 'ERR_PASSWORD_INCORRECT': self.errorMessage( "Password is not correct." ); break; case 'ERR_PASSWORD_NOT_FOUND': var params = getUrlParameters(); params['email'] = encodeURIComponent( self.email() ); params['screen'] = ScreenEnum.ADD_PASSWORD; redirect( window.location.pathname + '?' + new HttpUtil().formatParams( params ) ); self.errorMessage( "Password is not set for your account. Please login through google / facebook." ); break; case 'ERR_NAME_REQUIRED': self.nameInvalidMessage( "Name Required" ); break; case 'ERR_TOKEN_EXPIRED': case 'ERR_TOKEN_INVALID': /* TODO: Implementation */ self.errorMessage( "Token is invalid." ); break; default: console.log( 'ERROR_NOT_HANDLED :: ' + JSON.stringify( error ) + " :: " + statusCode ); self.errorMessage( ( error && error.message ) ? error.message : ( error || "Some exception occured at the server. Please try again!" ) ); break; } /* Invalid accessToken (or) user already logged in (or) user blocked */ } else if( statusCode === 401 || statusCode === 403 ) { if( error.type === "ERR_LOGGED_IN_ALREADY" ) { self.errorMessage( "You are already logged in." ); } else if( error.type === "ERR_USER_BLOCKED" ) { self.errorMessage( "You are blocked. Please write to kannada@pratilipi.com to re-activate your account!" ); /* AccessToken invalid */ /* TODO: Remove message check */ } else if( error.message === "Access Token is invalid" ) { self.errorMessage( "Your session got expired. Please reload!" ); /* Error Message from server */ } else { console.log( 'ERROR_NOT_HANDLED :: ' + JSON.stringify( response ) + " :: " + statusCode ); self.errorMessage( ( error && error.message ) ? error.message : ( error || "Some exception occured at the server. Please try again!" ) ); } /* Internal server error */ } else if( statusCode >= 500 ) { self.errorMessage( "Some exception occured at the server. Please try again!" ); /* Unhandled error */ } else { console.log( 'ERROR_NOT_HANDLED :: ' + response + " :: " + statusCode ); self.errorMessage( ( error && error.message ) ? error.message : ( error || "Some exception occured at the server. Please try again!" ) ); } }; /* Pre-Login */ this.preLoginButtonEnabled = ko.computed( function() { return ! self.requestOnFlight(); }, this ); this.preLoginButtonClick = function() { if( ! self._canSendAJAXCall( ['email'] ) ) return false; /* Making AJAX request */ self.requestOnFlight( true ); dataAccessor.preLoginUserV2( self.email(), function( response, statusCode ) { self.requestOnFlight( false ); if( statusCode === 200 ) { var params = getUrlParameters(); params['email'] = encodeURIComponent( self.email() ); params['screen'] = response.isValid ? ScreenEnum.LOGIN : ScreenEnum.REGISTER; redirect( window.location.pathname + '?' + new HttpUtil().formatParams( params ) ); /* Error handler */ } else { self._errorHandler( response, statusCode ); } } ); }; this.facebookLoginClick = function() { if( ! self._canSendAJAXCall() ) return false; FB.login( function( fbResponse ) { if( fbResponse == null || fbResponse.authResponse == null ) { self.requestOnFlight( false ); return false; } self.requestOnFlight( true ); dataAccessor.facebookLoginUserV2( fbResponse.authResponse.accessToken, function( response, statusCode ) { self.requestOnFlight( false ); window.location.href = statusCode === 201 ? '/me' : getRetUrl( true ); }, function( error, statusCode ) { self.requestOnFlight( false ); self._errorHandler( error, statusCode ); }); }, { scope: 'public_profile,email,user_birthday' } ); }; this.googleLoginClick = function() { if( ! self._canSendAJAXCall() ) return false; gapi.auth2.getAuthInstance().signIn().then( function( googleUser ) { self.requestOnFlight( true ); dataAccessor.googleLoginUserV2( googleUser.getAuthResponse().id_token, function( response, statusCode ) { self.requestOnFlight( false ); window.location.href = statusCode === 201 ? '/me' : getRetUrl( true ); }, function( error, statusCode ) { self.requestOnFlight( false ); self._errorHandler( error, statusCode ); }); }, function( error ) { console.log( JSON.stringify( error ) ); if( error.error === "popup_closed_by_user" ) { } self.requestOnFlight( false ); }); }; /* Login */ this.loginButtonEnabled = ko.computed( function() { return ! self.requestOnFlight(); }, this ); this.loginButtonClick = function() { if( ! self._canSendAJAXCall( ['email', 'password'] ) ) return false; /* Making AJAX request */ self.requestOnFlight( true ); dataAccessor.loginUserV2( self.email(), self.password(), function( response ) { self.requestOnFlight( false ); window.location.href = getRetUrl( true ); }, function( error, statusCode ) { self.requestOnFlight( false ); self._errorHandler( error, statusCode ); } ); }; this.forgotPasswordClick = function() { if( ! self._canSendAJAXCall( ['email'] ) ) return false; /* Making AJAX request */ self.requestOnFlight( true ); dataAccessor.forgotPasswordV2( self.email(), function( response, statusCode ) { var timeout = 4000; ToastUtil.toast( "A link to reset your password has been sent to your email", timeout ); setTimeout( function() { self.requestOnFlight( false ); redirect( getRetUrl( true ) ); }, timeout ); }, function( error, statusCode ) { self.requestOnFlight( false ); self._errorHandler( error, statusCode ); } ); }; /* Register */ this.registerButtonEnabled = ko.computed( function() { return ! self.requestOnFlight(); }, this ); this.registerButtonClick = function() { if( ! self._canSendAJAXCall( ['email', 'name', 'password', 'isAgreedToTerms'] ) ) return false; /* Making AJAX request */ self.requestOnFlight( true ); dataAccessor.registerUserV2( self.name(), self.email(), self.password(), function( response, statusCode ) { self.requestOnFlight( false ); window.location.href = statusCode === 201 ? '/me' : getRetUrl( true ); }, function( error, statusCode ) { self.requestOnFlight( false ); self._errorHandler( error, statusCode ); } ); }; /* Password Reset */ this.passwordResetButtonEnabled = ko.computed( function() { return ! self.requestOnFlight(); }, this ); this.passwordResetButtonClick = function() { if( ! self._canSendAJAXCall( ['password'] ) ) return false; /* Making AJAX request */ self.requestOnFlight( true ); dataAccessor.resetPasswordWithTokenV2( getUrlParameter( 'token' ), self.password(), function( response, statusCode ) { self.requestOnFlight( false ); window.location.href = getRetUrl( true ); }, function( error, statusCode ) { self.requestOnFlight( false ); self._errorHandler( error, statusCode ); } ); }; /* Password Add */ this.passwordAddButtonEnabled = ko.computed( function() { return ! self.requestOnFlight(); }, this ); this.passwordAddButtonClick = function() { if( ! self._canSendAJAXCall( ['email'] ) ) return false; /* Making AJAX request */ self.requestOnFlight( true ); dataAccessor.forgotPasswordV2( self.email(), function( response, statusCode ) { var timeout = 4000; ToastUtil.toast( "A link to reset your password has been sent to your email", timeout ); setTimeout( function() { self.requestOnFlight( false ); redirect( getRetUrl( true ) ); }, timeout ); }, function( error, statusCode ) { self.requestOnFlight( false ); self._errorHandler( error, statusCode ); } ); }; /* Computed Observables */ /* Hide errorMessage when user starts correcting her mistake */ this.errorMessageObserver = ko.computed( function() { self.email(); self.password(); self.name(); self.isAgreedToTerms(); self.screen(); setTimeout( function() { if( self.errorMessage() != null ) self.errorMessage( null ); }); }, this ); this.emailInvalidMessageObserver = ko.computed( function() { self.email(); setTimeout( function() { if( self.emailInvalidMessage() == null ) return false; if( self.email().trim() == "" ) self.emailInvalidMessage( "Email Required" ); else if( ! validateEmail( self.email() ) ) self.emailInvalidMessage( "ದಯವಿಟ್ಟು ಸರಿಯಾಗಿರುವ ಇಮೇಲ್'ಅನ್ನು ನಮೂದಿಸಿ" ); else self.emailInvalidMessage( null ); }); }, this ); this.passwordInvalidMessageObserver = ko.computed( function() { self.password(); setTimeout( function() { if( self.passwordInvalidMessage() == null ) return false; if( validatePassword( self.password() ) ) self.passwordInvalidMessage( null ); }); }, this ); this.nameInvalidMessageObserver = ko.computed( function() { self.name(); setTimeout( function() { if( self.nameInvalidMessage() == null ) return false; if( self.name().trim() !== "" ) self.nameInvalidMessage( null ); }); }, this ); /* Screen Observer */ this.screenObserver = ko.computed( function() { self.screen(); setTimeout( function() { switch( self.screen() ) { case ScreenEnum.PRE_LOGIN: if( self.email().trim() === "" ) self.autoFocus('email'); else self.autoFocus( null ); break; case ScreenEnum.LOGIN: if( self.email().trim() === "" ) self.autoFocus( "email" ); else if( self.password().trim() === "" ) self.autoFocus( "password" ); else self.autoFocus( null ); break; case ScreenEnum.REGISTER: if( self.email().trim() === "" ) self.autoFocus( "email" ); else if( self.name().trim() === "" ) self.autoFocus( "name" ); else if( self.password().trim() === "" ) self.autoFocus( "password" ); else self.autoFocus( null ); break; case ScreenEnum.RESET_PASSWORD: if( self.password().trim() === "" ) self.autoFocus( "password" ); else self.autoFocus( null ); break; case ScreenEnum.ADD_PASSWORD: self.autoFocus( null ); break; } }); }, this ); /* userObservser - logged in user */ this.userObservser = ko.computed( function() { if( appViewModel.user.userId() == null || appViewModel.user.userId() === 0 ) return false; setTimeout( function() { ToastUtil.toastUp( "<a href='" + getRetUrl( true ) + "'>ನೀವು ಈಗಾಗಲೇ ಲಾಗಿನ್ ಆಗಿರುವಿರಿ, ಹಿಂದಕ್ಕೆ ಹೋಗಲು ದಯವಿಟ್ಟು ಇಲ್ಲಿ ಕ್ಲಿಕ್ ಮಾಡಿ!</a>" ); }, 0 ); }, this ); /* Initialising */ this.locationObserver = ko.computed( function() { appViewModel.currentLocation(); setTimeout( function() { if( appViewModel.currentView() != LOCATION.LOGIN_V2.ko_element ) { /* Dispose all observers */ self.userObservser.dispose(); self.errorMessageObserver.dispose(); self.screenObserver.dispose(); self.locationObserver.dispose(); } else { /* Reset All Fields */ self.email( getUrlParameter( 'email' ) ? decodeURIComponent( getUrlParameter( 'email' ) ) : "" ); self.name( "" ); self.password( "" ); self.isAgreedToTerms( false ); self.errorMessage( null ); self.screen( ScreenEnum[ getUrlParameter( 'screen' ) ] ? getUrlParameter( 'screen' ) : "PRE_LOGIN" ); } }); }, this ); } , template: `<div class="pratilipi-login-component"><!-- First screen - pre login screen --><div class="pre-login-screen" data-bind="css: { 'is-active': screen() == 'PRE_LOGIN' }"><span class="sprites-icon pratilipi-logo-icon"></span><div class="screen-heading-text material-title">Welcome to Pratilipi</div><div class="form-container social-login-container"><button type="submit" data-bind="{ enable: ! requestOnFlight(), click: facebookLoginClick }" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect login-button fb-login"><span class="sprites-icon login-sprite-icon-24 facebook-login-icon"></span><span class="material-button social-login-title">Continue with Facebook</span></button><button type="submit" data-bind="{ enable: ! requestOnFlight(), click: googleLoginClick }" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect login-button google-login"><span class="sprites-icon login-sprite-icon-24 google-login-icon"></span><span class="material-button social-login-title">Continue with Google</span></button></div><p class="login-or margin-zero">or</p><div class="form-container email-login-container"><form><input type="email" data-bind="{ value: email, valueUpdate: ['input'], hasFocus: autoFocus() === 'email' }" class="material-button login-input" placeholder="Email" /><span data-bind="{ text: emailInvalidMessage() || ' ' }" class="error-message font-xs"></span><button type="submit" data-bind="{ enable: preLoginButtonEnabled, click: preLoginButtonClick }" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect login-button"><span class="material-button button-text">Continue</span><i class="material-icons">arrow_forward</i></button></form><span data-bind="{ text: errorMessage() || ' ' }" class="common-error-message font-xs"></span></div></div><!-- Second screen - login with email screen --><div class="login-screen" data-bind="css: { 'is-active': screen() == 'LOGIN' }"><div class="screen-heading-text material-title">Login to Pratilipi</div><div class="form-container"><form><input type="email" data-bind="{ value: email, valueUpdate: ['input'], hasFocus: autoFocus() === 'email' }" class="material-button login-input" placeholder="Email" /><span data-bind="{ text: emailInvalidMessage() || ' ' }" class="error-message font-xs"></span><input type="password" data-bind="{ value: password, valueUpdate: ['input'] , hasFocus: autoFocus() === 'password' }" class="material-button login-input" placeholder="Password" /><span data-bind="{ text: passwordInvalidMessage() || ' ' }" class="error-message font-xs"></span><button type="submit" data-bind="{ enable: loginButtonEnabled, click: loginButtonClick }" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect login-button"><span class="material-button button-text">Login</span></button></form><span data-bind="{ text: errorMessage() || ' ' }" class="common-error-message font-xs"></span></div><button data-bind="{ enable: ! requestOnFlight(), click: forgotPasswordClick }" class="forgot-password-button font-xs" type="submit">Forgot Password?</button></div><!-- Third screen - register with email screen --><div class="register-screen" data-bind="css: { 'is-active': screen() == 'REGISTER' }"><div class="screen-heading-text material-title">Sign Up for Pratilipi</div><div class="screen-description-text material-body-1">The email id you entered doesn't belong to an account. Please check your email id and try again or signup</div><div class="form-container"><form><input type="email" data-bind="{ value: email, valueUpdate: ['input'], hasFocus: autoFocus() === 'email' }" class="material-button login-input" placeholder="Email" /><span data-bind="{ text: emailInvalidMessage() || ' ' }" class="error-message font-xs"></span><input type="text" data-bind="{ value: name, valueUpdate: ['input'], hasFocus: autoFocus() === 'name' }" class="material-button login-input" placeholder="Full Name" /><span data-bind="{ text: nameInvalidMessage() || ' ' }" class="error-message font-xs"></span><input type="password" data-bind="{ value: password, valueUpdate: ['input'], hasFocus: autoFocus() === 'password' }" class="material-button login-input" placeholder="Password" /><span data-bind="{ text: passwordInvalidMessage() || ' ' }" class="error-message font-xs"></span><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect terms-conditions" for="agree-terms-conditions"><input type="checkbox" data-bind="checked: isAgreedToTerms" id="agree-terms-conditions" class="mdl-checkbox__input" /><span class="mdl-checkbox__label material-body-2 label-text">ನೋಂದಾಯಿಸಿಕೊಳ್ಳುವ ಮೂಲಕ ನೀವು ನಮ್ಮ <a href="/privacy-policy" target="_blank">ಗೌಪ್ಯತಾ ನೀತಿ</a> ಮತ್ತು <a href="/terms-of-service" target="_blank">ನಿಯಮಗಳಿಗೆ</a> ಒಪ್ಪಿಕೊಳ್ಳುತ್ತೀರಿ</span></label><button type="submit" data-bind="{ enable: registerButtonEnabled, click: registerButtonClick }" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect login-button"><span class="material-button button-text">Sign Up</span></button></form><span data-bind="{ text: errorMessage() || ' ' }" class="common-error-message font-xs"></span></div></div><!-- Fourth screen - reset password from email screen --><div class="reset-password-screen" data-bind="css: { 'is-active': screen() == 'RESET_PASSWORD' }"><div class="screen-heading-text material-title">Reset Password</div><div class="screen-description-text material-body-1">Enter new password for your account</div><div class="form-container"><form><input type="password" data-bind="{ value: password, valueUpdate: ['input'], hasFocus: autoFocus() === 'password' }" class="material-button login-input" placeholder="Password" /><span data-bind="{ text: passwordInvalidMessage() || ' ' }" class="error-message font-xs"></span><button type="submit" data-bind="{ enable: passwordResetButtonEnabled, click: passwordResetButtonClick }" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect login-button"><span class="material-button button-text">Reset</span></button></form><span data-bind="{ text: errorMessage() || ' ' }" class="common-error-message font-xs"></span></div></div><!-- Fifth screen - add password --><div class="add-password-screen" data-bind="css: { 'is-active': screen() == 'ADD_PASSWORD' }"><div class="screen-heading-text material-title">Login to Pratilipi</div><div class="screen-description-text material-body-1">You have logged in with a social account. Please login with social account or set a password to continue.</div><div class="form-container social-login-container"><button type="submit" data-bind="{ enable: ! requestOnFlight(), click: facebookLoginClick }" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect login-button fb-login"><span class="sprites-icon login-sprite-icon-24 facebook-login-icon"></span><span class="material-button social-login-title">Continue with Facebook</span></button><button type="submit" data-bind="{ enable: ! requestOnFlight(), click: googleLoginClick }" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect login-button google-login"><span class="sprites-icon login-sprite-icon-24 google-login-icon"></span><span class="material-button social-login-title">Continue with Google</span></button></div><p class="login-or margin-zero">or</p><div class="form-container email-login-container"><form><input type="email" data-bind="{ value: email, valueUpdate: ['input'], hasFocus: autoFocus() === 'email' }" class="material-button login-input" placeholder="Email" /><span data-bind="{ text: emailInvalidMessage() || ' ' }" class="error-message font-xs"></span><button type="submit" data-bind="{ enable: passwordAddButtonEnabled, click: passwordAddButtonClick }" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect login-button"><span class="material-button button-text">Set Password</span><i class="material-icons">arrow_forward</i></button></form><span data-bind="{ text: errorMessage() || ' ' }" class="common-error-message font-xs"></span></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-verify-user-page', { viewModel: function() { var dataAccessor = new DataAccessor(); this.requestOnFlight = ko.observable( true ); dataAccessor.verifyUser( getUrlParameter( "e" ), getUrlParameter( "t" ), function() { self.requestOnFlight( false ); ToastUtil.toastUp( "ಯಶಸ್ವಿ!" ); setTimeout( function() { window.location.href = "/"; }, 4000 ); }, function() { var message = "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!"; if( error.message != null ) message = error.message; ToastUtil.toastUp( message, 4000 ); self.requestOnFlight( false ); }); } , template: `<div class="pratilipi-login-page"><div class="pratilipi-login-container"><span class="sprites-icon pratilipi-logo-icon"></span><div class="pratilipi-heading material-title">ಇ-ಮೇಲ್ ಪರಿಶೀಲನೆ</div><div class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active" data-bind="visible: requestOnFlight()"></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-notification-settings', { viewModel: function( params ) { var self = this; var getEmailFrequencyVernacular = function( emailFrequency ) { switch( emailFrequency ) { case "IMMEDIATELY": return "ತಕ್ಷಣ"; case "DAILY": return "ಪ್ರತಿನಿತ್ಯ"; case "WEEKLY": return "ವಾರಕ್ಕೊಮ್ಮೆ"; case "MONTHLY": return "ತಿಂಗಳಿಗೊಮ್ಮೆ"; case "NEVER": return "ಬೇಡ"; } }; this.updateNotificationPreferences = function() { var userPreferences = {}; userPreferences[ "emailFrequency" ] = document.querySelector( "#pratilipiNotificationSettings #emailFrequency" ).getAttribute( "data-val" ); userPreferences[ "newsletterFrequency" ] = document.querySelector( "#pratilipiNotificationSettings #newsletterFrequency" ).getAttribute( "data-val" ); userPreferences[ "notificationSubscriptions" ] = {}; $( '#pratilipiNotificationSettings .mdl-js-checkbox' ).each( function( index, element ) { userPreferences[ "notificationSubscriptions" ][ element.firstChild.value ] = element.firstChild.checked; }); setUserPreferences( userPreferences ); ToastUtil.toast( "ಯಶಸ್ವಿ!" ); $( "#pratilipiNotificationSettings" ).modal( 'hide' ); }; this.firebaseCallback = ko.computed( function() { var userPreferences = appViewModel.userPreferences(); var emailFrequency = userPreferences[ "emailFrequency" ] != null ? userPreferences[ "emailFrequency" ] : "IMMEDIATELY"; var newsletterFrequency = userPreferences[ "newsletterFrequency" ] != null ? userPreferences[ "newsletterFrequency" ] : "DAILY"; var notificationSubscriptions = userPreferences[ "notificationSubscriptions" ] != null ? userPreferences[ "notificationSubscriptions" ] : {}; $( "#pratilipiNotificationSettings #emailFrequency" ).attr( 'data-val', emailFrequency ); $( "#pratilipiNotificationSettings #emailFrequency" ).attr( 'value', getEmailFrequencyVernacular( emailFrequency ) ); $( "#pratilipiNotificationSettings #newsletterFrequency" ).attr( 'data-val', newsletterFrequency ); $( "#pratilipiNotificationSettings #newsletterFrequency" ).attr( 'value', getEmailFrequencyVernacular( newsletterFrequency ) ); $( '#pratilipiNotificationSettings .mdl-js-checkbox' ).each( function( index, element ) { if( element.MaterialCheckbox == null ) return; var val = element.firstChild.value; if( notificationSubscriptions[ val ] != null && ! notificationSubscriptions[ val ] ) element.MaterialCheckbox.uncheck(); else element.MaterialCheckbox.check(); }); }, this ); } , template: `<div class="modal common-modal fade" id="pratilipiNotificationSettings" role="dialog" tabindex="-1"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button class="mdl-button mdl-js-button mdl-button--icon close" class="close" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button><h6 class="modal-title">ನೋಟಿಫಿಕೇಶನ್ ಸೆಟ್ಟಿಂಗ್ಸ್</h6></div><div class="modal-body"><div class="mdl-textfield mdl-js-textfield getmdl-select getmdl-select__fullwidth getmdl-select__fix-height mdl-textfield--floating-label"><input class="mdl-textfield__input"id="emailFrequency"data-val="IMMEDIATELY"value="ತಕ್ಷಣ"type="text" tabIndex="-1" /><label class="mdl-textfield__label" for="emailFrequency">ಇಮೇಲ್ ಫ್ರೀಕ್ವೆನ್ಸಿ</label><ul class="mdl-menu mdl-menu--bottom-left mdl-js-menu" for="emailFrequency"><li class="mdl-menu__item" data-val="IMMEDIATELY">ತಕ್ಷಣ</li><li class="mdl-menu__item" data-val="DAILY">ಪ್ರತಿನಿತ್ಯ</li><li class="mdl-menu__item" data-val="WEEKLY">ವಾರಕ್ಕೊಮ್ಮೆ</li><li class="mdl-menu__item" data-val="MONTHLY">ತಿಂಗಳಿಗೊಮ್ಮೆ</li><li class="mdl-menu__item" data-val="NEVER">ಬೇಡ</li></ul></div><div class="mdl-textfield mdl-js-textfield getmdl-select getmdl-select__fullwidth getmdl-select__fix-height mdl-textfield--floating-label"><input class="mdl-textfield__input"id="newsletterFrequency"data-val="DAILY"value="ಪ್ರತಿನಿತ್ಯ"type="text" tabIndex="-1" /><label class="mdl-textfield__label" for="newsletterFrequency">Newsletter Frequency</label><ul class="mdl-menu mdl-menu--bottom-left mdl-js-menu" for="newsletterFrequency"><li class="mdl-menu__item" data-val="DAILY">ಪ್ರತಿನಿತ್ಯ</li><!-- <li class="mdl-menu__item" data-val="WEEKLY">ವಾರಕ್ಕೊಮ್ಮೆ</li> --><li class="mdl-menu__item" data-val="NEVER">ಬೇಡ</li></ul></div><div class="settings-group"><h6>ಬರಹ</h6><div class="mdl-grid"><div class="mdl-cell mdl-cell--6-col mdl-cell--12-col-phone"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_new_review"><input value="USER_PRATILIPI_REVIEW" type="checkbox" id="notif_option_new_review" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">ಹೊಸ ಪ್ರತಿಕ್ರಿಯೆ</span></label></div><div class="mdl-cell mdl-cell--6-col mdl-cell--12-col-phone"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_new_comment"><input value="COMMENT_REVIEW_REVIEWER" type="checkbox" id="notif_option_new_comment" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">ಹೊಸ ಕಾಮೆಂಟ್</span></label></div><div class="mdl-cell mdl-cell--6-col mdl-cell--12-col-phone"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_like_review"><input value="VOTE_REVIEW_REVIEWER" type="checkbox" id="notif_option_like_review" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">ಪ್ರತಿಕ್ರಿಯೆಯ ಮೆಚ್ಚುಗೆ</span></label></div><div class="mdl-cell mdl-cell--6-col mdl-cell--12-col-phone"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_like_comment"><input value="VOTE_COMMENT_REVIEW_COMMENTOR" type="checkbox" id="notif_option_like_comment" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">ಕಾಮೆಂಟಿಗೆ ಹೊಸ ಮೆಚ್ಚುಗೆ</span></label></div></div></div><div class="settings-group"><h6>ನೆಟ್ವರ್ಕ್</h6><div class="mdl-grid"><div class="mdl-cell mdl-cell--6-col mdl-cell--12-col-phone"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_new_follower"><input value="AUTHOR_FOLLOW" type="checkbox" id="notif_option_new_follower" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">ಹೊಸ ಹಿಂಬಾಲಕರು</span></label></div><div class="mdl-cell mdl-cell--6-col mdl-cell--12-col-phone"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_pratilipi_published_follower"><input value="PRATILIPI_PUBLISHED_FOLLOWER" type="checkbox" id="notif_option_pratilipi_published_follower" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">ನೀವು ಹಿಂಬಾಲಿಸುತ್ತಿರುವ ವ್ಯಕ್ತಿಯ ಹೊಸ ಬರಹ</span></label></div><div class="mdl-cell mdl-cell--6-col mdl-cell--12-col-phone"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_pratilipi_updates"><input value="GENERIC" type="checkbox" id="notif_option_pratilipi_updates" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">ಪ್ರತಿಲಿಪಿ ಅಪ್ಡೇಟ್ಸ್ ಮತ್ತು ಆಫರ್ಸ್</span></label></div></div></div></div><div class="modal-footer"><button onclick="ga_CA( 'Notification', 'Update' )"data-bind="click: updateNotificationPreferences"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin"type="button">ಬದಲಾವಣೆಗಳನ್ನು ಸಂರಕ್ಷಿಸಿ</button></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-message-notification-list', { viewModel: function( params ) { var self = this; this.messageNotificationList = ko.observableArray(); this.hasMoreContents = ko.observable( false ); this.channelLastReadMessage = {}; this.fetchedChannelMetadataData = {}; this.pendingUnreadMessages = ko.observable(params.pendingUnreadMessages || false); this.unreadMessageNotifObserver = ko.computed( function() { debugger; if(appViewModel.pendingUnreadMessages == undefined) { appViewModel.pendingUnreadMessages = ko.observable(false); } if(self.messageNotificationList().length > 0) { appViewModel.pendingUnreadMessages(true); self.pendingUnreadMessages(true); } else { appViewModel.pendingUnreadMessages(false); self.pendingUnreadMessages(false); } }, this); this.loadChannelMessageNotifications = function(channelId) { self.firebaseGrowthDB.ref('/CHATS').child('channel_metadata').child(channelId).once('value').then(function(snapshot) { if(snapshot.val() == undefined) { /* TODO Something wrong */ } var userInChannel = false; var otherUserId = 0; var conversationDisplayName = ""; var conversationImageUrl = ""; $.each(snapshot.val().users, function(user, userDetails) { if(user == appViewModel.user.userId()) { userInChannel = true; } else { otherUserId = user; conversationDisplayName = userDetails.displayName; conversationImageUrl = userDetails.profileImageUrl; } console.log(user, userDetails); }); if(userInChannel != true) { /* TODO Something wrong */ return; } self.firebaseGrowthDB.ref('/CHATS').child('user_profile').child(otherUserId).once('value').then(function(snapshot) { if(snapshot.val() != undefined) { conversationDisplayName = snapshot.val().displayName; conversationImageUrl = snapshot.val().profileImageUrl; } var conversationImageUrlScaled = getImageUrl(conversationImageUrl,100); self.fetchedChannelMetadataData[channelId] = {'otherUserId' : otherUserId, conversationDisplayName : conversationDisplayName, conversationImageUrl : conversationImageUrlScaled}; self.attachLastReadListener(channelId); self.attachLastMessageListener(channelId); }); }); }; this.attachLastReadListener = function(channelId) { self.firebaseGrowthDB.ref('/CHATS').child('user_channels').child(appViewModel.user.userId()).child(channelId).child('lastReadMessage').on('value', function(snapshot) { self.channelLastReadMessage[channelId] = snapshot.val(); self.messageNotificationList.remove(function(item) { return (item.channelId == channelId && item.messageId == snapshot.val()); }); }); }; this.parseDateDisplay = function(sentTime) { var currentDate = new Date(); var currentDateStart = currentDate.setHours(0,0,0,0); var timeToDisplay = ""; var messageDate = new Date(sentTime); var messageDateKey = messageDate.toLocaleDateString(); if(+messageDate >= +currentDateStart) { timeToDisplay = new Date(sentTime).toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true }); } else { yesterdayDate = new Date(); yesterdayDate.setTime(currentDate.getTime() - (24*3600000)); var yesterdayDateStart = yesterdayDate.setHours(0,0,0,0); if(+messageDate >= +yesterdayDateStart) { timeToDisplay = "YESTERDAY"; } else { timeToDisplay = messageDateKey; } } return timeToDisplay; }; this.attachLastMessageListener = function(channelId) { var channelMessagesRef = self.firebaseGrowthDB.ref('/CHATS').child('messages').child(channelId).orderByKey(); if(self.channelLastReadMessage[channelId] != null) { channelMessagesRef = channelMessagesRef.startAt(self.channelLastReadMessage[channelId]); } channelMessagesRef.limitToLast(1).on('child_added', function(snapshot) { var message = snapshot.val(); console.log("Last message added : ",message, " for channel : ", channelId); self.messageNotificationList.remove(function(item) { return item.channelId == channelId; }); if((message.senderId == appViewModel.user.userId()) || (self.channelLastReadMessage[channelId] == snapshot.key)) { return; } var messageTimeDisplay = self.parseDateDisplay(message.sendTime); var messageReceived = {channelId : channelId, messageId : snapshot.key, userId : self.fetchedChannelMetadataData[channelId].otherUserId, channelName : self.fetchedChannelMetadataData[channelId].conversationDisplayName, profileImageUrl : self.fetchedChannelMetadataData[channelId].conversationImageUrl, senderId : message.senderId, lastMessage : message.messageText, lastMessageTime : message.sendTime, lastMessageTimeDisplay : messageTimeDisplay}; debugger; self.messageNotificationList.unshift(messageReceived); }, function() {}, self); }; this.loadAllConversations = function() { if(appViewModel.p2p2pChat == undefined) { appViewModel.p2pChat = {}; } appViewModel.p2pChat.sourcePagePath = window.location.pathname; redirect( '/messages/' ); }; this.getHrefForConversation = function(userId) { return '/messages/' + userId; }; this.attachMessageNotificationListener = function() { console.log("Attaching message notification listner"); self.firebaseGrowthDB.ref('/CHATS').child('user_watched_channels').child(appViewModel.user.userId()).on('child_added', function(snapshot) { var channelId = snapshot.key; self.loadChannelMessageNotifications(channelId); }, function() {}, self); }; this.firebaseObserver = ko.computed( function() { if (!appViewModel.firebaseGrowthDB()) { console.log('FIREBASE LOADING'); } else { console.log('FIREBASE LOADED'); console.log(appViewModel.firebaseGrowthDB()); self.firebaseGrowthDB = appViewModel.firebaseGrowthDB(); setTimeout( self.attachMessageNotificationListener, 0 ); } }); this.userObserver = ko.computed( function() { if( appViewModel.user.userId() == null ) return; setTimeout( function() { if( appViewModel.user.userId() == 0 ) goToLoginPage( getUrlParameters() ); }, 0 ); }, this ); } , template: `<ul class="pratilipi-notification-list"><!-- ko foreach: { data: messageNotificationList, as: 'messageNotification' } --><li class="chat-item"><a data-bind="attr: { 'href': $parent.getHrefForConversation(messageNotification.userId) }"><div><div class="user-img"><img data-bind="attr: { src: messageNotification.profileImageUrl }" alt="profile-img"></div><div class="chat-wrap"><div class="user-info"><div class="user-name" data-bind="html: messageNotification.channelName"></div><div class="user-last-msg" data-bind="html: messageNotification.lastMessage"></div></div><div class="chat-info" data-bind="css: { 'notif-unread': ( true ) }"><div class="chat-time" data-bind="text: messageNotification.lastMessageTimeDisplay">11:30 PM</div></div></div></div></a></li><!--/ko--><li class="no-messages" data-bind="visible: messageNotificationList().length == 0">ನಿಮಗೆ ಯಾವುದೇ ಓದದ ಸಂದೇಶ ಇರುವುದಿಲ್ಲ</li><li class="mdl-menu__item show-more small-show-more" data-bind="visible: true"><button onclick="ga_CA( 'Notification', 'Load More' )"data-bind="click: loadAllConversations"class="mdl-button mdl-js-button">ಎಲ್ಲವನ್ನೂ ತೋರಿಸಿ</button></li></ul>` }); </script> <script> ko.components.register( 'pratilipi-videoseries-list-page', { viewModel: function pratilipiVideoseriesListPage() { var self = this; var dataAccessor = new DataAccessor(); this.videoseriesList = ko.observableArray(); this.isLoading = ko.observable(); this.fetchVideoseriesList = function() { self.isLoading( true ); dataAccessor.getVideoseriesList( function( videoseriesListResponse, status ) { self.isLoading( false ); if( status !== 200 ) appViewModel.currentView( LOCATION.SERVER_ERROR["ko_element"] ); else self.videoseriesList( videoseriesListResponse.data ); }); }; setTimeout(function() { self.fetchVideoseriesList(); MetaTagUtil.setMetaTagsForVideoseriesList(); }); /** * Facebook events */ /* this.triggerFacebookEvent = function(eventName, parentId) { switch (eventName) { case 'CLICKEVENT_EVENTLISTM_EVENTLIST': FacebookEventTriggerUtil.triggerFacebookEventByNameAndParentId('CLICKEVENT_EVENTLISTM_EVENTLIST', parentId); break; case 'LANDED_EVENTLISTM_EVENTLIST': FacebookEventTriggerUtil.triggerFacebookEventByName('LANDED_EVENTLISTM_EVENTLIST'); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; setTimeout(function() { self.triggerFacebookEvent('LANDED_EVENTLISTM_EVENTLIST'); }, 3000); this.triggerEventClickEvent = function(event) { self.triggerFacebookEvent('CLICKEVENT_EVENTLISTM_EVENTLIST', event.eventId); return true; }; */ } , template: `<div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card pratilipi-videoseries-list-page generic-list-page"><div class="load-more-container mdl-card-border material-heading"style="margin-top: 0;">ಪ್ರತಿಲಿಪಿಯ ವೀಡಿಯೊ ಸರಣಿಗಳು</div><div data-bind="foreach: { data: videoseriesList, as: 'videoseries' }, visible: ( ! isLoading() && videoseriesList().length > 0 )"class="mdl-grid pratilipi-list-grid js-pratilipi-list-grid mobile-card"><div class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><div class="videoseries-container"><a class="videoseries-cover-image"onclick="ga_CA( 'Videoseries', 'Open' )"data-bind="attr: { 'alt': videoseries.displayTitle, href: videoseries.pageUrl },style: { backgroundImage: 'url(' + videoseries.hqImageUrl + ')' }"></a><!-- click: $parent.triggerEventClickEvent --><div class="videoseries-meta-container"><a class="material-title videoseries-title"onclick="ga_CA( 'Videoseries', 'Open' )"data-bind="text: videoseries.displayTitle, attr: { 'alt': videoseries.displayTitle, href: videoseries.pageUrl }"></a></div></div></div></div><div class="load-more-container mdl-card-border text-center" data-bind="visible: isLoading()"><span data-bind="visible: videoseriesList().length > 0" class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span><pratilipi-loading-state data-bind="visible: videoseriesList().length == 0"></pratilipi-loading-state></div></div>` }); </script> <script> ko.components.register( 'pratilipi-message-user', { viewModel: function() { var self = this; this.messages = ko.observableArray(); this.toSendMessageText = ko.observable(); this.isUserBlockedBySelf = ko.observable(false); this.isBlockedByOtherUser = ko.observable(false); this.conversationImageUrl = ko.observable(); this.conversationImageUrlScaled = ko.observable(); this.conversationDisplayName = ko.observable(); this.otherUserProfileUrl = ko.observable(); this.isChannelInSelfWatchlist = false; this.isChannelInOtherUserWatchlist = false; this.firstMessageOfDayCheckMap = new Map(); this.isConversationBlocked = ko.computed( function() { console.log('Conversation Block Status changed'); return self.isUserBlockedBySelf() || self.isBlockedByOtherUser(); }, this); this.isConnectedToServer = ko.observable(false); this.pendingMessageStatus = new Map(); this.loadConversationsList = function() { redirect( '/messages' ); }; this.loadMessagesInConversation = function() { console.log("Loading Messages in Conversation : ", self.channelId); self.firebaseGrowthDB.ref('/CHATS').child('user_watched_channels').child(self.otherUserId).child(self.channelId).on('value', function(snapshot) { console.log("Changed other user watched channel status : ", snapshot.val()); if(snapshot.val() == true) { self.isChannelInOtherUserWatchlist = true; } else { self.isChannelInOtherUserWatchlist = false; } }, function() {}, self); self.firebaseGrowthDB.ref('/CHATS').child('user_watched_channels').child(appViewModel.user.userId()).child(self.channelId).on('value', function(snapshot) { console.log("Changed self user watched channel status : ", snapshot.val()); if(snapshot.val() == true) { self.isChannelInSelfWatchlist = true; } else { self.isChannelInSelfWatchlist = false; } }, function() {}, self); console.log('Loading conversations from firebase DB for channel : ', self.channelId); self.firebaseGrowthDB.ref('/CHATS').child('user_channels').child(appViewModel.user.userId()).child(self.channelId).once('value').then(function(snapshot) { if(snapshot.val() != undefined) { console.log("Last read message : ", snapshot.val().lastReadMessage); console.log("Last deleted message : ", snapshot.val().lastDeletedMessage); self.lastDeletedMessageId = snapshot.val().lastDeletedMessage; } self.attachMessagesListner(); }); }; this.parseDateDisplay = function(sentTime) { var currentDate = new Date(); var currentDateStart = currentDate.setHours(0,0,0,0); var isFirstMessageOfDay = false; var dayDefenition = ""; var messageDate = new Date(sentTime); var messageDateKey = messageDate.toLocaleDateString(); if(!self.firstMessageOfDayCheckMap.has(messageDateKey)) { self.firstMessageOfDayCheckMap.set(messageDateKey,true); isFirstMessageOfDay = true; if(+messageDate >= +currentDateStart) { dayDefenition = "TODAY"; } else { yesterdayDate = new Date(); yesterdayDate.setTime(currentDate.getTime() - (24*3600000)); var yesterdayDateStart = yesterdayDate.setHours(0,0,0,0); if(+messageDate >= +yesterdayDateStart) { dayDefenition = "YESTERDAY"; } else { dayDefenition = messageDateKey; } } } return {isFirstMessageOfDay : isFirstMessageOfDay, dayDefenition : dayDefenition}; }; this.attachMessagesListner = function() { self.attachMessageChildAddedListener(); self.attachLastReadUpdater(); }; this.attachMessageChildAddedListener = function() { var channelMessagesRef = self.firebaseGrowthDB.ref('/CHATS').child('messages').child(self.channelId).orderByKey(); debugger; if(self.lastDeletedMessageId != undefined) { channelMessagesRef = channelMessagesRef.startAt(self.lastDeletedMessageId); } channelMessagesRef.on('child_added', function(snapshot) { debugger; if(self.lastDeletedMessageId == snapshot.key) { console.log("Skipping the first message, since firebase by default doesnt have a exclusive range query"); return; } var toPushMessage = self.buildMessage(snapshot); self.messages.push(toPushMessage); self.lastDeliveredMessageId = snapshot.key }, function() {}, self); }; this.scrollMessageIntoView = function(data) { debugger; console.log('To scroll into view', data, ' Element : ', $('#' + data.messageId)[0]); $('#' + data.messageId)[0].scrollIntoView(); }; this.attachLastReadUpdater = function() { self.firebaseGrowthDB.ref('/CHATS').child('messages').child(self.channelId).limitToLast(1).on('child_added', function(snapshot) { debugger; console.log("Last message added : ", snapshot.key, " for channel : ", self.channelId, " Updating the last read message for user"); self.firebaseGrowthDB.ref('/CHATS').child('user_channels').child(appViewModel.user.userId()).child(self.channelId).child('lastReadMessage').set(snapshot.key); }, function() {}, self); }; this.buildMessage = function(snapshot) { var message = snapshot.val(); console.log("Message added : ",message, " for channel : ", self.channelId); var isMessageBySelf = false; if( message.senderId == appViewModel.user.userId()) { isMessageBySelf = true; } var dateDisplayParsed = this.parseDateDisplay(message.sendTime); var messageTime = new Date(message.sendTime).toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true }); console.log('Message Time : ', messageTime); var toPushMessage = {messageId: snapshot.key, isMessageBySelf: isMessageBySelf, messageText : message.messageText, messageTime : messageTime}; toPushMessage.isFirstMessageOfDay = dateDisplayParsed.isFirstMessageOfDay; toPushMessage.dayDefenition = dateDisplayParsed.dayDefenition; return toPushMessage; }; this.watchBlockedConversation = function() { self.firebaseGrowthDB.ref('/CHATS').child('blocked_users').child(appViewModel.user.userId()).child(self.otherUserId).on('value', function(snapshot) { console.log("Changed blocked status Value : ", snapshot.val()); self.isUserBlockedBySelf(snapshot.val()); }, function() {}, self); self.firebaseGrowthDB.ref('/CHATS').child('blocked_users').child(self.otherUserId).child(appViewModel.user.userId()).on('value', function(snapshot) { self.isBlockedByOtherUser(snapshot.val()); console.log("Changed blocked status Value for other user : ", snapshot.val()); }, function() {}, self); }; this.getChannelIdForConversation = function(otherUser) { if(appViewModel.user.userId() < otherUser) { return appViewModel.user.userId() + '_' + otherUser; } else { return otherUser + '_' + appViewModel.user.userId(); } }; this.loadChannelDetails = function() { self.firebaseGrowthDB.ref('/CHATS').child('channel_metadata').child(self.channelId).once('value').then(function(snapshot) { debugger; if(snapshot.val() == undefined) { if(appViewModel.p2pChat != undefined && appViewModel.p2pChat.userDetails != undefined && appViewModel.p2pChat.userDetails.userId == self.otherUserId) { self.createChannelAndRenderChat(); } else { redirect( '/messages' ); } } else { self.renderChatData(snapshot.val().users); } }); }; this.createChannelAndRenderChat = function() { var channelUsersData = {}; channelUsersData[self.otherUserId] = {profileImageUrl: appViewModel.p2pChat.userDetails.profileImageUrl, displayName : appViewModel.p2pChat.userDetails.displayName, profileUrl : appViewModel.p2pChat.userDetails.profileUrl}; channelUsersData[appViewModel.user.userId()] = {profileImageUrl: appViewModel.user.profileImageUrl(), displayName : appViewModel.user.displayName(), profileUrl : appViewModel.user.profilePageUrl()}; self.firebaseGrowthDB.ref('/CHATS/channel_metadata/' + self.channelId).set({users : channelUsersData}, function(error) { if(error) { redirect('/messages'); console.log("Channel metadata could not be saved. Error : " + error); } else { self.renderChatData(channelUsersData); } }); appViewModel.p2pChat = {}; }; this.readOtherUserProfileData = function() { debugger; self.firebaseGrowthDB.ref('/CHATS').child('user_profile').child(self.otherUserId).once('value').then(function(snapshot) { if(snapshot.val() == undefined) { console.log("No profile data present for the other user. Using data from channel metadata"); return; } else { var otherUserProfile = snapshot.val(); if(otherUserProfile.displayName != self.conversationDisplayName()) { self.conversationDisplayName(otherUserProfile.displayName); } if(otherUserProfile.profileImageUrl != self.conversationImageUrl()) { self.conversationImageUrl(otherUserProfile.profileImageUrl); var scaledProfileImageUrl = getImageUrl(otherUserProfile.profileImageUrl,100); self.conversationImageUrlScaled(scaledProfileImageUrl); } if(otherUserProfile.profileUrl != self.otherUserProfileUrl()) { self.otherUserProfileUrl(otherUserProfile.profileUrl); } } }); }; this.renderChatData = function(channelUsersData) { var userInChannel = false; $.each(channelUsersData, function(user, userData) { debugger; if(user == appViewModel.user.userId()) { userInChannel = true; } else if (user == self.otherUserId){ self.conversationDisplayName(userData.displayName); self.conversationImageUrl(userData.profileImageUrl); var scaledProfileImageUrl = getImageUrl(userData.profileImageUrl, 100); self.conversationImageUrlScaled(scaledProfileImageUrl); self.otherUserProfileUrl(userData.profileUrl); } console.log(user, userData); }); if(userInChannel != true) { redirect('/messages'); } self.loadMessagesInConversation(); self.watchBlockedConversation(); self.readOtherUserProfileData(); }; this.setAllPendingMessageStatus = function(status) { debugger; self.pendingMessageStatus.forEach(function(value,key) { if(value() == "SEND_SUCCESS") { return; } else { self.pendingMessageStatus.get(key)(status); } }); }; this.firebaseObserver = ko.computed( function() { if (!appViewModel.firebaseGrowthDB()) { console.log('FIREBASE LOADING'); } else { console.log('FIREBASE LOADED'); console.log(appViewModel.firebaseGrowthDB()); self.firebaseGrowthDB = appViewModel.firebaseGrowthDB(); self.otherUserId = window.location.pathname.split("/")[2]; self.channelId = self.getChannelIdForConversation(self.otherUserId); self.loadChannelDetails(); var connectedRef = self.firebaseGrowthDB.ref(".info/connected"); connectedRef.on("value", function(snap) { if (snap.val() === true) { console.log("connected to internet"); self.isConnectedToServer(true); self.setAllPendingMessageStatus("SENDING"); } else { self.isConnectedToServer(false); console.log("not connected to internet"); self.setAllPendingMessageStatus("SEND_FAILED"); } }); } }); this.userObserver = ko.computed( function() { if( appViewModel.user.userId() == null ) return; setTimeout( function() { if( appViewModel.user.userId() == 0 ) goToLoginPage( getUrlParameters() ); }, 0 ); }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.MESSAGES_USER.ko_element ) { /* Dispose all observers */ self.locationObserver.dispose(); self.userObserver.dispose(); var chatRef = self.firebaseGrowthDB.ref('/CHATS'); chatRef.child('messages').child(self.channelId).off(); chatRef.child('blocked_users').child(appViewModel.user.userId()).child(self.otherUserId).off(); chatRef.child('blocked_users').child(self.otherUserId).child(appViewModel.user.userId()).off(); chatRef.child('user_watched_channels').child(appViewModel.user.userId()).child(self.channelId).off(); chatRef.child('user_watched_channels').child(self.otherUserId).child(self.channelId).off(); self.firebaseGrowthDB.ref(".info/connected").off(); if(appViewModel.p2pChat != undefined) { delete appViewModel.p2pChat.userDetails; } self.firebaseObserver.dispose(); return; } appViewModel.currentLocation(); }, this ); this.sendMessageToFirebase = function() { debugger; var addChannelToWatchlistUpdate = {}; var watchlistUpdateNeeded = false; if(self.isChannelInSelfWatchlist != true) { addChannelToWatchlistUpdate['/CHATS/user_watched_channels/' + appViewModel.user.userId() + '/' + self.channelId] = true; watchlistUpdateNeeded = true; } if(self.isChannelInOtherUserWatchlist != true) { addChannelToWatchlistUpdate['/CHATS/user_watched_channels/' + self.otherUserId + '/' + self.channelId] = true; watchlistUpdateNeeded = true; } if(watchlistUpdateNeeded == true) { self.firebaseGrowthDB.ref().update(addChannelToWatchlistUpdate, function(error) { if (error) { console.log("Error updating data:", error); } }); } var messagePushRef = self.firebaseGrowthDB.ref('/CHATS').child('messages').child(self.channelId).push(); var messageId = messagePushRef.key; var sendStatus = self.isConnectedToServer() ? "SENDING" : "SEND_FAILED"; self.pendingMessageStatus.set(messageId, ko.observable(sendStatus)); messagePushRef.set({senderId: appViewModel.user.userId() + "", messageText : self.toSendMessageText(), sendTime: firebase.database.ServerValue.TIMESTAMP}, function(error) { if (error) { console.log("Message : " + messageId + " could not be saved." + error); self.pendingMessageStatus.get(messageId)("SEND_FAILED"); } else { console.log("Message : " + messageId + " saved successfully."); self.pendingMessageStatus.get(messageId)("SEND_SUCCESS"); } }); self.toSendMessageText(""); }; this.blockUser = function() { debugger; self.firebaseGrowthDB.ref('CHATS').child('blocked_users').child(appViewModel.user.userId()).child(self.otherUserId).set(true); }; this.unblockUser = function() { debugger; self.firebaseGrowthDB.ref('/CHATS').child('blocked_users').child(appViewModel.user.userId()).child(self.otherUserId).set(false); }; this.openDeletePratilipiChat = function() { $( "#pratilipi-chat-delete-confirmation-dialog" ).modal(); }; this.deleteConversation = function() { var deleteConversationUpdates = {}; deleteConversationUpdates['/CHATS/user_watched_channels/' + appViewModel.user.userId() + '/' + self.channelId] = {}; deleteConversationUpdates['/CHATS/user_channels/' + appViewModel.user.userId() + '/' + self.channelId + '/lastDeletedMessage'] = self.lastDeliveredMessageId; self.firebaseGrowthDB.ref().update(deleteConversationUpdates, function(error) { if (error) { console.log("Error updating data:", error); } }); self.messages([]); $('.modal-backdrop').hide(); $("body").removeClass("modal-open"); redirect('/messages'); }; this.redirectToOtherUserProfile = function() { debugger; redirect(self.otherUserProfileUrl()); }; $("#text-message").on("keyup", function () { if (this.innerHTML === "<br>") { this.innerHTML = ""; } }); } , template: `<div class="chat-header individual"><div class="back-btn" data-bind="click: function(){ loadConversationsList(); }"><i class="material-icons">arrow_back</i></div><div class="user-img"><img alt="https://0.ptlp.co/author/image?width=60" data-bind="attr:{src: conversationImageUrlScaled}" ></div><div class="user-name" data-bind="text: conversationDisplayName">Rahul</div><div class="options" id="chat-user-more-option"><i class="material-icons">more_vert</i></div><ul class = "mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for = "chat-user-more-option"><li class = "mdl-menu__item" data-bind="click: function(){ redirectToOtherUserProfile(); }">ಪ್ರೊಫೈಲ್ ವೀಕ್ಷಣೆ</li><!-- ko if: messages().length > 0 --><li class = "mdl-menu__item" data-bind="click: function() { openDeletePratilipiChat(); }">ಡಿಲೀಟ್ ಮಾಡಿ</li><!-- /ko --><!-- ko if: isUserBlockedBySelf --><li class = "mdl-menu__item" data-bind="click: function() { unblockUser(); }">ಅನ್ ಬ್ಲಾಕ್ ಯೂಸರ್</li><!-- /ko --><!-- ko ifnot: isUserBlockedBySelf --><li class = "mdl-menu__item" data-bind="click: function() { blockUser(); }">ಬ್ಲಾಕ್ ಯೂಸರ್</li><!-- /ko --></ul></div><!-- Message Confirmation Modal --><div class="modal common-modal fade" id="pratilipi-chat-delete-confirmation-dialog" tabindex="-1" role="dialog" aria-labelledby="pratilipi-chat-delete-confirmation-dialog"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button data-dismiss="modal" class="mdl-button mdl-js-button mdl-button--icon close"><i class="material-icons">close</i></button><h6 class="modal-title">ಡಿಲೀಟ್ ಮಾಡಿ</h6></div><div class="modal-body"><div class="material-subtitle-2">ನೀವು ಎಲ್ಲಾ ಮೆಸೇಜ್ ಗಳನ್ನೂ ಅಳಿಸಲು ಇಚ್ಚಿಸುತ್ತೀರಾ?</div></div><div class="modal-footer"><button data-bind="click: function() { deleteConversation(); }" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin pull-left">ಹೌದು</button><button data-dismiss="modal" class="mdl-button mdl-js-button mdl-button--colored mdl-js-ripple-effect mdl-button--raised">ರದ್ದುಗೊಳಿಸಿ</button></div></div></div></div><div id="p2p-chat-body" class="chat-body"><div id="all-messages" class="all-messages" data-bind="foreach: { data:messages, afterRender: function(elems, data) { scrollMessageIntoView(data); } }"><!-- ko if: isFirstMessageOfDay --><div class="chat-date"><span data-bind="text: dayDefenition">TODAY</span></div><!-- /ko --><div class="chat-msg" data-bind="css: isMessageBySelf ? 'self' : 'sender', attr: { id: messageId } "><span class="msg-text" data-bind="text: messageText"></span><div class="extra-info"><span class="time" data-bind="text: messageTime">16:40</span><!-- ko if: $parent.pendingMessageStatus.has(messageId) && $parent.pendingMessageStatus.get(messageId)() == 'SEND_FAILED' --><span class="status sent" data-bind="css: 'error'"><i class="material-icons">error</i></span><!-- /ko --><!-- ko if: $parent.pendingMessageStatus.has(messageId) && $parent.pendingMessageStatus.get(messageId)() == 'SENDING' --><span class="status sending"><i class="material-icons">access_time</i></span><!-- /ko --></div></div></div><!-- ko if: isBlockedByOtherUser --><div class="message-blocked">ನೀವು ಈ ಬಳಕೆದಾರರಿಗೆ ಮೆಸೇಜ್ ಕಳುಹಿಸಲು ಮತ್ತು ಇವರಿಂದ ಮೆಸೇಜ್ ಪಡೆಯಲು ಸಾಧ್ಯವಿಲ್ಲ.</div><!-- /ko --><!-- ko if: isUserBlockedBySelf --><div class="message-blocked">ಸಂದೇಶವನ್ನು ಕಳುಹಿಸಲು ಯೂಸರ್ ಅನ್ ಬ್ಲಾಕ್ ಮಾಡಿ</div><!-- /ko --></div><div class="chat-box"><form action="#"><div class="type-message"><textarea id="text-message" contenteditable="true" data-bind="value: toSendMessageText, enable: !isConversationBlocked()" placeholder="ಇಲ್ಲಿ ಬರೆಯಿರಿ..."></textarea></div><button type="submit" name="button" class="send-message mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab" data-bind="click: function() { sendMessageToFirebase(); }, enable: !isConversationBlocked()"><i class="material-icons">send</i></button></form></div>` }); </script> <script> ko.components.register( 'pratilipi-home-page', { viewModel: function pratilipiHomePage() { var self = this; var dataAccessor = new DataAccessor(); this.bannerList = ko.observableArray(); this.sectionList = ko.observableArray(); this.fetchHomePageBanners = function() { dataAccessor.getHomePageBanners( function( response ) { if( response == null ) return; self.bannerList( response.bannerList ); self.triggerFacebookEvent('VIEWED_BANNERS_HOME'); $( '#carousel' ).carousel({ interval: 6000, pause: "hover" }).on( "touchstart", function( event ) { var xClick = event.originalEvent.touches[0].pageX; $(this).one( "touchmove", function( event ) { var xMove = event.originalEvent.touches[0].pageX; if( Math.floor( xClick - xMove ) > 5 ) { $(this).carousel( 'next' ); $(this).carousel( 'pause' ); setTimeout(function() { self.triggerFacebookEvent('SWIPE_BANNERS_HOME', self.bannerList()[$("div.item.active").index()].actionUrl); }, 1500); } else if( Math.floor( xClick - xMove ) < -5 ) { $(this).carousel( 'prev' ); $(this).carousel( 'pause' ); setTimeout(function() { self.triggerFacebookEvent('SWIPE_BANNERS_HOME', self.bannerList()[$("div.item.active").index()].actionUrl); }, 1500); } }); $(this).on( "touchend", function(event) { $(this).off( "touchmove" ); }); }); }); }; this.fetchHomePageSections = function() { dataAccessor.getHomePageSections( function( response ) { var newPratilipiList = function( pList ) { var pratilipiList = ko.observableArray(); for( var i = 0; i < pList.length; i++ ) pratilipiList.push( ko.mapping.fromJS( pList[i] ) ); return pratilipiList; }; var sectionList = response.sections; for( var i = 0; i < sectionList.length; i++ ) { var section = sectionList[i]; section.partnership = section.partnership ? section.partnership[0] : null; section.pratilipiList = newPratilipiList( section.pratilipiList ); self.sectionList.push( section ); } }); }; this.initialDataLoaded = ko.computed( function() { return self.bannerList().length > 0 || self.sectionList().length > 0; }, this ); this.dataLoaded = ko.computed( function() { return self.bannerList().length > 0 && self.sectionList().length > 0; }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.HOME.ko_element ) { self.locationObserver.dispose(); self.dataLoaded.dispose(); return; } setTimeout( function() { if( getUrlParameter( "email" ) != null && getUrlParameter( "token" ) != null ) { if( getUrlParameter( "passwordReset" ) == "true" ) { if( appViewModel.isTestEnvironment ) redirect( "/login?screen=RESET_PASSWORD&token=" + getUrlParameter( "token" ) ); else redirect( "/reset-password?e=" + getUrlParameter( "email" ) + "&t=" + getUrlParameter( "token" ) ); } else if( getUrlParameter( "verifyUser" ) == "true" ) redirect( "/verify-user?e=" + getUrlParameter( "email" ) + "&t=" + getUrlParameter( "token" ) ); } self.fetchHomePageBanners(); self.fetchHomePageSections(); MetaTagUtil.setMetaTagsForHome(); }, 0 ); }, this ); this.sendAnalyticsEvent = function(vm, e) { ga_CA( vm.partnership.type + '-' + vm.partnership.name, 'Click' ); return true; }; /** * Facebook events */ this.triggerFacebookEvent = function(eventName, parentId) { switch (eventName) { case 'CLICKBANNER_BANNERS_HOME': case 'SWIPE_BANNERS_HOME': case 'CLICKCOLLECTION_COLLECTIONS_HOME': FacebookEventTriggerUtil.triggerFacebookEventByNameAndParentId(eventName, parentId); break; case 'LANDED_HOMEM_HOME': case 'VIEWED_BANNERS_HOME': case 'VIEWED_COLLECTIONS_HOME': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.triggerCollectionClickEvent = function(value) { self.triggerFacebookEvent('CLICKCOLLECTION_COLLECTIONS_HOME', value.listPageUrl); return true; }; this.triggerBannerClickEvent = function(parentId) { self.triggerFacebookEvent('CLICKBANNER_BANNERS_HOME', parentId); return true; }; self.triggerFacebookEvent('LANDED_HOMEM_HOME'); self.collectionViewEventTriggered = ko.observable(false); $( window ).scroll(function() { if (FacebookEventTriggerUtil.isScrolledIntoView($('.section-container'), false) && !self.collectionViewEventTriggered()) { self.triggerFacebookEvent('VIEWED_COLLECTIONS_HOME'); self.collectionViewEventTriggered(true); } }); } , template: `<!-- ko if: bannerList().length > 0 --><div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><div id="carousel" class="carousel slide" data-ride="carousel"><ol data-bind="foreach: bannerList" class="carousel-indicators"><li data-target="#carousel"data-bind="attr: { 'data-slide-to': $index }, css: { 'active': $index() == 0 }"></li></ol><div class="carousel-inner" data-bind="foreach: bannerList"><div class="item" data-bind="css: { 'active': $index() == 0 }"><a data-bind="attr: { 'href': $data.actionUrl }, click: $parent.triggerBannerClickEvent.bind(this, $data.actionUrl)"><img style="width: 100%; height: 100%;" data-bind="attr: { 'src': $data.imageUrl, 'alt': $data.title }" /></a></div></div></div></div><!-- /ko --><div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card section-list"data-bind="foreach: sectionList, as: section"><div class="section-container"><div class="section-header mdl-card-border mobile-card"><div class="section-heading-container"><a style="color: #000;"class="material-heading section-heading"data-bind="attr: { 'href': listPageUrl }, text: title, click: $parent.triggerCollectionClickEvent"></a></div><!-- ko if: partnership != null --><div class="partnership-container"><span class="caption" data-bind="text: partnership.caption"></span><a class="image-holder" data-bind="{ attr: { 'href': partnership.link }, click: $parent.sendAnalyticsEvent }" target="_blank"><img class="partner-image" data-bind="attr: { 'src': partnership.imageUrl }" /></a></div><!-- /ko --></div><div data-bind="foreach: { data: pratilipiList, as: 'pratilipi' }" class="mdl-grid pratilipi-list-grid mobile-card"><div class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><!-- ko component: {name: "pratilipi-pratilipi-card",params: { pratilipi: pratilipi }} --><!-- /ko --></div></div><div class="section-footer view-more-holder material-subtitle-1 mdl-card-border mobile-card" style="margin-top: -1px;"><a class="material-subheading-1" style="opacity: 0.8;" data-bind="attr: { 'href': listPageUrl }">ಇನ್ನೂ ಹೆಚ್ಚು ತೋರಿಸಿ...<i class="material-icons pull-right mdl-layout--small-screen-only">navigate_next</i></a><a data-bind="attr: { 'href': listPageUrl }"><i class="material-icons pull-right mdl-layout--large-screen-only">navigate_next</i></a></div></div></div><div data-bind="visible: ! dataLoaded(), css: { 'mdl-card-border': ! initialDataLoaded() }"class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><span data-bind="visible: initialDataLoaded()" class="initial-data-loading-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span><pratilipi-loading-state data-bind="visible: ! initialDataLoaded()"></pratilipi-loading-state></div>` }); </script> <script> ko.components.register( 'pratilipi-login-page-v2', { viewModel: function pratilipiLoginPageV2(params) { /* Initialising */ this.locationObserver = ko.computed( function() { appViewModel.currentLocation(); setTimeout( function() { if( appViewModel.currentView() != LOCATION.LOGIN_V2.ko_element ) { /* Dispose all observers */ $("body").removeClass("bg-white"); self.locationObserver.dispose(); return; } else { $("body").addClass("bg-white"); MetaTagUtil.setMetaTagsForLogin(); } }); }, this ); } , template: `<div class="pratilipi-login-page-v2"><!-- ko component: "pratilipi-login-component" --><!-- /ko --></div>` }); </script> <script> ko.components.register( 'pratilipi-library-page', { viewModel: function() { var self = this; var cursor = null; var resultCount = 20; var dataAccessor = new DataAccessor(); this.pratilipiList = ko.observableArray(); this.hasMoreContents = ko.observable( true ); /* Loading state */ /* * 4 Possible values for 'loadingState' * LOADING * LOADED_EMPTY * LOADED * FAILED * * */ this.loadingState = ko.observable(); this.updatePratilipiList = function( pratilipiList ) { for( var i = 0; i < pratilipiList.length; i++ ) self.pratilipiList.push( ko.mapping.fromJS( pratilipiList[i] ) ); }; this.fetchUserLibraryList = function() { if( self.loadingState() == "LOADING" || ! self.hasMoreContents() ) return; self.loadingState( "LOADING" ); dataAccessor.getUserLibraryList( cursor, resultCount, function( pratilipiListResponse ) { if( pratilipiListResponse == null ) { self.loadingState( "FAILED" ); return; } FacebookEventTriggerUtil.setUserProperties('LIBRARY_COUNT', pratilipiListResponse.numberFound); var loadMore = self.pratilipiList().length != 0; var pratilipiList = pratilipiListResponse.pratilipiList; self.updatePratilipiList( pratilipiList ); cursor = pratilipiListResponse.cursor; self.loadingState( self.pratilipiList().length > 0 || pratilipiList.length > 0 ? "LOADED" : "LOADED_EMPTY" ); self.hasMoreContents( pratilipiList.length == resultCount && cursor != null ); if( loadMore ) ga_CA( 'Pratilipi', 'LoadMore' ); }); }; this.userObserver = ko.computed( function() { if( appViewModel.user.isGuest() && appViewModel.user.userId() == 0 ) { goToLoginPage( null, { "message": "LIBRARY" } ); } }, this ); this.pageScrollObserver = ko.computed( function() { if( ( appViewModel.scrollTop() / $( ".js-pratilipi-list-grid" ).height() ) > 0.6 ) { setTimeout( function() { self.fetchUserLibraryList(); }, 100 ); /* locationObserver and pageScrollObserver will be triggered at once. */ } }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.LIBRARY.ko_element ) { /* Dispose all observers */ self.locationObserver.dispose(); self.pageScrollObserver.dispose(); self.userObserver.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { self.fetchUserLibraryList(); MetaTagUtil.setMetaTagsForLibrary(); }, 0 ); }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName, parentId) { switch (eventName) { case 'LANDED_LIBRARYM_LIBRARY': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; self.triggerFacebookEvent('LANDED_LIBRARYM_LIBRARY'); } , template: `<div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card generic-list-page"><div class="load-more-container mdl-card-border material-heading" style="margin-top: 0;">ನನ್ನ ಗ್ರಂಥಾಲಯ</div><div data-bind="foreach: { data: pratilipiList, as: 'pratilipi' }, visible: pratilipiList().length > 0"class="mdl-grid pratilipi-list-grid js-pratilipi-list-grid mobile-card"><div data-bind="visible: pratilipi.addedToLib()"class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><!-- ko component: {name: "pratilipi-pratilipi-card",params: { pratilipi: pratilipi, canRemoveFromLibrary: true, redirectToReaderOnClick: true }} --><!-- /ko --></div></div><div class="load-more-container mdl-card-border material-subtitle-1 text-center" data-bind="visible: loadingState() == 'LOADED_EMPTY'"><div style="width: 200px; height: 200px; margin: auto;" class="empty-library-icon"></div>ಕ್ಷಮಿಸಿ, ನಿಮ್ಮ ಗ್ರಂಥಾಲಯದಲ್ಲಿ ಯಾವುದೇ ಪುಸ್ತಕಗಳಿಲ್ಲ, ನೀವು ಪುಸ್ತಕಗಳನ್ನು ಬರಹ ಪುಟದಿಂದ ತೆಗೆದು ಸೇರಿಸಬಹುದು.</div><div class="load-more-container mdl-card-border" data-bind="visible: hasMoreContents()"><button data-bind="{ visible: loadingState() != 'LOADING', click: fetchUserLibraryList }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">ಇನ್ನಷ್ಟು ವಿಷಯಗಳನ್ನು ಲೋಡ್ ಮಾಡಿ</button><div class="text-center" data-bind="visible: loadingState() == 'LOADING'"><span data-bind="visible: pratilipiList().length > 0" class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span><pratilipi-loading-state data-bind="visible: pratilipiList().length == 0"></pratilipi-loading-state></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-notifications-page', { viewModel: function( params ) { var self = this; this.userObserver = ko.computed( function() { if( appViewModel.user.isGuest() && appViewModel.user.userId() == 0 ) { goToLoginPage( getUrlParameter( 'action' ) == "settings" ? { "action": "settings" } : null, { "message": "NOTIFICATIONS" } ); return; } if( getUrlParameter( 'action' ) == "settings" ) { setTimeout( function() { $( "#pratilipiNotificationSettings" ).modal(); }, 0 ); } }, this ); this.tabchange = function() { var tab_id = $(event.currentTarget).attr('data-tab'); $(".tab-menu li").removeClass("active"); $(event.currentTarget).addClass("active"); $(".tab-content").hide(); $("#" + tab_id).show(); }; this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.NOTIFICATIONS.ko_element ) { /* Dispose all observers */ self.locationObserver.dispose(); self.userObserver.dispose(); return; } else { setTimeout(function() { MetaTagUtil.setMetaTagsForNotification(); }); } appViewModel.currentLocation(); }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName) { switch (eventName) { case 'LANDED_NOTIFSM_NOTIFS': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; case 'GOSETTINGNOTIFY_NOTIFSM_NOTIFS': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.triggerNotificationSetClick = function() { self.triggerFacebookEvent('GOSETTINGNOTIFY_NOTIFSM_NOTIFS'); return true; }; self.triggerFacebookEvent('LANDED_NOTIFSM_NOTIFS'); } , template: `<!-- ko component: "pratilipi-notification-settings"--><!-- /ko --><div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card generic-list-page"><div class="mdl-card mdl-card-border mobile-card pratilipi-notifications-page"><div class="notifications-header"><ul class="tab-menu"><li data-bind="click: tabchange" class="active" data-tab="notifications">ಸೂಚನೆ</li><li data-bind="click: tabchange" data-tab="messages">ಸಂದೇಶಗಳು<!-- ko if: appViewModel.pendingUnreadMessages && appViewModel.pendingUnreadMessages() --><span class="message-dot"></span><!-- /ko --></li></ul><button onclick="ga_CA( 'Notification', 'Settings' )"class="mdl-button mdl-js-button mdl-button--icon pull-right notif-settings-btn" data-bind="click: triggerNotificationSetClick" data-toggle="modal" data-target="#pratilipiNotificationSettings"><i class="material-icons">settings</i></button></div><div class="tab-content" id="notifications"><!-- ko component: {name: "pratilipi-notification-list",params: { resultCount: 20,notificationsPageBehaviour: true }} --><!-- /ko --></div><div class="tab-content" id="messages"><!-- ko component: {name: "pratilipi-message-notification-list",params: { resultCount: 20,notificationsPageBehaviour: true }} --><!-- /ko --></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-author-card', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.author = params.author; this.followRequestOnFlight = ko.observable( false ); this.followOrUnfollowAuthor = function() { if( appViewModel.user.isGuest() ) { goToLoginPage( null, { "message": "FOLLOW" } ); return; } if( self.followRequestOnFlight() ) return; self.followRequestOnFlight( true ); var getFollowingMessage = function( following, name ) { var text = following ? "ನೀವು $authorName ಅವರನ್ನು ಹಿಂಬಾಲಿಸುತ್ತಿದ್ದೀರಿ" : "ನೀವು $authorName ಅವರನ್ನು ಹಿಂಬಾಲಿಸುತ್ತಿಲ್ಲ"; return text.replace( "$authorName", name ); }; var switchState = function() { self.author.following( ! self.author.following() ); }; switchState(); ToastUtil.toast( getFollowingMessage( self.author.following(), self.author.name() ) ); dataAccessor.followOrUnfollowAuthor( self.author.authorId(), self.author.following(), function( userAuthor ) { self.followRequestOnFlight( false ); ga_CA( 'Author', userAuthor.following ? 'Follow' : 'UnFollow' ); }, function( error ) { self.followRequestOnFlight( false ); switchState(); ToastUtil.toast( error[ "message" ] != null ? error[ "message" ] : "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!", 3000, true ); }); }; } , template: `<div class="pratilipi-author-card"><div class="author-image-holder"><a data-bind="attr: { href: author.pageUrl() }" onclick="ga_CA( 'Author', 'Open' );"><img class="cover-image" data-bind="attr: { src: getImageUrl( author.profileImageUrl(), 80 ), alt: author.name() }" /></a></div><a class="author-name" data-bind="text: author.name(), attr: { href: author.pageUrl() }" onclick="ga_CA( 'Author', 'Open' );"></a><div class="follow-button-holder"><button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect"data-bind="{ text: author.following() ? 'ಹಿಂಬಾಲಿಸುತ್ತಿರುವಿರಿ' : 'ಹಿಂಬಾಲಿಸಿ',click: followOrUnfollowAuthor,disable: author.following(),style: { 'visibility': author.authorId() != appViewModel.user.author.authorId() ? 'visible' : 'hidden' } }"></button></div></div>` }); </script> <script> ko.components.register( 'pratilipi-see-more', { viewModel: function( params ) { var self = this; /* Pass originalText as ko.observable() */ this.originalText = params.originalText; /* Booleans */ this.isViewMoreVisible = ko.observable( false ); this.isViewMoreShown = ko.observable( true ); this.maxHeightPx = ko.observable( "initial" ); this.toggleViewMore = function( vm, e ) { self.isViewMoreShown( ! self.isViewMoreShown() ); if( self.isViewMoreShown() ) { var pos = e.currentTarget.parentElement.parentElement.offsetTop; /* Not adding header padding */ appViewModel.scrollToTop( pos ); } }; } , template: `<div data-bind="seeMore: true"><p data-bind="style: { 'max-height': isViewMoreShown() ? maxHeightPx() : 'initial' }"style="white-space:pre-wrap; min-width: 100%; overflow: hidden; position: relative;"class="material-subtitle-1"></p><div class="text-center" data-bind="visible: isViewMoreVisible"><button data-bind="{ click: toggleViewMore,text: isViewMoreShown() ? 'ಇನ್ನೂ ಹೆಚ್ಚು ತೋರಿಸಿ' : 'ಕಡಿಮೆ ತೋರಿಸಿ' }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect"></button></div></div>` }); </script> <script> ko.components.register( 'pratilipi-author-contents', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.author = params.author; this.publishedPratilipiList = ko.observableArray(); this.draftedPratilipiList = ko.observableArray(); this.updatePublishedPratilipiList = function( pratilipiList ) { for( var i = 0; i < pratilipiList.length; i++ ) { var pratilipi = pratilipiList[i]; pratilipi[ "author" ] = { "authorId": self.author.authorId(), "name": "" }; if (!pratilipi.hasOwnProperty('tags')) pratilipi["tags"] = null; if (!pratilipi.hasOwnProperty('suggestedTags')) pratilipi["suggestedTags"] = null; self.publishedPratilipiList.push( ko.mapping.fromJS( pratilipi ) ); } }; this.updateDraftedPratilipiList = function( pratilipiList ) { for( var i = 0; i < pratilipiList.length; i++ ) { var pratilipi = pratilipiList[i]; if( pratilipi[ "title" ] == null ) pratilipi[ "title" ] = " "; if( pratilipi[ "pageUrl" ] == null ) continue; /* Hack: Fix for Deleted entitites from backend */ pratilipi[ "author" ] = { "authorId": self.author.authorId(), "name": "" }; self.draftedPratilipiList.push( ko.mapping.fromJS( pratilipi ) ); } }; /* Load Drafted and Published Contents */ var publishedCursor = null; var draftedCursor = null; /* Loading state */ /* * 4 Possible values * LOADING * LOADED_EMPTY * LOADED * FAILED * * */ this.loadingStatePublished = ko.observable(); this.loadingStateDrafted = ko.observable(); this.hasMorePublishedContents = ko.observable( true ); this.hasMoreDraftedContents = ko.observable( true ); this._loadPublishedContents = function( resultCount ) { if( self.loadingStatePublished() == "LOADING" ) return; self.loadingStatePublished( "LOADING" ); dataAccessor.getPratilipiListByAuthor( self.author.authorId(), "PUBLISHED", publishedCursor, null, resultCount, function( pratilipiListResponse ) { if( pratilipiListResponse == null ) { self.loadingStatePublished( "FAILED" ); return; } var pratilipiList = pratilipiListResponse.pratilipiList; self.updatePublishedPratilipiList( pratilipiList ); publishedCursor = pratilipiListResponse.cursor; self.loadingStatePublished( self.publishedPratilipiList().length > 0 ? "LOADED" : "LOADED_EMPTY" ); self.hasMorePublishedContents( pratilipiList.length == resultCount && publishedCursor != null ); }); }; this._loadDraftedContents = function( resultCount ) { if( self.loadingStateDrafted() == "LOADING" ) return; self.loadingStateDrafted( "LOADING" ); dataAccessor.getPratilipiListByAuthor( self.author.authorId(), "DRAFTED", draftedCursor, null, resultCount, function( pratilipiListResponse ) { if( pratilipiListResponse == null ) { self.loadingStateDrafted( "FAILED" ); return; } var pratilipiList = pratilipiListResponse.pratilipiList; self.updateDraftedPratilipiList( pratilipiList ); draftedCursor = pratilipiListResponse.cursor; self.loadingStateDrafted( self.draftedPratilipiList().length > 0 ? "LOADED" : "LOADED_EMPTY" ); self.hasMoreDraftedContents( pratilipiList.length == resultCount && draftedCursor != null ); }); }; /* Constants */ var initialPublishedResultCount = 6; var subsequentPublishedResultCount = 6; var initialDraftedResultCount = 5; var subsequentDraftedResultCount = 6; this.loadInitialPublishedContents = function() { self.publishedPratilipiList( [] ); publishedCursor = null; self.loadingStatePublished( null ); self.hasMorePublishedContents( true ); self._loadPublishedContents( initialPublishedResultCount ); }; this.loadMorePublishedContents = function() { self._loadPublishedContents( subsequentPublishedResultCount ); }; this.loadInitialDraftedContents = function() { self.draftedPratilipiList( [] ); draftedCursor = null; self.loadingStateDrafted( null ); self.hasMoreDraftedContents( true ); self._loadDraftedContents( initialDraftedResultCount ); }; this.loadMoreDraftedContents = function() { self._loadDraftedContents( subsequentDraftedResultCount ); }; /* Create new Draft */ this.createNewPratilipi = function() { if( isMobile() ) { ToastUtil.toast( "ಪ್ರತಿಲಿಪಿಯಲ್ಲಿ ಬರೆಯಲು ದಯವಿಟ್ಟು ಆ್ಯoಡ್ರಾಯ್ಡ್ ಆ್ಯಪ್ ಮೂಲಕ ಲಾಗಿನ್ ಆಗಿ", 5000 ); return; } appViewModel.pratilipiWriteAuthorId( self.author.authorId() ); self.triggerFacebookEvent('WRITENEWBOOK_DRAFTS_MYPROFILE'); $( "#pratilipiWrite" ).modal(); }; /* Computed Observables */ this.authorIdObserver = ko.computed( function() { if( self.author.authorId() == null ) return; setTimeout( function() { if( self.author.hasAccessToUpdate() ) { self.loadInitialDraftedContents(); } self.loadInitialPublishedContents(); }, 0 ); }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName, pratilipi) { switch (eventName) { case 'CLICKBOOK_DRAFTS_MYPROFILE': FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('CLICKBOOK_DRAFTS_MYPROFILE', pratilipi ); break; case 'WRITENEWBOOK_DRAFTS_MYPROFILE': FacebookEventTriggerUtil.triggerFacebookEventByName('WRITENEWBOOK_DRAFTS_MYPROFILE'); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.triggerDraftedPratilipiClickEvent = function(pratilipi) { self.triggerFacebookEvent('CLICKBOOK_DRAFTS_MYPROFILE', pratilipi); return true; }; } , template: `<div class="pratilipi-author-contents"><div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card" style=" margin-top: 0px;"><div class="author-drafted-contents" data-bind="visible: author.hasAccessToUpdate()"><div class="load-more-container mdl-card-border material-title" style="padding: 14px 8px; background-color: #fff;">ಅಪ್ರಕಟಿತ ಬರಹಗಳು</div><div data-bind="visible: draftedPratilipiList().length > 0 || loadingStateDrafted() == 'LOADED_EMPTY'"class="mdl-grid pratilipi-list-grid js-pratilipi-list-grid mobile-card"><div data-bind="visible: loadingStateDrafted() != 'LOADING' || draftedPratilipiList().length != 0"class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><!-- Add New Content Card --><a class="pratilipi-pratilipi-card mdl-card clickable-element create-pratilipi" data-bind="click: createNewPratilipi"><span class="create-pratilipi-icon-holder"><i class="material-icons">note_add</i></span><span class="create-pratilipi-text-holder"><span class="font-m">ಹೊಸ ಬರಹವನ್ನು ಸೇರಿಸಿ</span></span></a></div><!-- ko foreach: { data: draftedPratilipiList, as: 'pratilipi' } --><div class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card drafted-card"><a onclick="ga_CA( 'Pratilipi', 'OpenDraft' )"class="pratilipi-pratilipi-card mdl-card" data-bind="attr: { href: pratilipi.pageUrl() }, click: $parent.triggerDraftedPratilipiClickEvent"><span class="pratilipi-cover-image-holder"><img data-bind="attr: { src: getImageUrl( pratilipi.coverImageUrl(), 32 ), title: pratilipi.title(), alt: pratilipi.title() }" /></span><span class="pratilipi-meta-holder"><span class="pratilipi-title mdl-card__title"><span class="font-m" data-bind="text: pratilipi.title()"></span></span></span></a></div><!--/ko--></div><div class="load-more-container mdl-card-border" data-bind="visible: hasMoreDraftedContents()"><button onclick="ga_CA( 'Pratilipi', 'LoadMoreDrafts' )"data-bind="{ visible: loadingStateDrafted() != 'LOADING', click: loadMoreDraftedContents }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">ಇನ್ನಷ್ಟು ವಿಷಯಗಳನ್ನು ಲೋಡ್ ಮಾಡಿ</button><div data-bind="visible: loadingStateDrafted() == 'LOADING'" class="text-center"><span class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div></div></div><div class="author-published-contents js-author-published-contents" data-bind="css: { 'margin-top--1': !author.hasAccessToUpdate() }"><div class="load-more-container mdl-card-border material-title"style="padding: 14px 8px; background-color: #fff;"data-bind="visible: author.hasAccessToUpdate()">ಪ್ರಕಟಿತ ಬರಹಗಳು</div><div data-bind="foreach: { data: publishedPratilipiList, as: 'pratilipi' }, visible: publishedPratilipiList().length > 0"class="mdl-grid pratilipi-list-grid js-pratilipi-list-grid mobile-card"><div class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><!-- ko component: {name: "pratilipi-pratilipi-card",params: { pratilipi: pratilipi, showCategoryButton: true }} --><!-- /ko --></div></div><div class="load-more-container mdl-card-border" data-bind="visible: hasMorePublishedContents()"><button onclick="ga_CA( 'Pratilipi', 'LoadMore' )"data-bind="{ visible: loadingStatePublished() != 'LOADING', click: loadMorePublishedContents }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">ಇನ್ನಷ್ಟು ವಿಷಯಗಳನ್ನು ಲೋಡ್ ಮಾಡಿ</button><div data-bind="visible: loadingStatePublished() == 'LOADING'" class="text-center"><span class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div></div><div class="load-more-container mdl-card-border material-subtitle-1" data-bind="visible: loadingStatePublished() == 'LOADED_EMPTY'">ಕ್ಷಮಿಸಿ! ಈ ಲೇಖಕರ ಪ್ರಕಟಿತ ಪುಸ್ತಕಗಳು ಯಾವುವೂ ಇಲ್ಲ!</div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-servererror-page', { viewModel: function() {} , template: `<div class="server-error-page mdl-card mdl-card-border mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><div class="left-col"><div style="width: 200px; height: 200px; margin: auto;" class="page-not-found-icon"></div></div><div class="right-col"><div class="material-title">ಸರ್ವರ್ ಎರರ್!</div><br/><a href="/" class="material-subtitle-1" style="margin: 16px 0; color: inherit;">Oops, ನಮ್ಮ ಸರ್ವರ್ ಕೆಲವು ಸಮಸ್ಯೆಗಳನ್ನು ಎದುರಿಸುತ್ತಿದೆ! ದಯವಿಟ್ಟು ಪೇಜನ್ನು ರಿಲೋಡ್ ಮಾಡಲು ಇಲ್ಲಿ ಕ್ಲಿಕ್ ಮಾಡಿ.</a><br/><br/><a class="material-subtitle-1" href="/"><i class="material-icons" style="float: left;">home</i><span>ಹೋಮ್</span></a></div></div>` }); </script> <script> ko.components.register( 'pratilipi-event-page', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); var defaultEvent = { "eventId": null, "name": null, "nameEn": null, "language": null, "description": null, "pageUrl": null, "bannerImageUrl": null, "hasAccessToUpdate": false }; this.event = ko.mapping.fromJS( defaultEvent, {}, self.event ); this.updateEvent = function( event, initialiseObject ) { var updatedEvent = JSON.parse( JSON.stringify( initialiseObject ? defaultEvent : event ) ); if( initialiseObject && event != null ) { for( var key in event ) if( event.hasOwnProperty( key ) ) updatedEvent[ key ] = event[ key ]; } ko.mapping.fromJS( updatedEvent, {}, self.event ); MetaTagUtil.setMetaTagsForEvent( ko.mapping.toJS( self.event ) ); }; /* Load initial data */ this.initialDataLoaded = ko.observable( false ); var _handleDataAccessorResponse = function( event, statusCode ) { if( statusCode === 200 ) { self.updateEvent( event, true ); if( !self.initialDataLoaded() ) self.initialDataLoaded( true ); } else if( statusCode === 400 || statusCode === 404 ) { /* Invalid slug/eventId or Page Not Found */ appViewModel.currentView( LOCATION.PAGE_NOT_FOUND["ko_element"] ); } else if( statusCode === 500 ) { /* Server error */ appViewModel.currentView( LOCATION.SERVER_ERROR["ko_element"] ); } else { /* Unhandled error */ console.log( "UNHANDLED_ERROR :: " + event + " :: " + statusCode ); appViewModel.currentView( LOCATION.SERVER_ERROR["ko_element"] ); } }; this.fetchEvent = function() { dataAccessor.getEventBySlug( window.location.pathname.split("/")[2], function( event, status ) { if( status === 200 ) { _handleDataAccessorResponse( event, status ); /* SlugCall failed => fallback to PageUriCall */ } else { dataAccessor.getEventByUri( window.location.pathname, _handleDataAccessorResponse ); } } ); }; /* Event Entries -> Pratilipi List */ var cursor = null; var resultCount = 20; this.pratilipiList = ko.observableArray(); this.hasMoreContents = ko.observable( true ); this.isLoading = ko.observable( false ); this.updatePratilipiList = function( pratilipiList ) { for( var i = 0; i < pratilipiList.length; i++ ) self.pratilipiList.push( ko.mapping.fromJS( pratilipiList[i] ) ); }; this.fetchPratilipiList = function() { if( self.isLoading() || ! self.hasMoreContents() ) return; self.isLoading( true ); dataAccessor.getPratilipiListByEventId( self.event.eventId(), cursor, null, resultCount, function( pratilipiListResponse ) { if( pratilipiListResponse == null ) { self.isLoading( false ); return; } var loadMore = self.pratilipiList().length != 0; var pratilipiList = pratilipiListResponse.pratilipiList; self.updatePratilipiList( pratilipiList ); cursor = pratilipiListResponse.cursor; self.isLoading( false ); self.hasMoreContents( pratilipiList.length == resultCount && cursor != null ); if( loadMore ) ga_CA( 'Pratilipi', 'LoadMore' ); }); }; this.pageScrollObserver = ko.computed( function() { if( ( appViewModel.scrollTop() / $( ".js-pratilipi-list-grid" ).height() ) > 0.6 ) { setTimeout( function() { if( self.event.eventId() == null ) return; self.fetchPratilipiList(); }, 100 ); /* locationObserver and pageScrollObserver will be triggered at once. */ } }, this ); this.eventIdListener = ko.computed( function() { if( self.event.eventId() == null ) return; setTimeout( function() { self.fetchPratilipiList(); }, 0); }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.EVENT.ko_element ) { /* Dispose all observers */ self.locationObserver.dispose(); self.pageScrollObserver.dispose(); self.eventIdListener.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { self.pratilipiList( [] ); self.hasMoreContents( true ); self.isLoading( false ); self.initialDataLoaded( false ); self.fetchEvent(); }, 0 ); }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName) { switch (eventName) { case 'LANDED_EVENTM_EVENT': FacebookEventTriggerUtil.triggerFacebookEventByNameAndParentId('LANDED_EVENTM_EVENT', self.event.eventId()); break; case 'UPDATEEVENTINFO_EVENTM_EVENT': FacebookEventTriggerUtil.triggerFacebookEventByNameAndParentId('UPDATEEVENTINFO_EVENTM_EVENT', self.event.eventId()); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; self.triggerFacebookEvent('LANDED_EVENTM_EVENT'); self.triggerEventEditEvent = function() { self.triggerFacebookEvent('UPDATEEVENTINFO_EVENTM_EVENT'); return true; }; } , template: `<div data-bind="visible: ! initialDataLoaded()" class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mdl-card-border mobile-card"><!-- ko component: "pratilipi-loading-state" --><!-- /ko --></div><div class="pratilipi-event-page" data-bind="visible: initialDataLoaded()" style="flex-grow: 1; width: 100%;"><div class="mdl-card mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card image-holder"><img data-bind="attr: { src: event.bannerImageUrl() }" /></div><div class="mdl-card mdl-card-border mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card description-holder"><div class="event-title-holder"><div data-bind="text: event.name()" class="material-heading"></div><a data-bind="{ visible: event.hasAccessToUpdate(), attr: { 'href': '/edit-event?id=' + event.eventId() }, click: triggerEventEditEvent }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin small-button pull-right"><i class="material-icons material-icons-16">create</i></a></div><div data-bind="html: event.description()" class="material-subtitle-1"></div></div><div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card event-entries"><div data-bind="visible: pratilipiList().length > 0"class="load-more-container mdl-card-border material-heading"style="margin-top: 0; border-top: none;">ಕಾರ್ಯಕ್ರಮ ನಮೂದುಗಳು</div><div data-bind="foreach: { data: pratilipiList, as: 'pratilipi' }, visible: pratilipiList().length > 0"class="mdl-grid pratilipi-list-grid js-pratilipi-list-grid mobile-card"><div class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><!-- ko component: {name: "pratilipi-pratilipi-card",params: { pratilipi: pratilipi }} --><!-- /ko --></div></div><div class="load-more-container mdl-card-border" data-bind="visible: hasMoreContents()"><button data-bind="{ visible: ! isLoading(), click: fetchPratilipiList }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">ಇನ್ನಷ್ಟು ವಿಷಯಗಳನ್ನು ಲೋಡ್ ಮಾಡಿ</button><div data-bind="visible: isLoading()" class="text-center"><span class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-author-page', { viewModel: function() { var self = this; var defaultAuthor = { "authorId": null, "user": { "userId": null, "followCount": 0 }, "firstName": null, "firstNameEn": null, "lastName": null, "lastNameEn": null, "name": null, "nameEn": null, "fullName": null, "fullNameEn": null, "gender": null, "dateOfBirth": null, "language": null, "location": null, "summary": null, "pageUrl": null, "imageUrl": null, "hasCoverImage": false, "coverImageUrl": null, "hasProfileImage": false, "profileImageUrl": null, "registrationDateMillis": null, "followCount": 0, "contentDrafted": 0, "contentPublished": 0, "totalReadCount": 0, "totalFbLikeShareCount": 0, "following": false, "hasAccessToUpdate": false }; var defaultUserAuthor = { "authorId": null, "following": false }; this.author = ko.mapping.fromJS( defaultAuthor, {}, self.author ); this.userAuthor = ko.mapping.fromJS( defaultUserAuthor, {}, self.userAuthor ); this.updateAuthor = function( author, initialiseObject ) { var updatedAuthor = JSON.parse( JSON.stringify( initialiseObject ? defaultAuthor : author ) ); if( initialiseObject && author != null ) { if( author.summary != null && author.summary.trim() == "" ) author.summary = null; for( var key in author ) if( author.hasOwnProperty( key ) ) updatedAuthor[ key ] = author[ key ]; if( author.user != null ) { for( var key in author.user ) if( author.user.hasOwnProperty( key ) ) updatedAuthor.user[ key ] = author.user[ key ]; } } ko.mapping.fromJS( updatedAuthor, {}, self.author ); MetaTagUtil.setMetaTagsForAuthor( ko.mapping.toJS( self.author ) ); appViewModel.isUserPage( self.author.authorId() == appViewModel.user.author.authorId() ); }; this.updateUserAuthor = function( userAuthor, initialiseObject ) { var updatedUserAuthor = JSON.parse( JSON.stringify( initialiseObject ? defaultUserAuthor : userAuthor ) ); if( initialiseObject && userAuthor != null ) { for( var key in userAuthor ) if( userAuthor.hasOwnProperty( key ) ) updatedUserAuthor[ key ] = userAuthor[ key ]; } ko.mapping.fromJS( updatedUserAuthor, {}, self.userAuthor ); }; var _fireFbEvent = function(author) { var _getGender = function(gender) { if (gender === "MALE") { return "M"; } else if (gender === "FEMALE") { return "F"; } }; FacebookEventTriggerUtil.setUserProperties('DOB', author.dateOfBirth); FacebookEventTriggerUtil.setUserProperties('GENDER', _getGender(author.gender)); FacebookEventTriggerUtil.setUserProperties('JOINING_DATE', author.registrationDateMillis); FacebookEventTriggerUtil.setUserProperties('DRAFT_COUNT', author.contentDrafted); FacebookEventTriggerUtil.setUserProperties('PUBLISHED_COUNT', author.contentPublished); FacebookEventTriggerUtil.setUserProperties('FOLLOWER_COUNT', author.followCount); FacebookEventTriggerUtil.setUserProperties('FOLLOWING_COUNT', author.user.followCount); }; /* Load initial data */ this.initialDataLoaded = ko.observable( false ); var _handleDataAccessorResponse = function( author, statusCode ) { if( statusCode === 200 ) { self.updateAuthor( author, true ); self.updateUserAuthor( author, true ); if( !self.initialDataLoaded() ) self.initialDataLoaded( true ); _fireFbEvent( author ); } else if( statusCode === 400 || statusCode === 404 ) { /* Page Not Found => Invalid slug */ appViewModel.currentView( LOCATION.PAGE_NOT_FOUND["ko_element"] ); } else if( statusCode === 500 ) { /* Server error */ appViewModel.currentView( LOCATION.SERVER_ERROR["ko_element"] ); } else { /* Unhandled error */ console.log( "UNHANDLED_ERROR :: " + author + " :: " + statusCode ); appViewModel.currentView( LOCATION.SERVER_ERROR["ko_element"] ); } }; this.fetchAuthorAndUserAuthor = function() { var dataAccessor = new DataAccessor(); if (window.location.pathname.startsWith( "/user/" )) { dataAccessor.getAuthorBySlug( window.location.pathname.split("/")[2], _handleDataAccessorResponse ); } else { dataAccessor.getAuthorByUri( window.location.pathname, _handleDataAccessorResponse ); } }; /* Landing from Search page */ var searchQuery = getUrlParameter( "searchQuery" ) != null ? decodeURIComponent( getUrlParameter( "searchQuery" ) ) : null; this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.AUTHOR.ko_element ) { if( appViewModel.currentView() == LOCATION.SEARCH_V2.ko_element && searchQuery != null ) { setTimeout( function() { appViewModel.searchQuery( searchQuery ); }, 50 ); } /* Dispose all observers */ self.locationObserver.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { self.initialDataLoaded( false ); self.fetchAuthorAndUserAuthor(); $( ".modal" ).modal( "hide" ); /* Follows Modal */ }, 0 ); }, this ); } , template: `<div data-bind="visible: ! initialDataLoaded()" class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mdl-card-border mobile-card"><!-- ko component: "pratilipi-loading-state" --><!-- /ko --></div><div data-bind="visible: initialDataLoaded()" style="flex-grow: 1; width: 100%;"><!-- ko component: {name: "pratilipi-author-follows",params: { author: author }} --><!-- /ko --><!-- ko component: {name: "pratilipi-author-info",params: { author: author,updateAuthor: $data.updateAuthor,userAuthor: userAuthor,updateUserAuthor: $data.updateUserAuthor }} --><!-- /ko --><!-- ko component: {name: "pratilipi-author-contents",params: { author: author }} --><!-- /ko --></div>` }); </script> <script> ko.components.register( 'pratilipi-notification-list', { viewModel: function( params ) { var self = this; var resultCount = params.resultCount; this.notificationsPageBehaviour = params.notificationsPageBehaviour != null ? params.notificationsPageBehaviour : false; var listenToFirebase = params.listenToFirebase != null ? params.listenToFirebase : false; var dataAccessor = new DataAccessor(); var cursor = null; /* Loading state */ /* * 4 Possible values for 'loadingState' * LOADING * LOADED_EMPTY * LOADED * FAILED * * */ this.loadingState = ko.observable(); this.notificationList = ko.observableArray(); this.hasMoreContents = ko.observable( false ); this.setNotificationList = function( notificationList ) { self.notificationList( [] ); self.updateNotificationList( notificationList ); }; this.updateNotificationList = function( notificationList ) { for( var i = 0; i < notificationList.length; i++ ) self.notificationList.push( ko.mapping.fromJS( notificationList[i] ) ); }; this.fetchNotificationList = function() { debugger; if( self.loadingState() == "LOADING" ) return; self.loadingState( "LOADING" ); dataAccessor.getNotificationList( cursor, resultCount, function( notificationListResponse ) { if( notificationListResponse == null ) { self.loadingState( "FAILED" ); return; } var notificationList = notificationListResponse[ "notificationList" ]; self.loadingState( self.notificationList().length > 0 || notificationList.length > 0 ? "LOADED" : "LOADED_EMPTY" ); if( ! self.notificationsPageBehaviour ) { self.setNotificationList( notificationList ); return; } cursor = notificationListResponse.cursor; self.updateNotificationList( notificationList ); self.hasMoreContents( notificationList.length == resultCount && self.notificationsPageBehaviour ); }); }; this.resetNotificationList = function() { self.fetchNotificationList( true ); }; this.markNotificationRead = function( vm, e ) { var notifId = vm.notificationId; self.triggerFacebookEvent('CLICKNOTIF', vm.state(), vm.androidHandler(), notifId()); for( var i = 0; i < self.notificationList().length; i++ ) { if( notifId == self.notificationList()[i].notificationId ) { self.notificationList()[i].state( "READ" ); break; } } return true; }; this.userObserver = ko.computed( function() { if( ! appViewModel.user.isGuest() ) { setTimeout( self.fetchNotificationList, 0 ); } }, this ); this.notificationCountObserver = ko.computed( function() { if( ! appViewModel.user.isGuest() && appViewModel.notificationCount() != 0 && listenToFirebase ) { setTimeout( self.resetNotificationList, 0 ); } }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName, state, value, parentId) { switch (eventName) { case 'CLICKNOTIF': if (params.notificationsPageBehaviour) { FacebookEventTriggerUtil.triggerFacebookEventByNameStateValueAndParentId('CLICKNOTIF_NOTIFSM_NOTIFS', state, value, parentId); } else { FacebookEventTriggerUtil.triggerFacebookEventByNameStateValueAndParentId('CLICKNOTIF_HEADER_GLOBAL', state, value, parentId); } break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; } , template: `<ul class="pratilipi-notification-list"><!-- ko foreach: { data: notificationList, as: 'notification' } --><!--ko if: notification.message && notification.message() --><li class="mdl-menu__item"data-bind="css: { 'notif-unread': ( notification.state() == 'UNREAD' ) }"><span class="notification-message"><a onclick="ga_CA( 'Notification', 'Open' )"data-bind="attr: { 'href': notification.sourceUrl() }, click: $parent.markNotificationRead"><span style="display: flex;"><span class="notification-display-image"><img class="img-circle" data-bind="attr: { src: getImageUrl( notification.displayImageUrl(), 48 ) }" /></span><span class="notification-message-holder"><span class="font-s" data-bind="html: notification.message()"></span><br/><span class="notification-meta"><span class="text-muted font-xs" data-bind="text: convertDate( notification.lastUpdatedMillis() )"></span></span></span><span class="notification-source-image" data-bind="if: notification.sourceImageUrl && notification.sourceImageUrl()"><img data-bind="attr: { src: getImageUrl( notification.sourceImageUrl(), 48 ) }" /></span></span></a></span></li><!--/ko--><!--/ko--><li class="mdl-menu__item show-more" data-bind="visible: hasMoreContents() && loadingState() != 'LOADING'"><button onclick="ga_CA( 'Notification', 'Load More' )"data-bind="click: fetchNotificationList"class="mdl-button mdl-js-button">ಇನ್ನೂ ಹೆಚ್ಚು ತೋರಿಸಿ</button></li></ul><div data-bind="visible: loadingState() == 'LOADING'"class="spinner-holder"><span data-bind="visible: notificationList().length > 0 || ! notificationsPageBehaviour"class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span><pratilipi-loading-state data-bind="visible: notificationList().length == 0 && notificationsPageBehaviour"></pratilipi-loading-state></div><div style="margin: 25px 15px;" class="text-center" data-bind="visible: loadingState() == 'LOADED_EMPTY'"><div data-bind="visible: notificationsPageBehaviour" style="width: 200px; height: 200px; margin: auto;" class="empty-notifications-icon"></div>ಕ್ಷಮಿಸಿ!ಸದ್ಯ ನಿಮಗೆ ಯಾವ ಸೂಚನೆಗಳೂ ಇಲ್ಲ! ದಯವಿಟ್ಟು ನಂತರ ಪರಿಶೀಲಿಸಿ!</div><div style="margin: 25px 15px;" data-bind="visible: loadingState() == 'FAILED'"><a style="cursor: pointer; color: #555;" data-bind="click: fetchNotificationList">ನೋಟಿಫಿಕೇಶನ್ಸ್ ಲೋಡ್ ಆಗುವಲ್ಲಿ ವಿಫಲಗೊಂಡಿವೆ. ನೋಟಿಫಿಕೇಶನ್ಸ್ ರೀ-ಲೋಡ್ ಮಾಡಲು ದಯವಿಟ್ಟು ಇಲ್ಲಿ ಕ್ಲಿಕ್ ಮಾಡಿ!</a></div>` }); </script> <script> ko.components.register( 'pratilipi-review-comment', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.comment = params.comment; this.pratilipi = params.pratilipi; this.deleteComment = params.deleteComment; this.toggleCommentInput = params.toggleCommentInput; this.isLiked = ko.observable( self.comment.isLiked ? self.comment.isLiked() : false ); this.likeCount = ko.observable( self.comment.likeCount ? self.comment.likeCount() : 0 ); /* Like / Dislike Comment */ this.voteRequestOnFlight = ko.observable( false ); this.likeOrDislikeComment = function() { if( appViewModel.user.isGuest() ) { this.triggerFacebookEvent('LIKE_COMMENTS_BOOK'); goToLoginPage(); return; } if( self.voteRequestOnFlight() ) return; self.voteRequestOnFlight( true ); var toggleIsLiked = function() { self.likeCount( self.isLiked() ? self.likeCount() - 1 : self.likeCount() + 1 ); self.isLiked( ! self.isLiked() ); }; toggleIsLiked(); if (self.isLiked()) { this.triggerFacebookEvent('LIKE_COMMENTS_BOOK'); } else { this.triggerFacebookEvent('UNLIKE_COMMENTS_BOOK'); } dataAccessor.likeOrDislikeComment( self.comment.commentId(), self.isLiked(), function( vote ) { self.voteRequestOnFlight( false ); }, function( error ) { toggleIsLiked(); self.voteRequestOnFlight( false ); ToastUtil.toast( error.message != null ? error.message : "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!" ); }); }; /* Edit Comment - Input */ this.editCommentInput = ko.observable(); this.editCommentVisible = ko.observable( false ); this.openEditComment = function() { self.editCommentInput( self.comment.content() ); self.editCommentVisible( true ); }; this.closeEditComment = function() { self.editCommentVisible( false ); }; /* Edit Comment - Submit */ this.editCommentRequestOnFlight = ko.observable( false ); this.submitEditComment = function() { if( self.editCommentRequestOnFlight() ) return; self.editCommentRequestOnFlight( true ); ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); dataAccessor.createOrUpdateReviewComment( null, self.comment.commentId(), self.editCommentInput(), function( comment ) { self.comment.content( comment.content ); self.closeEditComment(); self.editCommentRequestOnFlight( false ); self.triggerFacebookEvent('EDITCOMMENT_COMMENTS_BOOK', 'UPDATE', self.comment.commentId()); ToastUtil.toast( "ಯಶಸ್ವಿ!" ); }, function( error ) { self.editCommentRequestOnFlight( false ); ToastUtil.toast( error.message != null ? error.message : "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!" ); }); }; /* Report comment */ this.reportContent = function() { ReportUtil.report( "COMMENT", self.comment.commentId() ); }; /* Computed observables */ this.canSubmitEditComment = ko.computed( function() { return self.editCommentVisible() && self.editCommentInput() != null && self.editCommentInput().trim() != "" && ! self.editCommentRequestOnFlight(); }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName, state, parentId) { switch (eventName) { case 'CLICKUSER_COMMENTS_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId('CLICKUSER_COMMENTS_BOOK', self.pratilipi, self.comment.user.userId() ); break; case 'LIKE_COMMENTS_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiParentIdAndValue('LIKE_COMMENTS_BOOK', self.pratilipi, self.comment.commentId(), self.likeCount() ); break; case 'UNLIKE_COMMENTS_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiParentIdAndValue('UNLIKE_COMMENTS_BOOK', self.pratilipi, self.comment.commentId(), self.likeCount() ); break; case 'EDITCOMMENT_COMMENTS_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiStateAndParentId(eventName, self.pratilipi, state, parentId ); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.triggerClickUserFbEvent = function() { self.triggerFacebookEvent('CLICKUSER_COMMENTS_BOOK'); return true; } } , template: `<div class="pratilipi-review-comment"><div class="comment-header"><div class="user-info"><img data-bind="attr: { src: getImageUrl( comment.user.profileImageUrl(), 48 ) }" class="mdl-list__item-avatar"><div style="padding: 0 8px;"><a class="commentor-name material-subtitle-1" data-bind="attr: { href: comment.user.profilePageUrl() }, text: comment.user.displayName(), click: triggerClickUserFbEvent"></a><br/><span class="font-xs comment-date" data-bind="text: convertDate( comment.creationDateMillis() )"></span></div></div><div class="three-dots pull-right"><button class="mdl-button mdl-js-button mdl-button--icon" data-bind="attr: { 'id': 'pratilipi-review-comment-' + comment.commentId() }"><i class="material-icons">more_vert</i></button><ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect"data-bind="attr: { 'data-mdl-for': 'pratilipi-review-comment-' + comment.commentId() }"><li data-bind="click: reportContent, visible: ! comment.hasAccessToUpdate()" class="mdl-menu__item">Report Comment</li><li data-bind="click: openEditComment, visible: comment.hasAccessToUpdate()" class="mdl-menu__item">ಕಾಮೆಂಟ್ ಎಡಿಟ್ ಮಾಡಿ</li><li data-toggle="modal"data-bind="attr: { 'data-target': '#pratilipi-comment-delete-confirmation-' + comment.commentId() }, visible: comment.hasAccessToUpdate()"class="mdl-menu__item">ಕಾಮೆಂಟ್ ಡಿಲೀಟ್ ಮಾಡಿ</li></ul></div></div><div data-bind="visible: ! editCommentVisible()"><div class="comment-container material-subtitle-1" data-bind="text: comment.content()"></div><div class="comment-footer"><span class="like-holder"><span class="font-s" data-bind="visible: likeCount() > 0, text: likeCount()"></span><button data-bind="click: likeOrDislikeComment, disable: voteRequestOnFlight" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"><i class="material-icons material-icons-16" data-bind="css: { 'mdl-color-text--primary': isLiked() }">thumb_up</i></button></span><span class="separator"></span><span class="comment-holder"><button data-bind="click: toggleCommentInput" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"><i class="material-icons material-icons-16">message</i></button></span></div></div><div class="comment-container" data-bind="visible: editCommentVisible()"><textarea data-bind="{ mdlFloatingInput: { label: 'ಪ್ರತಿಕ್ರಿಯಿಸಲು ಇಲ್ಲಿ ಟೈಪ್ ಮಾಡಿ',value: editCommentInput, id: 'pratilipi-review-comment-input-' + comment.commentId() },valueUpdate: ['input'],transliterate: true }"></textarea><div style="height: 36px;"><div class="pull-right"><button data-bind="click: closeEditComment" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin">ರದ್ದುಪಡಿಸಿ</button><button data-bind="enable: canSubmitEditComment, click: submitEditComment" class="mdl-button mdl-js-button mdl-button--colored mdl-js-ripple-effect mdl-button--raised">ಸಬ್ಮಿಟ್ ಮಾಡಿ</button></div></div></div><!-- Delete Comment Modal --><div class="modal common-modal fade" tabindex="-1" role="dialog" data-bind="attr: { 'id': 'pratilipi-comment-delete-confirmation-' + comment.commentId() }"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button data-dismiss="modal" class="mdl-button mdl-js-button mdl-button--icon close"><i class="material-icons">close</i></button><h6 class="modal-title">ಕಾಮೆಂಟ್ ಡಿಲೀಟ್ ಮಾಡಿ</h6></div><div class="modal-body"><div class="material-subtitle-2">ನೀವು ನಿಸ್ಸಂದೇಹವಾಗಿ ಈ ಕಾಮೆಂಟನ್ನು ಡಿಲೀಟ್ ಮಾಡುವಿರಾ?</div></div><div class="modal-footer"><button data-bind="click: deleteComment" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin pull-left">ಹೌದು</button><button class="mdl-button mdl-js-button mdl-button--colored mdl-js-ripple-effect mdl-button--raised" data-dismiss="modal">ಇಲ್ಲ</button></div></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-videoseries-page', { viewModel: function pratilipiVideoseriesPage(params) { var self = this; var dataAccessor = new DataAccessor(); this.initialDataLoaded = ko.observable(); /* Loading state */ /* * 4 Possible values for 'loadingState' * LOADING * LOADED_EMPTY * LOADED * FAILED * * */ this.latestVideoLoadingState = ko.observable(); this.allVideosLoadingState = ko.observable(); var defaultVideoseries = { "displayTitle": null, "imageUrl": null, "type": null, "videoUrl": null, "videoEmbedUrl": null, "pageUrl": null, "description": null }; var defaultLatestVideo = { "displayTitle": null, "imageUrl": null, "type": null, "videoUrl": null, "videoEmbedUrl": null, "pageUrl": null, "description": null }; this.videoseries = ko.mapping.fromJS( defaultVideoseries, {}, self.videoseries ); this.latestVideo = ko.mapping.fromJS( defaultLatestVideo, {}, self.latestVideo ); this.allVideoList = ko.observableArray(); /* All Videos */ this.allVideosOffset; this.allVideosLoadMore = ko.observable(); var ALL_VIDEOS_LIMIT = 12; this.updateVideoseries = function( videoseries, initialiseObject ) { var updatedVideoseries = JSON.parse( JSON.stringify( initialiseObject ? defaultVideoseries : videoseries ) ); if( initialiseObject && videoseries != null ) { for( var key in videoseries ) if( videoseries.hasOwnProperty( key ) ) updatedVideoseries[ key ] = videoseries[ key ]; } ko.mapping.fromJS( updatedVideoseries, {}, self.videoseries ); }; this.updateLatestVideo = function( latestVideo, initialiseObject ) { var updatedLatestVideo = JSON.parse( JSON.stringify( initialiseObject ? defaultLatestVideo : latestVideo ) ); if( initialiseObject && latestVideo != null ) { for( var key in latestVideo ) if( latestVideo.hasOwnProperty( key ) ) updatedLatestVideo[ key ] = latestVideo[ key ]; } ko.mapping.fromJS( updatedLatestVideo, {}, self.latestVideo ); }; this.updateAllVideoList = function( allVideoList, initialiseObject ) { for( var i = 0; i < allVideoList.length; i++ ) self.allVideoList.push( ko.mapping.fromJS( allVideoList[i] ) ); }; var _handleVideoseriesResponse = function( response, statusCode ) { if( statusCode === 200 ) { self.updateVideoseries( response.data[0], true ); self.initialDataLoaded( true ); /* MetaTagUtil */ MetaTagUtil.setMetaTagsForVideoseries( ko.mapping.toJS( self.videoseries ) ); } else if( statusCode === 400 || statusCode === 404 ) { /* Invalid slug or Page Not Found */ appViewModel.currentView( LOCATION.PAGE_NOT_FOUND["ko_element"] ); } else if( statusCode === 500 ) { /* Server error */ appViewModel.currentView( LOCATION.SERVER_ERROR["ko_element"] ); } else { /* Unhandled error */ console.log( "UNHANDLED_ERROR :: " + response + " :: " + statusCode ); appViewModel.currentView( LOCATION.SERVER_ERROR["ko_element"] ); } }; var _handleLatestVideoResponse = function( response, statusCode ) { if( statusCode === 200 ) { if( response.data.length > 0 ) { self.updateLatestVideo( response.data[0], true ); self.latestVideoLoadingState( "LOADED" ); } else { self.latestVideoLoadingState( "LOADED_EMPTY" ); } } else { self.latestVideoLoadingState( "FAILED" ); } }; var _handleAllVideoResponse = function( response, statusCode ) { if( statusCode === 200 ) { if( response.data.length > 0 ) { self.updateAllVideoList( response.data ); self.allVideosLoadingState( "LOADED" ); /* update offset */ self.allVideosOffset = response.offset; self.allVideosLoadMore( response.data.length === ALL_VIDEOS_LIMIT ); } else { self.allVideosLoadingState( "LOADED_EMPTY" ); self.allVideosLoadMore( false ); } } else { self.allVideosLoadingState( "FAILED" ); } }; this.fetchInitialData = function() { dataAccessor.getVideoseries( window.location.pathname.split("/")[2], _handleVideoseriesResponse ); }; this.fetchLatestVideoData = function() { dataAccessor.getVideoseriesLatest( window.location.pathname.split("/")[2], _handleLatestVideoResponse ); }; this.fetchAllVideoData = function() { dataAccessor.getVideoseriesAll( window.location.pathname.split("/")[2], self.allVideosOffset, ALL_VIDEOS_LIMIT, _handleAllVideoResponse ); }; /* Initialising */ this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.VIDEOSERIES.ko_element ) { /* Dispose all observers */ self.locationObserver.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { /* Initialising variables */ self.initialDataLoaded( false ); self.latestVideoLoadingState( "LOADING" ); self.allVideosLoadingState( "LOADING" ); self.allVideosOffset = 0; self.allVideosLoadMore( true ); /* Calling functions */ self.fetchInitialData(); self.fetchLatestVideoData(); self.fetchAllVideoData(); }); }, this ); } , template: `<div data-bind="visible: ! initialDataLoaded()" class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mdl-card-border mobile-card"><!-- ko component: "pratilipi-loading-state" --><!-- /ko --></div><div data-bind="visible: initialDataLoaded()" class="pratilipi-videoseries-page mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><div class="videoseries-info-container"><div class="videoseries-info-media-container"><!-- ko if: ( videoseries.type() == 'IMAGE' ) --><div class="img-container"><img data-bind="attr: { src: videoseries.imageUrl(), alt: videoseries.displayTitle() }"/></div><!-- /ko --><!-- ko if: ( videoseries.type() == 'VIDEO' ) --><div class="iframe-container"><iframe data-bind="attr: { src: getYoutubeVideo( videoseries.videoEmbedUrl() ) }"frameborder="0"allow="autoplay; encrypted-media"allowfullscreen></iframe></div><!-- /ko --></div><div class="videoseries-info-description-container"><div data-bind="text: videoseries.displayTitle()" class="material-title title-padding"></div><div data-bind="html: videoseries.description()" class="material-subtitle-1"></div></div></div><div class="latest-video-container" data-bind="visible: latestVideoLoadingState() == 'LOADING' || latestVideoLoadingState() == 'LOADED'"><div data-bind="visible: latestVideoLoadingState() == 'LOADING'" class="mdl-spinner-container"><span class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div><div class="latest-video-inner-container" data-bind="visible: latestVideoLoadingState() == 'LOADED'"><div class="material-title title-padding">ಹೊಸ ಅಧ್ಯಾಯ</div><div class="mdl-grid"><div class="mdl-cell mdl-cell--6-col latest-video-media-container"><!-- ko if: ( latestVideo.type() == 'IMAGE' ) --><a data-bind="attr: { href: latestVideo.pageUrl() }"><img data-bind="attr: { src: latestVideo.imageUrl(), alt: latestVideo.displayTitle() }" /></a><!-- /ko --><!-- ko if: ( latestVideo.type() == 'VIDEO' ) --><div class="iframe-container"><iframe data-bind="attr: { src: getYoutubeVideo( latestVideo.videoEmbedUrl() ) }"frameborder="0"allow="autoplay; encrypted-media"allowfullscreen></iframe></div><!-- /ko --></div><div class="mdl-cell mdl-cell--6-col latest-video-info-container"><a data-bind="attr: { href: latestVideo.pageUrl() }, text: latestVideo.displayTitle()" class="material-subtitle-1"></a><div data-bind="text: latestVideo.description()" class="material-caption latest-video-description"></div></div></div></div></div><div class="all-videos-container" data-bind="visible: allVideosLoadingState() == 'LOADING' || allVideoList().length > 0"><div class="all-videos-inner-container" data-bind="visible: allVideoList().length > 0"><div class="material-title title-padding">ಎಲ್ಲಾ ಅಧ್ಯಾಯಗಳು</div><div class="mdl-grid" data-bind="foreach: { data: allVideoList, as: 'video' }"><div class="video-card mobile-card mdl-cell mdl-cell--4-col-desktop mdl-cell--4-col-tablet mdl-cell--12-col-phone"><div class="video-card-inner-container"><div class="media-container"><!-- ko if: ( video.type() == 'IMAGE' ) --><a class="reco-container" data-bind="{style: {'background-image': 'url(' + video.hqImageUrl() + ')','background-repeat': 'no-repeat','background-size': 'cover','background-position': 'center center'},attr: {href: video.pageUrl()}}"></a><!-- /ko --><!-- ko if: ( video.type() == 'VIDEO' ) --><div class="iframe-container"><iframe data-bind="attr: { src: getYoutubeVideo( video.videoEmbedUrl() ) }"frameborder="0"allow="autoplay; encrypted-media"allowfullscreen></iframe></div><!-- /ko --></div><a class="material-subtitle-1 video-display-title" data-bind="attr: { href: video.pageUrl() }, text: video.displayTitle()"></a></div></div></div></div><div class="load-more-container" data-bind="visible: allVideosLoadingState() != 'LOADING' && allVideosLoadMore()"><button class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect" data-bind="click: fetchAllVideoData">ಇನ್ನೂ ಹೆಚ್ಚು ತೋರಿಸಿ</button></div><div data-bind="visible: allVideosLoadingState() == 'LOADING'" class="mdl-spinner-container"><span class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-blog-page', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); var BLOG_LIST_RESULT_COUNT = 10; this.title = ko.observable(); this.cursor = null; this.blogPostList = ko.observableArray(); this.isLoading = ko.observable(); this.hasMoreContents = ko.observable(); this.updateBlogPostList = function( blogPostList ) { for( var i = 0; i < blogPostList.length; i++ ) self.blogPostList.push( blogPostList[i] ); }; this.fetchBlogPostList = function() { if( self.isLoading() || ! self.hasMoreContents() ) return; self.isLoading( true ); dataAccessor.getBlogPostListByUri( window.location.pathname, "PUBLISHED", self.cursor, BLOG_LIST_RESULT_COUNT, function( blogPostListResponse, status ) { if( status !== 200 ) { self.isLoading( false ); return; } var blogPostList = blogPostListResponse.blogPostList; self.updateBlogPostList( blogPostList ); self.cursor = blogPostListResponse.cursor; self.isLoading( false ); self.hasMoreContents( blogPostList.length == BLOG_LIST_RESULT_COUNT && self.cursor != null ); }); }; this.pageScrollObserver = ko.computed( function() { if( ( appViewModel.scrollTop() / $( ".js-pratilipi-blog-post-grid" ).height() ) > 0.6 ) { setTimeout( function() { self.fetchBlogPostList(); }, 100 ); /* locationObserver and pageScrollObserver will be triggered at once. */ } }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.BLOG.ko_element && appViewModel.currentView() != LOCATION.AUTHOR_INTERVIEWS.ko_element ) { /* Dispose all observers */ self.locationObserver.dispose(); self.pageScrollObserver.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { self.title( window.location.pathname == "/blog" ? "ಪ್ರತಿಲಿಪಿ ಕನ್ನಡ ಬ್ಲಾಗ್ ಮತ್ತು ಸಂಪಾದಕೀಯ" : "ಪ್ರತಿಲಿಪಿ ಕನ್ನಡದಲ್ಲಿನ ಜನಪ್ರಿಯ ಬರಹಗಾರರ ಸಂದರ್ಶನಗಳು" ); self.cursor = null; self.blogPostList([]); self.isLoading( false ); self.hasMoreContents( true ); self.fetchBlogPostList(); if( window.location.pathname === "/blog" ) MetaTagUtil.setMetaTagsForBlog(); else if( window.location.pathname === "/author-interviews" ) MetaTagUtil.setMetaTagsForAuthorInterview(); }, 0 ); }, this ); var container = $( ".pratilipi-blog-page .js-blog-post-content" ); var lineHeight = parseInt( container.css( "line-height" ) ); container.css( "max-height", (lineHeight*3) + 'px' ); } , template: `<div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card pratilipi-blog-page generic-list-page"><div class="load-more-container mdl-card-border material-heading"data-bind="text: title()"style="margin-top: 0;"></div><div data-bind="foreach: { data: blogPostList, as: 'blogPost' }, visible: blogPostList().length > 0"class="mdl-grid pratilipi-list-grid js-pratilipi-blog-post-grid mobile-card"><a class="blog-post-container" data-bind="{ attr: { 'href': blogPost.pageUrl }, click: ga_CA( window.location.pathname == '/blog' ? 'Blog' : 'AuthorInterview', 'Open' ); }"><div class="blog-post-snippet"><div class="material-title blog-post-title pratilipi-red" data-bind="text: blogPost.title"></div><div class="material-subtitle-2 blog-post-content js-blog-post-content" data-bind="text: blogPost.content"></div><div class="material-subtitle-2 see-more">ಇನ್ನೂ ಹೆಚ್ಚು ತೋರಿಸಿ</div></div></a></div><div class="load-more-container mdl-card-border" data-bind="visible: hasMoreContents()"><button data-bind="{ visible: ! isLoading(), click: fetchBlogPostList }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">ಇನ್ನಷ್ಟು ವಿಷಯಗಳನ್ನು ಲೋಡ್ ಮಾಡಿ</button><div data-bind="visible: isLoading()" class="text-center"><span data-bind="visible: blogPostList().length > 0" class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span><pratilipi-loading-state data-bind="visible: blogPostList().length == 0"></pratilipi-loading-state></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-edit-pratilipi', { viewModel: function( params ) { var self = this; var editPratilipiDialog = $( "#pratilipi_edit_pratilipi" ); var dropdown = $( "#pratilipi_edit_pratilipi #pratilipi_edit_pratilipi_type" ); this.pratilipi = params.pratilipi; this.updatePratilipi = params.updatePratilipi; this.pratilipiId = ko.observable( null ); this.title = ko.observable(); this.titleEn = ko.observable(); /* this.type = ko.observable(); */ this.setToDefault = function() { self.pratilipiId( self.pratilipi.pratilipiId() ); self.title( self.pratilipi.title() ); self.titleEn( self.pratilipi.titleEn() ); /* self.type( self.pratilipi.type() ); dropdown.attr( 'data-val', self.pratilipi.type() ); dropdown.attr( 'value', getPratilipiTypeVernacular( self.pratilipi.type() ) ); dropdown.val( getPratilipiTypeVernacular( self.pratilipi.type() ) ); */ getmdlSelect.init( ".getmdl-select" ); }; this.pratilipiObserver = ko.computed( function() { if( self.pratilipi.pratilipiId() == null ) return; setTimeout( function() { self.setToDefault(); }, 0 ); }, this ); this.requestOnFlight = ko.observable( false ); this.submit = function() { if( self.requestOnFlight() ) return; if( self.title().trim() == "" ) { ToastUtil.toast( "ದಯವಿಟ್ಟು ಶೀರ್ಷಿಕೆಯನ್ನು ನಮೂದಿಸಿ" ); return; } /* if( self.type() == null || self.type().trim() == "" ) { ToastUtil.toast( "ದಯವಿಟ್ಟು ಪ್ರಭೇದವನ್ನು ಆಯ್ಕೆಮಾಡಿಕೊಳ್ಳಿ" ); return; } */ var successCallBack = function( pratilipi ) { ToastUtil.toast( "ಯಶಸ್ವಿ!" ); self.updatePratilipi( pratilipi ); self.requestOnFlight( false ); self.closeEditPratilipi(); }; var errorCallBack = function( error, status ) { ToastUtil.toast( error.message != null ? error.message : "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!", 3000 ); self.requestOnFlight( false ); }; ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); var pratilipi = { "pratilipiId": self.pratilipiId(), "title": self.title(), "titleEn": self.titleEn() /* "type": self.type() */ }; self.requestOnFlight( true ); var dataAccessor = new DataAccessor(); dataAccessor.createOrUpdatePratilipi( pratilipi, successCallBack, errorCallBack ); if (self.pratilipi.title() !== self.title()) { self.triggerFacebookEvent('EDITTITLE_BOOKTITLE_BOOK'); } if (self.pratilipi.titleEn() !== self.titleEn()) { self.triggerFacebookEvent('EDITTITLEENG_BOOKTITLE_BOOK'); } }; /* this.updateType = function() { self.type( dropdown.attr( "data-val" ) ); }; */ this.canEditPratilipi = ko.computed( function() { return self.title() != null && self.title() != "" && ! self.requestOnFlight(); }, this ); this.closeEditPratilipi = function() { editPratilipiDialog.modal( "hide" ); setTimeout( function() { self.setToDefault(); }, 0); }; editPratilipiDialog.on( 'hidden.bs.modal', function(e) { self.closeEditPratilipi(); }); /** * Facebook events */ this.triggerFacebookEvent = function(eventName) { switch (eventName) { case 'EDITTITLE_BOOKTITLE_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('EDITTITLE_BOOKTITLE_BOOK', self.pratilipi ); break; case 'EDITTITLEENG_BOOKTITLE_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi('EDITTITLEENG_BOOKTITLE_BOOK', self.pratilipi ); break; default: console.log('INVALID EVENT TRIGGERED : ', eventName); } return true; }; } , template: `<div class="modal fade pratilipi-edit-pratilipi" id="pratilipi_edit_pratilipi" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><span data-bind="click: closeEditPratilipi" class="material-icons close clickable-element">close</span><h6 class="modal-title">ಮಾಹಿತಿ ಎಡಿಟ್ ಮಾಡಿ</h6></div><div class="modal-body"><input data-bind="{ mdlFloatingInput: { label: 'ಇಲ್ಲಿ ಶೀರ್ಷಿಕೆ ನಮೂದಿಸಿ *', value: title, id: 'pratilipi_edit_pratilipi_title_input' }, valueUpdate: ['input'], transliterate: true }" /><input data-bind="{ mdlFloatingInput: { label: 'ಆಂಗ್ಲ ಭಾಷೆಯಲ್ಲಿ ಶೀರ್ಷಿಕೆಯನ್ನು ಮರು-ನಮೂದಿಸಿ', value: titleEn, id: 'pratilipi_edit_pratilipi_title_en_input' }, valueUpdate: ['input'] }" /></div><div class="modal-footer"><button data-bind="{ click: submit, enable: canEditPratilipi() }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect"type="button">ಬದಲಾವಣೆಗಳನ್ನು ಸಂರಕ್ಷಿಸಿ</button></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-facebook-login', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.requestOnFlight = params.requestOnFlight; this.isRegister = params.isRegister; this.facebookLogin = function() { if( self.requestOnFlight() ) return; FB.login( function( fbResponse ) { if( fbResponse == null || fbResponse.authResponse == null ) { self.requestOnFlight( false ); return; } self.requestOnFlight( true ); ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); dataAccessor.loginFacebookUser( fbResponse.authResponse.accessToken, function( user ) { ToastUtil.toast( "ಯಶಸ್ವಿ!" ); self.triggerFacebookEvent('SIGNUPSUC_FACEBOOK_REGISTER'); window.location.href = self.isRegister ? user[ "profilePageUrl" ] : getRetUrl( true ); }, function( error ) { self.requestOnFlight( false ); var message = "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!"; if( error[ "fbUserAccessToken" ] != null ){ message = error[ "fbUserAccessToken" ]; self.triggerFacebookEvent('SIGNUPERR_FACEBOOK_REGISTER', JSON.stringify(error), 'fbUserAccessToken'); } else if( error[ "message" ] != null ){ message = error[ "message" ]; self.triggerFacebookEvent('SIGNUPERR_FACEBOOK_REGISTER', JSON.stringify(error), 'message'); } ToastUtil.toast( message, 3000, true ); }); }, { scope: 'public_profile,email,user_birthday' } ); }; /** * Facebook events */ this.triggerFacebookEvent = function(eventName, value, parentId) { switch (eventName) { case 'SIGNUPERR_FACEBOOK_REGISTER': FacebookEventTriggerUtil.triggerFacebookEventByName('SIGNUPERR_FACEBOOK_REGISTER'); break; case 'SIGNUPSUC_FACEBOOK_REGISTER': FacebookEventTriggerUtil.triggerFacebookEventByName('SIGNUPSUC_FACEBOOK_REGISTER'); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; } , template: `<button onclick="ga_CA( 'Login', 'FB-Login' )"data-bind="{ click: facebookLogin, disable: requestOnFlight }"type="submit"class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored pratilipi-fb-blue-button login-button"><div class="sprites-icon login-sprite-icon-24 facebook-login-icon"></div>ಫೇಸ್ಬುಕ್ನೊಂದಿಗೆ ಸೈನ್ ಇನ್ ಆಗಿ</button>` }); </script> <script> ko.components.register( 'pratilipi-reader-app-install-banner', { viewModel: function() { var experimentCode = 'app_reader_001'; var self = this; self.bannerShown = ko.observable( false ); var initialised = false; var initAppBanner = function() { if( initialised ) return; if( getCookie( experimentCode ) ) return; self.bannerShown( true ); initialised = true; ga_CA( experimentCode, 'show' ); setCookie( experimentCode, new Date().getTime(), 365, '/' ); }; self.closeBanner = function() { self.bannerShown( false ); ga_CA( experimentCode, 'close' ); }; self.downloadApp = function() { self.bannerShown( false ); ga_CA( experimentCode, 'click' ); openInNewTab(getAndroidIntentUri({'utm_source': 'web_reader', 'utm_medium': experimentCode})); }; self.scrollTopObserver = ko.computed( function() { if( appViewModel.scrollTop() > 100 ) { setTimeout( function() { initAppBanner(); self.scrollTopObserver.dispose() } ); } }, this ); } , template: `<div class="pratilipi-reader-app-install-banner" data-bind="{ style: { opacity: bannerShown() ? 1 : 0, visibility: bannerShown() ? 'visible' : 'hidden' } }"><div class="banner"><div class="header"><img class="icon" src="http://public.pratilipi.com/pratilipi-logo/png/Logo-2C-RGB-192px.png"><div class="message">ಉತ್ತಮ ಕಥೆಗಳನ್ನು ಓದಲು ಪ್ರತಿಲಿಪಿ ಆ್ಯoಡ್ರಾಯ್ಡ್ ಆ್ಯಪನ್ನು ಡೌನ್ಲೋಡ್ ಮಾಡಿಕೊಳ್ಳಿ</div></div><div class="footer"><button class="declined" data-bind="click: closeBanner">ಬೇಡ</button><button class="accepted" data-bind="click: downloadApp">ಡೌನ್ಲೋಡ್</button></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-messages', { viewModel: function a( params ) { var self = this; this.conversations = ko.observableArray(); this.channelLastMessage = {}; this.channelLastReadMessage = {}; this.fetchedChannelMetadataData = {}; this.loadChannelMetadata = function(channelId) { self.firebaseGrowthDB.ref('/CHATS').child('channel_metadata').child(channelId).once('value').then(function(snapshot) { debugger; if(snapshot.val() == undefined) { /* TODO Something wrong */ } var userInChannel = false; var otherUserId = 0; var conversationDisplayName = ""; var conversationImageUrl = ""; $.each(snapshot.val().users, function(user, userDetails) { if(user == appViewModel.user.userId()) { userInChannel = true; } else { otherUserId = user; conversationDisplayName = userDetails.displayName; conversationImageUrl = userDetails.profileImageUrl; } console.log(user, userDetails); }); if(userInChannel != true) { /* TODO Something wrong */ return; } self.firebaseGrowthDB.ref('/CHATS').child('user_profile').child(otherUserId).once('value').then(function(snapshot) { if(snapshot.val() != undefined) { conversationDisplayName = snapshot.val().displayName; conversationImageUrl = snapshot.val().profileImageUrl; } var conversationImageUrlScaled = getImageUrl(conversationImageUrl,100); self.fetchedChannelMetadataData[channelId] = {'otherUserId' : otherUserId, conversationDisplayName : conversationDisplayName, conversationImageUrl : conversationImageUrlScaled}; self.attachLastReadListener(channelId); self.attachLastMessageListener(channelId); }); }); }; this.attachLastReadListener = function(channelId) { self.firebaseGrowthDB.ref('/CHATS').child('user_channels').child(appViewModel.user.userId()).child(channelId).child('lastReadMessage').on('value', function(snapshot) { debugger; if(self.channelLastMessage[channelId] != undefined) { if(snapshot.val() == self.channelLastMessage[channelId].messageId) { self.channelLastMessage[channelId].isUnread(false); } } self.channelLastReadMessage[channelId] = snapshot.val(); }); }; this.attachLastMessageListener = function(channelId) { self.firebaseGrowthDB.ref('/CHATS').child('messages').child(channelId).limitToLast(1).on('child_added', function(snapshot) { debugger; var message = snapshot.val(); console.log("Last message added : ",message, " for channel : ", channelId); self.conversations.remove(function(item) { return item.channelId == channelId; }); var isMessageUnread = true; if((message.senderId == appViewModel.user.userId()) || (self.channelLastReadMessage[channelId] == snapshot.key)) { isMessageUnread = false; } var messageTimeDisplay = self.parseDateDisplay(message.sendTime); var messageReceived = {channelId : channelId, messageId : snapshot.key, userId : self.fetchedChannelMetadataData[channelId].otherUserId, channelName : self.fetchedChannelMetadataData[channelId].conversationDisplayName, profileImageUrl : self.fetchedChannelMetadataData[channelId].conversationImageUrl, senderId : message.senderId, lastMessage : message.messageText, lastMessageTime : message.sendTime, lastMessageTimeDisplay : messageTimeDisplay, isUnread : ko.observable(isMessageUnread)}; self.channelLastMessage[channelId] = messageReceived; self.conversations.unshift(messageReceived); }, function() {}, self); }; this.parseDateDisplay = function(sentTime) { var currentDate = new Date(); var currentDateStart = currentDate.setHours(0,0,0,0); var timeToDisplay = ""; var messageDate = new Date(sentTime); var messageDateKey = messageDate.toLocaleDateString(); if(+messageDate >= +currentDateStart) { timeToDisplay = new Date(sentTime).toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true }); } else { yesterdayDate = new Date(); yesterdayDate.setTime(currentDate.getTime() - (24*3600000)); var yesterdayDateStart = yesterdayDate.setHours(0,0,0,0); if(+messageDate >= +yesterdayDateStart) { timeToDisplay = "YESTERDAY"; } else { timeToDisplay = messageDateKey; } } return timeToDisplay; }; this.loadWatchedChannels = function() { self.firebaseGrowthDB.ref('/CHATS').child('user_watched_channels').child(appViewModel.user.userId()).on('child_added', function(snapshot) { debugger; var channelId = snapshot.key; self.loadChannelMetadata(channelId); }, function() {}, self); self.firebaseGrowthDB.ref('/CHATS').child('user_watched_channels').child(appViewModel.user.userId()).on('child_removed', function(snapshot) { debugger; console.log("Watching channel removed : ", snapshot.key); self.conversations.remove(function(item) { return item.channelId == snapshot.key; }); self.firebaseGrowthDB.ref('/CHATS').child('messages').child(snapshot.key).off(); }, function() {}, self); }; this.clearConversationsFromCache = function() { ko.utils.arrayForEach(self.conversations(), function (conversation) { if(conversation.isLoadedFromCache != undefined && conversation.isLoadedFromCache == true) { self.conversations.remove(function(item) { return item.channelId == conversation.channelId; }); } }); }; this.loadConversationsFromCache = function() { debugger; if((appViewModel.p2pChat != undefined) && (appViewModel.p2pChat.convesationCache != undefined)) { if(typeof appViewModel.p2pChat.convesationCache.conversations != undefined) { ko.utils.arrayForEach(appViewModel.p2pChat.convesationCache.conversations, function (conversation) { conversation.isLoadedFromCache = true; self.conversations.push(conversation); }); } self.channelLastMessage = appViewModel.p2pChat.convesationCache.channelLastMessage; self.channelLastReadMessage = appViewModel.p2pChat.convesationCache.channelLastReadMessage; self.fetchedChannelMetadataData = appViewModel.p2pChat.convesationCache.fetchedChannelMetadataData; } setTimeout(self.clearConversationsFromCache, 4000); }; this.updateUserProfile = function() { debugger; if((appViewModel.p2pChat != undefined) && (appViewModel.p2pChat.updatedUserProfile == true)) { console.log("User profile already updated for this session. Skipping update"); return; } self.firebaseGrowthDB.ref('/CHATS').child('user_profile').child(appViewModel.user.userId()).once('value').then(function(snapshot) { if(snapshot.val() == undefined || snapshot.val.displayName != appViewModel.user.displayName() || snapshot.val.profileImageUrl != appViewModel.user.profileImageUrl()) { var userProfile = {displayName : appViewModel.user.displayName(), profileImageUrl : appViewModel.user.profileImageUrl(), profileUrl: appViewModel.user.profilePageUrl()}; self.firebaseGrowthDB.ref('/CHATS').child('user_profile').child(appViewModel.user.userId()).set(userProfile, function(error) { if(error == undefined) { if(appViewModel.p2pChat == undefined) { appViewModel.p2pChat = {}; } appViewModel.p2pChat.updatedUserProfile = true; } }); } }); }; this.firebaseObserver = ko.computed( function() { if (!appViewModel.firebaseGrowthDB()) { console.log('FIREBASE LOADING'); } else { console.log('FIREBASE LOADED'); console.log(appViewModel.firebaseGrowthDB()); self.firebaseGrowthDB = appViewModel.firebaseGrowthDB(); self.loadConversationsFromCache(); self.loadWatchedChannels(); self.updateUserProfile(); } }); this.userObserver = ko.computed( function() { if( appViewModel.user.userId() == null ) return; setTimeout( function() { if( appViewModel.user.userId() == 0 ) goToLoginPage( getUrlParameters() ); }, 0 ); }, this ); this.locationObserver = ko.computed( function() { if(appViewModel.currentView() != LOCATION.MESSAGES.ko_element) { /* Dispose all observers */ self.locationObserver.dispose(); self.userObserver.dispose(); var chatRef = self.firebaseGrowthDB.ref('/CHATS'); chatRef.child('user_watched_channels').child(appViewModel.user.userId()).off(); ko.utils.arrayForEach(this.conversations(), function(conversation) { var conversationChannel = conversation.channelId; chatRef.child('user_channels').child(appViewModel.user.userId()).child(conversationChannel).child('lastReadMessage').off(); chatRef.child('messages').child(conversationChannel).off(); }); self.firebaseObserver.dispose(); if(appViewModel.p2p2pChat == undefined) { appViewModel.p2pChat = {}; } appViewModel.p2pChat.convesationCache = {}; appViewModel.p2pChat.convesationCache.conversations = self.conversations(); appViewModel.p2pChat.convesationCache.channelLastMessage = self.channelLastMessage; appViewModel.p2pChat.convesationCache.channelLastReadMessage = self.channelLastReadMessage; appViewModel.p2pChat.convesationCache.fetchedChannelMetadataData = self.fetchedChannelMetadataData; return; } appViewModel.currentLocation(); }, this ); this.loadMessagesForConversation = function(userId) { redirect( '/messages/' + userId ); }; this.redirectToSourcePage = function() { var sourcePath = "/"; if((appViewModel.p2pChat != undefined) && (appViewModel.p2pChat.sourcePagePath != undefined )) { sourcePath = appViewModel.p2pChat.sourcePagePath; } redirect(sourcePath) } } , template: `<div class="chat-header"><div class="back-btn" data-bind="click: function() { redirectToSourcePage(); }"><i class="material-icons">arrow_back</i></div><span class="title">ಸಂದೇಶಗಳು</span></div><ul class="chat-list" data-bind="foreach: conversations().sort(function (l, r) { return l.lastMessageTime > r.lastMessageTime ? -1 : 1 })"><li class="chat-item" data-bind="click: function(){ $parent.loadMessagesForConversation(userId); }"><div class="user-img"><img data-bind="attr:{src: profileImageUrl}" alt="https://0.ptlp.co/author/image?width=60"></div><div class="chat-wrap"><div class="user-info"><div class="user-name" data-bind="text: channelName">Lores</div><div class="user-last-msg" data-bind="text: lastMessage">ipsum</div></div><div class="chat-info" data-bind="css: isUnread() ? 'unread' : ''"><div class="chat-time" data-bind="text: lastMessageTimeDisplay">Valar Morghulis</div></div></div></li></ul>` }); </script> <script> ko.components.register( 'pratilipi-loading-state', { viewModel: function( params ) { this.customText = params != null && params.customText != null ? params.customText : null; } , template: `<div class="pratilipi-loading-state"><div class="loading-state-container"><div class="pratilipi-icon-spinner"><span class="sprites-icon pratilipi-logo-icon"></span><div class="spinner"><div class="double-bounce1"></div><div class="double-bounce2"></div></div></div><div class="quote-container" data-bind="visible: customText == null"><span class="quote-content material-subtitle-1" data-bind="text: appViewModel.randomQuote().content"></span><br><span class="quote-name material-body-1" data-bind="visible: appViewModel.randomQuote().name != null, text: '- ' + appViewModel.randomQuote().name"></span></div><div class="custom-text-container" data-bind="visible: customText != null"><span class="custom-text" data-bind="text: customText"></span></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-author-follows', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.author = params.author; var processUserList = function( userList ) { if( userList == null ) return []; var followList = []; for( var i = 0; i < userList.length; i++ ) { var user = userList[i]; var follow = { authorId: user.author.authorId, name: user.author.name, pageUrl: user.profilePageUrl, followCount: user.author.followCount, imageUrl: user.profileImageUrl, following: user.author.following, canFollow: user.userId != appViewModel.user.userId(), requestOnFlight: false /* Hack: To manipulate */ }; followList.push( follow ); } return followList; }; var processAuthorList = function( authorList ) { if( authorList == null ) return []; var followList = []; for( var i = 0; i < authorList.length; i++ ) { var author = authorList[i]; var follow = { authorId: author.authorId, name: author.name, pageUrl: author.pageUrl, followCount: author.followCount, imageUrl: author.imageUrl, following: author.following, canFollow: author.user == null || author.user.userId != appViewModel.user.userId(), requestOnFlight: false /* Hack: To manipulate */ }; followList.push( follow ); } return followList; }; /* Followers and Following List */ this.followersList = ko.observableArray(); this.followingList = ko.observableArray(); this.updateFollowersList = function( userList ) { var processedUserList = processUserList( userList ); for( var i = 0; i < processedUserList.length; i++ ) self.followersList.push( ko.mapping.fromJS( processedUserList[i] ) ); }; this.updateFollowingList = function( authorList ) { var processedAuthorList = processAuthorList( authorList ); for( var i = 0; i < processedAuthorList.length; i++ ) self.followingList.push( ko.mapping.fromJS( processedAuthorList[i] ) ); }; /* Fetching followers and following list */ var followersCursor = null; var followingCursor = null; this.isLoadingFollowers = ko.observable( false ); this.isLoadingFollowing = ko.observable( false ); this.hasMoreFollowers = ko.observable( true ); this.hasMoreFollowing = ko.observable( true ); this.numberFoundFollowers = ko.observable(); this.numberFoundFollowing = ko.observable(); this._loadFollowersList = function( resultCount ) { if( self.isLoadingFollowers() ) return; self.isLoadingFollowers( true ); dataAccessor.getAuthorFollowers( self.author.authorId(), followersCursor, null, resultCount, function( followersListResponse ) { if( followersListResponse == null ) { self.isLoadingFollowers( false ); return; } var userList = followersListResponse.userList; self.updateFollowersList( userList ); followersCursor = followersListResponse.cursor; self.numberFoundFollowers( followersListResponse.numberFound ); self.isLoadingFollowers( false ); self.hasMoreFollowers( userList.length == resultCount ); }); }; this._loadFollowingList = function( resultCount ) { if( self.isLoadingFollowing() ) return; self.isLoadingFollowing( true ); dataAccessor.getUserFollowing( self.author.user.userId(), followingCursor, null, resultCount, function( followingListResponse ) { if( followingListResponse == null ) { self.isLoadingFollowing( false ); return; } var authorList = followingListResponse.authorList; self.updateFollowingList( authorList ); followingCursor = followingListResponse.cursor; self.numberFoundFollowing( followingListResponse.numberFound ); self.isLoadingFollowing( false ); self.hasMoreFollowing( authorList.length == resultCount ); }); }; /* Constants */ var initialFollowersResultCount = 10; var subsequentFollowersResultCount = 15; var initialFollowingResultCount = 10; var subsequentFollowingResultCount = 15; this.loadInitialFollowers = function() { self.followersList( [] ); followersCursor = null; self.isLoadingFollowers( false ); self.hasMoreFollowers( true ); self.numberFoundFollowers( 0 ); self._loadFollowersList( initialFollowersResultCount ); }; this.loadMoreFollowers = function() { self._loadFollowersList( subsequentFollowersResultCount ); }; this.loadInitialFollowing = function() { self.followingList( [] ); followingCursor = null; self.isLoadingFollowing( false ); self.hasMoreFollowing( true ); self.numberFoundFollowing( 0 ); self._loadFollowingList( initialFollowingResultCount ); }; this.loadMoreFollowing = function() { self._loadFollowingList( subsequentFollowingResultCount ); }; /* Follow / UnFollow Author */ this.followOrUnfollowAuthor = function( vm, targetModal ) { if( appViewModel.user.isGuest() ) { if (targetModal === 'FOLLOWS_MODAL') { self.triggerFacebookEvent('FOLLOW_FOLLOWERS', vm.followCount(), vm.authorId()); } else if (targetModal === 'FOLLOWING_MODAL') { self.triggerFacebookEvent('FOLLOW_FOLLOWINGS', vm.followCount(), vm.authorId()); } goToLoginPage( null, { "message": "FOLLOW" } ); return; } if( ! vm.canFollow() ) return; if( vm.requestOnFlight() ) return; vm.requestOnFlight( true ); var getFollowingMessage = function( following, name ) { var text = following ? "ನೀವು $authorName ಅವರನ್ನು ಹಿಂಬಾಲಿಸುತ್ತಿದ್ದೀರಿ" : "ನೀವು $authorName ಅವರನ್ನು ಹಿಂಬಾಲಿಸುತ್ತಿಲ್ಲ"; return text.replace( "$authorName", name ); }; var switchState = function() { vm.followCount( vm.following() ? vm.followCount() - 1 : vm.followCount() + 1 ); vm.following( ! vm.following() ); }; switchState(); ToastUtil.toast( getFollowingMessage( vm.following(), vm.name() ) ); dataAccessor.followOrUnfollowAuthor( vm.authorId(), vm.following(), function( userAuthor ) { vm.requestOnFlight( false ); ga_CA( 'Author', userAuthor.following ? 'Follow' : 'UnFollow' ); if (targetModal === 'FOLLOWS_MODAL') { if (userAuthor.following) { self.triggerFacebookEvent('FOLLOW_FOLLOWERS', vm.followCount(), vm.authorId()); } else { self.triggerFacebookEvent('UNFOLLOW_FOLLOWERS', vm.followCount(), vm.authorId()); } } else if (targetModal === 'FOLLOWING_MODAL') { if (userAuthor.following) { self.triggerFacebookEvent('FOLLOW_FOLLOWINGS', vm.followCount(), vm.authorId()); } else { self.triggerFacebookEvent('UNFOLLOW_FOLLOWINGS', vm.followCount(), vm.authorId()); } } }, function( error ) { vm.requestOnFlight( false ); switchState(); ToastUtil.toast( error[ "message" ] != null ? error[ "message" ] : "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!", 3000, true ); }); }; /* Computed Observables */ this.authorIdObserver = ko.computed( function() { if( self.author.authorId() == null ) return; setTimeout( function() { self.loadInitialFollowers(); }, 0 ); }, this ); this.authorUserIdObserver = ko.computed( function() { if( self.author.user.userId() == null ) return; setTimeout( function() { self.loadInitialFollowing(); }, 0 ); }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName, value, parentId ) { switch (eventName) { case 'CLICKUSER_FOLLOWERS': if (getLocation().fb_screen_name === 'USER') { FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue('CLICKUSER_FOLLOWERS_USER', parentId , self.numberFoundFollowers()); } else if (getLocation().fb_screen_name === 'MYPROFILE') { FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue('CLICKUSER_FOLLOWERS_MYPROFILE', parentId , self.numberFoundFollowers()); } break; case 'FOLLOW_FOLLOWERS': if (getLocation().fb_screen_name === 'USER') { FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue('FOLLOW_FOLLOWERS_USER', parentId, value); } else if (getLocation().fb_screen_name === 'MYPROFILE') { FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue('FOLLOW_FOLLOWERS_MYPROFILE', parentId, value); } break; case 'LANDED_FOLLOWERS_USER': break; case 'UNFOLLOW_FOLLOWERS': if (getLocation().fb_screen_name === 'USER') { FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue('UNFOLLOW_FOLLOWERS_USER', parentId, value); } else if (getLocation().fb_screen_name === 'MYPROFILE') { FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue('UNFOLLOW_FOLLOWERS_MYPROFILE', parentId, value); } break; case 'CLICKUSER_FOLLOWINGS': if (getLocation().fb_screen_name === 'USER') { FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue('CLICKUSER_FOLLOWINGS_USER', parentId , self.numberFoundFollowing()); } else if (getLocation().fb_screen_name === 'MYPROFILE') { FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue('CLICKUSER_FOLLOWINGS_MYPROFILE', parentId, value); } break; case 'FOLLOW_FOLLOWINGS': if (getLocation().fb_screen_name === 'USER') { FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue('FOLLOW_FOLLOWINGS_USER', parentId, value); } else if (getLocation().fb_screen_name === 'MYPROFILE') { FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue('FOLLOW_FOLLOWINGS_MYPROFILE', parentId, value); } break; case 'UNFOLLOW_FOLLOWINGS': if (getLocation().fb_screen_name === 'USER') { FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue('UNFOLLOW_FOLLOWINGS_USER', parentId, value); } else if (getLocation().fb_screen_name === 'MYPROFILE') { FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue('UNFOLLOW_FOLLOWINGS_MYPROFILE', parentId, value); } break; case 'LANDED_FOLLOWINGS_USER': break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.triggerClickUserFollowersrFbEvent = function(data) { self.triggerFacebookEvent('CLICKUSER_FOLLOWERS', null, data.authorId); return true; }; this.triggerClickUserFollowingFbEvent = function(data) { self.triggerFacebookEvent('CLICKUSER_FOLLOWINGS', null, data.authorId); return true; }; } , template: `<div class="pratilipi-author-follows"><div class="modal common-modal fade" id="pratilipi-author-follows-followers" tabindex="-1" role="dialog" aria-labelledby="pratilipi-author-follows-followers"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button class="mdl-button mdl-js-button mdl-button--icon close" class="close" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button><h6 style="margin: 0;" class="material-title">ಹಿಂಬಾಲಕರು</h6></div><div class="modal-body" style="padding: 0;"><ul class="mdl-list author-follow-ul" data-bind="foreach: { data: followersList, as: 'follow' }"><li class="mdl-list__item"><div><a data-bind="attr: { 'href': follow.pageUrl(), 'alt': follow.name(), click: $parent.triggerClickUserFollowersrFbEvent }"><img class="mdl-list__item-avatar" data-bind="attr: { 'src': getImageUrl( follow.imageUrl(), 48 ) }"/></a></div><div class="author-name"><a class="font-m" data-bind="text: follow.name(), attr: { 'href': follow.pageUrl() }, click: $parent.triggerClickUserFollowersrFbEvent"></a></div><div data-bind="visible: follow.canFollow()"><button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button-margin small-button"data-bind="{ click: $parent.followOrUnfollowAuthor.bind(this, $data, 'FOLLOWS_MODAL'),disable: follow.requestOnFlight(),css: { 'mdl-button--colored': ! follow.following() } }"><i data-bind="text: follow.following() ? 'done' : 'person_add'" class="material-icons"></i></button></div></li></ul><div class="load-more-container" data-bind="visible: hasMoreFollowers()"><button data-bind="{ visible: ! isLoadingFollowers(), click: loadMoreFollowers }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">ಇನ್ನೂ ಹೆಚ್ಚು ತೋರಿಸಿ</button><div data-bind="visible: isLoadingFollowers()" class="text-center"><span class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div></div></div></div></div></div><div class="modal common-modal fade" id="pratilipi-author-follows-following" tabindex="-1" role="dialog" aria-labelledby="pratilipi-author-follows-following"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button class="mdl-button mdl-js-button mdl-button--icon close" class="close" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button><h6 style="margin: 0;" class="material-title">ಹಿಂಬಾಲಿಸುತ್ತಿದ್ದಾರೆ</h6></div><div class="modal-body" style="padding: 0;"><ul class="mdl-list author-follow-ul" data-bind="foreach: { data: followingList, as: 'follow' }"><li class="mdl-list__item"><div><a data-bind="attr: { 'href': follow.pageUrl(), 'alt': follow.name() }, click: $parent.triggerClickUserFollowingFbEvent"><img class="mdl-list__item-avatar" data-bind="attr: { 'src': getImageUrl( follow.imageUrl(), 48 ) }"/></a></div><div class="author-name"><a class="font-m" data-bind="text: follow.name(), attr: { 'href': follow.pageUrl() }, click: $parent.triggerClickUserFollowingFbEvent"></a></div><div data-bind="visible: follow.canFollow()"><button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button-margin small-button"data-bind="{ click: $parent.followOrUnfollowAuthor.bind(this, $data, 'FOLLOWING_MODAL'),disable: follow.requestOnFlight(),css: { 'mdl-button--colored': ! follow.following() } }"><i data-bind="text: follow.following() ? 'done' : 'person_add'" class="material-icons"></i></button></div></li></ul><div class="load-more-container" data-bind="visible: hasMoreFollowing()"><button data-bind="{ visible: ! isLoadingFollowing(), click: loadMoreFollowing }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">ಇನ್ನೂ ಹೆಚ್ಚು ತೋರಿಸಿ</button><div data-bind="visible: isLoadingFollowing()" class="text-center"><span class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div></div></div></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-rating', { viewModel: function( params ) { /* Pass rating in parameter as an ko.observable */ this.rating = params.rating != null ? params.rating : ko.observable( 0 ); } , template: `<!-- ko if: rating() > 0 --><!-- ko foreach: ko.utils.range( 1, rating() ) --><i class="material-icons material-icons-16">star</i><!-- /ko --><!-- ko foreach: ko.utils.range( 1, 5 - rating() ) --><i class="material-icons material-icons-16">star_border</i><!-- /ko --><!-- /ko -->` }); </script> <script> ko.components.register( 'pratilipi-reset-password-page', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); this.newPassword = ko.observable(); this.confirmPassword = ko.observable(); this.requestOnFlight = ko.observable( false ); this.resetPassword = function() { if( self.newPassword() != this.confirmPassword() ) { ToastUtil.toast( "Passwords doesn't match!" ); return; } self.requestOnFlight( true ); dataAccessor.resetUserPassword( getUrlParameter( "e" ), getUrlParameter( "t" ), self.newPassword(), function( user ) { ToastUtil.toastUp( "ಯಶಸ್ವಿ!" ); setTimeout( function() { window.location.href = "/"; }, 4000 ); }, function( error ) { var message = "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!"; if( error.email != null ) message = error.email; if( error.message != null ) message = error.message; ToastUtil.toast( message, 4000 ); self.requestOnFlight( false ); }); }; this.resetPasswordButtonEnabled = ko.computed( function() { return self.newPassword() != null && self.newPassword().trim() != "" && self.confirmPassword() != null && self.confirmPassword().trim() != "" && ! self.requestOnFlight(); }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.RESET_PASSWORD.ko_element ) { /* Clear All Fields */ self.newPassword( null ); self.confirmPassword( null ); self.requestOnFlight( false ); /* Dispose all observers */ self.resetPasswordButtonEnabled.dispose(); self.locationObserver.dispose(); return; } else { setTimeout(function() { MetaTagUtil.setMetaTagsForResetPassword(); }); } appViewModel.currentLocation(); }, this ); } , template: `<div class="pratilipi-login-page"><div class="pratilipi-login-container"><span class="sprites-icon pratilipi-logo-icon"></span><div class="pratilipi-heading material-title">ಪಾಸ್ವರ್ಡ್ ರೀಸೆಟ್ ಮಾಡಿ</div><form id="reset_password_form" class="pratilipi-content-container margin-zero"><input type="password" data-bind="mdlFloatingInput: { label: 'ಹೊಸ ಪಾಸ್ವರ್ಡ್', value: newPassword, id: 'pratilipi_reset_password_page_user_new_password' }, valueUpdate: ['input']" /><input type="password" data-bind="mdlFloatingInput: { label: 'ಪಾಸ್ವರ್ಡ್ ಖಚಿತಪಡಿಸಿ', value: confirmPassword, id: 'pratilipi_reset_password_page_user_confirm_password' }, valueUpdate: ['input']" /><button data-bind="{ click: resetPassword, enable: resetPasswordButtonEnabled }"type="submit"class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored pratilipi-red-button login-button">ಅಪ್ಡೇಟ್</button></form></div></div>` }); </script> <script> ko.components.register( 'pratilipi-reader-header', { viewModel: function( params ) { var self = this; this.pratilipi = params.pratilipi; this.userPratilipi = params.userPratilipi; this.openSettings = params.openSettings; this.switchLibraryState = params.switchLibraryState; this.sharePratilipi = params.sharePratilipi; this.reportContent = params.reportContent; this.openNavigationModal = params.openNavigationModal; this.index = params.index; this.chapterNo = params.chapterNo; this.setChapterNo = params.setChapterNo; this.changeChapter = function( vm, e ) { self.setChapterNo( vm.chapterNo ); document.querySelector( '.mdl-layout' ).MaterialLayout.toggleDrawer(); }; this.pratilipiObserver = ko.computed( function() { if( self.pratilipi.title() == null ) return; setTimeout( function() { var divWidth = $( ".pratilipi-reader .pratilipi-reader-header .js-pratilipi-title-holder" ).width(); var text = $( ".pratilipi-reader .pratilipi-reader-header .js-pratilipi-title-holder .js-pratilipi-title" ); var fontSize = 20.5; do { text.css( "font-size", fontSize -= 0.5 ); } while( text.width() > divWidth && fontSize > 12 ); }, 0 ); }, this ); } , template: `<div class="pratilipi-reader-header"><div class="exit-reader"><a onclick="ga_CA( 'Pratilipi', 'ActionBack' );" class="mdl-button mdl-js-button mdl-button--icon" data-bind="attr: { href: pratilipi.pageUrl() }"><i class="material-icons">arrow_back</i></a><button class="mdl-button mdl-js-button mdl-button--icon show-tablet" data-bind="click: openNavigationModal"><i class="material-icons">list</i></button></div><div class="pratilipi-title-holder js-pratilipi-title-holder"><div class="pratilipi-title js-pratilipi-title" data-bind="text: pratilipi.title()"></div></div><div class="menu-option-holder"><button onclick="ga_CA( 'Pratilipi', 'Settings' );" class="mdl-button mdl-js-button mdl-button--icon hide-mobile" data-bind="click: openSettings"><i class="material-icons">settings</i></button><button onclick="ga_CA( 'Pratilipi', 'AddToLibrary' );" class="mdl-button mdl-js-button mdl-button--icon hide-mobile" data-bind="click: switchLibraryState,disable: pratilipi.state() != 'PUBLISHED' || pratilipi.author.authorId() == appViewModel.user.author.authorId()"><i data-bind="css: { 'pratilipi-red': userPratilipi.addedToLib() }" class="material-icons">bookmark</i></button><button onclick="ga_CA( 'Pratilipi', 'Share' );" class="mdl-button mdl-js-button mdl-button--icon hide-mobile" data-bind="click: sharePratilipi"><i class="material-icons">share</i></button><button id="reader-report-content"onclick="ga_CA( 'Pratilipi', 'MoreOptions' );"class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">more_vert</i></button><ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect"for="reader-report-content"><a class="mdl-menu__item clickable-element"data-bind="click: reportContent, visible: pratilipi.state() == 'PUBLISHED' && pratilipi.author.authorId() != appViewModel.user.author.authorId()">ಸಮಸ್ಯೆ ತಿಳಿಸಿ</a><a class="mdl-menu__item clickable-element"target="_blank"data-bind="attr: { href: pratilipi.writePageUrl() }, visible: pratilipi.hasAccessToUpdate()">ವಿಷಯ ಎಡಿಟ್ ಮಾಡಿ</a></ul></div></div><div class="mdl-layout__drawer"><nav class="mdl-navigation"><!-- ko foreach: { data: index() } --><a class="index-entry" onclick="ga_CA( 'Pratilipi', 'ChangeChapter' );" data-bind="{ text: $data.title, css: { 'highlight': $data.chapterNo == $parent.chapterNo() }, click: $parent.changeChapter }"></a><!--/ko--></nav></div>` }); </script> <script> ko.components.register( 'pratilipi-reader-navigation', { viewModel: function( params ) { var self = this; this.index = params.index; this.chapterNo = params.chapterNo; this.setChapterNo = params.setChapterNo; this.pratilipi = params.pratilipi; this.changeChapter = function( vm, e ) { self.setChapterNo( vm.chapterNo ); self.triggerFacebookEvent('CHANGECHAPTER_INDEX_READER', vm.chapterNo); }; /** * Facebook events */ this.triggerFacebookEvent = function(eventName, parentId) { switch (eventName) { case 'CHANGECHAPTER_INDEX_READER': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId(eventName, self.pratilipi, parentId); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; } , template: `<div class="pratilipi-reader-navigation"><!-- ko foreach: { data: index() } --><a class="index-entry"onclick="ga_CA( 'Pratilipi', 'ChangeChapter' );"data-bind="{ text: $data.title, css: { 'highlight': $data.chapterNo == $parent.chapterNo() }, click: $parent.changeChapter }"></a><!--/ko--></div>` }); </script> <script> ko.components.register( 'pratilipi-list-page', { viewModel: function() { var self = this; var cursor = null; var resultCount = 20; var dataAccessor = new DataAccessor(); this.listTitle = ko.observable(); this.pratilipiList = ko.observableArray(); this.hasMoreContents = ko.observable( true ); this.isLoading = ko.observable( false ); this.updatePratilipiList = function( pratilipiList ) { for( var i = 0; i < pratilipiList.length; i++ ) self.pratilipiList.push( ko.mapping.fromJS( pratilipiList[i] ) ); }; this.fetchPratilipiList = function() { if( self.isLoading() || ! self.hasMoreContents() ) return; self.isLoading( true ); dataAccessor.getPratilipiListByListName( window.location.pathname.substring(1), cursor, null, resultCount, function( pratilipiListResponse ) { if( pratilipiListResponse == null ) { self.isLoading( false ); return; } var loadMore = self.pratilipiList().length != 0; var pratilipiList = pratilipiListResponse.pratilipiList; self.updatePratilipiList( pratilipiList ); cursor = pratilipiListResponse.cursor; self.isLoading( false ); self.hasMoreContents( pratilipiList.length == resultCount && cursor != null ); if( loadMore ) ga_CA( 'Pratilipi', 'LoadMore' ); }); }; this.listUpdated = function() { self.listTitle( getListTitle() ); self.pratilipiList( [] ); cursor = null; self.hasMoreContents( true ); self.isLoading( false ); self.fetchPratilipiList(); }; this.pageScrollObserver = ko.computed( function() { if( ( appViewModel.scrollTop() / $( ".js-pratilipi-list-grid" ).height() ) > 0.6 ) { setTimeout( function() { self.fetchPratilipiList(); }, 100 ); /* locationObserver and pageScrollObserver will be triggered at once. */ } }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.LIST.ko_element ) { /* Dispose all observers */ self.locationObserver.dispose(); self.pageScrollObserver.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { self.listUpdated(); MetaTagUtil.setMetaTagsForList( { title: getListTitle(), titleEn: getListTitleEn() } ); }, 0 ); }, this ); /* Hack: Setting listTitle */ var getListTitle = function() { var listListTitleMap = { '/5kreads': 'ಬೆಸ್ಟ್ ಸೆಲ್ಲರ್ ಕಥೆಗಳು', '/horrorhome': 'ಭಯಾನಕ & ನಿಗೂಢ', '/letterbox-banner': 'ಪತ್ರಗಳು', '/editorschoice': 'ಸಂಪಾದಕರ ಆಯ್ಕೆ', '/life': 'ಜೀವನ', '/editors-choice': 'ಸಂಪಾದಕರ ಆಯ್ಕೆ', '/satire': 'ವಿಡಂಬನೆ', '/homewomen': 'ಮಹಿಳಾಂತರಂಗ', '/homelove': 'ಪ್ರೇಮಿಗಳ ದಿನ ವಿಶೇಷ', '/books': 'ಸಮಗ್ರ', '/mostreaddec': 'ಕಂತಿನ ಕಥೆಗಳು', '/relationship': 'ಬಂಧುತ್ವ', '/winterdec': 'ಚಳಿಗಾಲದ ಸಂಗ್ರಹ', '/nonfiction': 'ಅಕಲ್ಪಿತ', '/splarticles': 'ವಿಶೇಷ ಆಯ್ಕೆ', '/friendship': 'ಸ್ನೇಹ', '/articles-home': 'ಲೇಖನಗಳು', '/inspirational': 'ಸ್ಫೂರ್ತಿದಾಯಕ', '/festival-stories': 'ಹಬ್ಬದ ವಿಶೇಷ ಸಂಗ್ರಹ', '/horror-suspense-crime-oct': 'ಹಾರರ್, ಸಸ್ಪೆನ್ಸ್ ಮತ್ತು ಕ್ರೈಂ', '/current-event': 'ಪತ್ರ ಲೇಖನ ಸ್ಪರ್ಧೆ', '/kavyadhare': 'ಕಾವ್ಯಧಾರೆ', '/diwali': 'ದೀಪಾವಳಿ ವಿಶೇಷ', '/otherstories': 'ಇತರೆ ಕಥೆಗಳು', '/travel-companion': 'ಪ್ರಯಾಣ ಸಮಯದ ಕಥೆಗಳು', '/newcontents': 'ಹೊಸ ಬರಹಗಳು', '/science': 'ವಿಜ್ಞಾನ', '/teatimecollection': 'ಟೀ ಟೈಮ್ ಕಲೆಕ್ಷನ್', '/love': 'ಪ್ರೀತಿ', '/aow': 'ಪ್ರತಿಲಿಪಿ ವಾರದ ಸಾಹಿತಿ', '/editorialcollectionnov': 'ಸಂಪಾದಕರ ಆಯ್ಕೆ - ಅಕ್ಟೋಬರ್', '/latest-stories': 'ಲೇಟೆಸ್ಟ್ ಕಥೆಗಳು', '/homelife': 'ಬದುಕಿನ ಕಥೆಗಳು', '/society': 'ಸಮಾಜ', '/2minstories': '2 ನಿಮಿಷಗಳ ಕಥೆಗಳು', '/newold': 'ಹೊಸ', '/2kreads': '2000+ ಓದುಗರ ಸಂಖ್ಯೆ', '/spiritual': 'ಅನುಭಾವ', '/homepoems': 'ಕಾವ್ಯಧಾರೆ', '/mothers-day': 'ಅಮ್ಮನ ದಿನ ವಿಶೇಷ', '/articles': 'ಲೇಖನಗಳು', '/longform': 'ಕಂತಿನ ಕಥೆಗಳು', '/poems': 'ಕವಿತೆಗಳು', '/most-read': 'ಓದುಗರ ಆಯ್ಕೆ', '/hidden-gems': '2017 ರ ಗುಪ್ತ ರತ್ನಗಳು', '/3am': 'ಘೋರರಾತ್ರಿಯ ಸಂಗ್ರಹ', '/monsoon': 'ಮುಂಗಾರಿನ ಸಂಗ್ರಹ', '/stories': 'ಕಥೆಗಳು', '/thriller': 'ಥ್ರಿಲ್ಲರ್/ಹಾರರ್', '/deceditorial': 'ಸಂಪಾದಕರ ಆಯ್ಕೆ', '/politics': 'ರಾಜಕೀಯ', '/dhaaraavaahi': 'ಧಾರಾವಾಹಿ', '/horror': 'ಹಾರರ್', '/classic-sahitya': 'ವಚನಗಳು', '/poems-home': 'ಕವಿತೆಗಳು', '/comedy': 'ಹಾಸ್ಯ', '/bannerpoems': 'ಕಾವ್ಯಧಾರೆ', '/classicandcontemporary-oct': 'ಮನಸಿಗೊಪ್ಪುವ ಬರಹಗಳು', '/newyear2017': '2016ರ ವಿಶೇಷ ಕಥೆಗಳು', '/love-stories': 'ಪ್ರೇಮ ಕಥೆಗಳು', '/women': 'ಮಹಿಳೆ', '/rated': 'ಟಾಪ್ ರೇಟೆಡ್ ಕಥೆಗಳು', '/fiction': 'ಕಲ್ಪಿತ', '/recommended': 'ಶಿಫಾರಸ್ಸು ಮಾಡಲ್ಪಟ್ಟ', '/2minstoriesnov': 'ಸಣ್ಣ ಕಥೆಗಳು', '/cinema': 'ಸಿನಿಮಾ', '/popular-stories': 'ಜನಪ್ರಿಯ ಕಥೆಗಳು', '/specialcollectionnov': 'ವಿಶೇಷ ಸಂಗ್ರಹ', '/selfpublished': 'ಕಳೆದ ಮೂರು ತಿಂಗಳ ಅತ್ಯುತ್ತಮ ಕೃತಿಗಳು', '/most-read-stories': 'ಅತೀ ಹೆಚ್ಚು ಓದಲ್ಪಟ್ಟ ಕಥೆಗಳು', '/homearticles': 'ಜನಪ್ರಿಯ ಲೇಖನಗಳು', '/relationshipstories': 'ಪ್ರೇಮ ಕಥೆಗಳು', }; return listListTitleMap[ window.location.pathname ] != null ? listListTitleMap[ window.location.pathname ] : null; }; var getListTitleEn = function() { var listListTitleEnMap = { '/5kreads': '2000+ reads', '/horrorhome': '/horrorhome'.substr(1), '/letterbox-banner': 'Letters', '/editorschoice': 'Editorschoice', '/life': 'life', '/editors-choice': '/editors-choice'.substr(1), '/satire': 'Satire', '/homewomen': '/homewomen'.substr(1), '/homelove': '/homelove'.substr(1), '/books': '/books'.substr(1), '/mostreaddec': '/mostreaddec'.substr(1), '/relationship': 'relationship', '/winterdec': '/winterdec'.substr(1), '/nonfiction': 'nonfiction', '/splarticles': '/splarticles'.substr(1), '/friendship': 'friendship', '/articles-home': '/articles-home'.substr(1), '/inspirational': 'inspirational', '/festival-stories': '/festival-stories'.substr(1), '/horror-suspense-crime-oct': 'horror-suspense-crime-oct', '/current-event': '/current-event'.substr(1), '/kavyadhare': '/kavyadhare'.substr(1), '/diwali': 'diwali special', '/otherstories': 'otherstories', '/travel-companion': '/travel-companion'.substr(1), '/newcontents': 'new', '/science': 'science', '/teatimecollection': 'Teatime colletion', '/love': 'Love', '/aow': 'aow', '/editorialcollectionnov': '/editorialcollectionnov'.substr(1), '/latest-stories': '/latest-stories'.substr(1), '/homelife': '/homelife'.substr(1), '/society': 'Society', '/2minstories': '/2minstories'.substr(1), '/newold': 'new', '/2kreads': '2000+ reads', '/spiritual': 'Spiritual', '/homepoems': 'homepoems', '/mothers-day': '/mothers-day'.substr(1), '/articles': 'Articles', '/longform': 'Long Stories', '/poems': 'Poems', '/most-read': 'most-read', '/hidden-gems': '/hidden-gems'.substr(1), '/3am': '/3am'.substr(1), '/monsoon': '/monsoon'.substr(1), '/stories': 'Stories', '/thriller': 'thriller', '/deceditorial': '/deceditorial'.substr(1), '/politics': 'Politics', '/dhaaraavaahi': '/dhaaraavaahi'.substr(1), '/horror': 'horror', '/classic-sahitya': '/classic-sahitya'.substr(1), '/poems-home': '/poems-home'.substr(1), '/comedy': '/comedy'.substr(1), '/bannerpoems': 'World of Poetry', '/classicandcontemporary-oct': 'classicandcontemporary-oct', '/newyear2017': 'newyear2017', '/love-stories': '/love-stories'.substr(1), '/women': 'women', '/rated': 'Top Rated Stories', '/fiction': 'fiction', '/recommended': 'Recommended', '/2minstoriesnov': '/2minstoriesnov'.substr(1), '/cinema': 'Cinema', '/popular-stories': '/popular-stories'.substr(1), '/specialcollectionnov': '/specialcollectionnov'.substr(1), '/selfpublished': '/selfpublished'.substr(1), '/most-read-stories': '/most-read-stories'.substr(1), '/homearticles': '/homearticles'.substr(1), '/relationshipstories': 'Relationshipstories', }; return listListTitleEnMap[ window.location.pathname ] != null ? listListTitleEnMap[ window.location.pathname ] : null; }; /** * Facebook events */ this.triggerFacebookEvent = function(eventName, parentId) { switch (eventName) { case 'LANDED_CATEGORYM_CATEGORY': FacebookEventTriggerUtil.triggerFacebookEventByNameAndParentId(eventName, parentId); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; self.triggerFacebookEvent('LANDED_CATEGORYM_CATEGORY', getListTitle()); } , template: `<div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card generic-list-page"><div data-bind="visible: listTitle() != null, html: listTitle()"class="load-more-container mdl-card-border material-heading"style="margin-top: 0;"></div><div data-bind="foreach: { data: pratilipiList, as: 'pratilipi' }, visible: pratilipiList().length > 0"class="mdl-grid pratilipi-list-grid js-pratilipi-list-grid mobile-card"><div class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><!-- ko component: {name: "pratilipi-pratilipi-card",params: { pratilipi: pratilipi }} --><!-- /ko --></div></div><div class="load-more-container mdl-card-border" data-bind="visible: hasMoreContents()"><button data-bind="{ visible: ! isLoading(), click: fetchPratilipiList }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">ಇನ್ನಷ್ಟು ವಿಷಯಗಳನ್ನು ಲೋಡ್ ಮಾಡಿ</button><div data-bind="visible: isLoading()" class="text-center"><span data-bind="visible: pratilipiList().length > 0"class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span><pratilipi-loading-state data-bind="visible: pratilipiList().length == 0"></pratilipi-loading-state></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-reader-content', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.pratilipi = params.pratilipi; this.updatePratilipi = params.updatePratilipi; this.userPratilipi = params.userPratilipi; this.updateUserPratilipi = params.updateUserPratilipi; this.chapterNo = params.chapterNo; this.chapterCount = params.chapterCount; this.fontSize = params.fontSize; this.imageSize = params.imageSize; this.setImageSize = params.setImageSize; this.lineHeight = params.lineHeight; this.setChapterNo = params.setChapterNo; this.scrollToTop = params.scrollToTop; this.content = ko.observable(); this.isLoading = ko.observable(); var contentMap; this._getImageUrl = function( chapterNo ) { if( chapterNo == null ) return; return "<img style='width: " + self.imageSize() + "px' class='image-content js-image-content' src='/api/pratilipi/content/image?pratilipiId=" + self.pratilipi.pratilipiId() + "&" + "name=" + contentMap[ chapterNo ] + "' />"; }, this._precache = function( chapterNo ) { setTimeout( function() { if( self.pratilipi.contentType() == "PRATILIPI" ) { if( self.chapterNo() > 1 ) self._loadContent( self.chapterNo() - 1 ); if( self.chapterNo() < self.chapterCount() ) self._loadContent( self.chapterNo() + 1 ); } else if( self.pratilipi.contentType() == "IMAGE" ) { if( self.chapterNo() > 1 ) $( self._getImageUrl( self.chapterNo() - 1 ) ).trigger( 'load' ); if( self.chapterNo() < self.chapterCount() ) $( self._getImageUrl( self.chapterNo() + 1 ) ).trigger( 'load' ); } }, 0 ); }; this._loadContent = function( chapterNo, scrollToTop ) { if( contentMap[ chapterNo ] !== undefined ) /* Either marked null or has content */ return; contentMap[ chapterNo ] = null; dataAccessor.getPratilipiContent( self.pratilipi.pratilipiId(), chapterNo, self.pratilipi.oldContent(), function( contentResponse ) { if( contentResponse == null ) contentResponse = { "content": "", "chapterNo": chapterNo }; var content = contentResponse.content != null ? contentResponse.content.replace( /&nbsp;/g, " " ) : ""; if( contentResponse.chapterTitle != null ) content = "<h1 class='chapter-title'>" + contentResponse.chapterTitle + "</h1>" + content; var cNo = contentResponse.chapterNo; contentMap[ cNo ] = content; if( self.chapterNo() == cNo ) { self.content( content ); self.isLoading( false ); self._precache(); /* Not making calls to x+1 and x-1 chapter if chapter is not available. Giving utmost importance to the current page. */ if( scrollToTop ) { self.scrollToTop( 0 ); } } }); }; this._initialiseImageContentReader = function() { dataAccessor.getPratilipiContent( self.pratilipi.pratilipiId(), null, true, function( contentResponse ) { var chapters = contentResponse.content.chapters; var c = 1; for( var i = 0; i < chapters.length; i++ ) { var pages = chapters[i].pages; for( var j = 0; j < pages.length; j++ ) contentMap[ c++ ] = pages[j].pagelets[0].data.name; } /* First Load */ self.isLoading( false ); self.content( self._getImageUrl( self.chapterNo() ) ); self.setImageSizeDOM(); self._precache(); }); }; this.chapterNoObserver = ko.computed( function() { if( self.chapterNo() == null ) return; setTimeout( function() { if( self.pratilipi.contentType() == "PRATILIPI" ) { if( contentMap[ self.chapterNo() ] === undefined ) { self.isLoading( true ); self._loadContent( self.chapterNo() ); } else if( contentMap[ self.chapterNo() ] == null ) { self.isLoading( true ); } else if( contentMap[ self.chapterNo() ] != null ) { self.content( contentMap[ self.chapterNo() ] ); self.isLoading( false ); self._precache(); /* Since the page is already available, precaching other pages */ } } else if( self.pratilipi.contentType() == "IMAGE" ) { if( isEmpty( contentMap ) ) { self.isLoading( true ); self._initialiseImageContentReader(); } else { self.content( self._getImageUrl( self.chapterNo() ) ); self._precache(); } } }, 0 ); }, this ); this.readerContentClassObserver = ko.computed( function() { var getLineHeightClass = function( lineHeight ) { if( lineHeight == 'SMALL' ) return 'lh-sm'; if( lineHeight == 'MEDIUM' ) return 'lh-md'; if( lineHeight == 'LARGE' ) return 'lh-lg'; }; var getFontClass = function( fontSize ) { return "content-font-" + fontSize; }; var getContentTypeClass = function( contentType ) { return contentType ? "content-type-" + contentType.toLowerCase() : ""; }; return getLineHeightClass( self.lineHeight() ) + " " + getFontClass( self.fontSize() ) + " " + getContentTypeClass( self.pratilipi.contentType() ); }, this ); this.setImageSizeDOM = function() { var contentDiv = $( ".pratilipi-reader .pratilipi-reader-content .js-content" ); if( self.imageSize() == -1 ) { /* undetermined */ if( contentDiv.width() == 0 ) return; self.setImageSize( contentDiv.width() ); } jQuery( "img.js-image-content" ).css( 'width', self.imageSize() + 'px', 'important' ); }; this.imageSizeObserver = ko.computed( function() { self.imageSize(); setTimeout( function() { self.setImageSizeDOM(); }, 0 ); }, this ); this.goToPreviousChapter = function() { self.setChapterNo( self.chapterNo() - 1 ); self.triggerFacebookEvent('CHANGECHAPTER_READERM_READER', self.chapterNo() - 1); }; this.goToNextChapter = function() { self.setChapterNo( self.chapterNo() + 1 ); self.triggerFacebookEvent('CHANGECHAPTER_READERM_READER', self.chapterNo() + 1); }; /* Rating and review */ this.ratingInput = ko.observable(0); this.reviewInput = ko.observable(); this.addOrDeleteReviewRequestOnFlight = ko.observable( false ); var reviewInputDialog = $( '#pratilipi-reader-review-input-dialog' ); this.openReviewModal = function() { self.triggerFacebookEvent('RATE_BOOKEND_READER', null, self.ratingInput()); if( appViewModel.user.isGuest() ) { goToLoginPage( { "id": self.pratilipi.pratilipiId(), "action": "openReviewModal", "ratingInput": self.ratingInput() } ); return; } reviewInputDialog.modal( 'show' ); }; this.closeReviewModal = function() { reviewInputDialog.modal( 'hide' ); self.ratingInput( self.userPratilipi.rating() ); self.reviewInput( self.userPratilipi.review() ); }; /* Clicking anywhere outside the screen */ reviewInputDialog.on( 'hidden.bs.modal', function(e) { self.closeReviewModal(); }); /* Create/Update Review */ this.createOrUpdateReview = function() { if( self.addOrDeleteReviewRequestOnFlight() ) return; self.addOrDeleteReviewRequestOnFlight( true ); ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); dataAccessor.createOrUpdateReview( self.pratilipi.pratilipiId(), self.ratingInput(), self.reviewInput(), function( review ) { if( review.rating == null ) review.rating = 0; if( review.reviewState != "PUBLISHED" || review.review == null || review.review.trim() == "" ) review.review = null; self.updateUserPratilipi( review ); self.addOrDeleteReviewRequestOnFlight( false ); self.closeReviewModal(); ToastUtil.toast( "ಯಶಸ್ವಿ!" ); redirect( self.pratilipi.pageUrl() ); }, function( error ) { self.addOrDeleteReviewRequestOnFlight( false ); ToastUtil.toast( "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!" ); }); }; /* Delete Review */ this.deleteReview = function( review ) { if( self.addOrDeleteReviewRequestOnFlight() ) return; self.addOrDeleteReviewRequestOnFlight( true ); ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); dataAccessor.deleteReview( self.pratilipi.pratilipiId(), function( review ) { self.updateUserPratilipi( review ); self.addOrDeleteReviewRequestOnFlight( false ); ToastUtil.toast( "ಯಶಸ್ವಿ!" ); }, function( error ) { self.addOrDeleteReviewRequestOnFlight( false ); ToastUtil.toast( "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!" ); } ); }; this.submitReview = function() { /* Not Updated rating, just cleared the review */ if( self.ratingInput() == self.userPratilipi.rating() && self.userPratilipi.review() != null && self.userPratilipi.review().trim() != "" && self.reviewInput() != null && self.reviewInput().trim() == "" ) self.deleteReview(); else self.createOrUpdateReview(); }; this.canSubmitReview = ko.computed( function() { return self.ratingInput() != 0 && ! self.addOrDeleteReviewRequestOnFlight(); }, this ); this.userPratilipiMetaObserver = ko.computed( function() { self.ratingInput( self.userPratilipi.rating() ); self.reviewInput( self.userPratilipi.review() ); }, this ); this.userObserver = ko.computed( function() { appViewModel.user.userId(); setTimeout(function() { if( appViewModel.user.userId() > 0 && getUrlParameter( 'action' ) == "openReviewModal" ) { var ratingParam = parseInt( getUrlParameter( "ratingInput" ) ); if( ! isNaN( ratingParam ) && ratingParam > 0 && ratingParam <= 5 ) self.ratingInput( ratingParam ); self.openReviewModal(); } }); }, this ); this.pratilipiIdObserver = ko.computed( function () { if( self.pratilipi.pratilipiId() == null ) return; setTimeout(function() { self.content( "" ); self.isLoading( true ); contentMap = {}; if (self.pratilipi.contentType() == "PRATILIPI") { self._loadContent( self.chapterNo(), true ); } else if (self.pratilipi.contentType() == "IMAGE") { self._initialiseImageContentReader(); } self.triggerFacebookEvent('LANDED_READERM_READER'); self.bookEndViewEventTriggered(false); }); }, this ); /* Share */ var getShareUrl = function( utm_source ) { return encodeURIComponent( window.location.origin + self.pratilipi.pageUrl() + ( self.pratilipi.pageUrl().indexOf( '?' ) == -1 ? "?" : "&" ) + "utm_language=kannada" + "&" + "utm_version=pwa" + "&" + "utm_device=" + ( isMobile() ? "mobile" : "desktop" ) + "&" + "utm_parent=reader" + "&" + "utm_action=share" + "&" + "utm_source=" + utm_source ); }; var getWhatsappText = function() { return '"' + self.pratilipi.title() + '", ಪ್ರತಿಲಿಪಿಯಲ್ಲಿ ಓದಿರಿ : ' + getShareUrl() +" ಅನಿಯಮಿತ ಕಥೆ, ಕವನ, ಲೇಖನಗಳನ್ನು ಭಾರತೀಯ ಭಾಷೆಗಳಲ್ಲಿ ಉಚಿತವಾಗಿ ಓದಿರಿ!"; }; this.shareOnFacebook = function() { self.triggerFacebookEvent('SHAREBOOKFB_BOOKEND_READER'); window.open( "http://www.facebook.com/sharer.php?u=" + getShareUrl( "facebook" ), "share", "width=1100,height=500,left=70px,top=60px" ); }; this.shareOnTwitter = function( utm_location ) { self.triggerFacebookEvent('SHAREBOOKTW_BOOKEND_READER'); window.open( "http://twitter.com/share?url=" + getShareUrl( "twitter" ), "share", "width=1100,height=500,left=70px,top=60px" ); }; this.shareOnGplus = function( utm_location ) { self.triggerFacebookEvent('SHAREBOOKGP_BOOKEND_READER'); window.open( "https://plus.google.com/share?url=" + getShareUrl( "gplus" ), "share", "width=1100,height=500,left=70px,top=60px" ); }; this.shareOnWhatsapp = function() { self.triggerFacebookEvent('SHAREBOOKWA_BOOKEND_READER'); window.open( "whatsapp://send?text=" + getWhatsappText() ); }; /** * Facebook events */ this.triggerFacebookEvent = function(eventName, parentId, value) { switch (eventName) { case 'SHAREBOOKFB_BOOKEND_READER': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndValue(eventName, self.pratilipi, 'FACEBOOK'); break; case 'SHAREBOOKGP_BOOKEND_READER': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndValue(eventName, self.pratilipi, 'GOOGLEPLUS'); break; case 'SHAREBOOKOT_BOOKEND_READER': break; case 'SHAREBOOKTW_BOOKEND_READER': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndValue(eventName, self.pratilipi, 'TWITTER'); break; case 'SHAREBOOKWA_BOOKEND_READER': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndValue(eventName, self.pratilipi, 'WHATSAPP'); break; case 'CHANGECHAPTER_READERM_READER': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId(eventName, self.pratilipi, parentId); break; case 'GOLOGIN_BOOKEND_READER': FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi(eventName, self.pratilipi); break; case 'RATE_BOOKEND_READER': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndValue(eventName, self.pratilipi, value); break; case 'LANDED_BOOKEND_READER': case 'LANDED_READERM_READER': FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi(eventName, self.pratilipi); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; self.triggerGoLoginEvent = function() { self.triggerFacebookEvent('GOLOGIN_BOOKEND_READER'); return true; }; self.bookEndViewEventTriggered = ko.observable(false); $( window ).scroll(function() { if (self.content()) { if (FacebookEventTriggerUtil.isScrolledIntoView($('.social-icons-holder'), true) && !self.bookEndViewEventTriggered() && self.chapterNo() === self.chapterCount() ) { self.triggerFacebookEvent('LANDED_BOOKEND_READER'); self.bookEndViewEventTriggered(true); } } }); } , template: `<div class="pratilipi-reader-content"><span data-bind="visible: isLoading()" class="initial-data-loading-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span><div data-bind="visible: !isLoading()"><div class="content js-content"data-bind="{ html: content(),css: readerContentClassObserver(),swipeleft: goToNextChapter,swiperight: goToPreviousChapter }"></div><div data-bind="visible: chapterNo() != chapterCount()" class="next-chapter-container"><div class="next-chapter clickable-element" data-bind="click: goToNextChapter">ಮುಂದಿನ ಅಧ್ಯಾಯ</div></div><div data-bind="visible: chapterNo() == chapterCount()" class="last-page-review-container"><div class="social-icons-holder"><div class="sprites-icon facebook-icon clickable-element" data-bind="click: shareOnFacebook"></div><div class="sprites-icon twitter-icon clickable-element" data-bind="click: shareOnTwitter"></div><div class="sprites-icon google-plus-icon clickable-element" data-bind="click: shareOnGplus"></div><div class="sprites-icon whatsapp-icon clickable-element" data-bind="visible: isMobile(), click: shareOnWhatsapp"></div></div><div class="user-image-container"><hr/><img data-bind="visible: ! appViewModel.user.isGuest(), attr: { src: getImageUrl( appViewModel.user.profileImageUrl(), 48 ) }" /><i onclick="goToLoginPage()" class="material-icons clickable-element" data-bind="visible: appViewModel.user.isGuest(), click: triggerGoLoginEvent">account_circle</i></div><div class="rating-input-container"><div class="material-title">ನಿಮ್ಮ ರೇಟಿಂಗ್</div><pratilipi-rating-input params="{ rating: ratingInput }" data-bind="click: openReviewModal"></pratilipi-rating-input></div><!-- ko if: pratilipi.state() == 'PUBLISHED' --><!-- ko component: {name: "pratilipi-recommendation-carousel",params: { pratilipiId: pratilipi.pratilipiId, context: 'readPage', pratilipi: pratilipi }} --><!-- /ko --><!-- /ko --></div></div></div><div class="modal common-modal fade" id="pratilipi-reader-review-input-dialog" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button data-bind="click: closeReviewModal" class="mdl-button mdl-js-button mdl-button--icon close"><i class="material-icons">close</i></button><h6 class="modal-title">ರೇಟಿಂಗ್ ಮತ್ತು ರಿವ್ಯೂ</h6></div><div class="modal-body"><pratilipi-rating-input style="color: rgba(0,0,0,0.54);" params="{ rating: ratingInput }"></pratilipi-rating-input><textarea data-bind="{ mdlFloatingInput: { label: 'ಪ್ರತಿಕ್ರಿಯೆ ಬರೆಯಿರಿ', value: reviewInput, id: 'pratilipi_reader_review_list_review_input' }, valueUpdate: ['input'], transliterate: true }" rows= "3"></textarea></div><div class="modal-footer"><button onclick="ga_CA( 'Review', 'Cancel Rating' )"data-bind="click: closeReviewModal"class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin">ರದ್ದುಗೊಳಿಸಿ</button><button onclick="ga_CA( 'Review', 'Add Rating' )"data-bind="click: submitReview, enable: canSubmitReview"class="mdl-button mdl-js-button mdl-button--colored mdl-js-ripple-effect mdl-button--raised">ಸಬ್ಮಿಟ್ ಮಾಡಿ</button></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-pratilipi-info', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); /* Setting Local Variables */ this.pratilipi = params.pratilipi; this.userPratilipi = params.userPratilipi; this.updatePratilipi = params.updatePratilipi; this.updateUserPratilipi = params.updateUserPratilipi; var defaultAuthor = { "authorId": null, "name": null, "nameEn": null, "pageUrl": null, "profileImageUrl": null, "summary": null }; var defaultUserAuthor = { "authorId": null, "following": false }; this.author = ko.mapping.fromJS( defaultAuthor, {}, self.author ); this.userAuthor = ko.mapping.fromJS( defaultUserAuthor, {}, self.userAuthor ); this.authorLoaded = ko.observable( false ); this.canAddToLibrary = ko.observable( false ); this.canShare = ko.observable( false ); this.canDelete = ko.observable( false ); this.pratilipiRequestOnFlight = ko.observable( false ); this.userPratilipiRequestOnFlight = ko.observable( false ); this.userAuthorRequestOnFlight = ko.observable( false ); this.authorIsUser = ko.observable( false ); /* Summary Input */ this.summaryInputValue = ko.observable(); this.summaryInputActive = ko.observable( false ); this.summaryInputRequestOnFlight = ko.observable( false ); this.openSummaryInput = function() { self.summaryInputValue( self.pratilipi.summary() ); self.summaryInputActive( true ); }; this.closeSummaryInput = function() { self.summaryInputActive( false ); }; this.toggleSummaryInput = function() { if( self.summaryInputActive() ) self.closeSummaryInput(); else self.openSummaryInput(); }; this.submitSummaryInput = function() { ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); var pratilipi = { "pratilipiId": self.pratilipi.pratilipiId(), "summary": self.summaryInputValue() }; self.summaryInputRequestOnFlight( true ); var dataAccessor = new DataAccessor(); dataAccessor.createOrUpdatePratilipi( pratilipi, function( pratilipi ) { if (params.pratilipi.summary() && params.pratilipi.summary() != self.summaryInputValue()) { self.triggerFacebookEvent('UPDATEBOOKINFO_SUMMARY_BOOK'); } else if (!params.pratilipi.summary() || params.pratilipi.summary() === '') { self.triggerFacebookEvent('NEWBOOKINFO_SUMMARY_BOOK'); } self.updatePratilipi( pratilipi ); self.summaryInputRequestOnFlight( false ); ToastUtil.toast( "ಯಶಸ್ವಿ!", 3000 ); self.closeSummaryInput(); }, function( error ) { self.summaryInputRequestOnFlight( false ); var message = "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!"; if( error[ "message" ] != null ) message = error[ "message" ]; ToastUtil.toast( message, 3000 ); } ); }; /* Author */ this.updateAuthor = function( author ) { ko.mapping.fromJS( author, {}, self.author ); }; this.updateUserAuthor = function( userAuthor ) { ko.mapping.fromJS( userAuthor, {}, self.userAuthor ); }; this.fetchAuthorAndUserAuthor = function() { self.authorLoaded( false ); dataAccessor.getAuthorById( self.pratilipi.author.authorId(), function( author ) { self.updateAuthor( author ); self.updateUserAuthor( author ); self.authorLoaded( true ); }); }; /* Add to Library */ this.addToLibrary = function() { if( appViewModel.user.isGuest() ) { self.triggerFacebookEvent('LIBRARYADD_BOOKM_BOOK'); goToLoginPage( null, { "message": "LIBRARY" } ); return; } var getAddedToLibMessage = function( addedToLib ) { var text = addedToLib ? "ನೀವು $pratilipiTitle ಬರಹವನ್ನು ಗ್ರಂಥಾಲಯಕ್ಕೆ ಸೇರಿಸಿದ್ದೀರಿ" : "ನೀವು $pratilipiTitle ಬರಹವನ್ನು ಗ್ರಂಥಾಲಯದಿಂದ ತೆಗೆದುಹಾಕಿದ್ದೀರಿ"; var title = self.pratilipi.title().substring( 0, 10 ) + ( self.pratilipi.title().length > 10 ? "..." : "" ); return text.replace( "$pratilipiTitle", title ); }; var addedToLib = ! self.userPratilipi.addedToLib(); if( addedToLib ) { /* Toast only for remove action */ ToastUtil.toast( getAddedToLibMessage( addedToLib ), 3000 ); self.triggerFacebookEvent('LIBRARYADD_BOOKM_BOOK'); } else{ ToastUtil.toastCallBack( getAddedToLibMessage( addedToLib ), 4000, "", self.addToLibrary ); self.triggerFacebookEvent('LIBRARYREMOVE_BOOKM_BOOK'); } self.updateUserPratilipi( { "addedToLib": addedToLib } ); self.userPratilipiRequestOnFlight( true ); dataAccessor.addOrRemoveFromLibrary( self.pratilipi.pratilipiId(), addedToLib, function( userPratilipi ) { self.userPratilipiRequestOnFlight( false ); }, function( error ) { self.userPratilipiRequestOnFlight( false ); ToastUtil.toast( error[ "message" ] != null ? error[ "message" ] : "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!" ); self.updateUserPratilipi( { "addedToLib": ! addedToLib } ); }); }; /* Follow Author */ this.followAuthor = function() { if( appViewModel.user.isGuest() ) { self.triggerFacebookEvent('FOLLOW_AUTHORDETAIL_BOOK'); goToLoginPage( null, { "message": "FOLLOW" } ); return; } var getFollowingMessage = function( following ) { var text = following ? "ನೀವು $authorName ಅವರನ್ನು ಹಿಂಬಾಲಿಸುತ್ತಿದ್ದೀರಿ" : "ನೀವು $authorName ಅವರನ್ನು ಹಿಂಬಾಲಿಸುತ್ತಿಲ್ಲ"; return text.replace( "$authorName", self.pratilipi.author.name() ); }; var following = ! self.userAuthor.following(); if( following ) /* Toast only for unfollow action */ ToastUtil.toast( getFollowingMessage( following ), 3000 ); else ToastUtil.toastCallBack( getFollowingMessage( following ), 4000, "", self.followAuthor ); self.updateUserAuthor( { "following": following } ); self.userAuthorRequestOnFlight( true ); dataAccessor.followOrUnfollowAuthor( self.author.authorId(), following, function( userAuthor ) { self.userAuthorRequestOnFlight( false ); ga_CA( 'Author', userAuthor.following ? 'Follow' : 'UnFollow' ); if ( following ) { self.triggerFacebookEvent('FOLLOW_AUTHORDETAIL_BOOK'); } else { self.triggerFacebookEvent('UNFOLLOW_AUTHORDETAIL_BOOK'); } }, function( error ) { self.userAuthorRequestOnFlight( false ); ToastUtil.toast( error[ "message" ] != null ? error[ "message" ] : "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!" ); self.updateUserAuthor( { "following": ! following } ); }); }; /* Share on facebook modal */ this.openSharingModal = function () { if( self.authorIsUser() && self.pratilipi.state() == 'PUBLISHED') { $("#sharePratilipiOnFacebookModal").modal("show"); } }; this.getSharingUrl = function() { var urlParts = self.pratilipi.pageUrl().split('/'); var slugParts = urlParts[2].split('-'); return window.location.protocol + "//" + window.location.host + "/" + urlParts[1] + "/" + slugParts[slugParts.length - 1]; }; this.shareOnFacebook = function() { var sharingUrl = self.getSharingUrl() + encodeURIComponent( "?utm_source=pratilipi_website&utm_medium=summary_share_popup&utm_campaign=content_share" ); window.open( "http://www.facebook.com/sharer.php?u=" + sharingUrl, "share", "width=1100,height=500,left=70px,top=60px" ); }; /* pratilipiStateObserver */ this.pratilipiStateObserver = ko.computed( function() { if( this.pratilipi.state() == null ) return; setTimeout( function() { /* Show popup for self published contents only */ if( sessionStorage.publishType && sessionStorage.publishType == "self" ) { self.openSharingModal(); sessionStorage.publishType = null; } }); }, this); /* Publish or Unpublish */ this.togglePratilipiState = function() { var currentState = self.pratilipi.state(); var newState = self.pratilipi.state() != "PUBLISHED" ? "PUBLISHED" : "DRAFTED"; var getPublishedMessage = function( newState ) { var text = newState == "PUBLISHED" ? "ನೀವು $pratilipiTitle ಬರಹವನ್ನು ಪ್ರಕಟಿಸಿದ್ದೀರಿ" : "ನೀವು $pratilipiTitle ಬರಹವನ್ನು ಅಪ್ರಕಟಿತಗೊಳಿಸಿದ್ದೀರಿ"; var title = self.pratilipi.title().substring( 0, 10 ) + ( self.pratilipi.title().length > 10 ? "..." : "" ); return text.replace( "$pratilipiTitle", title ); }; self.updatePratilipi( { "state": newState } ); if( newState == "DRAFTED" ) {/* Toast only for Add to Drafts action */ ToastUtil.toastCallBack( getPublishedMessage( newState ), 4000, "", self.togglePratilipiState ); self.triggerFacebookEvent('UNPUBLISHBOOK_BOOKM_BOOK'); } else { ToastUtil.toast( getPublishedMessage( newState ), 3000 ); self.triggerFacebookEvent('PUBLISHBOOK_BOOKM_BOOK'); self.openSharingModal(); } self.pratilipiRequestOnFlight( true ); dataAccessor.createOrUpdatePratilipi( { "pratilipiId": self.pratilipi.pratilipiId(), "state": newState }, function( pratilipi ) { self.pratilipiRequestOnFlight( false ); }, function( error ) { self.pratilipiRequestOnFlight( false ); self.updatePratilipi( { "state": currentState } ); ToastUtil.toast( error.message, 3000 ); }); }; /* Share */ this.share = function() { var utmParameter = "utm_source=pratilipi_website&utm_medium=main_share_popup&utm_campaign=content_share"; ShareUtil.sharePratilipi( self.pratilipi, utmParameter, 'BOOKM_BOOK' ); self.triggerFacebookEvent('CLICKSHRBOOK_BOOKM_BOOK'); }; /* Image Upload */ this.imageUploaded = ko.observable( false ); this.chooseImageFile = function() { document.getElementById( 'uploadPratilipiImageInput' ).value= null; document.getElementById( "uploadPratilipiImageInput" ).click(); }; this.uploadPratilipiImage = function( vm, evt ) { var files = evt.target.files; var file = files[0]; self.imageUploaded( true ); document.getElementById( "uploadPratilipiImageForm" ).submit(); if (self.pratilipi.coverImageUrl().endsWith('pratilipi/cover')) { self.triggerFacebookEvent('NEWBOOKINFO_BOOKCOVER_BOOK'); } else { self.triggerFacebookEvent('UPDATEBOOKINFO_BOOKCOVER_BOOK'); } }; this.iframeLoaded = function( vm, evt ) { if( ! self.imageUploaded() ) return; var response = JSON.parse( evt.currentTarget.contentDocument.body.innerText ); if( response[ "coverImageUrl" ] != null ) { /* Success Callback */ var coverImageUrl = response[ "coverImageUrl" ]; self.updatePratilipi( { "coverImageUrl": coverImageUrl } ); ToastUtil.toast( "ಯಶಸ್ವಿ!", 3000 ); } else if( response[ "message" ] != null ) { ToastUtil.toast( response[ "message" ], 3000 ); } self.imageUploaded( false ); }; /* Delete Pratilipi */ this.openDeletePratilipiDialog = function() { $( "#pratilipi-info-delete-confirmation-dialog" ).modal(); self.triggerFacebookEvent('DELETEBOOK_BOOKM_BOOK'); }; this.deletePratilipi = function() { var currentState = self.pratilipi.state(); var pratilipi = { "pratilipiId": self.pratilipi.pratilipiId(), "state": "DELETED" }; self.pratilipiRequestOnFlight( true ); ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); dataAccessor.createOrUpdatePratilipi( pratilipi, function( pratilipi ) { ToastUtil.toast( "ಈ ಬರಹವು ಯಶಸ್ವಿಯಾಗಿ ಡಿಲೀಟ್ ಆಗಿರುತ್ತದೆ!", 3000 ); window.location.href = self.author.pageUrl(); }, function( error ) { self.pratilipiRequestOnFlight( false ); self.updatePratilipi( { "state": currentState } ); ToastUtil.toast( error.message, 3000 ); }); }; /* Computed observables - separate observers for ID and meta - performance optimization */ this.authorIdObserver = ko.computed( function() { /* Check for the exact data. * ko mapping updates properties in a different fashion * First it updates only the 'pratilipi' object * Then it updates the 'author' object inside 'pratilipi' object * As a result, the function will be called 2 times if we check for pratilipiId */ if( self.pratilipi.author.authorId() == null ) return; self.fetchAuthorAndUserAuthor(); }, this ); this.pratilipiMetaObserver = ko.computed( function() { self.canAddToLibrary( self.pratilipi.state() == "PUBLISHED" && ( appViewModel.user.isGuest() || self.pratilipi.author.authorId() != appViewModel.user.author.authorId() ) ); self.canShare( self.pratilipi.state() == "PUBLISHED" ); self.canDelete( self.pratilipi.state() == "DRAFTED" && self.pratilipi.hasAccessToUpdate() ); self.authorIsUser( self.pratilipi.author.authorId() == appViewModel.user.author.authorId() ); }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName) { switch (eventName) { case 'CLICKUSER_AUTHORDETAIL_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId(eventName, self.pratilipi, self.author.authorId() ); break; case 'FOLLOW_AUTHORDETAIL_BOOK': case 'UNFOLLOW_AUTHORDETAIL_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndValue(eventName, self.pratilipi, self.author.user.followCount ? self.author.user.followCount() : 0, self.author.authorId()); break; case 'NEWBOOKINFO_BOOKCOVER_BOOK': case 'UPDATEBOOKINFO_BOOKCOVER_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi(eventName, self.pratilipi); break; case 'CLICKSHRBOOK_BOOKM_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNameExperimentIdAndPratilipi('CLICKSHRBOOK_BOOKM_BOOK', 'CONTROL', self.pratilipi ); break; case 'DELETEBOOK_BOOKM_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNameExperimentIdAndPratilipi('DELETEBOOK_BOOKM_BOOK', 'CONTROL', self.pratilipi ); break; case 'EDITBOOK_BOOKM_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi(eventName, self.pratilipi); break; case 'LANDED_BOOKM_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNameExperimentIdAndPratilipi('LANDED_BOOKM_BOOK', 'CONTROL', self.pratilipi ); break; case 'LIBRARYADD_BOOKM_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNameExperimentIdAndPratilipi('LIBRARYADD_BOOKM_BOOK', 'CONTROL', self.pratilipi ); break; case 'LIBRARYREMOVE_BOOKM_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNameExperimentIdAndPratilipi('LIBRARYREMOVE_BOOKM_BOOK', 'CONTROL', self.pratilipi ); break; case 'UNPUBLISHBOOK_BOOKM_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNameExperimentIdAndPratilipi('UNPUBLISHBOOK_BOOKM_BOOK', 'CONTROL', self.pratilipi ); break; case 'READBOOK_BOOKM_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNameExperimentIdAndPratilipi('READBOOK_BOOKM_BOOK', 'CONTROL', self.pratilipi ); break; case 'UPDATEBOOKINFO_SUMMARY_BOOK': case 'NEWBOOKINFO_SUMMARY_BOOK': case 'VIEWED_AUTHORDETAIL_BOOK': case 'VIEWED_CATTAG_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi(eventName, self.pratilipi); break; case 'PUBLISHBOOK_BOOKM_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNameExperimentIdPratilipiAndState('PUBLISHBOOK_BOOKM_BOOK', 'CONTROL', self.pratilipi, 'EXISTING' ); break; case 'CLICKUSER_BOOKM_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId(eventName, self.pratilipi, self.author.authorId() ); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.triggerAuthorDetailUserClick = function() { self.triggerFacebookEvent('CLICKUSER_AUTHORDETAIL_BOOK'); return true; }; this.triggerBookSectionUserClick = function() { self.triggerFacebookEvent('CLICKUSER_BOOKM_BOOK'); return true; }; this.triggerEditBookEvent = function() { self.triggerFacebookEvent('EDITBOOK_BOOKM_BOOK'); return true; }; this.triggerReadBookEvent = function() { self.triggerFacebookEvent('READBOOK_BOOKM_BOOK'); return true; }; this.pratilipiObserver = ko.computed( function() { self.pratilipi.pratilipiId(); if (!self.pratilipi.pratilipiId()) { return; } self.authorDetailsViewEventTriggered = ko.observable(false); self.pratilipiTagsViewEventTriggered = ko.observable(false); $( window ).scroll(function() { if (FacebookEventTriggerUtil.isScrolledIntoView($('.author-meta-holder'), true) && !self.authorDetailsViewEventTriggered()) { self.triggerFacebookEvent('VIEWED_AUTHORDETAIL_BOOK'); self.authorDetailsViewEventTriggered(true); } if (FacebookEventTriggerUtil.isScrolledIntoView($('.pratilipi-tags'), true) && !self.pratilipiTagsViewEventTriggered()) { self.triggerFacebookEvent('VIEWED_CATTAG_BOOK'); self.pratilipiTagsViewEventTriggered(true); } }); }, this); } , template: `<div class="pratilipi-pratilipi-info"><div class="mdl-card mdl-card-border mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><div class="mdl-grid" style="padding: 1px; width: 100%;"><div class="pratilipi-cover-image-container"><pratilipi-image data-bind="visible: !imageUploaded()"params="{ src: pratilipi.coverImageUrl,width: 200,height: 300,mobWidth: 150,mobHeight: 225,alt: pratilipi.title }"></pratilipi-image><div data-bind="visible: imageUploaded()" class="pratilipi-cover-image image-uploaded-div"><div class="pratilipi-cover-image spinner-container"><span class="image-uploaded-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div></div><button class="upload-image-button mdl-button mdl-js-button mdl-button--fab"data-bind="{ click: chooseImageFile,visible: pratilipi.hasAccessToUpdate() && ! imageUploaded() }"><i class="material-icons">camera_alt</i></button><form id="uploadPratilipiImageForm"style="position: absolute; top: -1000px;"method="post"enctype="multipart/form-data"data-bind="{ attr: { 'action': '/api/pratilipi/cover?pratilipiId=' + pratilipi.pratilipiId() }, uniqueName: true }"target="pratilipi_upload_target"><input id="uploadPratilipiImageInput"data-bind="{ event: { change: uploadPratilipiImage }, uniqueName: true }"type="file"accept="image/*"></form><iframe id="pratilipi_upload_target"name="pratilipi_upload_target"style="display: none;"data-bind="event: { load: iframeLoaded }"></iframe><div id="percentage-read-bar" class="mdl-progress" data-bind="if: pratilipi.userPratilipi() && pratilipi.userPratilipi().percentageRead() > 0"><div class="progressbar bar bar1" data-bind="style: { width: pratilipi.userPratilipi().percentageRead() + '%' }"></div><div class="bufferbar bar bar2" style="width: 100%;"></div><div class="auxbar bar bar3" style="width: 0%;"></div></div></div><div class="mdl-grid mdl-grid--no-spacing pratilipi-info-variable-width" style="flex-grow: 1; margin: 8px;"><div class="mdl-cell mdl-cell--12-col mdl-cell--order-1 mdl-cell--order-1-phone"><div class="mdl-card__title"><div class="material-heading pratilipi-title" data-bind="text: pratilipi.title()"></div><button data-bind="visible: pratilipi.hasAccessToUpdate()"class="mdl-button mdl-js-button mdl-button--icon"data-toggle="modal" data-target="#pratilipi_edit_pratilipi"><i class="material-icons">create</i></button></div><div class="mdl-card__title"><a class="material-title author-name"onclick="ga_CA( 'Author', 'Open' )"data-bind="attr: { href: pratilipi.author.pageUrl() },click: triggerBookSectionUserClick,text: pratilipi.author.name()"></a></div><div class="mdl-card__supporting-text"><p class="material-subtitle-1 margin-bottom-8" data-bind="visible: pratilipi.averageRating() > 0"><!--ko text: roundOffToOneDecimal( pratilipi.averageRating() ) --><!--/ko--><i class="material-icons material-icons-16 vertical-middle icon-center">star</i>&nbsp;&nbsp;(<!--ko text: pratilipi.ratingCount() --><!--/ko--><i class="material-icons material-icons-16 vertical-middle icon-center">person</i>)</p><p class="font-16 margin-bottom-8"> ಓದುಗರು:&nbsp;<!--ko text: formatReadCount( pratilipi.readCount() ) --><!--/ko--></p><!-- ko if: ( pratilipi.readingTime() != null && pratilipi.readingTime() >= 30 ) --><p class="font-16 margin-bottom-8"> ಓದಿದ ಸಮಯ:&nbsp;<!--ko text: formatReadingTime( pratilipi.readingTime() ) --><!--/ko--></p><!--/ko--></div></div><div class="mdl-cell mdl-cell--12-col mdl-cell--order-3 mdl-cell--order-2-phone button-holders"><div class="mdl-card__actions" style="padding: 0;"><a onclick="ga_CA( 'Pratilipi', 'Read' )"data-bind="{ attr: { href: pratilipi.readPageUrl() },text: pratilipi.state() == 'PUBLISHED' ? 'ಓದಿರಿ' : 'ಪ್ರಿವ್ಯೂ',click: triggerReadBookEvent }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin"></a><button onclick="ga_CA( 'Pratilipi', 'Add To Library' )"data-bind="{ text: ( userPratilipi.addedToLib() ? '-' : '+' ) + ' ' + 'ಗ್ರಂಥಾಲಯ',click: addToLibrary,disable: userPratilipiRequestOnFlight,visible: canAddToLibrary() }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin"></button><button data-bind="{ visible: pratilipi.hasAccessToUpdate(),text: ( pratilipi.state() == 'PUBLISHED' ? 'ಅಪ್ರಕಟಿತಗೊಳಿಸಿ' : 'ಪ್ರಕಟಿಸಿ!' ),click: togglePratilipiState,disable: pratilipiRequestOnFlight }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin"></button><a data-bind="{ visible: pratilipi.hasAccessToUpdate() && ! isMobile(), attr: { 'href': pratilipi.writePageUrl() }, click: triggerEditBookEvent }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin small-button"><i class="material-icons material-icons-16">create</i></a><button data-bind="{ visible: canDelete(),click: openDeletePratilipiDialog,disable: pratilipiRequestOnFlight }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin">ಡಿಲೀಟ್ ಮಾಡಿ</button><button onclick="ga_CA( 'Pratilipi', 'Share' )"data-bind="{ visible: canShare(), click: share }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin small-button"><i class="material-icons material-icons-16">share</i></button></div></div><div class="mdl-cell mdl-cell--12-col mdl-cell--order-2 mdl-cell--order-3-phone"><div class="mdl-card__supporting-text"><p class="margin-bottom-8">ಪ್ರಕಟಿತ ದಿನಾಂಕ:&nbsp;<!--ko text: convertDate( pratilipi.listingDateMillis() ) --><!--/ko--></p><p class="font-16 margin-bottom-8" data-bind="text: getPratilipiTypeVernacular( pratilipi.type() )"></p></div></div></div><!-- ko if: pratilipi.hasAccessToUpdate() --><div class="mdl-cell mdl-cell--12-col padding-zero"><hr class="margin-zero"></div><!-- ko component: {name: "pratilipi-tags",params: {pratilipi: pratilipi}} --><!-- /ko --><!-- /ko --><!-- ko if: pratilipi.summary() || pratilipi.hasAccessToUpdate() --><div class="mdl-cell mdl-cell--12-col padding-zero"><hr class="margin-zero"></div><h3 class="mdl-cell mdl-cell--12-col material-title" style="margin: 8px 16px;">ಸಾರಾಂಶ<button data-bind="{ visible: pratilipi.hasAccessToUpdate(), click: toggleSummaryInput }" class="mdl-button mdl-js-button mdl-button--icon" style="margin-left: 4px;"><i style="font-size: 20px" class="material-icons">create</i></button></h3><div class="mdl-cell mdl-cell--12-col mdl-card__supporting-text" style="margin: 8px 16px;"><pratilipi-see-more data-bind="visible: ! summaryInputActive() && pratilipi.summary() != null" params="{ originalText: pratilipi.summary(), uniqueName: 'pratilipi-summary' }"></pratilipi-see-more><button style="outline: none; background: none; border: none; padding: 0; margin: 0; color: inherit; cursor: pointer;"class="material-subtitle-1"data-bind="visible: pratilipi.summary() == null && ! summaryInputActive(), click: openSummaryInput">ಸಾರಾಂಶವನ್ನು ಸೇರಿಸಲು ದಯವಿಟ್ಟು ಇಲ್ಲಿ ಕ್ಲಿಕ್ ಮಾಡಿ</button><div data-bind="visible: summaryInputActive()" class="summary-input-div"><textarea data-bind="{ mdlFloatingInput: { label: '', value: summaryInputValue, id: 'pratilipi_pratilipi_info_summary_input' }, valueUpdate: ['input'], transliterate: true }" rows= "3"></textarea><div class="summary-input-footer" style="text-align: right;"><button data-bind="click: closeSummaryInput, disable: summaryInputRequestOnFlight()" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button-margin">ರದ್ದುಗೊಳಿಸಿ</button><button data-bind="click: submitSummaryInput, disable: summaryInputRequestOnFlight()" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin">ಸಂರಕ್ಷಿಸಿ</button></div></div></div><!-- /ko --><!-- ko if: ! authorIsUser() --><div class="mdl-cell mdl-cell--12-col padding-zero"><hr class="margin-zero"></div><h3 class="mdl-cell mdl-cell--12-col material-title"style="margin: 8px 16px;"data-bind="text: author.summary() != null ? 'ಲೇಖಕರ ಕುರಿತು' : 'ಲೇಖಕ'"></h3><div data-bind="visible: ! authorLoaded()"style="margin: 25px auto;"class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></div><div class="mdl-cell mdl-cell--12-col"style="display: flex; align-items: center; justify-content: space-between; margin: 8px 16px;"data-bind="visible: authorLoaded()"><div class="author-meta-holder"><img data-bind="attr: { src: getImageUrl( author.profileImageUrl(), 48 ) }" class="mdl-list__item-avatar"><a onclick="ga_CA( 'Author', 'Open' )" class="author-name font-m" data-bind="attr: { href: pratilipi.author.pageUrl() }, click: triggerAuthorDetailUserClick, text: pratilipi.author.name()"></a><button data-bind="{ click: followAuthor,text: userAuthor.following() ? 'ಈಗಾಗಲೇ ಹಿಂಬಾಲಿಸುತ್ತಿದ್ದೀರಿ': 'ಹಿಂಬಾಲಿಸಿ',disable: userAuthorRequestOnFlight }"class="mdl-button mdl-js-button mdl-button--primary mdl-layout--large-screen-only"style="margin-left: auto;"></button><button data-bind="{ click: followAuthor,disable: userAuthorRequestOnFlight }"class="mdl-button mdl-js-button mdl-button--icon mdl-button--colored mdl-layout--small-screen-only"style="margin-left: auto;"><i class="material-icons" data-bind="text: ( userAuthor.following() ? 'done' : 'person_add' )"></i></button></div></div><div class="mdl-cell mdl-cell--12-col padding-zero author-summary"style="margin: 4px 16px 8px 16px;"data-bind="visible: author.summary() != null"><pratilipi-see-more params="{ originalText: author.summary(), uniqueName: 'author-summary' }"></pratilipi-see-more></div><!-- /ko --></div></div></div><!-- Delete Pratilipi Modal --><div class="modal common-modal fade" id="pratilipi-info-delete-confirmation-dialog" tabindex="-1" role="dialog" aria-labelledby="pratilipi-info-delete-confirmation-dialog"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button data-dismiss="modal" class="mdl-button mdl-js-button mdl-button--icon close"><i class="material-icons">close</i></button><h6 class="modal-title">ಪ್ರತಿಕ್ರಿಯೆಯನ್ನು ಡಿಲೀಟ್ ಮಾಡಿ</h6></div><div class="modal-body"><div class="material-subtitle-2">ನೀವು ಈ ಬರಹವನ್ನು ಡಿಲೀಟ್ ಮಾಡಲು ಬಯಸುವಿರಾ?</div></div><div class="modal-footer"><button data-bind="click: deletePratilipi" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin pull-left">ಹೌದು</button><button data-dismiss="modal" class="mdl-button mdl-js-button mdl-button--colored mdl-js-ripple-effect mdl-button--raised">ರದ್ದುಗೊಳಿಸಿ</button></div></div></div></div><div class="modal fade pratilipi-write" id="sharePratilipiOnFacebookModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><span data-dismiss="modal" aria-label="Close" class="material-icons close">close</span><h6 class="material-title" style="font-size:24px !important; text-align:center">ಅಭಿನಂದನೆಗಳು !</h6></div><div class="modal-body"><table style="width:100%"><tr><td style="width:100px;"><img data-bind="attr:{ src: getImageUrl( pratilipi.coverImageUrl(), 100, false ), alt: pratilipi.title }"style="vertical-align: middle; width: 100; height: 150;" /></td><td><div style="margin: 10px; height:130px; position: relative;"><span style="line-height: 20px; font-size:18px;"><span style="font-style: italic;" data-bind="{ text: pratilipi.title() + ' ' }"></span>ಪ್ರಕಟವಾಗಿರುತ್ತದೆ</span><span style="position:absolute; bottom:0px; left:0px; font-size:22px;line-height:26px">ನಿಮ್ಮ ಬರಹವನ್ನು ಓದುವ ಖುಷಿ ನಿಮ್ಮ ಸ್ನೇಹಿತರಿಗೂ ಸಿಗಲಿ.ಅವರ ಅಭಿಪ್ರಾಯವನ್ನೂ ತಿಳಿಯಿರಿ</span></div></td></tr><tr><td colspan="2" style="padding-top:20px;" data-bind="click: shareOnFacebook"><div class="mdl-list__item-primary-content"style="background: #3b5998;line-height: 50px;border-radius:2px; text-align:center; cursor:pointer;"><span class="sprites-icon mdl-list__item-icon"style="background-position:-72px -24px; padding-right:10px;"></span><span style="color: #fff;vertical-align: middle;padding:10px;font-size:24px;">ಫೇಸ್ಬುಕ್ನಲ್ಲಿ ಶೇರ್ ಮಾಡಿ</span></div></td></tr></table></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-settings-page', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.isAdmin = getUrlParameter( "authorId" ) != null && getUrlParameter( "userId" ) != null; /* PROFILE SETTINGS */ this.firstName = ko.observable(); this.lastName = ko.observable(); this.firstNameEn = ko.observable(); this.lastNameEn = ko.observable(); this.penName = ko.observable(); this.language = ko.observable(); this.summary = ko.observable(); this.authorPageUrl = ko.observable(); this.email = ko.observable(); this.phone = ko.observable(); this.gender = ko.observable(); this.dateOfBirth = ko.observable(); this.isLoading = ko.observable(); /* Original Data - Disable the button if user hadn't changed any setting */ var originalAuthor = null; var originalUser = {}; this.updateLanguage = function() { self.language( document.querySelector( '#pratilipi-settings-language' ).getAttribute( "data-val" ) ); }; this.updateGender = function() { self.gender( document.querySelector( '#pratilipi-settings-gender' ).getAttribute( "data-val" ) ); }; var getAuthorId = function() { return getUrlParameter( "authorId" ) != null ? getUrlParameter( "authorId" ) : appViewModel.user.author.authorId(); }; var getUserId = function() { return getUrlParameter( "userId" ) != null ? getUrlParameter( "userId" ) : appViewModel.user.userId(); }; /* Helper functions */ /* https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/date */ /* dd-mm-yyyy to yyyy-mm-dd format */ var _ddmmyyyy2yyyymmdd = function( date ) { if( date == null || date.trim() == "" ) return null; var d = new Date( date.replace( /(\d{2})-(\d{2})-(\d{4})/, "$2/$1/$3") ); if( isNaN( d.getTime() ) ) return null; var month = '' + ( d.getMonth() + 1 ), day = '' + d.getDate(), year = d.getFullYear(); if (month.length < 2) month = '0' + month; if (day.length < 2) day = '0' + day; return [year, month, day].join('-'); }; /* yyyy-mm-dd to dd-mm-yyyy */ var _yyyymmdd2ddmmyyyy = function( inputDate ) { if( inputDate == null ) return null; var d = new Date( inputDate ); if( isNaN( d.getTime() ) ) return null; var month = '' + ( d.getMonth() + 1 ), day = '' + d.getDate(), year = d.getFullYear(); if (month.length < 2) month = '0' + month; if (day.length < 2) day = '0' + day; return [day, month, year].join('-'); }; var _getVal = function( val ) { return ( val == null || val.trim() == "" ) ? "" : val.trim(); }; this.loadUserAndAuthor = function() { if( self.isLoading() ) return; self.isLoading( true ); dataAccessor.getAuthorById( getAuthorId(), function( author ) { /* Helper functions */ var _getGenderForAnalytics = function(gender) { if (gender === "MALE") { return "M"; } else if (gender === "FEMALE") { return "F"; } }; var _getGenderValue = function( gender ) { if( gender == "MALE" ) return "ಪುರುಷ"; if( gender == "FEMALE" ) return "ಮಹಿಳೆ"; if( gender == "OTHER" ) return "ಇತರೆ"; return null; }; var firstName = _getVal( author.firstName ), lastName = _getVal( author.lastName ), firstNameEn = _getVal( author.firstNameEn ), lastNameEn = _getVal( author.lastNameEn ), penName = _getVal( author.penName ), language = _getVal( author.language ), summary = _getVal( author.summary ), gender = _getVal( author.gender ), dateOfBirth = _ddmmyyyy2yyyymmdd( author.dateOfBirth ), authorPageUrl = author.pageUrl; /* originalAuthor - global variable for reference */ originalAuthor = { firstName: firstName, lastName: lastName, firstNameEn: firstNameEn, lastNameEn: lastNameEn, penName: penName, language: language, summary: summary, gender: gender, dateOfBirth: dateOfBirth }; /* Setting observables */ self.firstName( firstName ); self.lastName( lastName ); self.firstNameEn( firstNameEn ); self.lastNameEn( lastNameEn ); self.penName( penName ); self.language( language ); self.summary( summary ); self.gender( gender ); self.dateOfBirth( dateOfBirth ); self.authorPageUrl( authorPageUrl ); /* Language in UI */ if( language != "" ) { $( "#pratilipi-settings-language" ).attr( 'data-val', language ); $( "#pratilipi-settings-language" ).attr( 'value', getLanguageVernacular( language ) ); } /* Gender in UI */ if( gender != "" ) { $( "#pratilipi-settings-gender" ).attr( 'data-val', gender ); $( "#pratilipi-settings-gender" ).attr( 'value', _getGenderValue( gender ) ); } /* FB Events */ FacebookEventTriggerUtil.setUserProperties('DOB', author.dateOfBirth); FacebookEventTriggerUtil.setUserProperties('GENDER', _getGenderForAnalytics(author.gender)); FacebookEventTriggerUtil.setUserProperties('JOINING_DATE', author.registrationDateMillis); FacebookEventTriggerUtil.setUserProperties('DRAFT_COUNT', author.contentDrafted); FacebookEventTriggerUtil.setUserProperties('PUBLISHED_COUNT', author.contentPublished); FacebookEventTriggerUtil.setUserProperties('FOLLOWER_COUNT', author.followCount); FacebookEventTriggerUtil.setUserProperties('FOLLOWING_COUNT', author.user.followCount); /* Loading User Info */ if( self.isAdmin ) { dataAccessor.getUserById( author.user.userId, function( user ) { originalUser = { "email": _getVal( user.email ), "phone": _getVal( user.phone ) }; self.email( originalUser.email ); self.phone( originalUser.phone ); self.isLoading( false ); }); } else { originalUser = { "email": _getVal( appViewModel.user.email() ), "phone": _getVal( appViewModel.user.phone() ) }; self.email( originalUser.email ); self.phone( originalUser.phone ); self.isLoading( false ); } }); }; this.updateProfileSettings = function() { /* valid email */ if( self.email() != null && self.email().trim() != "" && ! validateEmail( self.email() ) ) { ToastUtil.toast( "ಇಮೇಲ್ ಐಡಿಯು ತಪ್ಪಾಗಿ ನಮೂದಾಗಿದೆ" ); return; } /* valid phone */ if( self.phone() != null && self.phone().trim() != "" && ! validatePhone( self.phone() ) ) { ToastUtil.toast( "ಮೊಬೈಲ್ ಸಂಖ್ಯೆಯು ತಪ್ಪಾಗಿ ನಮೂದಾಗಿದೆ" ); return; } var author = { "authorId": getAuthorId() }; author[ "firstName" ] = _getVal( self.firstName() ); author[ "lastName" ] = _getVal( self.lastName() ); author[ "firstNameEn" ] = _getVal( self.firstNameEn() ); author[ "lastNameEn" ] = _getVal( self.lastNameEn() ); author[ "penName" ] = _getVal( self.penName() ); author[ "language" ] = _getVal( self.language() ); author[ "summary" ] = _getVal( self.summary() ); author[ "gender" ] = _getVal( self.gender() ); author[ "dateOfBirth" ] = _yyyymmdd2ddmmyyyy( self.dateOfBirth() ) == null ? "" : _yyyymmdd2ddmmyyyy( self.dateOfBirth() ); /* Analytics */ if (self.language() != originalAuthor.language) { self.triggerFacebookEvent('UPDATEUSERINFO_CONTENTLANG_SETNGACC'); } if ( ( !originalAuthor.dateOfBirth || originalAuthor.dateOfBirth == '') && _yyyymmdd2ddmmyyyy(self.dateOfBirth()) != originalAuthor.dateOfBirth) { self.triggerFacebookEvent('NEWUSERINFO_DOB_SETNGACC'); } else if (originalAuthor.dateOfBirth && _yyyymmdd2ddmmyyyy( self.dateOfBirth() ) != originalAuthor.dateOfBirth) { self.triggerFacebookEvent('UPDATEUSERINFO_DOB_SETNGACC'); } if ( ( !originalUser.email || originalUser.email == '') && self.email() != originalUser.email) { self.triggerFacebookEvent('NEWUSERINFO_EMAIL_SETNGACC'); } else if (originalUser.email && _getVal( self.email() ) != originalUser.email) { self.triggerFacebookEvent('UPDATEUSERINFO_EMAIL_SETNGACC'); } if ( ( !originalAuthor.firstName || originalAuthor.firstName == '') && _getVal( self.firstName() ) != originalAuthor.firstName) { self.triggerFacebookEvent('NEWUSERINFO_FNAME_SETNGACC'); } else if (originalAuthor.firstName && _getVal( self.firstName() ) != originalAuthor.firstName) { self.triggerFacebookEvent('UPDATEUSERINFO_FNAME_SETNGACC'); } if ( ( !originalAuthor.firstNameEn || originalAuthor.firstNameEn == '') && _getVal( self.firstNameEn() ) != originalAuthor.firstNameEn) { self.triggerFacebookEvent('NEWUSERINFO_FNAMEENG_SETNGACC'); } else if (originalAuthor.firstNameEn && _getVal( self.firstNameEn() ) != originalAuthor.firstNameEn) { self.triggerFacebookEvent('UPDATEUSERINFO_FNAMEENG_SETNGACC'); } if ( ( !originalAuthor.gender || originalAuthor.gender == '') && _getVal( self.gender() ) != originalAuthor.gender) { self.triggerFacebookEvent('NEWUSERINFO_GENDER_SETNGACC'); } else if (originalAuthor.gender && _getVal( self.gender() ) != originalAuthor.gender) { self.triggerFacebookEvent('UPDATEUSERINFO_GENDER_SETNGACC'); } if ( ( !originalAuthor.lastName || originalAuthor.lastName == '') && _getVal( self.lastName() ) != originalAuthor.lastName) { self.triggerFacebookEvent('NEWUSERINFO_LNAME_SETNGACC'); } else if (originalAuthor.lastName && _getVal( self.lastName() ) != originalAuthor.lastName) { self.triggerFacebookEvent('UPDATEUSERINFO_LNAME_SETNGACC'); } if ( ( !originalAuthor.lastNameEn || originalAuthor.lastNameEn == '') && _getVal( self.lastNameEn() ) != originalAuthor.lastNameEn) { self.triggerFacebookEvent('NEWUSERINFO_LNAMEENG_SETNGACC'); } else if (originalAuthor.lastNameEn && _getVal( self.lastNameEn() ) != originalAuthor.lastNameEn) { self.triggerFacebookEvent('UPDATEUSERINFO_LNAMEENG_SETNGACC'); } if ( ( !originalAuthor.penName || originalAuthor.penName == '') && _getVal( self.penName() ) != originalAuthor.penName) { self.triggerFacebookEvent('NEWUSERINFO_PENNAME_SETNGACC'); } else if (originalAuthor.penName && _getVal( self.penName() ) != originalAuthor.penName) { self.triggerFacebookEvent('UPDATEUSERINFO_PENNAME_SETNGACC'); } if ( ( !originalUser.phone || originalUser.phone == '') && self.phone() != originalUser.phone) { self.triggerFacebookEvent('NEWUSERINFO_PHONE_SETNGACC'); } else if (originalUser.phone && _getVal( self.phone() ) != originalUser.phone) { self.triggerFacebookEvent('UPDATEUSERINFO_PHONE_SETNGACC'); } if ( ( !originalAuthor.summary || originalAuthor.summary == '') && _getVal( self.summary() ) != originalAuthor.summary) { self.triggerFacebookEvent('NEWUSERINFO_USERBIO_SETNGACC'); } else if (originalAuthor.summary && _getVal( self.summary() ) != originalAuthor.summary) { self.triggerFacebookEvent('UPDATEUSERINFO_USERBIO_SETNGACC'); } FacebookEventTriggerUtil.setUserProperties('DOB', author.dateOfBirth); FacebookEventTriggerUtil.setUserProperties('GENDER', author.gender); FacebookEventTriggerUtil.setUserProperties('CONTENT_LANGUAGE', author.language); /* Setting global variables */ originalAuthor = author; originalUser = { phone: _getVal( self.phone() ), email: _getVal( self.email() ) }; /* 4 states: INITIAL, LOADING, SUCCESS, FAIL */ self.userApiCallState = ko.observable( "INITIAL" ); self.authorApiCallState = ko.observable( "INITIAL" ); var errorMessage = null; /* In case UserApi Or AuthorApi failed. */ self.callbackObserver = ko.computed( function() { if( self.userApiCallState() == "SUCCESS" && self.authorApiCallState() == "SUCCESS" ) { ToastUtil.toast( "ಯಶಸ್ವಿ!" ); self.isLoading( false ); self.userApiCallState( "INITIAL" ); self.authorApiCallState( "INITIAL" ); if( self.isAdmin ) { /* Redirect to the author page */ redirect( self.authorPageUrl() ); } } else if( self.userApiCallState() == "LOADING" || self.authorApiCallState() == "LOADING" ) { return; } else if( self.userApiCallState() == "FAILED" || self.authorApiCallState() == "FAILED" ) { if( self.userApiCallState() == "FAILED" ) ToastUtil.toast( errorMessage ); /* Ensure errorMessage field is set */ errorMessage = null; self.isLoading( false ); } }, self ); self.isLoading( true ); ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); self.userApiCallState( "LOADING" ); dataAccessor.createOrUpdateUser( getUserId(), self.email(), self.phone(), function( user ) { self.userApiCallState( "SUCCESS" ); }, function( error ) { var message = "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!"; if( error[ "email" ] != null ) message = error[ "email" ]; if( error[ "phone" ] != null ) message = error[ "phone" ]; if( error[ "message" ] != null ) message = error[ "message" ]; errorMessage = message; self.userApiCallState( "FAILED" ); }); self.authorApiCallState( "LOADING" ); dataAccessor.createOrUpdateAuthor( author, function( aAuthor ) { self.authorPageUrl( aAuthor.pageUrl ); self.authorApiCallState( "SUCCESS" ); }, function( error ) { var message = "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!"; if( error[ "language" ] != null ) message = error[ "language" ]; if( error[ "message" ] != null ) message = error[ "message" ]; errorMessage = message; self.authorApiCallState( "FAILED" ); }); }; this.canSaveProfileSettings = ko.computed( function() { return _getVal( self.firstName() ) !== "" && _getVal( self.language() ) !== "" && originalAuthor != null && originalUser != null && ! self.isLoading() && ( _getVal( self.firstName() ) != originalAuthor.firstName || _getVal( self.lastName() ) != originalAuthor.lastName || _getVal( self.firstNameEn() ) != originalAuthor.firstNameEn || _getVal( self.lastNameEn() ) != originalAuthor.lastNameEn || _getVal( self.penName() ) != originalAuthor.penName || _getVal( self.language() ) != originalAuthor.language || _getVal( self.summary() ) != originalAuthor.summary || _getVal( self.email() ) != originalUser.email || _getVal( self.phone() ) != originalUser.phone || _getVal( self.gender() ) != originalAuthor.gender || self.dateOfBirth() != originalAuthor.dateOfBirth ); }, this ); this.userObserver = ko.computed( function() { if( appViewModel.user.userId() == null ) return; if( appViewModel.user.isGuest() && appViewModel.user.userId() == 0 ) goToLoginPage(); setTimeout( function() { self.loadUserAndAuthor(); }, 0 ); }, this ); /* NOTIFICATION SETTINGS */ var originalEmailFrequency = null; var originalNewsletterFrequency = null; var originalNotificationSubscriptions = null; this.emailFrequency = ko.observable(); this.newsletterFrequency = ko.observable(); var getEmailFrequencyVernacular = function( emailFrequency ) { switch( emailFrequency ) { case "IMMEDIATELY": return "ತಕ್ಷಣ"; case "DAILY": return "ಪ್ರತಿನಿತ್ಯ"; case "WEEKLY": return "ವಾರಕ್ಕೊಮ್ಮೆ"; case "MONTHLY": return "ತಿಂಗಳಿಗೊಮ್ಮೆ"; case "NEVER": return "ಬೇಡ"; } }; this.updateNotificationPreferences = function() { var userPreferences = {}; userPreferences[ "emailFrequency" ] = document.querySelector( "#pratilipi-settings-email-frequency" ).getAttribute( "data-val" ); userPreferences[ "newsletterFrequency" ] = document.querySelector( "#pratilipi-settings-newsletter-frequency" ).getAttribute( "data-val" ); userPreferences[ "notificationSubscriptions" ] = {}; $( '#notification-settings .mdl-js-checkbox' ).each( function( index, element ) { userPreferences[ "notificationSubscriptions" ][ element.firstChild.value ] = element.firstChild.checked; if (appViewModel.userPreferences()["notificationSubscriptions"] && appViewModel.userPreferences()["notificationSubscriptions"][element.firstChild.value] == element.firstChild.checked) { return; } if (element.firstChild.checked) { switch (element.firstChild.value) { case 'COMMENT_REVIEW_REVIEWER': self.triggerFacebookEvent('NOTIFY_COMMENTS_SETNGNOTIFY'); break; case 'AUTHOR_FOLLOW': self.triggerFacebookEvent('NOTIFY_FOLLOWERS_SETNGNOTIFY'); break; case 'VOTE_COMMENT_REVIEW_COMMENTOR': self.triggerFacebookEvent('NOTIFY_LIKECOMMENT_SETNGNOTIFY'); break; case 'VOTE_REVIEW_REVIEWER': self.triggerFacebookEvent('NOTIFY_LIKEREVIEW_SETNGNOTIFY'); break; case 'GENERIC': self.triggerFacebookEvent('NOTIFY_PROMOTIONAL_SETNGNOTIFY'); break; case 'PRATILIPI_PUBLISHED_FOLLOWER': self.triggerFacebookEvent('NOTIFY_PUBLISHED_SETNGNOTIFY'); break; case 'USER_PRATILIPI_REVIEW': self.triggerFacebookEvent('NOTIFY_REVIEWS_SETNGNOTIFY'); break; default: console.log('EVENT NOT ADDED!'); break; } } else { switch (element.firstChild.value) { case 'COMMENT_REVIEW_REVIEWER': self.triggerFacebookEvent('DND_COMMENTS_SETNGNOTIFY'); break; case 'AUTHOR_FOLLOW': self.triggerFacebookEvent('DND_FOLLOWERS_SETNGNOTIFY'); break; case 'VOTE_COMMENT_REVIEW_COMMENTOR': self.triggerFacebookEvent('DND_LIKECOMMENT_SETNGNOTIFY'); break; case 'VOTE_REVIEW_REVIEWER': self.triggerFacebookEvent('DND_LIKEREVIEW_SETNGNOTIFY'); break; case 'GENERIC': self.triggerFacebookEvent('DND_PROMOTIONAL_SETNGNOTIFY'); break; case 'PRATILIPI_PUBLISHED_FOLLOWER': self.triggerFacebookEvent('DND_PUBLISHED_SETNGNOTIFY'); break; case 'USER_PRATILIPI_REVIEW': self.triggerFacebookEvent('DND_REVIEWS_SETNGNOTIFY'); break; default: console.log('EVENT NOT ADDED!'); break; } } }); /* Analytics Event for emailFrequency */ if (userPreferences['emailFrequency'] === "NEVER" && appViewModel.userPreferences()["emailFrequency"] != "NEVER") { self.triggerFacebookEvent('DND_EMAILFREQ_SETNGNOTIFY'); } else if (appViewModel.userPreferences()["emailFrequency"] != userPreferences['emailFrequency']) { self.triggerFacebookEvent('NOTIFY_EMAILFREQ_SETNGNOTIFY', userPreferences['emailFrequency']); } /* Analytics Event for newsletterFrequency */ if (userPreferences['newsletterFrequency'] === "NEVER" && appViewModel.userPreferences()["newsletterFrequency"] != "NEVER") { self.triggerFacebookEvent('DND_NEWSLETTERFREQ_SETNGNOTIFY'); } else if (appViewModel.userPreferences()["newsletterFrequency"] != userPreferences['newsletterFrequency']) { self.triggerFacebookEvent('NOTIFY_NEWSLETTERFREQ_SETNGNOTIFY', userPreferences['newsletterFrequency']); } /* Updating preferences in firebase => Refer app.js for this function */ setUserPreferences( userPreferences ); ToastUtil.toast( "ಯಶಸ್ವಿ!" ); }; this.firebaseCallback = ko.computed( function() { var userPreferences = appViewModel.userPreferences(); setTimeout( function() { self.emailFrequency( userPreferences[ "emailFrequency" ] != null ? userPreferences[ "emailFrequency" ] : "IMMEDIATELY" ); $( "#pratilipi-settings-email-frequency" ).attr( 'data-val', self.emailFrequency() ); $( "#pratilipi-settings-email-frequency" ).attr( 'value', getEmailFrequencyVernacular( self.emailFrequency() ) ); originalEmailFrequency = self.emailFrequency(); self.newsletterFrequency( userPreferences[ "newsletterFrequency" ] != null ? userPreferences[ "newsletterFrequency" ] : "DAILY" ); $( "#pratilipi-settings-newsletter-frequency" ).attr( 'data-val', self.newsletterFrequency() ); $( "#pratilipi-settings-newsletter-frequency" ).attr( 'value', getEmailFrequencyVernacular( self.newsletterFrequency() ) ); originalNewsletterFrequency = self.newsletterFrequency(); var notificationSubscriptions = userPreferences[ "notificationSubscriptions" ] != null ? userPreferences[ "notificationSubscriptions" ] : {}; $( '#notification-settings .mdl-js-checkbox' ).each( function( index, element ) { if( element.MaterialCheckbox == null ) return; var val = element.firstChild.value; if( notificationSubscriptions[ val ] == null ) notificationSubscriptions[ val ] = true; notificationSubscriptions[ val ] ? element.MaterialCheckbox.check() : element.MaterialCheckbox.uncheck(); }); originalNotificationSubscriptions = notificationSubscriptions; }, 0 ); }, this ); this.randomVariable = ko.observable( 0 ); /* Hack: To execute computed */ $( '#notification-settings .mdl-js-checkbox' ).click( function() { self.randomVariable( self.randomVariable() + 1 ); } ); this.canSaveNotificationSettings = ko.computed( function() { self.randomVariable(); self.emailFrequency(); self.newsletterFrequency(); if( originalNotificationSubscriptions == null ) return; var canSave = false; $( '#notification-settings .mdl-js-checkbox' ).each( function( index, element ) { if( originalNotificationSubscriptions[ element.firstChild.value ] != element.firstChild.checked ) { canSave = true; return; } }); return canSave || self.emailFrequency() != originalEmailFrequency || self.newsletterFrequency() != originalNewsletterFrequency; }, this ); this.updateEmailFrequency = function() { self.emailFrequency( $( "#pratilipi-settings-email-frequency" ).attr( "data-val" ) ); }; this.updateNewsletterFrequency = function() { self.newsletterFrequency( $( "#pratilipi-settings-newsletter-frequency" ).attr( "data-val" ) ); }; /* PASSWORD SETTINGS */ this.currentPassword = ko.observable(); this.newPassword = ko.observable(); this.confirmPassword = ko.observable(); this.updatePassword = function() { if( self.newPassword() != self.confirmPassword() ) { ToastUtil.toast( "Passwords doesn't match!" ); return; } if( self.isLoading() ) return; self.isLoading( true ); ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); dataAccessor.updateUserPassword( self.currentPassword(), self.newPassword(), function( user ) { self.currentPassword( null ); self.newPassword( null ); self.confirmPassword( null ); self.isLoading( false ); ToastUtil.toast( "ಯಶಸ್ವಿ!" ); self.triggerFacebookEvent('RESETPASSWORD_PASSWORD_SETNGPRI'); }, function( error ) { self.isLoading( false ); var message = "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!"; if( error[ "password" ] != null ) message = error[ "password" ]; if( error[ "newPassword" ] != null ) message = error[ "newPassword" ]; if( error[ "message" ] != null ) message = error[ "message" ]; ToastUtil.toast( message ); }); }; this.canUpdatePassword = ko.computed( function() { return self.currentPassword() != null && self.currentPassword() != "" && self.newPassword() != null && self.newPassword() != "" && self.confirmPassword() != null && self.confirmPassword() != "" && ! self.isLoading(); }, this ); /* LOGOUT */ this.logoutUser = function() { if( self.isLoading() ) return; self.isLoading( true ); ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); if( appViewModel.isTestEnvironment ) { dataAccessor.logoutUserV2( function( user ) { self.triggerFacebookEvent('LOGOUT_SETTINGSM_SETTINGS'); ToastUtil.toastUp( "ಯಶಸ್ವಿ!" ); logoutFirebase(function() { window.location.href = "/"; }); }, function( error ) { self.isLoading( false ); ToastUtil.toast( error[ "message" ] != null ? error[ "message" ] : "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!" ); }); } else { dataAccessor.logoutUser( function( user ) { self.triggerFacebookEvent('LOGOUT_SETTINGSM_SETTINGS'); ToastUtil.toastUp( "ಯಶಸ್ವಿ!" ); logoutFirebase(function() { window.location.href = "/"; }); }, function( error ) { self.isLoading( false ); ToastUtil.toast( error[ "message" ] != null ? error[ "message" ] : "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!" ); }); } }; /* Helpers */ var alignRightPane = function() { var element = $( ".js-tabs-right-pane" ); var width = element.width() - parseInt( element.css( "margin-left" ) ) - parseInt( element.css( "margin-right" ) ); $( '.js-width-50' ).css( 'width', ( width / 2 ) > 300 ? '50%' : '100%' ); }; $( window ).resize( function() { alignRightPane(); }); this.tabTitle = ko.observable(); var setTabTitle = function() { setTimeout( function() { $( ".mdl-tabs__panel" ).each( function( index, element ) { if( $( element ).hasClass( "is-active" ) ) self.tabTitle( $( element ).attr( 'data-name' ) ); }); }, 0 ); }; $( ".mdl-tabs__tab" ).on( 'click', function() { setTabTitle(); }); $( document ).ready( function() { alignRightPane(); setTabTitle(); }); /* Location Observer */ this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.SETTINGS.ko_element ) { /* Dispose all observers */ self.canSaveProfileSettings.dispose(); self.userObserver.dispose(); self.firebaseCallback.dispose(); self.canSaveNotificationSettings.dispose(); self.canUpdatePassword.dispose(); self.locationObserver.dispose(); return; } setTimeout( function() { getmdlSelect.init( ".getmdl-select" ); }, 0 ); }, this ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName, value) { switch (eventName) { case 'UPDATEUSERINFO_CONTENTLANG_SETNGACC': case 'NEWUSERINFO_DOB_SETNGACC': case 'UPDATEUSERINFO_DOB_SETNGACC': case 'NEWUSERINFO_EMAIL_SETNGACC': case 'UPDATEUSERINFO_EMAIL_SETNGACC': case 'NEWUSERINFO_FNAME_SETNGACC': case 'UPDATEUSERINFO_FNAME_SETNGACC': case 'NEWUSERINFO_FNAMEENG_SETNGACC': case 'UPDATEUSERINFO_FNAMEENG_SETNGACC': case 'NEWUSERINFO_GENDER_SETNGACC': case 'UPDATEUSERINFO_GENDER_SETNGACC': case 'NEWUSERINFO_LNAME_SETNGACC': case 'UPDATEUSERINFO_LNAME_SETNGACC': case 'NEWUSERINFO_LNAMEENG_SETNGACC': case 'UPDATEUSERINFO_LNAMEENG_SETNGACC': case 'NEWUSERINFO_PENNAME_SETNGACC': case 'UPDATEUSERINFO_PENNAME_SETNGACC': case 'NEWUSERINFO_PHONE_SETNGACC': case 'UPDATEUSERINFO_PHONE_SETNGACC': case 'NEWUSERINFO_USERBIO_SETNGACC': case 'UPDATEUSERINFO_USERBIO_SETNGACC': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; case 'DND_COMMENTS_SETNGNOTIFY': case 'NOTIFY_COMMENTS_SETNGNOTIFY': case 'DND_FOLLOWERS_SETNGNOTIFY': case 'NOTIFY_FOLLOWERS_SETNGNOTIFY': case 'DND_LIKECOMMENT_SETNGNOTIFY': case 'NOTIFY_LIKECOMMENT_SETNGNOTIFY': case 'DND_LIKEREVIEW_SETNGNOTIFY': case 'NOTIFY_LIKEREVIEW_SETNGNOTIFY': case 'DND_PROMOTIONAL_SETNGNOTIFY': case 'NOTIFY_PROMOTIONAL_SETNGNOTIFY': case 'DND_PUBLISHED_SETNGNOTIFY': case 'NOTIFY_PUBLISHED_SETNGNOTIFY': case 'DND_REVIEWS_SETNGNOTIFY': case 'NOTIFY_REVIEWS_SETNGNOTIFY': case 'DND_EMAILFREQ_SETNGNOTIFY': case 'DND_NEWSLETTERFREQ_SETNGNOTIFY': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; case 'NOTIFY_EMAILFREQ_SETNGNOTIFY': case 'NOTIFY_NEWSLETTERFREQ_SETNGNOTIFY': FacebookEventTriggerUtil.triggerFacebookEventByNameAndValue(eventName, value); break; case 'RESETPASSWORD_PASSWORD_SETNGPRI': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; case 'GOSETNGACC_SETTINGSM_SETTINGS': case 'GOSETNGNOTIFY_SETTINGSM_SETTINGS': case 'GOSETNGSEC_SETTINGSM_SETTINGS': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; case 'LANDED_SETTINGSM_SETTINGS': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; case 'LOGOUT_SETTINGSM_SETTINGS': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.triggerSettingAccGoEvent = function() { self.triggerFacebookEvent('GOSETNGACC_SETTINGSM_SETTINGS'); return true; }; this.triggerSettingNotifyGoEvent = function() { self.triggerFacebookEvent('GOSETNGNOTIFY_SETTINGSM_SETTINGS'); return true; }; this.triggerSettingSecGoEvent = function() { self.triggerFacebookEvent('GOSETNGSEC_SETTINGSM_SETTINGS'); return true; }; self.triggerFacebookEvent('LANDED_SETTINGSM_SETTINGS'); } , template: `<div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col pratilipi-settings-page"><div class="mdl-tabs vertical-mdl-tabs mdl-js-tabs mdl-js-ripple-effect mdl-card-border"><div class="tabs-mobile-bar"><span class="material-subtitle-1" data-bind="text: tabTitle()"></span><div class="pull-right"><button id="pratilipi-settings-mobile-icon"class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">menu</i></button><ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect"for="pratilipi-settings-mobile-icon"><li class="mdl-menu__item"><a onclick="ga_CA( 'User', 'Profile' )"href="#profile-settings" data-bind="click: triggerSettingAccGoEvent" class="mdl-tabs__tab is-active"><span>ಪ್ರೊಫೈಲ್ ಸೆಟ್ಟಿಂಗ್ಸ್</span></a></li><li class="mdl-menu__item" data-bind="visible: !isAdmin"><a onclick="ga_CA( 'User', 'Notification' )" data-bind="click: triggerSettingNotifyGoEvent"href="#notification-settings" class="mdl-tabs__tab"><span>ನೋಟಿಫಿಕೇಶನ್ ಸೆಟ್ಟಿಂಗ್ಸ್</span></a></li><li class="mdl-menu__item" data-bind="visible: !isAdmin"><a onclick="ga_CA( 'User', 'Password' )"href="#password-settings" data-bind="click: triggerSettingSecGoEvent" class="mdl-tabs__tab"><span>ಅಪ್ಡೇಟ್ ಪಾಸ್ವರ್ಡ್</span></a></li><li class="mdl-menu__item" data-bind="visible: !isAdmin"><a onclick="ga_CA( 'User', 'Logout' )"data-bind="click: logoutUser" class="mdl-tabs__tab clickable-element"><span>ಸೈನ್ ಔಟ್</span></a></li></ul></div></div><div class="mdl-grid mdl-grid--no-spacing settings-grid"><div class="tabs-left-pane"><div class="mdl-tabs__tab-bar"><a onclick="ga_CA( 'User', 'Profile' )"href="#profile-settings" data-bind="click: triggerSettingAccGoEvent" class="mdl-tabs__tab is-active"><span>ಪ್ರೊಫೈಲ್ ಸೆಟ್ಟಿಂಗ್ಸ್</span></a><a onclick="ga_CA( 'User', 'Notification' )"href="#notification-settings" data-bind="click: triggerSettingNotifyGoEvent" class="mdl-tabs__tab" data-bind="visible: !isAdmin"><span>ನೋಟಿಫಿಕೇಶನ್ ಸೆಟ್ಟಿಂಗ್ಸ್</span></a><a onclick="ga_CA( 'User', 'Password' )"href="#password-settings" data-bind="click: triggerSettingSecGoEvent" class="mdl-tabs__tab" data-bind="visible: !isAdmin"><span>ಅಪ್ಡೇಟ್ ಪಾಸ್ವರ್ಡ್</span></a><a onclick="ga_CA( 'User', 'Logout' )"data-bind="click: logoutUser, visible: !isAdmin" class="mdl-tabs__tab clickable-element"><span>ಸೈನ್ ಔಟ್</span></a></div></div><div class="tabs-right-pane js-tabs-right-pane"><div class="mdl-tabs__panel is-active" data-name="ಪ್ರೊಫೈಲ್ ಸೆಟ್ಟಿಂಗ್ಸ್" id="profile-settings"><div class="width-50 js-width-50 text-center"><input data-bind="{ mdlFloatingInput: { label: 'ಮೊದಲ ಹೆಸರು (ಕನ್ನಡದಲ್ಲಿ) *', value: firstName, id: 'pratilipi-settings-first-name' }, valueUpdate: ['input'], transliterate: true }" /></div><div class="width-50 js-width-50 text-center"><input data-bind="{ mdlFloatingInput: { label: 'ಕೊನೆಯ ಹೆಸರು (ಕನ್ನಡದಲ್ಲಿ)', value: lastName, id: 'pratilipi-settings-last-name' }, valueUpdate: ['input'], transliterate: true }" /></div><div class="width-50 js-width-50 text-center"><input data-bind="{ mdlFloatingInput: { label: 'ಮೊದಲ ಹೆಸರು (ಆಂಗ್ಲ ಭಾಷೆಯಲ್ಲಿ)', value: firstNameEn, id: 'pratilipi-settings-first-name-en' }, valueUpdate: ['input'] }" /></div><div class="width-50 js-width-50 text-center"><input data-bind="{ mdlFloatingInput: { label: 'ಕೊನೆಯ ಹೆಸರು (ಆಂಗ್ಲ ಭಾಷೆಯಲ್ಲಿ)', value: lastNameEn, id: 'pratilipi-settings-last-name-en' }, valueUpdate: ['input'] }" /></div><div class="width-50 js-width-50 text-center"><input data-bind="{ mdlFloatingInput: { label: 'ಕಾವ್ಯನಾಮ (ಕನ್ನಡದಲ್ಲಿ)', value: penName, id: 'pratilipi-settings-pen-name' }, valueUpdate: ['input'], transliterate: true }" /></div><div class="width-50 js-width-50 text-center"><div class="mdl-textfield mdl-js-textfield getmdl-select getmdl-select__fullwidth getmdl-select__fix-height mdl-textfield--floating-label"><input data-bind="event: { change: updateLanguage }"class="mdl-textfield__input"id="pratilipi-settings-language"type="text" readonly /><label style="top: 4px; font-size: 12px; visibility: visible;"class="mdl-textfield__label" for="pratilipi-settings-language">ಭಾಷೆ ಆಯ್ಕೆ ಮಾಡಿಕೊಳ್ಳಿ *<i class="material-icons dropdown-icon">arrow_drop_down</i></label><ul class="mdl-menu mdl-menu--bottom-left mdl-js-menu dropdown-ul" for="pratilipi-settings-language"><li class="mdl-menu__item" data-val="HINDI">हिंदी</li><li class="mdl-menu__item" data-val="GUJARATI">ગુજરાતી</li><li class="mdl-menu__item" data-val="TAMIL">தமிழ்</li><li class="mdl-menu__item" data-val="MARATHI">मराठी</li><li class="mdl-menu__item" data-val="MALAYALAM">മലയാളം</li><li class="mdl-menu__item" data-val="BENGALI">বাংলা</li><li class="mdl-menu__item" data-val="TELUGU">తెలుగు</li><li class="mdl-menu__item" data-val="KANNADA">ಕನ್ನಡ</li></ul></div></div><div class="summary-holder"><textarea data-bind="{ mdlFloatingInput: { label: 'ಸಾರಾಂಶ (ಐಚ್ಛಿಕ)', value: summary, id: 'pratilipi-settings-summary' }, valueUpdate: ['input'], transliterate: true }" rows= "3"></textarea></div><div class="private-information"><div class="material-title">Private Information</div><div class="width-50 js-width-50 text-center"><input type="email" data-bind="{ mdlFloatingInput: { label: 'ಇ-ಮೇಲ್', value: email, id: 'pratilipi-settings-email' }, valueUpdate: ['input'] }" /></div><div class="width-50 js-width-50 text-center"><input type="number" data-bind="{ mdlFloatingInput: { label: 'ಫೋನ್', value: phone, id: 'pratilipi-settings-phone' }, valueUpdate: ['input'] }" /></div><div class="width-50 js-width-50 text-center"><div class="mdl-textfield mdl-js-textfield getmdl-select getmdl-select__fullwidth getmdl-select__fix-height mdl-textfield--floating-label"><input data-bind="event: { change: updateGender }"class="mdl-textfield__input"id="pratilipi-settings-gender"type="text" readonly /><label style="top: 4px; font-size: 12px; visibility: visible;"class="mdl-textfield__label" for="pratilipi-settings-gender">ಲಿಂಗ<i class="material-icons dropdown-icon">arrow_drop_down</i></label><ul class="mdl-menu mdl-menu--bottom-left mdl-js-menu dropdown-ul" for="pratilipi-settings-gender"><li class="mdl-menu__item" data-val="MALE">ಪುರುಷ</li><li class="mdl-menu__item" data-val="FEMALE">ಮಹಿಳೆ</li><li class="mdl-menu__item" data-val="OTHER">ಇತರೆ</li></ul></div></div><div class="width-50 js-width-50 text-center"><div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label"><input data-bind="value: dateOfBirth, valueUpdate: ['input']"type="date"class="mdl-textfield__input"id="pratilipi-settings-dateOfBirth"><label style="top: 4px; font-size: 12px; visibility: visible;"class="mdl-textfield__label" for="pratilipi-settings-dateOfBirth">ಜನ್ಮ ದಿನಾಂಕ</label></div></div></div><div class="save-button-holder"><button onclick="ga_CA( 'User', 'SubmitProfile' )"data-bind="enable: canSaveProfileSettings(), click: updateProfileSettings"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect">ಬದಲಾವಣೆಗಳನ್ನು ಸಂರಕ್ಷಿಸಿ</button></div></div><div class="mdl-tabs__panel" data-name="ನೋಟಿಫಿಕೇಶನ್ ಸೆಟ್ಟಿಂಗ್ಸ್" id="notification-settings"><div class="mdl-textfield mdl-js-textfield getmdl-select getmdl-select__fullwidth getmdl-select__fix-height mdl-textfield--floating-label"><input class="mdl-textfield__input"id="pratilipi-settings-email-frequency"data-bind="event: { change: updateEmailFrequency }"data-val="IMMEDIATELY"value="ತಕ್ಷಣ"type="text" tabIndex="-1" /><label class="mdl-textfield__label" for="pratilipi-settings-email-frequency">ಇಮೇಲ್ ಫ್ರೀಕ್ವೆನ್ಸಿ<i class="material-icons dropdown-icon">arrow_drop_down</i></label><ul class="mdl-menu mdl-menu--bottom-left mdl-js-menu dropdown-ul" for="pratilipi-settings-email-frequency"><li class="mdl-menu__item" data-val="IMMEDIATELY">ತಕ್ಷಣ</li><li class="mdl-menu__item" data-val="DAILY">ಪ್ರತಿನಿತ್ಯ</li><li class="mdl-menu__item" data-val="WEEKLY">ವಾರಕ್ಕೊಮ್ಮೆ</li><li class="mdl-menu__item" data-val="MONTHLY">ತಿಂಗಳಿಗೊಮ್ಮೆ</li><li class="mdl-menu__item" data-val="NEVER">ಬೇಡ</li></ul></div><div class="mdl-textfield mdl-js-textfield getmdl-select getmdl-select__fullwidth getmdl-select__fix-height mdl-textfield--floating-label"><input class="mdl-textfield__input"id="pratilipi-settings-newsletter-frequency"data-bind="event: { change: updateNewsletterFrequency }"data-val="DAILY"value="ಪ್ರತಿನಿತ್ಯ"type="text" tabIndex="-1" /><label class="mdl-textfield__label" for="pratilipi-settings-newsletter-frequency">Newsletter Frequency<i class="material-icons dropdown-icon">arrow_drop_down</i></label><ul class="mdl-menu mdl-menu--bottom-left mdl-js-menu dropdown-ul" for="pratilipi-settings-newsletter-frequency"><li class="mdl-menu__item" data-val="DAILY">ಪ್ರತಿನಿತ್ಯ</li><!-- <li class="mdl-menu__item" data-val="WEEKLY">ವಾರಕ್ಕೊಮ್ಮೆ</li> --><li class="mdl-menu__item" data-val="NEVER">ಬೇಡ</li></ul></div><div class="settings-group"><div class="material-title group-title">ಬರಹ</div><div class="width-50 js-width-50"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_new_review"><input value="USER_PRATILIPI_REVIEW" type="checkbox" id="notif_option_new_review" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">ಹೊಸ ಪ್ರತಿಕ್ರಿಯೆ</span></label></div><div class="width-50 js-width-50"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_new_comment"><input value="COMMENT_REVIEW_REVIEWER" type="checkbox" id="notif_option_new_comment" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">ಹೊಸ ಕಾಮೆಂಟ್</span></label></div><div class="width-50 js-width-50"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_like_review"><input value="VOTE_REVIEW_REVIEWER" type="checkbox" id="notif_option_like_review" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">ಪ್ರತಿಕ್ರಿಯೆಯ ಮೆಚ್ಚುಗೆ</span></label></div><div class="width-50 js-width-50"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_like_comment"><input value="VOTE_COMMENT_REVIEW_COMMENTOR" type="checkbox" id="notif_option_like_comment" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">ಕಾಮೆಂಟಿಗೆ ಹೊಸ ಮೆಚ್ಚುಗೆ</span></label></div></div><div class="settings-group"><div class="material-title group-title">ನೆಟ್ವರ್ಕ್</div><div class="width-50 js-width-50"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_new_follower"><input value="AUTHOR_FOLLOW" type="checkbox" id="notif_option_new_follower" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">ಹೊಸ ಹಿಂಬಾಲಕರು</span></label></div><div class="width-50 js-width-50"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_pratilipi_published_follower"><input value="PRATILIPI_PUBLISHED_FOLLOWER" type="checkbox" id="notif_option_pratilipi_published_follower" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">ನೀವು ಹಿಂಬಾಲಿಸುತ್ತಿರುವ ವ್ಯಕ್ತಿಯ ಹೊಸ ಬರಹ</span></label></div><div class="width-50 js-width-50"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_pratilipi_updates"><input value="GENERIC" type="checkbox" id="notif_option_pratilipi_updates" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">ಪ್ರತಿಲಿಪಿ ಅಪ್ಡೇಟ್ಸ್ ಮತ್ತು ಆಫರ್ಸ್</span></label></div></div><div class="save-button-holder"><button onclick="ga_CA( 'User', 'SubmitNotification' )"data-bind="click: updateNotificationPreferences, enable: canSaveNotificationSettings()"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect">ಬದಲಾವಣೆಗಳನ್ನು ಸಂರಕ್ಷಿಸಿ</button></div></div><div class="mdl-tabs__panel" data-name="ಅಪ್ಡೇಟ್ ಪಾಸ್ವರ್ಡ್" id="password-settings"><div class="mdl-cell mdl-cell--12-col"><input type="password" data-bind="{ mdlFloatingInput: { label: 'ಈಗಿನ ಪಾಸ್ವರ್ಡ್ *', value: currentPassword, id: 'pratilipi-settings-current-password' }, valueUpdate: ['input'] }" /></div><div class="mdl-cell mdl-cell--12-col"><input type="password" data-bind="{ mdlFloatingInput: { label: 'ಹೊಸ ಪಾಸ್ವರ್ಡ್ *', value: newPassword, id: 'pratilipi-settings-new-password' }, valueUpdate: ['input'] }" /></div><div class="mdl-cell mdl-cell--12-col"><input type="password" data-bind="{ mdlFloatingInput: { label: 'ಪಾಸ್ವರ್ಡ್ ಖಚಿತಪಡಿಸಿ *', value: confirmPassword, id: 'pratilipi-settings-confirm-password' }, valueUpdate: ['input'] }" /></div><div class="save-button-holder"><button onclick="ga_CA( 'User', 'SubmitPassword' )"data-bind="enable: canUpdatePassword(), click: updatePassword"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect">ಬದಲಾವಣೆಗಳನ್ನು ಸಂರಕ್ಷಿಸಿ</button></div></div></div></div></div><div data-bind="visible: isLoading()"class="page-loading-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></div></div>` }); </script> <script> ko.components.register( 'pratilipi-pratilipi-info-cover', { viewModel: function ( params ) { var self = this; this.pratilipi = params.pratilipi; this.imageUploaded = params.imageUploaded; this.chooseImageFile = params.chooseImageFile; this.uploadPratilipiImage = params.uploadPratilipiImage; this.iframeLoaded = params.iframeLoaded; this.userPratilipi = params.userPratilipi; this.addToLibrary = params.addToLibrary; this.userPratilipiRequestOnFlight = params.userPratilipiRequestOnFlight; this.canAddToLibrary = params.canAddToLibrary; this.togglePratilipiState = params.togglePratilipiState; this.triggerEditBookEvent = params.triggerEditBookEvent; this.canDelete = params.canDelete; this.openDeletePratilipiDialog = params.openDeletePratilipiDialog; this.pratilipiRequestOnFlight = params.pratilipiRequestOnFlight; this.canShare = params.canShare; this.share = params.share; this.triggerReadBookEvent = params.triggerReadBookEvent; this.getRatingInTermsOfFive = function (rating) { return Math.floor(rating * 2) * 10; }; /** * Facebook events */ } , template: `<!-- ko if: ( (getCookie('bucketId') ? parseInt( getCookie('bucketId') ) : null) >= 5 && (getCookie('bucketId') ? parseInt( getCookie('bucketId') ) : null) < 10 && isMobile() ) --><div class="pratilipi-book-design variation-3"><div class="story-type-flag"><span data-bind="text: getPratilipiTypeVernacular( pratilipi.type() )"></span></div><div class="share-btn"><button class="upload-image-button mdl-button mdl-js-button mdl-button--fab"style="position: relative; right: unset; bottom: unset; margin: 8px"onclick="ga_CA( 'Pratilipi', 'Share' )"data-bind="{ visible: canShare(), click: share }" ><i class="material-icons">share</i></button><!-- ko if: canShare() --><br><!-- /ko --><button id="edit-book-details"class="upload-image-button mdl-button mdl-js-button mdl-button--fab"data-bind="visible: pratilipi.hasAccessToUpdate() || canDelete()"style="position: relative; right: unset; bottom: unset; margin: 8px"><i class="material-icons">more_vert</i></button><ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect"for="edit-book-details"><a class="mdl-menu__item clickable-element"data-bind="visible: pratilipi.hasAccessToUpdate()"data-toggle="modal" data-target="#pratilipi_edit_pratilipi"href="#">ಶೀರ್ಷಿಕೆ ಎಡಿಟ್ ಮಾಡಿ</a><a class="mdl-menu__item clickable-element"data-bind="{ visible: pratilipi.hasAccessToUpdate() && pratilipi.state() == 'PUBLISHED',text: ( pratilipi.state() == 'PUBLISHED' ? 'ಅಪ್ರಕಟಿತಗೊಳಿಸಿ' : 'ಪ್ರಕಟಿಸಿ!' ),click: togglePratilipiState,disable: pratilipiRequestOnFlight }" ></a></ul></div><div class="book-main-image"><div class="pratilipi-cover-image spinner-container"><span class="image-uploaded-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div><div class="image-bg" data-bind="style: { 'background-image': 'url(' + getImageUrl( pratilipi.coverImageUrl() ) + ')' }"></div><button class="upload-image-button mdl-button mdl-js-button mdl-button--fab"data-bind="{ click: chooseImageFile,visible: pratilipi.hasAccessToUpdate() && ! imageUploaded() }"><i class="material-icons">camera_alt</i></button><form id="uploadPratilipiImageForm"style="position: absolute; top: -1000px;"method="post"enctype="multipart/form-data"data-bind="{ attr: { 'action': '/api/pratilipi/cover?pratilipiId=' + pratilipi.pratilipiId() }, uniqueName: true }"target="pratilipi_upload_target"><input id="uploadPratilipiImageInput"data-bind="{ event: { change: uploadPratilipiImage }, uniqueName: true }"type="file"accept="image/*"></form><iframe id="pratilipi_upload_target"name="pratilipi_upload_target"style="display: none;"data-bind="event: { load: iframeLoaded }"></iframe></div><div class="book-title"><span data-bind="text: pratilipi.title()"></span><!-- <button data-bind="visible: pratilipi.hasAccessToUpdate()"class="mdl-button mdl-js-button mdl-button--icon"data-toggle="modal" data-target="#pratilipi_edit_pratilipi"><i class="material-icons">create</i></button> --></div><div class="book-author-name"><a onclick="ga_CA( 'Author', 'Open' )"data-bind="attr: { href: pratilipi.author.pageUrl() },text: pratilipi.author.name()"></a></div><div class="stats"><div class="avg-rating" data-bind="css: {'stars-red': getRatingInTermsOfFive(pratilipi.averageRating()) > 0 && getRatingInTermsOfFive(pratilipi.averageRating()) <=20 ,'stars-orange': getRatingInTermsOfFive(pratilipi.averageRating()) > 20 && getRatingInTermsOfFive(pratilipi.averageRating()) < 60,'stars-green': getRatingInTermsOfFive(pratilipi.averageRating()) >= 60 && getRatingInTermsOfFive(pratilipi.averageRating()) <=100}, visible: pratilipi.averageRating() > 0"><span data-bind="text: roundOffToOneDecimal( pratilipi.averageRating() )" style="font-size: 12px;"></span><i class="material-icons">star_rate</i></div><div class="rewiew-count"><!--ko text: pratilipi.ratingCount() --><!--/ko--><span>ರೇಟಿಂಗ್ಸ್</span></div><div><div class="read-count">ಓದುಗರು:&nbsp; <!--ko text: formatReadCount( pratilipi.readCount() ) --><!--/ko--></div><div class="published-date">ಪ್ರಕಟಿತ ದಿನಾಂಕ:&nbsp;<!--ko text: convertDate( pratilipi.listingDateMillis() ) --><!--/ko--></div></div></div><!-- ko if: pratilipi.state() != 'PUBLISHED' --><div class="mdl-card__actions extra-actions" data-bind="visible: pratilipi.hasAccessToUpdate()"><button data-bind="{ visible: pratilipi.hasAccessToUpdate() && pratilipi.state() != 'PUBLISHED',text: ( pratilipi.state() == 'PUBLISHED' ? 'ಅಪ್ರಕಟಿತಗೊಳಿಸಿ' : 'ಪ್ರಕಟಿಸಿ!' ),click: togglePratilipiState,disable: pratilipiRequestOnFlight }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin"></button><button data-bind="{ visible: canDelete(),click: openDeletePratilipiDialog,disable: pratilipiRequestOnFlight }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin">ಡಿಲೀಟ್ ಮಾಡಿ</button></div><!--/ko--><div class="main-action-btns"><!-- ko if: canAddToLibrary() --><div class="add-to-lib"><a onclick="ga_CA( 'Pratilipi', 'Add To Library' )"data-bind="{ text: ( userPratilipi.addedToLib() ? '-' : '+' ) + ' ' + 'ಗ್ರಂಥಾಲಯ',click: addToLibrary,disable: userPratilipiRequestOnFlight,visible: canAddToLibrary() }"></a></div><!-- /ko --><div class="read-book" data-bind="style: { width: canAddToLibrary() ? '50%' : '100%' }"><a onclick="ga_CA( 'Pratilipi', 'Read' )"data-bind="{ attr: { href: pratilipi.readPageUrl() },text: pratilipi.state() == 'PUBLISHED' ? 'ಓದಿರಿ' : 'ಪ್ರಿವ್ಯೂ',click: triggerReadBookEvent }"></a></div></div></div><!-- /ko -->` }); </script> <script> ko.components.register( 'pratilipi-footer', { viewModel: function( params ) { var self = this; /** * Facebook events */ this.triggerFacebookEvent = function(eventName, value) { switch (eventName) { case 'GETANDROID_FOOTER_GLOBAL': case 'LIKEPRATFB_FOOTER_GLOBAL': case 'LIKEPRATGP_FOOTER_GLOBAL': case 'LIKEPRATLINKD_FOOTER_GLOBAL': case 'LIKEPRATTW_FOOTER_GLOBAL': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.triggerAndroidGetEvent = function() { self.triggerFacebookEvent('GETANDROID_FOOTER_GLOBAL'); return true; }; this.triggerSocialMediaLinkClickEvent = function(socialMedia) { switch (socialMedia) { case 'FACEBOOK': self.triggerFacebookEvent('LIKEPRATFB_FOOTER_GLOBAL'); break; case 'GOOGLEPLUS': self.triggerFacebookEvent('LIKEPRATGP_FOOTER_GLOBAL'); break; case 'LINKEDIN': self.triggerFacebookEvent('LIKEPRATLINKD_FOOTER_GLOBAL'); break; case 'TWITTER': self.triggerFacebookEvent('LIKEPRATTW_FOOTER_GLOBAL'); break; } return true; }; } , template: `<footer class="mdl-mega-footer font-s"><div class="mdl-mega-footer__middle-section"><div onclick="ga_CA( 'Footer', 'GPS App' )"class="mdl-mega-footer__drop-down-section"><input class="mdl-mega-footer__heading-checkbox" type="checkbox" unchecked><h1 class="mdl-mega-footer__heading">ಮೊಬೈಲ್ ಆ್ಯಪ್</h1><ul class="mdl-mega-footer__link-list"><li><a data-bind="click: triggerAndroidGetEvent" href="https://play.google.com/store/apps/details?id=com.pratilipi.mobile.android&utm_source=web_footer&utm_campaign=app_download"><div class="sprites-icon google-play-icon"></div></a></li></ul></div><div class="mdl-mega-footer__drop-down-section"><input class="mdl-mega-footer__heading-checkbox" type="checkbox" unchecked><h1 class="mdl-mega-footer__heading">ನಮ್ಮನ್ನು ಸಂಪರ್ಕಿಸಿ</h1><ul class="mdl-mega-footer__link-list" style="vertical-align: middle;"><li><a href="tel:9480165516"><i class="material-icons material-icons-16 vertical-middle">phone</i>9480165516</a></li><li><a href="mailto:kannada@pratilipi.com"><i class="material-icons material-icons-16 vertical-middle">mail</i> kannada@pratilipi.com</a></li></ul></div><div onclick="ga_CA( 'Footer', 'About Us' )"class="mdl-mega-footer__drop-down-section"><input class="mdl-mega-footer__heading-checkbox" type="checkbox" checked><h1 class="mdl-mega-footer__heading">ನಮ್ಮ ಬಗ್ಗೆ</h1><ul class="mdl-mega-footer__link-list"><li><a href="/about/pratilipi">ನಮ್ಮ ಬಗ್ಗೆ</a></li><li><a href="/work-with-us">ನಮ್ಮ ಜೊತೆ ಕಾರ್ಯ ನಿರ್ವಹಿಸಿ</a></li><li><a href="/privacy-policy">ಗೌಪ್ಯತಾ ನೀತಿ</a></li><li><a href="/terms-of-service">ನಿಯಮಗಳಿಗೆ</a></li></ul></div><div onclick="ga_CA( 'Footer', 'Company Social Media' )"class="mdl-mega-footer__drop-down-section"><input class="mdl-mega-footer__heading-checkbox" type="checkbox" checked><h1 class="mdl-mega-footer__heading">ನಮ್ಮನ್ನು ಸಾಮಾಜಿಕ ಜಾಲತಾಣಗಳಲ್ಲಿ ಹಿಂಬಾಲಿಸಿ</h1><ul class="mdl-mega-footer__link-list"><li><div class="sprites-icon footer-social-icons facebook-icon"></div><a data-bind="click: triggerSocialMediaLinkClickEvent.bind(this, 'FACEBOOK')" href="https://www.facebook.com/pratilipi.kannada">ಫೇಸ್ಬುಕ್</a></li><li><div class="sprites-icon footer-social-icons twitter-icon"></div><a data-bind="click: triggerSocialMediaLinkClickEvent.bind(this, 'TWITTER')" href="https://twitter.com/TeamPratilipi">ಟ್ವಿಟರ್</a></li><li><div class="sprites-icon footer-social-icons google-plus-icon"></div><a data-bind="click: triggerSocialMediaLinkClickEvent.bind(this, 'GOOGLEPLUS')" href="https://plus.google.com/+PratilipiTeam">ಗೂಗಲ್ ಪ್ಲಸ್</a></li><li><div class="sprites-icon footer-social-icons linkedin-icon"></div><a data-bind="click: triggerSocialMediaLinkClickEvent.bind(this, 'LINKEDIN')" href="https://www.linkedin.com/company/pratilipi">ಲಿಂಕ್ಡ್ ಇನ್</a></li></ul></div></div><div class="mdl-mega-footer__bottom-section"><div class="mdl-logo" data-bind="html: '&copy; ' + new Date().getFullYear() + ' Nasadiya Tech. Pvt. Ltd.'"></div></div></footer>` }); </script> <script> ko.components.register( 'pratilipi-rating-input', { viewModel: function( params ) { var self = this; /* Pass rating in parameter as an ko.observable */ this.rating = params.rating; this.setRating = function( rating ) { if( rating == null ) self.rating( 0 ); if( rating < 0 ) self.rating( 0 ); if( rating > 5 ) self.rating( 5 ); self.rating( rating ); ga_CA( 'Review', 'Star Rating' ); } } , template: `<!-- ko foreach: ko.utils.range( 1, rating() ) --><i class="material-icons material-icons-36 pratilipi-red clickable-element" data-bind="click: $parent.setRating.bind($data, $data)">star</i><!-- /ko --><!-- ko foreach: ko.utils.range( 1, 5 - rating() ) --><i class="material-icons material-icons-36 clickable-element" data-bind="click: $parent.setRating.bind($data, $data + $parent.rating() )">star_border</i><!-- /ko -->` }); </script> <script> ko.components.register( 'pratilipi-android-strip', { viewModel: function( params ) { var self = this; var showBanner = getCookie( "USER_NOTIFIED_APP_LAUNCHED" ) == null || getCookie( "USER_NOTIFIED_APP_LAUNCHED" ) == "true"; var click_count = getCookie( "APP_LAUNCHED_CLICKED" ) == null ? 0 : parseInt( getCookie( "APP_LAUNCHED_CLICKED" ) ); var cross_count = getCookie( "APP_LAUNCHED_CROSSED" ) == null ? 0 : parseInt( getCookie( "APP_LAUNCHED_CROSSED" ) ); /** * Facebook events */ this.triggerFacebookEvent = function(eventName, value) { switch (eventName) { case 'DISMISS_APPBANNER_GLOBAL': case 'GETANDROID_APPBANNER_GLOBAL': case 'VIEWED_APPBANNER_GLOBAL': FacebookEventTriggerUtil.triggerFacebookEventByName(eventName); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.stripVisible = ko.observable( showBanner ); if( self.stripVisible() ) { ga_CA( 'app_download_strip', 'app_strip_show' ); self.triggerFacebookEvent('VIEWED_APPBANNER_GLOBAL'); }; this.execLogic = function() { if( click_count >= 3 ) { setCookie( "USER_NOTIFIED_APP_LAUNCHED", false, 365, "/" ); return; } if( click_count > 0 && click_count < 3 ) { if( cross_count > 2 ) cross_count = 0; if( cross_count == 0 ) setCookie( "USER_NOTIFIED_APP_LAUNCHED", false, 3, "/" ); if( cross_count == 1 ) setCookie( "USER_NOTIFIED_APP_LAUNCHED", false, 7, "/" ); if( cross_count == 2 ) setCookie( "USER_NOTIFIED_APP_LAUNCHED", false, 30, "/" ); } else { if( cross_count < 3 ) setCookie( "USER_NOTIFIED_APP_LAUNCHED", false, null, "/" ); if( cross_count >= 3 && cross_count < 6) setCookie( "USER_NOTIFIED_APP_LAUNCHED", false, 2, "/" ); if( cross_count >= 6 ) setCookie( "USER_NOTIFIED_APP_LAUNCHED", false, 7, "/" ); } setCookie( "APP_LAUNCHED_CLICKED", click_count, 365, "/" ); setCookie( "APP_LAUNCHED_CROSSED", cross_count, 365, "/" ); }; this.androidBannerCrossed = function() { cross_count++; self.execLogic(); ga_CA( 'app_download_strip', 'app_strip_close' ); self.triggerFacebookEvent('DISMISS_APPBANNER_GLOBAL'); self.stripVisible( false ); return false; }; this.androidBannerClicked = function() { click_count++; self.execLogic(); self.stripVisible( false ); self.triggerFacebookEvent('GETANDROID_APPBANNER_GLOBAL'); ga_CA( 'app_download_strip', 'app_strip_click' ); var newtab = window.open( '', '_blank' ); newtab.location = "https://play.google.com/store/apps/details?id=com.pratilipi.mobile.android&referrer=utm_source%3Dpratilipi_main_web%26utm_medium%3Dweb_bottom_strip%26utm_campaign%3Dapp_download"; return false; }; this.stripVisibleObserver = ko.computed( function() { self.stripVisible(); setTimeout( function() { var pratilipiHeader = $( ".js-pratilipi-header" ); if( pratilipiHeader == null ) return; if( ! self.stripVisible() ) { pratilipiHeader.css( "margin-top", 0 ); return; } var androidStrip = $( ".js-pratilipi-android-strip" ); pratilipiHeader.css( "margin-top", ( androidStrip.height() + parseInt( androidStrip.css( "padding-top" ) ) + parseInt( androidStrip.css( "padding-bottom" ) ) ) + "px" ); }, 0); }, this ); } , template: `<div class="pratilipi-android-strip js-pratilipi-android-strip" data-bind="visible: stripVisible()"><i data-bind="click: androidBannerCrossed" class="material-icons pull-right clickable-element">close</i><div class="flex-container"><a data-bind="click: androidBannerClicked"><span class="sprites-icon pratilipi-logo-icon"></span></a><span class="app-info"><a data-bind="click: androidBannerClicked" class="app-heading"><span class="material-title">ಪ್ರತಿಲಿಪಿ ಆ್ಯoಡ್ರಾಯ್ಡ್ ಆ್ಯಪ್</span></a><img class="rating-image"src="http://public.pratilipi.com/images/Stars-for-App-Install-Strip.png"></span></div><div class="material-body-2 supporting-text">ನಿಮ್ಮ ನೆಚ್ಚಿನ ಕಥೆಗಳನ್ನು ಓದಿ</div><a data-bind="click: androidBannerClicked" class="download-button font-m">ಡೌನ್ಲೋಡ್ ಮಾಡಿ</a></div>` }); </script> <script> ko.components.register( 'pratilipi-tags', { viewModel: function(params) { /*Google analytic event Labels*/ var CATEGORY_TAGS_LABEL = "Category Tags"; /* when tags are clicked */ var CATEGORY_SUBMIT_LABEL = "Category Submit"; /* when submit button is clicked */ var CONTENT_CATEGORY_LABEL = "PP - Content Category"; /* when pratilipi type is changed on pratilipi page(PP) */ var TOOLTIP_LABEL = "g_category_tip"; /*Google analytic event actions*/ var SELECT_CATEGORY_ACTION = "Select Category"; /* when predefined tag is selected */ var DESELECT_CATEGORY_ACTION = "DeSelect Category"; /* when predefined tag is unselected */ var SELECT_USER_TAG_ACTION = "Select User Tag"; /* when user suggested tag is selected (Add button is clicked) */ var DESELECT_USER_TAG_ACTION = "DeSelect User Tag"; /* when user suggested tag is unselected */ var ASSIGN_CATEGORIES_TAGS_ACTION = "Assign Categories - Tags"; /* when both predefined tags and user tags are added(for 1st time) */ var ASSIGN_CATEGORIES_ACTION = "Assign Categories Only"; /* when predefined tags are added(for 1st time) */ var ASSIGN_TAGS_ACTION = "Assign Tags Only"; /* when user tags are added(for 1st time) */ var UPDATE_CATEGORIES_TAGS_ACTION = "Update Categories - Tags"; /* when both predefined tags and user tags are updated */ var UPDATE_CATEGORIES_ACTION = "Update Categories Only"; /* when predefined tags are updated */ var UPDATE_TAGS_ACTION = "Update Tags Only"; /* when user tags are updated */ var UPDATE_PRATILIPI_TYPE = "Update Pratilipi Type"; /* when pratilipi type */ var TOOLTIP_SHOW_ACTION = "g_tip_show"; /* when tooltip shown */ var TOOLTIP_LOCATION = "g_pratilipi_page"; /* when tooltip shown */ var allSystemCategories = null; /* all the predefined system categories for each content type*/ currentlysuggestedCategories = []; /*current state of suggestedTags when in expanded active state*/ preselectedSystemCategoryIds = []; /*contains ids of system categories already assigned to Pratilipi*/ var dataAccessor = new DataAccessor(); var self = this; self.selectedSystemTagIds = ko.observableArray([]); /*current state of selectedTagIds*/ self.isShownInModal = params.isShownInModal != null ? params.isShownInModal : false; /* Default set to false */ self.pratilipi = params.pratilipi; self.currentSuggestedCategory = ko.observable(""); self.showSystemCategoriesLengthViolationMsg = ko.observable(false); self.currentlySuggestedTag = ko.observable(""); self.currentContentTypeSystemTags = ko.observableArray([]); /*system categories*/ self.categories = ko.observableArray([]); /*pratilipis system + suggested categories shown in collapsed state only*/ self.currentlysuggestedCategories = ko.observableArray([]); /*final user suggested categories*/ self.currentContentType = ko.observable(); /* ARTICLE STORY POEM*/ self.tagsLoaded = ko.observable(true); /*when an ajax call is made for tags for story, article, etc*/ self.pratilipiTypeSelected = ko.observable(false); /*if the article, story,etc is checked*/ self.categoryInputActive = ko.observable(true); /*if in editing mode*/ self.isAdmin = ko.observable(false); var modal = document.getElementById("addCategory-" + self.pratilipi.pratilipiId()); var radios; /*radios will be in modal else in document*/ if (self.isShownInModal) radios = modal.querySelectorAll('input[type=radio][name="pratilipi-type"]'); else radios = document.querySelectorAll('input[type=radio][name="pratilipi-type"]'); function changeHandler(event, customValue) { self.currentContentType(customValue ? customValue : this.value); /*change type ie STORY, ARTICLE, POEM*/ self.pratilipiTypeSelected(true); self.showSystemCategoriesLengthViolationMsg(false); /* GA - PRATILIPI TYPE UPDATED EVENT */ if (self.currentContentType() != self.pratilipi.type()) { /*if type is not the same, clear selected ids, else set them to*/ /* clearing selected tags of previous Pratilipi type */ self.selectedSystemTagIds([]); ga_CAL(CONTENT_CATEGORY_LABEL, UPDATE_PRATILIPI_TYPE, self.currentContentType() + "-" + self.pratilipi.type()); } else { /*if type is changed to original content type, set selectedTagIds to original selected system tag ids*/ if (preselectedSystemCategoryIds) self.selectedSystemTagIds(preselectedSystemCategoryIds.slice()); } } /* add suggested tag if not already present. */ addSuggestedTag = function(tagName) { var isPresent = 0; /*if present in pratilipi categories already, mark isPresent = 1*/ self.categories().forEach(function(categoryObj) { if (categoryObj.name == tagName) isPresent = 1; }); /* Continue if already present in the list. */ if (isPresent) return; self.categories.push({ "name": tagName, "type": 1 }); }; /* bind changeHandle on each of radio buttons*/ Array.prototype.forEach.call(radios, function(radio) { radio.addEventListener('change', changeHandler); }); ko.computed( function () { self.isAdmin(self.pratilipi.hasAccessToUpdate() && appViewModel.user.author.authorId() != self.pratilipi.author.authorId()); }, this); ko.computed( function () { self.showSystemCategoriesLengthViolationMsg(self.selectedSystemTagIds().length > 3); }, this); /* preselectedSystemCategoryIds : contains ids of tags already assigned to Pratilipi */ ko.computed( function() { if(self.pratilipi.tags() == null) return null; self.pratilipi.tags().forEach(function(tag) { if (preselectedSystemCategoryIds.indexOf(tag.id()) == -1) { /* add if not present already. */ preselectedSystemCategoryIds.push(tag.id()); self.selectedSystemTagIds.push(tag.id()); self.categories.push({ "name": tag.name(), "type": 0 }); } }); self.categoryInputActive(false); }, this ); ko.computed(function() { /* Default value for pratilipi type dropdown */ if (self.pratilipi.type() && (self.pratilipi.type() == "ARTICLE" || self.pratilipi.type() == "POEM" || self.pratilipi.type() == "STORY")) { self.currentContentType(self.pratilipi.type()); Array.prototype.forEach.call(radios, function(radio) { if (radio.value == self.pratilipi.type()) { radio.checked = true; } }); self.pratilipiTypeSelected(true); } return null; }); ko.computed(function() { /* Initializing suggestedTags */ if(self.pratilipi.suggestedTags() == null) return; self.currentlysuggestedCategories(self.pratilipi.suggestedTags().slice()); currentlysuggestedCategories = self.pratilipi.suggestedTags().slice(); currentlysuggestedCategories.forEach(function(tagName) { addSuggestedTag(tagName); }); self.categoryInputActive(false); }, this); /* fetching system cats based on selected pratilipi type */ ko.computed(function() { if (self.currentContentType() == null) return; /* Show loading icon */ self.tagsLoaded(false); /* FETCHING TAGS EVERYTIME self.currentContentType CHANGES */ if(allSystemCategories == null) { dataAccessor.getTags(self.pratilipi.language(), function (response) { if (response == null) { /* Server call fails */ console.log('Tags not working'); /* hide loading icon */ self.tagsLoaded(true); } else { allSystemCategories = {}; Object.keys(response).forEach(function (key) { allSystemCategories[key] = response[key].categories }); self.onSuccess(); } }); } else { self.onSuccess(); } }); self.onSuccess = function() { self.tagsLoaded(true); ko.mapping.fromJS(allSystemCategories[self.currentContentType()], {}, self.currentContentTypeSystemTags); }; /* Toggle category input view visibility */ self.toggleCatergoryInput = function() { if (self.categoryInputActive()) self.categoryInputActive(false); else self.categoryInputActive(true); }; /* When cancel button is clicked */ self.closeCategoryInput = function() { self.categoryInputActive(false); /* Close modal if present in modal */ if (self.isShownInModal) $("#addCategory-" + self.pratilipi.pratilipiId()).modal('hide'); self.resetToPreviousState(); }; self.resetToPreviousState = function () { Array.prototype.forEach.call(radios, function(radio) { if (radio.value == self.pratilipi.type()) { radio.checked = true; changeHandler(null, radio.value); } }); if(self.pratilipi.suggestedTags().length) { self.currentlysuggestedCategories(self.pratilipi.suggestedTags().slice()); currentlysuggestedCategories = self.pratilipi.suggestedTags().slice(); } var initialSystemCategoryIds = self.pratilipi.tags().map(function (tag) { return tag.id(); }); updateCategoies(initialSystemCategoryIds, self.pratilipi.suggestedTags().slice()); }; self.tagClick = function(data, event) { var id = data.id(); var element = $("#" + id); if(!element.hasClass("checked") && self.selectedSystemTagIds().length >= 3) { self.showSystemCategoriesLengthViolationMsg(true); } else { self.showSystemCategoriesLengthViolationMsg(false); element.toggleClass("checked"); if (element.hasClass("checked")) { self.selectedSystemTagIds.push(id); /* GA - CATEGORY SELECT EVENT */ var selectCount = Number(element.attr("data-select"))+1; element.attr("data-select",selectCount); if (selectCount == 1) { /* send GA event only first time */ ga_CA(CATEGORY_TAGS_LABEL, SELECT_CATEGORY_ACTION); } self.triggerFacebookEvent('ADDCATEGORY_CATTAG_BOOK', id); } else { index = self.selectedSystemTagIds().indexOf(id); if (index != -1) self.selectedSystemTagIds.splice(index, 1); /* GA - CATEGORY DESELECT EVENT */ var deselectCount = Number(element.attr("data-deselect"))+1; element.attr("data-deselect",deselectCount); if (deselectCount == 1) { /* send GA and FB event only first time */ ga_CA(CATEGORY_TAGS_LABEL, DESELECT_CATEGORY_ACTION); /* if (preselectedSystemCategoryIds.indexOf(Number(id)) != -1) /* send only if it is existing category */ } self.triggerFacebookEvent('REMOVECATEGORY_CATTAG_BOOK', id); } } /* element.toggleClass("checked");*/ }; self.removeSuggestedCategory = function(data, event) { var userTag = data; index = currentlysuggestedCategories.indexOf(userTag); if (index != -1) { currentlysuggestedCategories.splice(index, 1); self.currentlysuggestedCategories.splice(index, 1); self.triggerFacebookEvent('REMOVETAG_CATTAG_BOOK', userTag); } /* GA - USER TAG DESELECT EVENT */ /*var deselectCount = Number(element.attr("data-deselect"))+1; element.attr("data-deselect",deselectCount); */ /* send GA and FB event only first time */ /*if (deselectCount == 1) { ga_CA(CATEGORY_TAGS_LABEL, DESELECT_USER_TAG_ACTION); */ /* send only if it is existing user tag */ /*if (self.pratilipi.suggestedTags().indexOf(userTag) != -1) } */ /* } */ }; self.addTag = function() { var inputBox = $("#pratilipi_suggested_tags_input-"+self.pratilipi.pratilipiId()); var userTag = $.trim(inputBox.val()); if (!userTag) return; /* clear input box. Add tag to the suggested list and to suggested selected list */ inputBox.val(""); inputBox.focus(); self.currentlysuggestedCategories.push(userTag); currentlysuggestedCategories.push(userTag); /* GA - USER TAG SELECT EVENT */ ga_CA(CATEGORY_TAGS_LABEL, SELECT_USER_TAG_ACTION); /* FB - USER TAG SELECT EVENT */ self.triggerFacebookEvent('ADDTAG_CATTAG_BOOK', userTag); }; self.saveTags = function() { var isTypeUpdated = false; var isCategoriesUpdated = false; var isUserTagsUpdated = false; /* Compare pratilipitype */ if (self.pratilipi.type() != self.currentContentType()) isTypeUpdated = true; /* Compare selectedTagIds with pratilipiTags */ if (preselectedSystemCategoryIds && preselectedSystemCategoryIds.length) { /* self.pratilipi.tags is not null and not empty */ if (self.selectedSystemTagIds().toString() != preselectedSystemCategoryIds.toString()) { isCategoriesUpdated = true; } } else { /* self.pratilipi.tags is null or empty */ if (self.selectedSystemTagIds().length > 0) /* selectedTagIds length is greater than 0 */ isCategoriesUpdated = true; } /* existing suggested tags is not null and not equal to updated value */ if (self.pratilipi.suggestedTags()) { /* self.pratilipi.suggestedTags is not null */ if (currentlysuggestedCategories.toString() != self.pratilipi.suggestedTags().toString()) { isUserTagsUpdated = true; } } else { /* self.pratilipi.suggestedTags is null */ if (currentlysuggestedCategories.length > 0) /* suggestedTags length is greater than 0 */ isUserTagsUpdated = true; } if (isTypeUpdated || isCategoriesUpdated || isUserTagsUpdated) { /* Google and FB Analytics */ var UPDATE = 'update'; var NEW = 'new'; var gaAction, fbEventType; if (isCategoriesUpdated && isUserTagsUpdated) { if ((preselectedSystemCategoryIds && preselectedSystemCategoryIds.length) || self.pratilipi.suggestedTags()) { gaAction = UPDATE_CATEGORIES_TAGS_ACTION; fbEventType = UPDATE; } else { gaAction = ASSIGN_CATEGORIES_TAGS_ACTION; fbEventType = NEW; } } else if (isCategoriesUpdated) { if (preselectedSystemCategoryIds && preselectedSystemCategoryIds.length) { gaAction = UPDATE_CATEGORIES_ACTION; fbEventType = UPDATE; } else { gaAction = ASSIGN_CATEGORIES_ACTION; fbEventType = NEW; } } else if (isUserTagsUpdated) { if (self.pratilipi.suggestedTags() && self.pratilipi.suggestedTags().length) { gaAction = UPDATE_TAGS_ACTION; fbEventType = UPDATE; } else { gaAction = ASSIGN_TAGS_ACTION; fbEventType = NEW; } } if (fbEventType === NEW) { self.triggerFacebookEvent('NEWBOOKINFO_CATTAG_BOOK'); } else if (fbEventType === UPDATE) { self.triggerFacebookEvent('UPDATEBOOKINFO_CATTAG_BOOK'); } /* disable submit button */ $("#saveTags-" + self.pratilipi.pratilipiId()).prop('disabled', true); $("#closeCategoryInputView-" + self.pratilipi.pratilipiId()).prop('disabled', true); /* Make server call to update tags. */ ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); dataAccessor.updatePratilipiTags( self.pratilipi.pratilipiId(), self.currentContentType(), self.selectedSystemTagIds(), currentlysuggestedCategories, function(data) { $("#saveTags-" + self.pratilipi.pratilipiId()).prop('disabled', false); $("#closeCategoryInputView-" + self.pratilipi.pratilipiId()).prop('disabled', false); self.categoryInputActive(false); self.pratilipi.suggestedTags(currentlysuggestedCategories.slice()); preselectedSystemCategoryIds = self.selectedSystemTagIds().slice(); /* Close modal if present in modal */ if (self.isShownInModal) $("#addCategory-" + self.pratilipi.pratilipiId()).modal('hide'); if (self.currentContentType() && self.currentContentType() != self.pratilipi.type()) { self.pratilipi.type(self.currentContentType()); } updateCategoies(self.selectedSystemTagIds(), currentlysuggestedCategories); ToastUtil.toast( "ಯಶಸ್ವಿ!", 3000 ); }, function(data) { $("#saveTags-" + self.pratilipi.pratilipiId()).prop('disabled', false); $("#closeCategoryInputView-" + self.pratilipi.pratilipiId()).prop('disabled', false); var message = "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!"; if( data[ "message" ] != null ) message = data[ "message" ]; ToastUtil.toast( message, 3000 ); } ); /* GA - ADD OR UPDATE CATEGORY OR/AND TAG EVENT */ if (gaAction) { /* gaAction is null if only pratilipi type is updated */ ga_CAV(CATEGORY_SUBMIT_LABEL, gaAction, Number(calculateGAValue(isCategoriesUpdated, isUserTagsUpdated))); } } else { /* close input view without making server call */ self.categoryInputActive(false); } }; updateCategoies = function(selectedTagIds, suggestedTags) { /* remove existing entries */ self.categories([]); var list = self.currentContentTypeSystemTags(); if (selectedTagIds) { selectedTagIds.forEach(function(id) { list.forEach(function(tag) { if (id == tag.id()) { self.categories.push({ "name": tag.name(), "type": 0 }); } }); }); } if (suggestedTags) { suggestedTags.forEach(function(tagName) { addSuggestedTag(tagName); }); } }; calculateGAValue = function(isCategoriesUpdated, isUserTagsUpdated) { var selectedTagIdsLength = self.selectedSystemTagIds().length; var suggestedTagsLength = currentlysuggestedCategories.length; if (selectedTagIdsLength == 0 || !isCategoriesUpdated) return suggestedTagsLength; if (suggestedTagsLength == 0 || !isUserTagsUpdated) return selectedTagIdsLength; if (suggestedTagsLength < 10) suggestedTagsLength = "0" + suggestedTagsLength; return selectedTagIdsLength + suggestedTagsLength; }; /** * Facebook events */ this.triggerFacebookEvent = function(eventName, parentId) { switch (eventName) { case 'ADDCATEGORY_CATTAG_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId(eventName, self.pratilipi, parentId); break; case 'REMOVECATEGORY_CATTAG_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId(eventName, self.pratilipi, parentId); break; case 'ADDTAG_CATTAG_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId(eventName, self.pratilipi, parentId); break; case 'REMOVETAG_CATTAG_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndParentId(eventName, self.pratilipi, parentId); break; case 'NEWBOOKINFO_CATTAG_BOOK': case 'UPDATEBOOKINFO_CATTAG_BOOK': FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi(eventName, self.pratilipi); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; } , template: `<div class="pratilipi-tags" style="margin: 0px; width: 100%;"> <h3 class="material-title" style="margin: 8px 16px;"> ಪ್ರಭೇದಗಳು <button data-bind="{click: toggleCatergoryInput, visible: !isShownInModal}" class="mdl-button mdl-js-button mdl-button--icon" style="margin-left: 4px;"> <i style="font-size: 20px" class="material-icons">create</i> </button> </h3> <div class="pratilipi-tag-container" data-bind="visible: !categoryInputActive() && !isShownInModal" style="margin: 8px 16px;"> <!-- ko foreach: categories --> <!-- ko ifnot: type --> <span class="pratilipi-tag-element disabled font-16" style="background: #D3D3D3" data-bind="text:name"> </span> <!-- /ko --> <!-- /ko --> <!-- ko foreach: categories --> <!-- ko if: type --> <span class="pratilipi-tag-element disabled font-16" style="background: white" data-bind="text:name"> </span> <!-- /ko --> <!-- /ko --> </div> <div data-bind="visible: categoryInputActive() || isShownInModal" style="margin: 8px 16px;"> <span class="font-xs" style="color: rgba(0,0,0,0.54);">ಪ್ರಭೇದವನ್ನು ಆಯ್ಕೆ ಮಾಡಿಕೊಳ್ಳಿ. ಇದರಿಂದ ನಿಮ್ಮ ಬರಹಗಳು ಹೆಚ್ಚಿನ ಓದುಗರಿಗೆ ತಲುಪುತ್ತವೆ</span> <h6 class="material-subtitle-1 font-m" style="margin-bottom: 0px;"> ವಿಧ </h6> <form> <div class="md-radio md-radio-inline"> <input type="radio" name="pratilipi-type" value="POEM" id="radio-POEM" > <label class="font-m" for="radio-POEM"> ಕವಿತೆ </label> </div> <div class="md-radio md-radio-inline"> <input type="radio" name="pratilipi-type" value="STORY" id="radio-STORY" > <label class="font-m" for="radio-STORY"> ಕಥೆ </label> </div> <div class="md-radio md-radio-inline"> <input type="radio" name="pratilipi-type" value="ARTICLE" id="radio-ARTICLE" > <label class="font-m" for="radio-ARTICLE"> ಲೇಖನ </label> </div> </form> <div data-bind="visible: pratilipiTypeSelected()"> <h6 class="material-subtitle-1 font-m"> ಪ್ರಭೇದಗಳು <span class="subtitle-span font-xs pratilipi-red-important" data-bind="style: {visibility: showSystemCategoriesLengthViolationMsg() ? 'visible' : 'hidden'}">( ಕೇವಲ 3 ಪ್ರಭೇದಗಳನ್ನು ಮಾತ್ರ ಆಯ್ಕೆ ಮಾಡಿಕೊಳ್ಳಿ )</span> </h6> <div data-bind="visible: ! tagsLoaded()" class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"> <span class="initial-data-loading-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span> </div> <div class="pratilipi-tag-container" data-bind="foreach: currentContentTypeSystemTags, visible: tagsLoaded()"> <div class="pratilipi-tag-element font-m" data-bind="text:name, attr: {id:id, 'data-select': $parent.selectedSystemTagIds().indexOf(id()) > -1 ? 1 : null }, click: $parent.tagClick, css: { checked: $parent.selectedSystemTagIds().indexOf(id()) > -1 }" data-select="0" data-deselect="0"> </div> </div> <div data-bind="visible: tagsLoaded()"> <h6 class="material-subtitle-1 font-m">ಹೊಸ ಪ್ರಭೇದ</h6> <div class="pratilipi-tag-container" data-bind="foreach: currentlysuggestedCategories"> <div class="pratilipi-tag-element font-16 checked tag-deletable" data-deselect="0"> <span class="mdl-chip__text font-m" data-bind="text: $data"></span> <button type="button" class="mdl-chip__action" data-bind="click: $parent.removeSuggestedCategory"><i class="material-icons">cancel</i></button> </div> </div> <div class="mdl-cell mdl-cell--12-col padding-zero"> <div class="mdl-grid padding-zero mdl-grid--no-spacing"> <div class="mdl-textfield mdl-js-textfield mdl-cell mdl-cell--4-col mdl-cell--3-col-phone" style="padding-top: 0"> <input class="mdl-textfield__input font-m" type="text" placeholder="ಇಲ್ಲಿ ಟೈಪ್ ಮಾಡಿ" data-bind="textInput: currentlySuggestedTag, attr: { 'id':'pratilipi_suggested_tags_input-'+pratilipi.pratilipiId() }, transliterate: true"> <label class="mdl-textfield__label" for="sample1"></label> </div> <button class="mdl-button mdl-js-button mdl-button--icon" data-bind="disable: currentlySuggestedTag().length > 30,click: addTag" style="margin-left:10px;"> <i class="material-icons">send</i> </button> <div class="mdl-cell mdl-cell--12-col pratilipi-red" data-bind="visible: currentlySuggestedTag().length > 30" style="margin-top: -15px;"> <i class="material-icons material-icons-16" style="vertical-align: middle;"> info_outline </i> <span class="">ನೀವು ಟೈಪಿಸುವ ಪ್ರಭೇದದ ಹೆಸರು 30 ಅಕ್ಷರಗಳಿಗಿಂತ ಕಡಿಮೆ ಇರಬೇಕು</span> </div> </div> </div> </div> <div style="text-align: right; padding-top:10px"> <button data-bind="click: closeCategoryInput, attr: {'id': 'closeCategoryInputView-' + pratilipi.pratilipiId() }" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button-margin"> ರದ್ದುಗೊಳಿಸಿ </button> <button data-bind="disable: !isAdmin() && ((currentlysuggestedCategories().length + selectedSystemTagIds().length) == 0 || selectedSystemTagIds().length > 3), click: saveTags, attr: {'id': 'saveTags-' + pratilipi.pratilipiId() }" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin"> ಸಂರಕ್ಷಿಸಿ </button> </div> </div> </div> </div>` }); </script> <script> ko.components.register( 'pratilipi-pratilipi2016-page', { viewModel: function() { var windowsize = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth; this.image = "http://public.pratilipi.com/year-in-review-2016/" + ( windowsize < 768 ? "low-res" : "high-res" ) + "/YearInReview-kn.jpg"; } , template: `<div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card mdl-card-border"><img data-bind="attr: { src: image }" style="width: 100%; max-width: 100%;" /></div>` }); </script> <script> ko.components.register( 'pratilipi-reader', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); var defaultPratilipi = { "pratilipiId": null, "title": null, "titleEn": null, "language": null, "author": { "authorId": null,"name": null, "pageUrl": null }, "summary": null, "pageUrl": null, "coverImageUrl": null, "readPageUrl": null, "writePageUrl": null, "type": null, "contentType": null, "oldContent": false, "index": null, "pageCount": null, "state": null, "listingDateMillis": null, "wordCount": null, "reviewCount": null, "ratingCount": null, "averageRating": null, "readCount": null, "userPratilipi" : null, "fbLikeShareCount": null, "hasAccessToUpdate": false }; var defaultUserPratilipi = { "userPratilipiId": null, "userId": null, "pratilipiId": null, "userName": null, "userImageUrl": null, "userProfilePageUrl": null, "rating": 0, "review": null, "reviewState": null, "addedToLib": false, "hasAccessToReview": true, "isLiked": false, }; this.updatePratilipi = function( pratilipi, initialiseObject ) { var updatedPratilipi = JSON.parse( JSON.stringify( initialiseObject ? defaultPratilipi : pratilipi ) ); if( initialiseObject && pratilipi != null ) { if( pratilipi.summary != null && pratilipi.summary.trim() == "" ) pratilipi.summary = null; for( var key in pratilipi ) if( pratilipi.hasOwnProperty( key ) ) updatedPratilipi[ key ] = pratilipi[ key ]; if( pratilipi.author != null ) { for( var key in pratilipi.author ) if( pratilipi.author.hasOwnProperty( key ) ) updatedPratilipi.author[ key ] = pratilipi.author[ key ]; } } ko.mapping.fromJS( updatedPratilipi, {}, self.pratilipi ); MetaTagUtil.setMetaTagsForReader( ko.mapping.toJS( self.pratilipi ) ); }; this.updateUserPratilipi = function( userPratilipi, initialiseObject ) { var updatedUserPratilipi = JSON.parse( JSON.stringify( initialiseObject ? defaultUserPratilipi : userPratilipi ) ); if( initialiseObject && userPratilipi != null ) { if( userPratilipi.rating == null ) userPratilipi.rating = 0; if( userPratilipi.review != null && userPratilipi.review.trim() == "" ) userPratilipi.review = null; if( userPratilipi.reviewState != null && userPratilipi.reviewState != "PUBLISHED" ) userPratilipi.review = null; for( var key in userPratilipi ) if( userPratilipi.hasOwnProperty( key ) ) updatedUserPratilipi[ key ] = userPratilipi[ key ]; } ko.mapping.fromJS( updatedUserPratilipi, {}, self.userPratilipi ); }; this.setChapterNo = function( chapterNo ) { /* Backward Compatibility */ chapterNo = parseInt( chapterNo ); if( chapterNo === self.chapterNo() ) return; if( chapterNo < 1 ) chapterNo = 1; if( chapterNo > self.chapterCount() ) chapterNo = self.chapterCount(); self.chapterNo( chapterNo ); if( self.scrollTop() > 100 ) { self.scrollToTop( 0 ); } setCookie( "reader_page_number_" + self.pratilipi.pratilipiId(), chapterNo, 30, "/read" ); }; /* Font Sizes */ var defaultFontSize = 18; this.minFontSize = 12; this.maxFontSize = 32; /* Image Size */ this.minImageSize = 300; this.maxImageSize = 1500; this.getFontSize = function() { if( getCookie( "fontSize" ) != null ) return parseInt( getCookie( "fontSize" ) ); return defaultFontSize; }; this.setFontSize = function( fontSize ) { fontSize = parseInt( fontSize ); if( fontSize > self.maxFontSize || fontSize < self.minFontSize ) return; appViewModel.readerFontSize( fontSize ); self.triggerFacebookEvent('READERFONT_SETTINGS_READER', fontSize); setTimeout( function() { setCookie( "fontSize", fontSize, 30, "/read" ) }, 0 ); }; this.getImageSize = function() { if( getCookie( "imageSize" ) != null ) return parseInt( getCookie( "imageSize" ) ); return -1; /* -1 for undetermined */ }; this.setImageSize = function( imageSize ) { imageSize = parseInt( imageSize ); if( imageSize > self.maxImageSize || imageSize < self.minImageSize ) return; appViewModel.readerImageSize( imageSize ); setTimeout( function() { setCookie( "imageSize", imageSize, 30, "/read" ) }, 0 ); }; this.getTheme = function() { /* Backward Compatibility */ if( getCookie( "PREFERRED_READING_MODE" ) == "NIGHT_MODE" ) return "NIGHT"; if( getCookie( "PREFERRED_READING_MODE" ) == "SEPIA_MODE" ) return "SEPIA"; return "NORMAL"; }; this.setTheme = function( theme ) { /* Backward Compatibility */ appViewModel.readerTheme( theme ); var mode = "NORMAL_MODE"; if( theme == "NIGHT" ) mode = "NIGHT_MODE"; if( theme == "SEPIA" ) mode = "SEPIA_MODE"; self.triggerFacebookEvent('READERBACKGROUND_SETTINGS_READER', theme ); setTimeout( function() { setCookie( "PREFERRED_READING_MODE", mode, 30, "/read" ) }, 0 ); }; this.getLineHeight = function() { if( getCookie( "lineHeight" ) != null ) return getCookie( "lineHeight" ); return "MEDIUM"; }; this.setLineHeight = function( lineHeight ) { appViewModel.readerLineHeight( lineHeight ); self.triggerFacebookEvent('READERGAP_SETTINGS_READER', lineHeight); setTimeout( function() { setCookie( "lineHeight", lineHeight, 30, "/read" ) }, 0 ); }; this.getChapterNoFromChapterId = function( lastReadChapterId, index ) { for( var i = 0; i < index.length; i++ ) if( index[i].chapterId == lastReadChapterId ) return index[i].chapterNo; return null; }; this.intializePercentageReadData = function (chapterNo) { if( ! appViewModel.user.isGuest() ) { var windowHeight = $(window).height() - 54; var documentHeight = $( ".js-content" ).height() + 16; var percentageRead = windowHeight/documentHeight * 100; if(!isNaN(percentageRead)) self.updatePercentageReadData(chapterNo, percentageRead); } }; /* Variables */ this.dataLoadedState = ko.observable(); /* 3 Possible states: LOADING, LOADED and FAILED */ this.pratilipi = ko.mapping.fromJS( defaultPratilipi, {}, self.pratilipi ); this.userPratilipi = ko.mapping.fromJS( defaultUserPratilipi, {}, self.userPratilipi ); this.libraryRequestOnFlight = ko.observable( false ); this.chapterNo = ko.observable(); this.chapterCount = ko.observable(); this.percentScrolled = ko.observable(0); this.index = ko.observableArray(); this.initialiseReader = function() { /* Setting up Reader */ if( appViewModel.readerFontSize() == null ) appViewModel.readerFontSize( self.getFontSize() ); if( appViewModel.readerImageSize() == null ) appViewModel.readerImageSize( self.getImageSize() ); if( appViewModel.readerTheme() == null ) appViewModel.readerTheme( self.getTheme() ); if( appViewModel.readerLineHeight() == null ) appViewModel.readerLineHeight( self.getLineHeight() ); /* Api call */ self.dataLoadedState( "LOADING" ); dataAccessor.getPratilipiAndIndex( getUrlParameter( "id" ), true, function( pratilipi, indexResponse, userPratilipi, statusCode ) { if( statusCode !== 200 ) { if( statusCode === 401 || statusCode === 403 ) { /* Guest user or logged in user(non-author) not allowed to view content */ redirect( "/error/draftedcontent" ); } else if( statusCode === 400 || statusCode === 404 ) { /* Invalid slug/pratilipiId or Page Not Found */ redirect( "/error/pagenotfound" ); } else if( statusCode === 500 ) { /* Server error */ redirect( "/error/servererror" ); } else { /* Unhandled error */ console.log( "UNHANDLED_ERROR :: " + pratilipi + " :: " + indexResponse + " :: " + userPratilipi + " :: " + statusCode ); redirect( "/error/servererror" ); } self.dataLoadedState( "FAILED" ); return; } /* Updating properties */ self.updatePratilipi( pratilipi, true ); self.updateUserPratilipi( userPratilipi, true ); /* Setting index and chapterCount */ /* Two different versions of contents */ var index = []; if( pratilipi.oldContent ) { if( pratilipi.index != null ) { index = JSON.parse( pratilipi.index ); for( var i = 0; i < index.length; i++ ) { if( index[i].title == null ) index[i].title = "ಅಧ್ಯಾಯ " + index[i].chapterNo; index[i].chapterNo = index[i].pageNo; } } self.chapterCount( pratilipi.pageCount > 0 ? pratilipi.pageCount : 1 ); } else { index = indexResponse.index; for( var i = 0; i < index.length; i++ ) if( index[i].title == null || index[i].title.trim() == "" ) index[i].title = "ಅಧ್ಯಾಯ " + index[i].chapterNo; self.chapterCount( index != null && index.length > 0 ? index.length : 1 ); } self.index( index ); /* update chapter no */ lastUsedChapterNo = self.getChapterNoFromChapterId(pratilipi.userPratilipi.lastReadChapterId, index); /* set chapterNo */ var chapterNo = 1; if( getCookie( "reader_page_number_" + pratilipi.pratilipiId ) != null ) chapterNo = parseInt(getCookie("reader_page_number_" + pratilipi.pratilipiId)); if( lastUsedChapterNo ) chapterNo = lastUsedChapterNo; if( getUrlParameter( "chapterNo" ) != null ) chapterNo = parseInt( getUrlParameter( "chapterNo" ) ); self.setChapterNo( chapterNo ); self.dataLoadedState( "LOADED" ); /* update percentage read */ setTimeout( function() { self.intializePercentageReadData( chapterNo ); }, 1000 ); }); }; this.openSettings = function() { self.triggerFacebookEvent('LANDED_SETTINGS_READER'); $( "#pratilipi-reader-settings" ).modal(); }; this.openNavigationModal = function() { if( !( typeof( componentHandler ) == 'undefined' ) ) { componentHandler.upgradeAllRegistered(); } document.querySelector( '.mdl-layout' ).MaterialLayout.toggleDrawer(); }; this.switchLibraryState = function() { if( appViewModel.user.isGuest() ) { self.triggerFacebookEvent('LIBRARYADD_READERM_READER'); goToLoginPage( { "id": self.pratilipi.pratilipiId() }, { "message": "LIBRARY" } ); return; } if( self.libraryRequestOnFlight() ) return; self.libraryRequestOnFlight( true ); var getAddedToLibMessage = function( addedToLib ) { var text = addedToLib ? "ನೀವು $pratilipiTitle ಬರಹವನ್ನು ಗ್ರಂಥಾಲಯಕ್ಕೆ ಸೇರಿಸಿದ್ದೀರಿ" : "ನೀವು $pratilipiTitle ಬರಹವನ್ನು ಗ್ರಂಥಾಲಯದಿಂದ ತೆಗೆದುಹಾಕಿದ್ದೀರಿ"; var title = self.pratilipi.title().substring( 0, 10 ) + ( self.pratilipi.title().length > 10 ? "..." : "" ); return text.replace( "$pratilipiTitle", title ); }; var addedToLib = ! self.userPratilipi.addedToLib(); if( addedToLib ) { /* Toast only for remove action */ ToastUtil.toast( getAddedToLibMessage( addedToLib ), 3000 ); self.triggerFacebookEvent('LIBRARYADD_READERM_READER'); } else { ToastUtil.toastCallBack( getAddedToLibMessage( addedToLib ), 4000, "", self.switchLibraryState ); self.triggerFacebookEvent('LIBRARYREMOVE_READERM_READER'); } self.updateUserPratilipi( { "addedToLib": addedToLib } ); dataAccessor.addOrRemoveFromLibrary( self.pratilipi.pratilipiId(), addedToLib, function( userPratilipi ) { self.libraryRequestOnFlight( false ); }, function( error ) { self.libraryRequestOnFlight( false ); self.updateUserPratilipi( { "addedToLib": ! addedToLib } ); var message = "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!"; if( error[ "message" ] != null ) message = error[ "message" ]; ToastUtil.toast( message, 3000, true ); }); }; this.sharePratilipi = function() { self.triggerFacebookEvent('CLICKSHRBOOK_READERM_READER'); ShareUtil.sharePratilipi( self.pratilipi, null, 'READERM_READER' ); }; /* Settings */ this.increaseFontSize = function() { self.setFontSize( appViewModel.readerFontSize() + 2 ); }; this.decreaseFontSize = function() { self.setFontSize( appViewModel.readerFontSize() - 2 ); }; this.increaseImageSize = function() { self.setImageSize( appViewModel.readerImageSize() + 50 ); }; this.decreaseImageSize = function() { self.setImageSize( appViewModel.readerImageSize() - 50 ); }; this.setNormalTheme = function() { self.setTheme( "NORMAL" );}; this.setNightTheme = function() { self.setTheme( "NIGHT" ); }; this.setSepiaTheme = function() { self.setTheme( "SEPIA" ); }; this.setSmallLineHeight = function() { self.setLineHeight( "SMALL" ) }; this.setMediumLineHeight = function() { self.setLineHeight( "MEDIUM" ) }; this.setLargeLineHeight = function() { self.setLineHeight( "LARGE" ) }; /* Report Content */ this.reportContent = function() { ReportUtil.report( "PRATILIPI", self.pratilipi.pratilipiId(), self.pratilipi, 'REPORTBOOK_READERM_READER' ); }; /* Navigate on Reader */ this.keyupHandler = function( keyCode ) { /* Left => 37 ; Right => 39 */ if( keyCode == 37 ) self.setChapterNo( self.chapterNo() - 1 ); else if( keyCode == 39 ) self.setChapterNo( self.chapterNo() + 1 ); }; /* ProgressBar */ var progressBar = null; this.setProgressBarObserver = ko.computed(function() { self.percentScrolled(); setTimeout(function() { if( progressBar == null ) return; progressBar.setProgress( self.percentScrolled() ); }); }); /* UserPratilipiReadApi => Trigger api calls on % read */ var lastUsedPercentage = 0; /* set default value of lastUsedChapterNo from pratilipi response */ var lastUsedChapterNo = 1; /* Defaulting to 1 */ var lastPrecentageReadUpdateTime = new Date(); this.percentContentScrolledObserver = ko.computed( function() { self.percentScrolled(); setTimeout( function() { var contentHeight = $( ".js-content" ).height() + 16; var windowHeight = $(window).height() - 54; var distanceToTop = self.scrollTop(); var percentageContentScrolled = distanceToTop/(contentHeight - windowHeight) * 100; if (!appViewModel.user.isGuest()) { if (self.chapterNo() > lastUsedChapterNo) { if (new Date() - lastPrecentageReadUpdateTime > 1000) { lastUsedPercentage = percentageContentScrolled; lastUsedChapterNo = self.chapterNo(); lastPrecentageReadUpdateTime = new Date(); if(!isNaN(lastUsedPercentage)) self.updatePercentageReadData(lastUsedChapterNo, lastUsedPercentage); } } else if (self.chapterNo() === lastUsedChapterNo) { if (self.percentScrolled() > lastUsedPercentage) { if (new Date() - lastPrecentageReadUpdateTime > 1000) { lastUsedPercentage = percentageContentScrolled; lastPrecentageReadUpdateTime = new Date(); if(!isNaN(lastUsedPercentage)) self.updatePercentageReadData(lastUsedChapterNo, lastUsedPercentage); } } } } }); }, this ); this.postReadcount = ko.computed(function() { if(self.dataLoadedState() == "LOADED") { dataAccessor.postReadcount(window.location.pathname + window.location.search, appViewModel.user.userId(), function(response, status) {}, function(response, status) {}) } }); document.querySelector( '#reader-progress-bar' ).addEventListener( 'mdl-componentupgraded', function() { progressBar = this.MaterialProgress; progressBar.setProgress(0); }); /* ScrollTop Handlers */ this.scrollTop = ko.observable(); this.scrollToTop = function() { $( ".js-body-layout-content" ).animate({ scrollTop: 0 }, 200 ); }; this.notifyOfScrollEvent = function() { self.scrollTop( $( ".js-body-layout-content" ).scrollTop() ); }; this.setPercentageScrolled = function () { var documentHeight = $( ".js-body-layout-content .js-body-layout-content-grid" ).height() + 16; /* 16 => Padding of js-body-layout-content-grid */ var windowHeight = $(window).height() - 54; /* 54 => Hardcoded height of header + scrollbar */ var distanceToTop = self.scrollTop(); self.percentScrolled( distanceToTop/(documentHeight - windowHeight) * 100 ); }; this.scrollTopObserver = ko.computed( function() { self.scrollTop(); appViewModel.scrollTop( self.scrollTop() ); setTimeout( function() { self.setPercentageScrolled(); }, 0 ); }, this ); /* Left and Right keys */ $(document).keyup( function(e) { self.keyupHandler( e.which ); }); this.locationObserver = ko.computed( function() { jQuery.fn.removeAttributes = function() { return this.each(function() { var attributes = $.map(this.attributes, function(item) { return item.name; }); var element = $(this); $.each(attributes, function(i, item) { element.removeAttr(item); }); }); }; if( appViewModel.currentView() != LOCATION.READER.ko_element ) { /* Dispose all observers */ $('body').removeAttributes(); self.scrollTopObserver.dispose(); self.locationObserver.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { self.initialiseReader(); }, 0 ); }, this ); $( document ).ready( function() { $( document ).on( "contextmenu",function() { return false; }); $( document ).mousedown( function(e) { if( e.button == 2 ) return false; else return true; }); }); $(document).keyup(function(e){ if(e.keyCode == 44) return false; }); document.onkeydown = function(e) { var isCtrl = false; if(e.which == 17) isCtrl = true; if(( ( e.which == 67 ) || ( e.which == 80 ) ) && isCtrl == true) return false; }; function clickIE4(){ if (event.button==2){ return false; } } function clickNS4(e){ if (document.layers||document.getElementById&&!document.all){ if (e.which==2||e.which==3){ return false; } } } if (document.layers){ document.captureEvents(Event.MOUSEDOWN); document.onmousedown=clickNS4; } else if (document.all&&!document.getElementById){ document.onmousedown=clickIE4; } document.oncontextmenu=new Function( "return false" ); $('body').attr('ondragstart', 'return false'); $('body').attr('onselectstart', 'return false'); $('body').attr('onContextMenu', 'return false'); $('body').attr('onkeydown', 'if ((arguments[0] || window.event).ctrlKey) return false'); /** * Facebook events */ this.triggerFacebookEvent = function(eventName, value) { switch (eventName) { case 'LIBRARYADD_READERM_READER': case 'LIBRARYREMOVE_READERM_READER': case 'CLICKSHRBOOK_READERM_READER': case 'LANDED_SETTINGS_READER': case 'LANDED_READERM_READER': FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi(eventName, self.pratilipi ); break; case 'READERBACKGROUND_SETTINGS_READER': case 'READERFONT_SETTINGS_READER': case 'READERGAP_SETTINGS_READER': FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndValue(eventName, self.pratilipi, value ); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; this.updatePercentageReadData = function( chapterNo, percentageScrolled ) { dataAccessor.updatePercentageReadData( self.pratilipi.pratilipiId(), chapterNo, percentageScrolled, JSON.stringify(self.index()) ); }; } , template: `<div data-bind="visible: dataLoadedState() == 'LOADING'" class="loading-state-reader"><!-- ko component: "pratilipi-loading-state" --><!-- /ko --></div><div data-bind="visible: dataLoadedState() == 'FAILED'" class="failed-state-reader"><div class="content"><div style="width: 180px; height: 200px; margin: auto;" class="page-not-found-icon"></div><div>ಕ್ಷಮಿಸಿ! ಈ ಬರಹ ಲಭ್ಯವಿಲ್ಲ!</div><br/><a style="margin-left: -48px;" class="material-subtitle-1" href="/"><i class="material-icons">home</i><span style="position: absolute;">ಹೋಮ್</span></a></div></div><div class="mdl-layout mdl-js-layout pratilipi-reader"data-bind="{ visible: dataLoadedState() == 'LOADED',css: { 'th-nor': appViewModel.readerTheme() == 'NORMAL', 'th-ngt': appViewModel.readerTheme() == 'NIGHT', 'th-sep': appViewModel.readerTheme() == 'SEPIA' } }"><!-- ko component: {name: "pratilipi-reader-header",params: { pratilipi: pratilipi,userPratilipi: userPratilipi,openSettings: $data.openSettings,switchLibraryState: $data.switchLibraryState,sharePratilipi: $data.sharePratilipi,reportContent: $data.reportContent,openNavigationModal: $data.openNavigationModal,index: index,chapterNo: chapterNo,setChapterNo: $data.setChapterNo }} --><!-- /ko --><div id="reader-progress-bar" class="mdl-progress mdl-js-progress"></div><main class="mdl-layout__content"><div class="body-layout-row"><div class="body-layout-nav" data-bind="style: { visibility: chapterCount() == 1 ? 'hidden' : 'visible' }"><!-- ko component: {name: "pratilipi-reader-navigation",params: { pratilipi: pratilipi,index: index,chapterNo: chapterNo,setChapterNo: $data.setChapterNo,pratilipi: pratilipi }} --><!-- /ko --></div><div class="body-layout-content js-body-layout-content" data-bind="event: { scroll: notifyOfScrollEvent }"><div class="mdl-grid mobile-grid js-body-layout-content-grid"style="flex-grow: 1;"><div class="mdl-cell mdl-cell--12-col-tablet mdl-cell--9-col mobile-card" style="margin: 0;"><!-- ko component: {name: "pratilipi-reader-content",params: { pratilipi: pratilipi,updatePratilipi: $data.updatePratilipi,userPratilipi: userPratilipi,updateUserPratilipi: $data.updateUserPratilipi,chapterNo: chapterNo,chapterCount: chapterCount,fontSize: appViewModel.readerFontSize,imageSize: appViewModel.readerImageSize,lineHeight: appViewModel.readerLineHeight,setImageSize: $data.setImageSize,setChapterNo: $data.setChapterNo,scrollToTop: $data.scrollToTop }} --><!-- /ko --></div></div></div></div></main><!-- ko component: {name: "pratilipi-reader-footer",params: { pratilipi: pratilipi,userPratilipi: userPratilipi,openSettings: $data.openSettings,switchLibraryState: $data.switchLibraryState,sharePratilipi: $data.sharePratilipi,canOpenNavigationModal: index().length > 0,openNavigationModal: $data.openNavigationModal }} --><!-- /ko --><!-- ko if: shouldShowReadHelper() --><!-- ko component: {name: "pratilipi-reader-read-in-app-helper",params: { pratilipi: pratilipi }} --><!-- /ko --><!-- /ko --></div><!-- Settings Modal --><div class="modal common-modal fade settings-modal" id="pratilipi-reader-settings" tabindex="-1" role="dialog" aria-labelledby="pratilipi-reader-settings"><div class="modal-dialog modal-sm" role="document"><div class="modal-content"><div class="modal-header"><button class="mdl-button mdl-js-button mdl-button--icon close" class="close" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button></div><div class="modal-body"><div class="option" data-bind="visible: pratilipi.contentType() == 'PRATILIPI'"><div class="option-heading material-subtitle-1">ಅಕ್ಷರ ಗಾತ್ರ</div><button class="mdl-button mdl-js-button mdl-button--icon"onclick="ga_CAL( 'Pratilipi', 'IncreaseFontSize', 'ReaderSettings' );"data-bind="disable: appViewModel.readerFontSize() == maxFontSize, click: increaseFontSize"><i class="material-icons">add</i></button><button class="mdl-button mdl-js-button mdl-button--icon"onclick="ga_CAL( 'Pratilipi', 'DecreaseFontSize', 'ReaderSettings' );"data-bind="disable: appViewModel.readerFontSize() == minFontSize, click: decreaseFontSize"><i class="material-icons">remove</i></button></div><div class="option" data-bind="visible: pratilipi.contentType() == 'IMAGE'"><div class="option-heading material-subtitle-1">ಚಿತ್ರ ಗಾತ್ರ</div><button class="mdl-button mdl-js-button mdl-button--icon"onclick="ga_CAL( 'Pratilipi', 'IncreaseImageSize', 'ReaderSettings' );"data-bind="disable: appViewModel.readerImageSize() >= maxImageSize, click: increaseImageSize"><i class="material-icons">add</i></button><button class="mdl-button mdl-js-button mdl-button--icon"onclick="ga_CAL( 'Pratilipi', 'DecreaseImageSize', 'ReaderSettings' );"data-bind="disable: appViewModel.readerImageSize() <= minImageSize, click: decreaseImageSize"><i class="material-icons">remove</i></button></div><div class="option"><div class="option-heading material-subtitle-1">ಬ್ಯಾಗ್ರೌಂಡ್</div><button class="mdl-button mdl-js-button mdl-button--icon"onclick="ga_CAL( 'Pratilipi', 'WhiteBkg', 'ReaderSettings' );"data-bind="click: setNormalTheme, enable: appViewModel.readerTheme() != 'NORMAL'"><i class="material-icons th-nor-config">check_box_outline_blank</i></button><button class="mdl-button mdl-js-button mdl-button--icon"onclick="ga_CAL( 'Pratilipi', 'BlackBkg', 'ReaderSettings' );"data-bind="click: setNightTheme, enable: appViewModel.readerTheme() != 'NIGHT'"><i class="material-icons th-ngt-config">check_box_outline_blank</i></button><button class="mdl-button mdl-js-button mdl-button--icon"onclick="ga_CAL( 'Pratilipi', 'SepiaBkg', 'ReaderSettings' );"data-bind="click: setSepiaTheme, enable: appViewModel.readerTheme() != 'SEPIA'"><i class="material-icons th-sep-config">check_box_outline_blank</i></button></div><div class="option" data-bind="visible: pratilipi.contentType() == 'PRATILIPI'"><div class="option-heading material-subtitle-1">ಲೈನ್ ಸ್ಪೇಸಿಂಗ್</div><button class="mdl-button mdl-js-button mdl-button--icon" data-bind="click: setSmallLineHeight, enable: appViewModel.readerLineHeight() != 'SMALL'"><span class="lh-icon lh-sm-icon"onclick="ga_CAL( 'Pratilipi', 'MinLineSpacing', 'ReaderSettings' );"data-bind="css: { 'lh-icon-inactive': appViewModel.readerLineHeight() == 'SMALL' }"></span></button><button class="mdl-button mdl-js-button mdl-button--icon" data-bind="click: setMediumLineHeight, enable: appViewModel.readerLineHeight() != 'MEDIUM'"><span class="lh-icon lh-md-icon"onclick="ga_CAL( 'Pratilipi', 'BasicLineSpacing', 'ReaderSettings' );"data-bind="css: { 'lh-icon-inactive': appViewModel.readerLineHeight() == 'MEDIUM' }"></span></button><button class="mdl-button mdl-js-button mdl-button--icon" data-bind="click: setLargeLineHeight, enable: appViewModel.readerLineHeight() != 'LARGE'"><span class="lh-icon lh-lg-icon"onclick="ga_CAL( 'Pratilipi', 'MaxLineSpacing', 'ReaderSettings' );"data-bind="css: { 'lh-icon-inactive': appViewModel.readerLineHeight() == 'LARGE' }"></span></button></div></div></div></div></div>` }); </script> <link rel="stylesheet" href="https://www.ptlp.co/resource-all/pwa/css/bmmg.css"/> <link rel="stylesheet" href="//kannada.pratilipi.com/pwa-stylesheets/css/style.css?070520181801" /> <script> var Suggester = function(selectorOrElem, onResolve, content_holder, isInputElement, lang) { if(selectorOrElem) { this.elem = $(selectorOrElem); this.setMode( false ); } else { throw 'Coding karni nahi aati.'; } if(typeof onResolve == 'function') { this.resolveCallback = onResolve; } else { throw 'Coding karni nahi aati.'; } if( content_holder ) { this.content_holder = content_holder; this.isInputTypeElement = isInputElement; } else { throw 'Coding karni nahi aati.'; } this.lang = lang; this.url = "https://www.google.com/inputtools/request?ime=transliteration_en_" + this.lang + "&num=5&cp=0&cs=0&ie=utf-8&oe=utf-8&app=jsapi"; this.text = ''; this.savedSelection = null; this.words_map = {}; }; var suggesterMethods = { init: function() { var self = this; this.content_holder.on("blur", function() { if( self.getMode() ) { if (this.savedSelection) { rangy.removeMarkers(this.savedSelection); } this.savedSelection = rangy.saveSelection(); } }); this.elem.on('click', 'div.suggestion', function(e) { self.elem.find(".highlight-suggestion").removeClass("highlight-suggestion"); $(this).addClass("highlight-suggestion"); if (this.savedSelection) { rangy.restoreSelection(savedSel, true); this.savedSelection = null; } self.handleWordSelection(); } ); }, type: function( translation ) { /* var translation = new Translation(keycode); */ if( translation.action == 'typing' ) { if( !this.getMode() ) { /* add a span tag there and set the relative position of the dropdown */ if( this.isInputTypeElement == false ) { this.curSpan = insertNodeAtRange(); } this.setSuggesterPosition(); this.showSuggester(); this.setMode( true ); } this.setText(this.text + translation.text); } else if(translation.action == 'space' || translation.action == 'enter') { this.handleWordSelection(); } else if( translation.action == 'special_char' ) { this.text += translation.text; this.handleWordSelection( translation.text ); } else if(translation.action == 'backspace') { this.backspace(); } else if(translation.action == 'up') { this.goUp(); } else if( translation.action == 'down') { this.goDown(); } else if( translation.action == 'escape' || translation.action == 'tab' ) { this.clear(); } }, backspace: function() { if( this.text.length == 1 ) { this.clear(); } else { this.setText(this.text.substr(0, this.text.length -1)); } }, goUp: function() { var $suggestions = this.elem.find('.suggestions'); var $currently_highlighted_suggestion = $suggestions.find('.highlight-suggestion'); var $prev_suggestion = $currently_highlighted_suggestion.prev(); $currently_highlighted_suggestion.removeClass("highlight-suggestion"); if( $prev_suggestion.length ) { $prev_suggestion.addClass("highlight-suggestion"); } else { $suggestions.find(".suggestion:last").addClass("highlight-suggestion"); } }, goDown: function() { var $suggestions = this.elem.find('.suggestions'); var $currently_highlighted_suggestion = $suggestions.find('.highlight-suggestion'); var $next_suggestion = $currently_highlighted_suggestion.next(); $currently_highlighted_suggestion.removeClass("highlight-suggestion"); if( $next_suggestion.length ) { $next_suggestion.addClass("highlight-suggestion"); } else { $suggestions.find(".suggestion:first").addClass("highlight-suggestion"); } }, getSuggestions: function() { this.suggestFromGoogleApi(); }, suggestFromWordsMap: function() { this.suggestions = this.words_map[this.text]; this.suggest(); }, suggestFromGoogleApi: function() { var self = this; $.ajax({ url: self.url, data: { text: self.text }, type: "GET", dataType : "json", }) .done(function( json ) { self.suggestions = json[1][0][1]; self.suggestions.push( self.text ); self.suggest(); }); }, clearSuggestions: function() { this.suggestions = []; this.suggest(); }, suggest: function() { var $suggestions = this.elem.find('.suggestions'); $suggestions.empty(); this.suggestions.forEach(function(suggestion) { var $suggestion = $("<div class='suggestion'></div>"); $suggestion.text(suggestion); $suggestions.append($suggestion); }); $suggestions.find(".suggestion:first").addClass("highlight-suggestion"); }, clear: function() { this.setText(''); this.hideSuggester(); this.clearSpanTags(); this.setMode(false); }, setText: function(text) { /* this.addSpanElement(); */ this.text = text; this.getInputElem().text(this.text); if(text) { this.getSuggestions(); } else { this.clearSuggestions(); } }, getInputElem: function() { if (!this.inputElem) { this.inputElem = this.elem.find('.word-input'); } return this.inputElem; }, resolve: function(withSuggestion) { this.resolveCallback && this.resolveCallback(withSuggestion, this.text); this.clear(); }, setMode: function( val ) { this.mode = val; }, getMode: function() { return this.mode; }, getCaretPosition: function() { var coordinates = {}; if( this.isInputTypeElement ) { var caret_coordinates = getCaretCoordinates( this.content_holder.get(0), this.content_holder.get(0).selectionEnd ); coordinates["top"] = caret_coordinates.top + this.content_holder.offset().top; coordinates["left"] = caret_coordinates.left + this.content_holder.offset().left; } else { var doc_height = $(document).height(); /* var client_height = document.body.clientHeight; */ coordinates["top"] = this.curSpan.offsetTop + this.curSpan.offsetHeight + this.content_holder.get(0).offsetTop; coordinates["left"] = this.curSpan.offsetLeft + this.content_holder.get(0).offsetLeft; /* var visibleTop = coordinates["top"] - $(window).scrollTop(); console.log( doc_height, coordinates["top"], doc_height - coordinates["top"] ); console.log( client_height, visibleTop, client_height - visibleTop ); */ var last_usable_value = doc_height - coordinates["top"]; if( doc_height - coordinates["top"] < 200 ) { /* this.content_holder.height( this.content_holder.height() + 200 ); */ coordinates["top"] -= 180; window.scrollTo( 0, document.body.scrollHeight + 200 ); } } return coordinates; }, setSuggesterPosition: function() { var coordinates = this.getCaretPosition(); var self = this; this.elem.css({ top: coordinates.top, left: coordinates.left, }); /* this.elem.css({ top: self.curSpan.offsetTop + self.curSpan.offsetHeight + self.content_holder.get(0).offsetTop, left: self.curSpan.offsetLeft + self.content_holder.get(0).offsetLeft, }); */ }, showSuggester: function() { this.elem.show(); }, hideSuggester: function() { this.elem.hide(); }, clearSpanTags: function() { $("span.curWord").remove(); }, handleWordSelection: function( special_char ) { var selected_word; var $highlighted_word = this.elem.find(".highlight-suggestion"); selected_word = $highlighted_word.length ? $highlighted_word.text() : this.text; if( special_char ) { selected_word += special_char; } this.resolve( selected_word ); } }; for(var method in suggesterMethods) { Suggester.prototype[method] = suggesterMethods[method]; } var Translation = function(keycode, isShiftKey) { if( keycode == 13 ) { this.action = 'enter' } else if( keycode == 32 ) { this.action = 'space'; } else if( keycode == 8 ) { this.action = 'backspace'; } else if( keycode == 9 ) { this.action = 'tab'; } else if( keycode == 38 && !isShiftKey ) { this.action = 'up'; } else if( keycode == 40 && !isShiftKey ) { this.action = 'down'; } else if( keycode == 37 && !isShiftKey ) { this.action = 'left'; } else if( keycode == 39 && !isShiftKey ) { this.action = 'right'; } else if( keycode == '27') { this.action = 'escape'; } else if(keycode > 32 && keycode < 127) { if( keycode.between(33, 47) || keycode.between(58, 64) || keycode.between(91, 96) || keycode.between(123, 126) ) { this.action = 'special_char'; } else { this.action = 'typing'; } this.text = String.fromCharCode(keycode).toLowerCase(); } }; Number.prototype.between = function (min, max) { return this >= min && this <= max; }; </script> <script> (function () { var properties = [ 'direction', /* RTL support */ 'boxSizing', 'width', /* on Chrome and IE, exclude the scrollbar, so the mirror div wraps exactly as the textarea does */ 'height', 'overflowX', 'overflowY', /* copy the scrollbar for IE */ 'borderTopWidth', 'borderRightWidth', 'borderBottomWidth', 'borderLeftWidth', 'borderStyle', 'paddingTop', 'paddingRight', 'paddingBottom', 'paddingLeft', /* https://developer.mozilla.org/en-US/docs/Web/CSS/font */ 'fontStyle', 'fontVariant', 'fontWeight', 'fontStretch', 'fontSize', 'fontSizeAdjust', 'lineHeight', 'fontFamily', 'textAlign', 'textTransform', 'textIndent', 'textDecoration', /* might not make a difference, but better be safe */ 'letterSpacing', 'wordSpacing', 'tabSize', 'MozTabSize' ]; var isBrowser = (typeof window !== 'undefined'); var isFirefox = (isBrowser && window.mozInnerScreenX != null); function getCaretCoordinates(element, position, options) { if(!isBrowser) { throw new Error('textarea-caret-position#getCaretCoordinates should only be called in a browser'); } var debug = options && options.debug || false; if (debug) { var el = document.querySelector('#input-textarea-caret-position-mirror-div'); if ( el ) { el.parentNode.removeChild(el); } } /* mirrored div */ var div = document.createElement('div'); div.id = 'input-textarea-caret-position-mirror-div'; document.body.appendChild(div); var style = div.style; var computed = window.getComputedStyle? getComputedStyle(element) : element.currentStyle; /* currentStyle for IE < 9 */ /* default textarea styles */ style.whiteSpace = 'pre-wrap'; if (element.nodeName !== 'INPUT') style.wordWrap = 'break-word'; /* only for textarea-s */ /* position off-screen */ style.position = 'absolute'; /* required to return coordinates properly */ if (!debug) style.visibility = 'hidden'; /* not 'display: none' because we want rendering */ /* transfer the element's properties to the div */ properties.forEach(function (prop) { style[prop] = computed[prop]; }); if (isFirefox) { /* Firefox lies about the overflow property for textareas: https://bugzilla.mozilla.org/show_bug.cgi?id=984275 */ if (element.scrollHeight > parseInt(computed.height)) style.overflowY = 'scroll'; } else { style.overflow = 'hidden'; /* for Chrome to not render a scrollbar; IE keeps overflowY = 'scroll' */ } div.textContent = element.value.substring(0, position); /* the second special handling for input type="text" vs textarea: spaces need to be replaced with non-breaking spaces - http://stackoverflow.com/a/13402035/1269037 */ if (element.nodeName === 'INPUT') div.textContent = div.textContent.replace(/\s/g, '\u00a0'); var span = document.createElement('span'); span.textContent = element.value.substring(position) || '.'; /* || because a completely empty faux span doesn't render at all */ div.appendChild(span); var coordinates = { top: span.offsetTop + parseInt(computed['borderTopWidth']), left: span.offsetLeft + parseInt(computed['borderLeftWidth']) }; if (debug) { span.style.backgroundColor = '#aaa'; } else { document.body.removeChild(div); } return coordinates; } if (typeof module != 'undefined' && typeof module.exports != 'undefined') { module.exports = getCaretCoordinates; } else if(isBrowser){ window.getCaretCoordinates = getCaretCoordinates; } }()); var transliterationApp = function( $transliterable_elem, lang ) { this.$transliterable_elem = $transliterable_elem; this.lang = lang; }; transliterationApp.prototype.init = function() { var _this = this; this.setTransliterationElementType(); this.setSuggestionResolveFunction(); if( $( ".word-suggester" ).length == 0 ) { var suggesDiv = document.createElement( 'div' ); suggesDiv.className = "word-suggester"; suggesDiv.innerHTML = "<div class='word-input'></div><div class='suggestions'><div class='suggestion'></div></div>"; document.body.appendChild( suggesDiv ); } var $suggester_div = $( ".word-suggester" ); document.body.appendChild( $suggester_div.get(0) ); this.suggester = new Suggester( $suggester_div.get(0), _this.onSuggestionPicked, _this.$transliterable_elem, _this.isTransliterationInputType(), _this.lang ); this.suggester.init(); this.$transliterable_elem.on('keypress', _this.suppressKeypress.bind( _this )); this.$transliterable_elem.on('keydown', _this.suppressKeydown.bind( _this )); this.$transliterable_elem.on("click", function(event) { if( _this.suggester.getMode() && ( !$(event.target).closest('.word-suggester').length ) ) { _this.suggester.clear(); } }); }; function getFirstRange() { var sel = rangy.getSelection(); return sel.rangeCount ? sel.getRangeAt(0) : null; }; transliterationApp.prototype.onSuggestionPickedInsideDiv = function( word, eng_word ) { if (window.getSelection) { var text = ( word ? word : eng_word ) + "\u00A0"; sel = rangy.getSelection(); var range = getFirstRange(); if (range) { var text_node = document.createTextNode(text); range.insertNode( text_node ); range.setStartAfter( text_node ); /* sel.collapseToEnd(); */ sel.setSingleRange(range); } } }; transliterationApp.prototype.onSuggestionPickedInsideInput = function(word, eng_word) { /* console.log(':::::::Resolved with word ' + word + '::::::::') */ var text = ( word ? word : eng_word ) + " "; var startPos = this.content_holder.get(0).selectionStart; var endPos = this.content_holder.get(0).selectionEnd; var positon_after_selection = startPos + text.length ; var word = this.content_holder.get(0).value.substring(0, startPos) + text + this.content_holder.get(0).value.substring(endPos, this.content_holder.get(0).value.length); $( this.content_holder.get(0)).val( word ).change(); this.content_holder.get(0).selectionStart = this.content_holder.get(0).selectionEnd = positon_after_selection; }; function insertNodeAtRange() { var range = getFirstRange(); if (range) { var el = document.createElement("span"); el.className = "curWord"; range.insertNode(el); rangy.getSelection().setSingleRange(range); return el; } }; transliterationApp.prototype.setTransliterationElementType = function() { this.isInputTypeElement = this.$transliterable_elem.is("input,textarea") ? true : false; }; transliterationApp.prototype.setSuggestionResolveFunction = function() { this.onSuggestionPicked = this.isTransliterationInputType() ? this.onSuggestionPickedInsideInput : this.onSuggestionPickedInsideDiv; }; transliterationApp.prototype.isTransliterationInputType = function() { return this.isInputTypeElement; }; transliterationApp.prototype.suppressKeypress = function(e) { var keycode = e.keycode || e.which; var isShiftKey = e.shiftKey; var translation = new Translation( keycode, isShiftKey ); if( this.shouldPreventKeypress( translation ) ) { e.preventDefault(); this.sendKeyToSuggester( translation ); } }; transliterationApp.prototype.sendKeyToSuggester = function( translation ) { this.suggester.type( translation ); }; transliterationApp.prototype.shouldPreventKeypress = function( translation ) { /* var translation = new Translation( keycode ); */ return ( this.isNotBackspaceKey(translation) && !this.isKeydownActionKey(translation) && ( this.isNotKeypressActionKey(translation) || this.suggester.getMode() ) ); }; transliterationApp.prototype.isNotKeypressActionKey = function( translation ) { return ( translation.action != 'space' && translation.action != 'special_char' ); }; transliterationApp.prototype.isNotBackspaceKey = function( translation ) { return translation.action != 'backspace'; }; transliterationApp.prototype.suppressKeydown = function(e) { var keycode = e.keycode || e.which; var isShiftKey = e.shiftKey; var translation = new Translation( keycode, isShiftKey ); if( this.shouldPreventKeydown( translation ) ) { e.preventDefault(); this.sendKeyToSuggester( translation ); } }; transliterationApp.prototype.shouldPreventKeydown = function( translation ) { /* var translation = new Translation( keycode ); */ return ( this.isKeydownActionKey(translation) && this.suggester.getMode() ); }; transliterationApp.prototype.isKeydownActionKey = function( translation ) { if( this.isTransliterationInputType() ) { return ( translation.action == 'up' || translation.action == 'down' || translation.action == 'left' || translation.action == 'right' || translation.action == 'escape' || translation.action == 'tab' || translation.action == 'backspace'); } else { return ( translation.action == 'up' || translation.action == 'down' || translation.action == 'left' || translation.action == 'right' || translation.action == 'escape' ); } }; window.onload = function() { if(screen.width > 480) { rangy.init(); } }; </script> <script> /* Helper functions not specific to Pratilipi */ function isMobile() { return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test( navigator.userAgent ); } function isAndroid() { return /Android/i.test( navigator.userAgent ); } function isChrome() { return /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor); } function openInNewTab(url) { var win = window.open(url, '_blank'); win.focus(); } function getAndroidIntentUri( utmParameters ) { var SCHEME = 'http'; var PACKAGE_NAME = 'com.pratilipi.mobile.android'; var PLAYSTORE_URL = 'https://play.google.com/store/apps/details?id=' + PACKAGE_NAME; var UTM_PARAMETER = utmParameters ? encodeURIComponent( Object.keys(utmParameters).map(function(key){ return key + "=" + utmParameters[key] }).join("&") ) : ""; var uri = window.location.host + window.location.pathname + ( window.location.search || '' ); return isChrome() ? 'intent://' + uri + '#Intent;scheme=' + SCHEME + ';package=' + PACKAGE_NAME + ';S.browser_fallback_url=' + PLAYSTORE_URL + '&referrer=' + UTM_PARAMETER + ';end' : 'intent://' + uri + '#Intent;scheme=' + SCHEME + ';package=' + PACKAGE_NAME + ';S.browser_fallback_url=' + 'market://search?q=pname:' + PACKAGE_NAME + '&referrer=' + UTM_PARAMETER + ';end' ; } function getUrlParameter( variable ) { var query = window.location.search.substring(1); var vars = query.split( "&" ); for( var i=0; i<vars.length; i++ ) { var pair = vars[i].split( "=" ); if( pair[0] == variable ) { return pair[1]; } } return null; } function getUrlParameters() { var str = decodeURI( location.search.substring(1) ), res = str.split("&"), retObj = {}; for( var i = 0; i < res.length; i++ ){ var key = res[i].substring( 0, res[i].indexOf( '=' ) ); var value = res[i].substring( res[i].indexOf( '=' ) + 1 ); retObj[ key ] = value; } if( retObj[""] != null ) delete retObj[""]; return retObj; } function setCookie( name, value, days, path ) { var expires = ""; if( days ) { var date = new Date(); date.setTime( date.getTime() + ( days * 24 * 60 * 60 * 1000 ) ); expires = "expires=" + date.toGMTString() + ";"; } document.cookie = name + "=" + ( value ? value : "" ) + ";" + expires + "path=" + ( path ? path : '/' ); } function getCookie( cname ) { var name = cname + "="; var ca = document.cookie.split( ';' ); for( var i = 0; i < ca.length; i++ ) { var c = ca[i]; while( c.charAt(0) == ' ' ) c = c.substring( 1 ); if( c.indexOf( name ) == 0 ) return c.substring( name.length, c.length ); } return null; } function validateEmail( email ) { if( email == null ) return false; var re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/; return re.test( email ); } function validatePhone( phone ) { if( phone == null ) return false; var pattern = /^[0-9]{10}$/; return pattern.test( phone ); } function validatePassword( password ) { if( password == null ) return false; var re = /^[a-zA-Z0-9\[\]\{\}\(\)\#\;\:\^\,\.\?\!\|\&\_\`\~\@\$\%\/\\\+\-\*\=\'\"]{6,128}$/; return re.test( password ); } function isEmpty( obj ) { for( var prop in obj ) { if( obj.hasOwnProperty( prop ) ) return false; } return JSON.stringify( obj ) === JSON.stringify( {} ); } function roundOffToOneDecimal( number ) { return Math.round( number * 10 ) / 10; } /* https://stackoverflow.com/questions/10599933/convert-long-number-into-abbreviated-string-in-javascript-with-a-special-shortn */ function abbrNum( num, fixed ) { if( num === null ) { return null; } if( num === 0 ) { return '0'; } fixed = (!fixed || fixed < 0) ? 0 : fixed; var b = (num).toPrecision(2).split("e"), k = b.length === 1 ? 0 : Math.floor(Math.min(b[1].slice(1), 14) / 3), c = k < 1 ? num.toFixed(0 + fixed) : (num / Math.pow(10, k * 3) ).toFixed(1 + fixed), d = c < 0 ? c : Math.abs(c), e = d + ['', 'K', 'M', 'B', 'T'][k]; return e; } function commaSeparatedNumber(x) { return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); } function capitalizeFirstLetter( string ) { return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase(); }/* HttpUtil */ var HttpUtil = function() { function processResponseText( repsonseText ) { var res = {}; try { res = JSON.parse( repsonseText ); } catch( err ) { res[ "message" ] = "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!"; } return res; }; this.formatParams = function( params ) { if( params == null ) return ""; if( typeof( params ) === "string" ) return params; return Object.keys( params ).map( function(key) { return key + "=" + params[key] }).join("&"); }; this.get = function( aUrl, headers, params, aCallback ) { var anHttpRequest = new XMLHttpRequest(); anHttpRequest.onreadystatechange = function() { if( anHttpRequest.readyState == 4 && aCallback != null ) aCallback( processResponseText( anHttpRequest.responseText ), anHttpRequest.status ); }; anHttpRequest.open( "GET", aUrl + ( aUrl.indexOf( "?" ) > -1 ? "&" : "?" ) + this.formatParams( params ), true ); anHttpRequest.setRequestHeader( "Content-type", "application/x-www-form-urlencoded" ); if( headers != null ) { for( var key in headers ) if( headers.hasOwnProperty(key) ) anHttpRequest.setRequestHeader( key, headers[key] ); } anHttpRequest.send( null ); }; this.post = function( aUrl, headers, params, aCallback ) { if( 'onLine' in navigator ) { if( ! navigator[ 'onLine' ] ) { aCallback( { "message": "ಸರ್ವರ್'ಗೆ ಕನೆಕ್ಟ್ ಮಾಡಲು ಆಗುತ್ತಿಲ್ಲ!" }, 0 ); return; } } var anHttpRequest = new XMLHttpRequest(); anHttpRequest.onreadystatechange = function() { if( anHttpRequest.readyState == 4 && aCallback != null ) aCallback( processResponseText( anHttpRequest.responseText ), anHttpRequest.status ); }; anHttpRequest.open( "POST", aUrl, true ); anHttpRequest.setRequestHeader( "Content-type", "application/x-www-form-urlencoded" ); if( headers != null ) { for( var key in headers ) if( headers.hasOwnProperty(key) ) anHttpRequest.setRequestHeader( key, headers[key] ); } anHttpRequest.send( this.formatParams( params ) ); }; this.patch = function( aUrl, headers, params, aCallback ) { if( 'onLine' in navigator ) { if( ! navigator[ 'onLine' ] ) { aCallback( { "message": "ಸರ್ವರ್'ಗೆ ಕನೆಕ್ಟ್ ಮಾಡಲು ಆಗುತ್ತಿಲ್ಲ!" }, 0 ); return; } } var anHttpRequest = new XMLHttpRequest(); anHttpRequest.onreadystatechange = function() { if( anHttpRequest.readyState == 4 && aCallback != null ) aCallback( processResponseText( anHttpRequest.responseText ), anHttpRequest.status ); }; anHttpRequest.open( "PATCH", aUrl, true ); anHttpRequest.setRequestHeader( "Content-type", "application/x-www-form-urlencoded" ); if( headers != null ) { for( var key in headers ) if( headers.hasOwnProperty(key) ) anHttpRequest.setRequestHeader( key, headers[key] ); } anHttpRequest.send( this.formatParams( params ) ); }; this.getCORS = function( aUrl, headers, params, aCallback ) { function createCORSRequest( method, url ) { var anHttpRequest = new XMLHttpRequest(); /* anHttpRequest.withCredentials = true; */ if( "withCredentials" in anHttpRequest ) { anHttpRequest.open( method, url, true ); } else if( typeof XDomainRequest != "undefined" ) { anHttpRequest = new XDomainRequest(); anHttpRequest.open( method, url ); } else { anHttpRequest = null; } return anHttpRequest; } var anHttpRequest = createCORSRequest( 'GET', aUrl + ( aUrl.indexOf( "?" ) > -1 ? "&" : "?" ) + this.formatParams( params ) ); if( !anHttpRequest ) { console.log( 'CORS not supported by browser.' ); return; } anHttpRequest.setRequestHeader( "Content-type", "application/x-www-form-urlencoded" ); if( headers != null ) { for( var key in headers ) if( headers.hasOwnProperty(key) ) anHttpRequest.setRequestHeader( key, headers[key] ); } anHttpRequest.onload = function() { aCallback( processResponseText( anHttpRequest.responseText ), anHttpRequest.status ); }; anHttpRequest.onerror = function( e ) { console.log( 'Error making the request: ', e ); }; anHttpRequest.send(); }; }; /* Toaster & SnackBar */ var snackbarContainer = document.createElement( 'div' ); snackbarContainer.id = "pratilipi-toast"; snackbarContainer.style.zIndex = "1051"; snackbarContainer.className = "mdl-js-snackbar mdl-snackbar"; snackbarContainer.innerHTML = '<div class="mdl-snackbar__text"></div><button class="mdl-snackbar__action" type="button"></button>'; document.body.appendChild( snackbarContainer ); var ToastUtil = (function() { return { toastCallBack: function( message, timeout, actionText, actionHandler ) { if( message == null || timeout == null ) return; var data = { message: message, timeout: timeout }; if( actionText ) { data[ "actionHandler" ] = actionHandler; data[ "actionText" ] = actionText; } setTimeout( function() { snackbarContainer.MaterialSnackbar.showSnackbar( data ); }, 1 ); }, toast: function( message, timeout, includeCloseButton ) { if( includeCloseButton ) this.toastCallBack( message, timeout == null ? 2000 : timeout, "x", this.toastDown ); else this.toastCallBack( message, timeout == null ? 2000 : timeout, null, null ); }, toastUp: function( message ) { var snackbarText = document.querySelector( '.mdl-snackbar__text' ); snackbarText.innerHTML = message; setTimeout( function() { snackbarContainer.classList.add( "mdl-snackbar--active" ); }, 1 ); }, toastDown: function( count ) { /* snackbarContainer.MaterialSnackbar.cleanup_(); */ /* As cleanup_ is not part of the public api and buggy, we are not using it. */ /* Removing "mdl-snackbar--active" woduln't allow additional toasts to display until that long timeout is completed */ setTimeout( function() { snackbarContainer.classList.remove( "mdl-snackbar--active" ); }, 1 ); } }; })();var metaTagProperty = function( property, content ) { return { "property": property, "content": content }; }; var metaTagItemprop = function( itemprop, content ) { return { "itemprop": itemprop, "content": content }; }; var metaTagName = function( name, content ) { return { "name": name, "content": content }; }; var MetaTagUtil = (function() { return { /* Helpers */ __exists: function( stringVal ) { return stringVal && stringVal.trim() !== ""; }, __stripTextFromHtml: function( html ) { var tmp = document.createElement( "div" ); tmp.innerHTML = html; var text = tmp.textContent || tmp.innerText || ""; return text.replace(/&nbsp;/g, "").trim(); }, __processString: function( dataModel, i18nString ) { i18nString = i18nString.replace(/\s+(?=[^{\]]*\})/g, ''); for( var key in dataModel ) { if( dataModel.hasOwnProperty( key ) ) { i18nString = i18nString.replace(new RegExp('@{'+key+'}', 'g'), dataModel[key]); } } return i18nString; }, __getPageTitle: function( dataModel, template, templateEn ) { var contentTitle = this.__processString( dataModel, template ), contentTitleEn = this.__processString( dataModel, templateEn ); return ( this.__exists( contentTitle ) ? contentTitle + " « " : "" ) + " ಪ್ರತಿಲಿಪಿ " + "ಕನ್ನಡ" + " | " + ( this.__exists( contentTitleEn ) ? contentTitleEn + " « " : "" ) + " Pratilipi " + "Kannada"; }, __setMeta: function( pageTitle, pageDescription, metaTagArray ) { /* Setting pageTitle */ if( pageTitle ) appViewModel.pageTitle( pageTitle ); /* Setting pageDescription */ if( pageDescription ) appViewModel.pageDescription( pageDescription ); /* Appending metaTags */ if( metaTagArray ) appViewModel.metaTags( metaTagArray ); }, __createMetaTagArray: function( title, description, pageUrl, imageUrl ) { /* Defaults */ if( !title ) title = "ಪ್ರತಿಲಿಪಿ | Pratilipi"; if( !description ) description = "ಕನ್ನಡ, ಹಿಂದಿ,ಗುಜರಾತಿ,ತಮಿಳು, ತೆಲುಗು, ಮಲಯಾಳಂ,ಮರಾಠಿ,ಬೆಂಗಾಲಿ ಕಥೆ, ಕವನ ಮತ್ತು ಪುಸ್ತಕಗಳನ್ನು ಓದಿರಿ. | Read Books, Stories, Poems and Articles in your language."; if( !pageUrl ) pageUrl = window.location.href; if( !imageUrl ) imageUrl = "http://public.pratilipi.com/pratilipi-logo/png/Logo-2C-RGB-200px.png"; var metaTagArray = []; /* Google+ Data */ metaTagArray.push( new metaTagItemprop( "name", title ) ); metaTagArray.push( new metaTagItemprop( "description", description ) ); metaTagArray.push( new metaTagItemprop( "image", imageUrl ) ); /* Twitter Card data */ /* https://developer.twitter.com/en/docs/tweets/optimize-with-cards/guides/getting-started */ metaTagArray.push( new metaTagName( "twitter:card", "summary" ) ); metaTagArray.push( new metaTagName( "twitter:site", "@TeamPratilipi" ) ); metaTagArray.push( new metaTagName( "twitter:domain", "https://twitter.com/TeamPratilipi" ) ); metaTagArray.push( new metaTagName( "twitter:title", title ) ); metaTagArray.push( new metaTagName( "twitter:description", description ) ); metaTagArray.push( new metaTagName( "twitter:image", imageUrl ) ); /* Open Graph/Facebook data */ metaTagArray.push( new metaTagProperty( "fb:app_id", "293990794105516" ) ); metaTagArray.push( new metaTagProperty( "og:locale", "kn_IN" ) ); metaTagArray.push( new metaTagProperty( "og:title", title ) ); metaTagArray.push( new metaTagProperty( "og:description", description ) ); metaTagArray.push( new metaTagProperty( "og:url", pageUrl ) ); metaTagArray.push( new metaTagProperty( "og:image", imageUrl ) ); return metaTagArray; }, /* Author */ _createAuthorPageTitle: function( author ) { return this.__getPageTitle( { authorName: author.fullName || author.fullNameEn, authorNameEn: author.fullNameEn || author.fullName, language: author.language || 'ENGLISH' }, "@{ authorName }", "@{ authorNameEn }" ); }, _createAuthorSeoTitle: function( author ) { if( !author ) return null; if( this.__exists( author.fullName ) && this.__exists( author.fullNameEn ) ) return author.fullName + " / " + author.fullNameEn; else if( this.__exists( author.fullName ) ) return author.fullName; else if( this.__exists( author.fullNameEn ) ) return author.fullNameEn; else return null; }, _createAuthorPageDescription: function( author ) { /* if author.summary => substr(0,155)... else "A platform to discover, read and share your favorite stories, poems and books in a language, device and format of your choice." */ if( ! this.__exists( author.summary ) ) return "A platform to discover, read and share your favorite stories, poems and books in a language, device and format of your choice."; if ( author.summary.length > 156 ) return author.summary.substr( 0, 153 ) + "..."; return author.summary; }, setMetaTagsForAuthor: function( author ) { var mainTitle = this._createAuthorPageTitle( author ), seoTitle = this._createAuthorSeoTitle( author ), pageDescription = this._createAuthorPageDescription( author ), authorPageUrl = "https://kannada.pratilipi.com" + author.pageUrl, /* Warning: Changing it to anything else will cause loss of like-share count */ authorImageUrl = getImageUrl( author.coverImageUrl, 200 ); /* Facebook needs minimum 200x200px image */ this.__setMeta( mainTitle, pageDescription, this.__createMetaTagArray( seoTitle, pageDescription, authorPageUrl, authorImageUrl ) ); }, /* Pratilipi */ _createPratilipiPageTitle: function( pratilipi ) { return this.__getPageTitle( { authorName: pratilipi.author.fullName || pratilipi.author.fullNameEn, authorNameEn: pratilipi.author.fullNameEn || pratilipi.author.fullName, pratilipiTitle: pratilipi.title || pratilipi.titleEn || pratilipi.displayTitle, pratilipiTitleEn: pratilipi.titleEn || pratilipi.title || pratilipi.displayTitle, language: pratilipi.language || 'ENGLISH' }, "@{ authorName }'s content @{ pratilipiTitle } Summary", "@{ authorNameEn }'s content @{ pratilipiTitleEn } Summary" ); }, _createPratilipiSeoTitle: function( pratilipi ) { if( !pratilipi ) return null; var authorTitle = this._createAuthorSeoTitle( pratilipi.author ); authorTitle = authorTitle == null ? "" : " « " + authorTitle; if( this.__exists( pratilipi.title ) && this.__exists( pratilipi.titleEn ) ) return pratilipi.title + " / " + pratilipi.titleEn + authorTitle; else if( this.__exists( pratilipi.title ) ) return pratilipi.title + authorTitle; else if( this.__exists( pratilipi.titleEn ) ) return pratilipi.titleEn + authorTitle; else return null; }, _createPratilipiPageDescription: function( pratilipi ) { /* if pratilipi.summary => substr(0,155)... else "A platform to discover, read and share your favorite stories, poems and books in a language, device and format of your choice." */ if( ! this.__exists( pratilipi.summary ) ) return "A platform to discover, read and share your favorite stories, poems and books in a language, device and format of your choice."; if ( pratilipi.summary.length > 156 ) return pratilipi.summary.substr( 0, 153 ) + "..."; return pratilipi.summary; }, setMetaTagsForPratilipi: function( pratilipi ) { var mainTitle = this._createPratilipiPageTitle( pratilipi ), seoTitle = this._createPratilipiSeoTitle( pratilipi ), pageDescription = this._createPratilipiPageDescription( pratilipi ), pratilipiPageUrl = "https://kannada.pratilipi.com" + pratilipi.pageUrl, /* Warning: Changing it to anything else will cause loss of like-share count */ pratilipiImageUrl = getImageUrl( pratilipi.coverImageUrl, 200 ); /* Facebook needs minimum 200x200px image */ var metaTagArray = this.__createMetaTagArray( seoTitle, pageDescription, pratilipiPageUrl, pratilipiImageUrl ); metaTagArray.push( new metaTagProperty( "og:type", "books.book" ) ); this.__setMeta( mainTitle, pageDescription, metaTagArray ); }, /* Reader */ _createReaderPageTitle: function( pratilipi ) { return this.__getPageTitle( { authorName: pratilipi.author.fullName || pratilipi.author.fullNameEn, authorNameEn: pratilipi.author.fullNameEn || pratilipi.author.fullName, pratilipiTitle: pratilipi.title || pratilipi.titleEn || pratilipi.displayTitle, pratilipiTitleEn: pratilipi.titleEn || pratilipi.title || pratilipi.displayTitle, language: pratilipi.language || 'ENGLISH' }, "@{ authorName } ಅವರ ಕನ್ನಡ ಕಥೆ @{ pratilipiTitle } ಅನ್ನು ಪ್ರತಿಲಿಪಿಯಲ್ಲಿ ಓದಿರಿ", "Read @{ authorNameEn }'s @{ language } content @{ pratilipiTitleEn } on Pratilipi" ); }, setMetaTagsForReader: function( pratilipi ) { var mainTitle = this._createReaderPageTitle( pratilipi ), seoTitle = this._createPratilipiSeoTitle( pratilipi ), pageDescription = this._createPratilipiPageDescription( pratilipi ), readerPageUrl = "https://kannada.pratilipi.com" + pratilipi.pageUrl, /* Warning: Changing it to anything else will cause loss of like-share count */ readerImageUrl = getImageUrl( pratilipi.coverImageUrl, 200 ); /* Facebook needs minimum 200x200px image */ var metaTagArray = this.__createMetaTagArray( seoTitle, pageDescription, readerPageUrl, readerImageUrl ); metaTagArray.push( new metaTagProperty( "og:type", "books.book" ) ); this.__setMeta( mainTitle, pageDescription, metaTagArray ); }, /* Home */ _createHomePageTitle: function() { return this.__getPageTitle( { language: "KANNADA".toLocaleLowerCase() }, "ಕನ್ನಡ ಕಥೆಗಳು, ಕವನಗಳು ಮತ್ತು ಪುಸ್ತಕಗಳನ್ನು ಪ್ರತಿಲಿಪಿಯಲ್ಲಿ ಓದಿರಿ", "Read @{ language } Stories, Poems and Books" ); }, setMetaTagsForHome: function() { var mainTitle = this._createHomePageTitle(), pageDescription = "ಕನ್ನಡ, ಹಿಂದಿ,ಗುಜರಾತಿ,ತಮಿಳು, ತೆಲುಗು, ಮಲಯಾಳಂ,ಮರಾಠಿ,ಬೆಂಗಾಲಿ ಕಥೆ, ಕವನ ಮತ್ತು ಪುಸ್ತಕಗಳನ್ನು ಓದಿರಿ. | Read Books, Stories, Poems and Articles in your language."; this.__setMeta( mainTitle, pageDescription, this.__createMetaTagArray( mainTitle, pageDescription ) ); }, /* List */ _createListPageTitle: function( list ) { return this.__getPageTitle( { listTitle: list.title || list.titleEn, listTitleEn: list.titleEn || list.title }, "@{ listTitle }", "@{ listTitleEn }" ); }, setMetaTagsForList: function( list ) { var mainTitle = this._createListPageTitle( list ), pageDescription = "ಕನ್ನಡ, ಹಿಂದಿ,ಗುಜರಾತಿ,ತಮಿಳು, ತೆಲುಗು, ಮಲಯಾಳಂ,ಮರಾಠಿ,ಬೆಂಗಾಲಿ ಕಥೆ, ಕವನ ಮತ್ತು ಪುಸ್ತಕಗಳನ್ನು ಓದಿರಿ. | Read Books, Stories, Poems and Articles in your language."; this.__setMeta( mainTitle, pageDescription, this.__createMetaTagArray( mainTitle, pageDescription ) ); }, /* Library */ _createLibraryPageTitle: function() { return this.__getPageTitle( { language: "KANNADA".toLocaleLowerCase() }, "ಪ್ರತಿಲಿಪಿಯಲ್ಲಿನ ನಿಮ್ಮ ಸಂರಕ್ಷಿತ ಕಥೆಗಳು, ಕವನಗಳು ಮತ್ತು ಪುಸ್ತಕಗಳು", "Your Saved Stories, Poems and Books" ); }, setMetaTagsForLibrary: function() { var libraryTitle = this._createLibraryPageTitle(); this.__setMeta( libraryTitle, null, this.__createMetaTagArray( libraryTitle ) ); }, /* Search */ _createSearchPageTitle: function() { return this.__getPageTitle( { language: "KANNADA".toLocaleLowerCase() }, "ನಿಮ್ಮ ನೆಚ್ಚಿನ ಕನ್ನಡ ಕಥೆಗಳು, ಬರಹಗಾರರು ಮತ್ತು ಇನ್ನೂ ಅನೇಕ ಸಂಗತಿಗಳಿಗಾಗಿ ಪ್ರತಿಲಿಪಿಯಲ್ಲಿ ಹುಡುಕಿ", "Search for your favorite Stories, Writers and a lot more on Pratilipi" ); }, setMetaTagsForSearch: function() { var searchTitle = this._createSearchPageTitle(); this.__setMeta( searchTitle, null, this.__createMetaTagArray( searchTitle ) ); }, /* Notifications */ _createNotificationPageTitle: function() { return this.__getPageTitle( { language: "KANNADA".toLocaleLowerCase() }, "ಪ್ರತಿಲಿಪಿಯಲ್ಲಿನ ನಿಮ್ಮ ನೋಟಿಫಿಕೇಶನ್ಸ್", "Your notifications on Pratilipi" ); }, setMetaTagsForNotification: function() { var notificationTitle = this._createNotificationPageTitle(); this.__setMeta( notificationTitle, null, this.__createMetaTagArray( notificationTitle ) ); }, /* Events */ _createEventsPageTitle: function() { return this.__getPageTitle( { language: "KANNADA".toLocaleLowerCase() }, "ಆನ್ಲೈನ್ ಸ್ಪರ್ಧೆಗಳು", "Online Competitions" ); }, setMetaTagsForEvents: function() { var eventsTitle = this._createEventsPageTitle(); this.__setMeta( eventsTitle, null, this.__createMetaTagArray( eventsTitle ) ); }, /* Event */ _createEventPageTitle: function( event ) { return this.__getPageTitle( { eventName: event.name || event.nameEn, eventNameEn: event.nameEn || event.name, language: event.language.toLocaleLowerCase() }, "@{ eventName }", "@{ eventNameEn }" ); }, _createEventSeoTitle: function( event ) { if( !event ) return null; if( this.__exists( event.name ) && this.__exists( event.nameEn ) ) return event.name + " / " + event.nameEn; else if( this.__exists( event.name ) ) return event.name; else if( this.__exists( event.nameEn ) ) return event.nameEn; else return null; }, _createEventPageDescription: function( event ) { /* if event.description => substr(0,155)... else "A platform to discover, read and share your favorite stories, poems and books in a language, device and format of your choice." */ if( ! this.__exists( event.description ) ) return "A platform to discover, read and share your favorite stories, poems and books in a language, device and format of your choice."; var description = this.__stripTextFromHtml( event.description ); if ( description.length > 156 ) return description.substr( 0, 153 ) + "..."; return description; }, setMetaTagsForEvent: function( event ) { var mainTitle = this._createEventPageTitle( event ), seoTitle = this._createEventSeoTitle( event ), pageDescription = this._createEventPageDescription( event ), eventPageUrl = "https://kannada.pratilipi.com" + event.pageUrl, /* Warning: Changing it to anything else will cause loss of like-share count */ eventImageUrl = getImageUrl( event.bannerImageUrl, 200 ); /* Facebook needs minimum 200x200px image */ this.__setMeta( mainTitle, pageDescription, this.__createMetaTagArray( seoTitle, pageDescription, eventPageUrl, eventImageUrl ) ); }, /* Login */ _createLoginPageTitle: function() { return this.__getPageTitle( { language: "KANNADA".toLocaleLowerCase() }, "ಪ್ರತಿಲಿಪಿಗೆ ಲಾಗಿನ್ ಆಗಿ", "Login to Pratilipi" ); }, setMetaTagsForLogin: function() { var loginTitle = this._createLoginPageTitle(); this.__setMeta( loginTitle, null, this.__createMetaTagArray( loginTitle ) ); }, /* Register */ _createRegisterPageTitle: function() { return this.__getPageTitle( { language: "KANNADA".toLocaleLowerCase() }, "ಪ್ರತಿಲಿಪಿಯಲ್ಲಿ ನಿಮ್ಮ ಖಾತೆ ತೆರೆಯಿರಿ", "Make your account on Pratilipi" ); }, setMetaTagsForRegister: function() { var registerTitle = this._createRegisterPageTitle(); this.__setMeta( registerTitle, null, this.__createMetaTagArray( registerTitle ) ); }, /* Forgot Password */ _createForgotPasswordPageTitle: function() { return this.__getPageTitle( { language: "KANNADA".toLocaleLowerCase() }, "ನಿಮ್ಮ ಪಾಸ್ವರ್ಡ್ ರೀಸೆಟ್ ಮಾಡಿ", "Reset Your Password - Pratilipi" ); }, setMetaTagsForForgotPassword: function() { var forgotPasswordTitle = this._createForgotPasswordPageTitle(); this.__setMeta( forgotPasswordTitle, null, this.__createMetaTagArray( forgotPasswordTitle ) ); }, /* Reset Password */ _createResetPasswordPageTitle: function() { return this.__getPageTitle( { language: "KANNADA".toLocaleLowerCase() }, "ಪಾಸ್ವರ್ಡ್ ಅಪ್ಡೇಟ್", "Update Password" ); }, setMetaTagsForResetPassword: function() { var resetPasswordTitle = this._createResetPasswordPageTitle(); this.__setMeta( resetPasswordTitle, null, this.__createMetaTagArray( resetPasswordTitle ) ); }, /* Blog */ _createBlogPageTitle: function() { return this.__getPageTitle( { language: "KANNADA".toLocaleLowerCase() }, "ಪ್ರತಿಲಿಪಿ ಕನ್ನಡ ಬ್ಲಾಗ್ ಮತ್ತು ಸಂಪಾದಕೀಯ", "Blog and Editorial" ); }, setMetaTagsForBlog: function() { var blogTitle = this._createBlogPageTitle(); this.__setMeta( blogTitle, null, this.__createMetaTagArray( blogTitle ) ); }, /* Author Interview */ _createAuthorInterviewPageTitle: function() { return this.__getPageTitle( { language: "KANNADA".toLocaleLowerCase() }, "ಪ್ರತಿಲಿಪಿ ಕನ್ನಡದಲ್ಲಿನ ಜನಪ್ರಿಯ ಬರಹಗಾರರ ಸಂದರ್ಶನಗಳು", "Interviews with Popular Writers" ); }, setMetaTagsForAuthorInterview: function() { var authorInterviewTitle = this._createAuthorInterviewPageTitle(); this.__setMeta( authorInterviewTitle, null, this.__createMetaTagArray( authorInterviewTitle ) ); }, /* Blog Post */ _createBlogPostPageTitle: function( blogPost ) { return this.__getPageTitle( { blogTitle: blogPost.title || blogPost.titleEn, blogTitleEn: blogPost.titleEn || blogPost.title, language: blogPost.language || 'ENGLISH' }, "@{ blogTitle }", "@{ blogTitleEn }" ); }, _createBlogPostSeoTitle: function( blogPost ) { if( !blogPost ) return null; if( this.__exists( blogPost.title ) && this.__exists( blogPost.title ) ) return blogPost.title + " / " + blogPost.titleEn; else if( this.__exists( blogPost.title ) ) return blogPost.title; else if( this.__exists( blogPost.titleEn ) ) return blogPost.titleEn; else return null; }, _createBlogPostPageDescription: function( blogPost ) { /* if blogPost.content => substr(0,155)... else "A platform to discover, read and share your favorite stories, poems and books in a language, device and format of your choice." */ if( ! this.__exists( blogPost.content ) ) return "A platform to discover, read and share your favorite stories, poems and books in a language, device and format of your choice."; var content = this.__stripTextFromHtml( blogPost.content ); if ( content.length > 156 ) return content.substr( 0, 153 ) + "..."; return content; }, setMetaTagsForBlogPost: function( blogPost ) { var mainTitle = this._createBlogPostPageTitle( blogPost ), seoTitle = this._createBlogPostSeoTitle( blogPost ), pageDescription = this._createBlogPostPageDescription( blogPost ), blogPostPageUrl = "https://kannada.pratilipi.com" + blogPost.pageUrl; /* Warning: Changing it to anything else will cause loss of like-share count */ this.__setMeta( mainTitle, pageDescription, this.__createMetaTagArray( seoTitle, pageDescription, blogPostPageUrl ) ); }, /* Videoseries List */ _createVideoseriesListPageTitle: function() { return this.__getPageTitle( { language: "KANNADA".toLocaleLowerCase() }, "Video Series List in Pratilipi", "Video Series List in Pratilipi" ); }, setMetaTagsForVideoseriesList: function() { var videoseriesTitle = this._createVideoseriesListPageTitle(); this.__setMeta( videoseriesTitle, null, this.__createMetaTagArray( videoseriesTitle ) ); }, /* Videoseries */ _createVideoseriesPageTitle: function( videoseries ) { return this.__getPageTitle( { videoseriesName: videoseries.name || videoseries.nameEn, videoseriesNameEn: videoseries.nameEn || videoseries.name, language: videoseries.language.toLocaleLowerCase() }, "@{ videoseriesName }", "@{ videoseriesNameEn }" ); }, _createVideoseriesSeoTitle: function( videoseries ) { if( !videoseries ) return null; if( this.__exists( videoseries.name ) && this.__exists( videoseries.nameEn ) ) return videoseries.name + " / " + videoseries.nameEn; else if( this.__exists( videoseries.name ) ) return videoseries.name; else if( this.__exists( videoseries.nameEn ) ) return videoseries.nameEn; else return null; }, _createVideoseriesPageDescription: function( videoseries ) { /* if videoseries.description => substr(0,155)... else "A platform to discover, read and share your favorite stories, poems and books in a language, device and format of your choice." */ if( ! this.__exists( videoseries.description ) ) return "A platform to discover, read and share your favorite stories, poems and books in a language, device and format of your choice."; var description = this.__stripTextFromHtml( videoseries.description ); if ( description.length > 156 ) return description.substr( 0, 153 ) + "..."; return description; }, setMetaTagsForVideoseries: function( videoseries ) { var mainTitle = this._createVideoseriesPageTitle( videoseries ), seoTitle = this._createVideoseriesSeoTitle( videoseries ), pageDescription = this._createVideoseriesPageDescription( videoseries ), videoseriesPageUrl = "https://kannada.pratilipi.com" + videoseries.pageUrl, /* Warning: Changing it to anything else will cause loss of like-share count */ videoseriesImageUrl = videoseries.imageUrl; this.__setMeta( mainTitle, pageDescription, this.__createMetaTagArray( seoTitle, pageDescription, videoseriesPageUrl, videoseriesImageUrl ) ); }, /* Video */ _createVideoPageTitle: function( video ) { return this.__getPageTitle( { videoName: video.name || video.nameEn, videoNameEn: video.nameEn || video.name, language: video.language.toLocaleLowerCase() }, "@{ videoName }", "@{ videoNameEn }" ); }, _createVideoSeoTitle: function( video ) { if( !video ) return null; if( this.__exists( video.name ) && this.__exists( video.nameEn ) ) return video.name + " / " + video.nameEn; else if( this.__exists( video.name ) ) return video.name; else if( this.__exists( video.nameEn ) ) return video.nameEn; else return null; }, _createVideoPageDescription: function( video ) { /* if video.description => substr(0,155)... else "A platform to discover, read and share your favorite stories, poems and books in a language, device and format of your choice." */ if( ! this.__exists( video.description ) ) return "A platform to discover, read and share your favorite stories, poems and books in a language, device and format of your choice."; var description = this.__stripTextFromHtml( video.description ); if ( description.length > 156 ) return description.substr( 0, 153 ) + "..."; return description; }, setMetaTagsForVideo: function( video ) { var mainTitle = this._createVideoPageTitle( video ), seoTitle = this._createVideoSeoTitle( video ), pageDescription = this._createVideoPageDescription( video ), videoPageUrl = "https://kannada.pratilipi.com" + video.pageUrl, /* Warning: Changing it to anything else will cause loss of like-share count */ videoImageUrl = video.imageUrl; this.__setMeta( mainTitle, pageDescription, this.__createMetaTagArray( seoTitle, pageDescription, videoPageUrl, videoImageUrl ) ); }, /* Static */ _createStaticPageTitle: function( pageContent ) { return this.__getPageTitle( { staticTitle: pageContent.title || pageContent.titleEn, staticTitleEn: pageContent.titleEn || pageContent.title, language: 'KANNADA'.toLocaleLowerCase() }, "@{ staticTitle }", "@{ staticTitleEn }" ); }, _createStaticSeoTitle: function( pageContent ) { if( !pageContent ) return null; if( this.__exists( pageContent.title ) && this.__exists( pageContent.titleEn ) ) return pageContent.title + " / " + pageContent.titleEn; else if( this.__exists( pageContent.title ) ) return pageContent.title; else if( this.__exists( pageContent.titleEn ) ) return pageContent.titleEn; else return null; }, _createStaticPageDescription: function( pageContent ) { /* if pageContent.content => substr(0,155)... else "A platform to discover, read and share your favorite stories, poems and books in a language, device and format of your choice." */ if( ! this.__exists( pageContent.content ) ) return "A platform to discover, read and share your favorite stories, poems and books in a language, device and format of your choice."; var content = this.__stripTextFromHtml( pageContent.content ); if ( content.length > 156 ) return content.substr( 0, 153 ) + "..."; return content; }, setMetaTagsForStatic: function( pageContent ) { var mainTitle = this._createStaticPageTitle( pageContent ), seoTitle = this._createStaticSeoTitle( pageContent ), pageDescription = this._createStaticPageDescription( pageContent ); this.__setMeta( mainTitle, pageDescription, this.__createMetaTagArray( seoTitle, pageDescription ) ); } }; })(); /* Helper functions specific to Pratilipi */ function getRetUrl( decoded ) { return getUrlParameter( "retUrl" ) == null ? "/" : ( decoded ? decodeURIComponent( getUrlParameter( "retUrl" ) ) : getUrlParameter( "retUrl" ) ); } function convertDate( date ) { var d = new Date( date ); function day(d) { return (d < 10) ? '0' + d : d; } function month(m) { var months = ['ಜನವರಿ','ಫೆಬ್ರವರಿ','ಮಾರ್ಚ್', 'ಏಪ್ರಿಲ್','ಮೇ','ಜೂನ್', 'ಜುಲೈ','ಆಗಸ್ಟ್','ಸೆಪ್ಟೆಂಬರ್', 'ಅಕ್ಟೋಬರ್','ನವೆಂಬರ್','ಡಿಸೆಂಬರ್']; return months[m]; } return [ day( d.getDate() ), month( d.getMonth() ), d.getFullYear() ].join(' '); } function convertDateWithMinutes( date ) { var d = new Date( date ); function weekday(d) { var days= [ "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" ]; return days[d]; } function day(d) { return (d < 10) ? '0' + d : d; } function getHoursMin( h, m ) { var suffix = ( h >= 12 ) ? 'PM' : 'AM'; var hours = h; hours = ( hours > 12 ) ? hours - 12 : hours; hours = ( hours == '00' ) ? 12 : hours; return ( hours + ":" + ( (m < 10) ? '0' + m : m ) + " " + suffix ); } function month(m) { var months = ['ಜನವರಿ','ಫೆಬ್ರವರಿ','ಮಾರ್ಚ್', 'ಏಪ್ರಿಲ್','ಮೇ','ಜೂನ್', 'ಜುಲೈ','ಆಗಸ್ಟ್','ಸೆಪ್ಟೆಂಬರ್', 'ಅಕ್ಟೋಬರ್','ನವೆಂಬರ್','ಡಿಸೆಂಬರ್']; return months[m]; } return [ weekday( d.getDay() ), day( d.getDate() ), month( d.getMonth() ), d.getFullYear(), getHoursMin( d.getHours(), d.getMinutes() ) ].join(' '); } function canRunExperiment( experimentName ) { if( !experimentName ) return false; if( appViewModel.isTestEnvironment ) return true; var bucketId = getCookie('bucketId') ? parseInt( getCookie('bucketId') ) : null; if( !bucketId ) return false; if( experimentName == "app_reader_001" ) { return isAndroid() && ( appViewModel.language == "HINDI" ) && ( bucketId >= 20 && bucketId < 40 ); } return false; } function shouldShowReadHelper(){ return isAndroid() && !getCookie( "readInAppTimeStamp" ); } function goToLoginPage( params, loginParams, retUrl ) { var redirectUrl; if( params == null || isEmpty( params ) ) redirectUrl= "/login?retUrl=" + encodeURIComponent( retUrl != null ? retUrl : window.location.pathname ); else redirectUrl= "/login?retUrl=" + encodeURIComponent( ( retUrl != null ? retUrl : window.location.pathname ) + "?" + new HttpUtil().formatParams( params ) ); if( loginParams != null && ! isEmpty( loginParams ) ) { redirectUrl += "&" + new HttpUtil().formatParams( loginParams ); } redirect( redirectUrl ); } function redirect( url, includeCurrentUrlParams ) { if( url == null ) return; if( includeCurrentUrlParams ) url = url + "?" + new HttpUtil().formatParams( getUrlParameters() ); if( sammy != null ) sammy.setLocation( url ); else window.location.href = url; } function sharePratilipiOnFacebook( url ) { window.open( "http://www.facebook.com/sharer.php?u=" + url, "share", "width=1100,height=500,left=70px,top=60px" ); } function sharePratilipiOnTwitter( url ) { window.open( "http://twitter.com/share?url=" + url, "share", "width=1100,height=500,left=70px,top=60px" ); } function sharePratilipiOnGplus( url ) { window.open( "https://plus.google.com/share?url=" + url, "share", "width=1100,height=500,left=70px,top=60px" ); } function sharePratilipiOnWhatsapp( text ) { window.open( "whatsapp://send?text=" + text ); } function getSupportedImageType() { function canUseWebP() { var elem = document.createElement( 'canvas' ); if( !!(elem.getContext && elem.getContext('2d')) ) { return elem.toDataURL( 'image/webp' ).indexOf( 'data:image/webp' ) == 0; } return false; } if( window.canUseWebp == null ) window.canUseWebp = canUseWebP(); return window.canUseWebp ? "webp" : "jpg"; } function getImageUrl( imageUrl, width, compressed ) { if( imageUrl == null ) return null; if( imageUrl.startsWith( "http://" ) && imageUrl.indexOf( "ptlp.co" ) !== -1 ) imageUrl = "https://" + imageUrl.substr(7); if( width != null ) imageUrl = imageUrl + ( imageUrl.indexOf( "?" ) > -1 ? "&" : "?" ) + "width=" + width; if( compressed != null ) imageUrl = imageUrl + ( imageUrl.indexOf( "?" ) > -1 ? "&" : "?" ) + "quality=" + ( compressed ? "low" : "high" ); imageUrl = imageUrl + ( imageUrl.indexOf( "?" ) > -1 ? "&" : "?" ) + "type=" + getSupportedImageType(); return imageUrl; } function getPratilipiTypeVernacular( pratilipiType ) { if( pratilipiType == null ) return null; var pratilipiTypes = { "BOOK": "ಪುಸ್ತಕ", "POEM": "ಕವಿತೆ", "STORY": "ಕಥೆ", "ARTICLE": "ಲೇಖನ", "MAGAZINE": "ನಿಯತಕಾಲಿಕೆ", }; return pratilipiTypes[ pratilipiType ]; } function getLanguageVernacular( language ) { if( language == null ) return null; var languages = { "HINDI": "हिंदी", "GUJARATI": "ગુજરાતી", "TAMIL": "தமிழ்", "MARATHI": "मराठी", "MALAYALAM": "മലയാളം", "BENGALI": "বাংলা", "TELUGU": "తెలుగు", "KANNADA": "ಕನ್ನಡ", }; return languages[ language ]; } function formatReadCount( readCount ) { if( readCount == null ) return null; if( isMobile() ) return readCount > 999 ? ( (readCount/1000).toFixed(1)[(readCount/1000).toFixed(1).length - 1] == 0 ? (readCount/1000).toFixed(0) + 'K' : (readCount/1000).toFixed(1) + 'K' ) : readCount; else return readCount.toLocaleString( 'en-US' ); } function formatReadingTime( readingTime ) { if( readingTime == null || isNaN(readingTime) ) return 0; else { var sec_num = readingTime; var hours = Math.floor(sec_num / 3600); var minutes = Math.round((sec_num - (hours * 3600)) / 60); var displayString = ""; if(hours > 1){ displayString = displayString.concat( hours + " " + 'ಗಂಟೆಗಳು' + " "); } else if (hours == 1) { displayString = displayString.concat( hours + " " + 'ಗಂಟೆ' + " "); } if(minutes > 1){ displayString = displayString.concat( minutes + " " + 'ನಿಮಿಷಗಳು'); } else if (minutes == 1) { displayString = displayString.concat( minutes + " " + 'ನಿಮಿಷ'); } if (displayString == "") displayString = "1 " + 'ನಿಮಿಷ'; return displayString; } } function getRandomQuote() { var arr = []; arr.push( { content: 'ಗೊಂದಲಗಳು, ಜಂಜಾಟಗಳು ನಮ್ಮ ಬರಹಗಳಿಗೆ ವಸ್ತುಗಳಾಗಲೆಂದೇ ಬರುವಂತಹವು. ಅವುಗಳ ಪಾಡಿಗೆ ಅವು ಬರಲಿ. ನಮ್ಮ ಓದು', name: 'ಬರಹಗಳೇ ಅವುಗಳಿಗೆ ಪರಿಹಾರ ನೀಡುತ್ತವೆ ## ಶ್ರೀಮಣಿ' } ); arr.push( { content: 'ಹೆಚ್ಚು ಓದಿದಷ್ಟೂ ನಮ್ಮ ಅಜ್ಞಾನ ತಿಳಿಯುತ್ತದೆ', name: 'ಶೆಲ್ಲಿ' } ); arr.push( { content: 'ನೀನು ಸತ್ತೊಡನೆ ಜನ ನಿನ್ನನ್ನು ಮರೆಯಬಾರದೆನ್ನುವುದಾದರೆ ಓದಬಹುದಾದನ್ನು ಬರೆ. ಇಲ್ಲವೇ ಬರೆಯಬಹುದಾದುದನ್ನು ಮಾಡು', name: 'ಫ್ರಾಂಕ್ಲಿನ್' } ); arr.push( { content: 'ಗ್ರಂಥವಿಲ್ಲದ ಕೋಣೆ ಆತ್ಮವಿಲ್ಲದ ದೇಹದಂತೆ', name: 'ಸಿಸಿರೋ' } ); arr.push( { content: 'ಪುಸ್ತಕ ಪ್ರೇಮವಿಲ್ಲದವನು ಹಣವಂತನಾದರೂ ದರಿದ್ರನೇ', name: 'ಲ್ಯಾಂಗ್ಫೋರ್ಡ್' } ); arr.push( { content: 'ಪುಸ್ತಕದ ಅವಹೆಳನವೇ ಜ್ಞಾನದ ಕೊಲೆ', name: 'ಜೆ.ಜೆ.ರೂಸೋ' } ); arr.push( { content: 'ಪುಸ್ತಕ ಓದುವ ಹವ್ಯಾಸವುಳ್ಳವನು ಎಲ್ಲಿಗೆ ಹೋದರೂ ಸಂತೋಷವಾಗಿರಬಲ್ಲ', name: 'ಗಾಂಧೀಜಿ' } ); arr.push( { content: 'ಪ್ರತಿಭೆ ಗುಡಿಸಿಲಲ್ಲಿ ಹುಟ್ಟುತ್ತದೆ; ಅರಮನೆಯಲ್ಲಿ ಸಾಯುತ್ತದೆ', name: 'ಷೇಕ್ಸ್ಪಿಯರ್' } ); arr.push( { content: 'ಪುಸ್ತಕಗಳ ಸಂಗ್ರಹವಷ್ಟೇ ಈ ದಿನಗಳ ನಿಜವಾದ ವಿಶ್ವವಿದ್ಯಾಲಯ', name: 'ಕಾರ್ಲೈಲ್' } ); arr.push( { content: 'ಒಳ್ಳೆಯ ಆಲೋಚನೆಗಳು ಎಲ್ಲೆಡೆಯಿಂದಲೂ ಬರಲಿ', name: 'ಋಗ್ವೇದ' } ); arr.push( { content: 'ಒಳ್ಳೆಯ ಚಿಂತನೆಗಳಿರುವವರು ಎಂದಿಗೂ ಒಬ್ಬಂಟಿಗರಲ್ಲ', name: 'ಪಿ.ಸಿಡ್ನಿ' } ); arr.push( { content: 'ಬುದ್ಧಿವಂತನಾದವನು ಪುಸ್ತಕಗಳು ಹಾಗೂ ಜೀವನ ಎರಡನ್ನೂ ಓದುತ್ತಾನೆ', name: 'ಲಿನ್ ಯುಟಾಂಗ್' } ); arr.push( { content: 'ನೀವು ಸ್ವರ್ಗವನ್ನು ಕಾಣಬೇಕಾದರೆ ಅನ್ಯರೊಡನೆ ಪ್ರೀತಿಯಿಂದ ನಡೆದುಕೊಳ್ಳಿ', name: 'ನೋವಾಲಿಸ್' } ); arr.push( { content: 'ನಮಗೆ ಜೀವಿಸಲು ಇರುವುದು ಒಂದೇ ಜೀವನ ಎನ್ನುವವನಿಗೆ ಸರಿಯಾಗಿ ಪುಸ್ತಕ ಓದಲು ತಿಳಿದಿಲ್ಲ ಎಂದರ್ಥ', name: 'ಅನಾಮಿಕ' } ); arr.push( { content: 'ಚಿನ್ನದ ಪ್ರತಿ ಎಳೆಯೂ ಯಾವ ರೀತಿ ಅಮೂಲ್ಯವೋ ಹಾಗೆಯೇ ಕಾಲದ ಪ್ರತಿಯೊಂದು ನಿಮಿಷವೂ ಅಮೂಲ್ಯ', name: 'ಸುಭಾಷಿತ' } ); arr.push( { content: 'ನಿಮ್ಮ ಮಗುವಿನ ಜಗತ್ತನ್ನು ವಿಸ್ತರಿಸಲು ಹಲವು ಪುಟ್ಟ ಮಾರ್ಗಗಳಿವೆ. ಅವುಗಳಲ್ಲಿ ಪುಸ್ತಕ ಪ್ರೀತಿ ಅತ್ಯುನ್ನತವಾದುದು', name: 'ಜಾಕ್ವೆಲಿನ್ ಕೆನಡಿ ಒನಾಸಿಸ್' } ); arr.push( { content: 'ಎಲ್ಲರೂ ಓದುವ ಪುಸ್ತಕಗಳನ್ನಷ್ಟೇ ನೀನೂ ಓದುತ್ತಿರುವೆ ಎನ್ನುವುದಾದರೆ ಎಲ್ಲರೂ ಯೋಚಿಸುವುದನ್ನಷ್ಟೇ ನೀನೂ ಯೋಚಿಸಬಲ್ಲೆ ಎಂದರ್ಥ', name: 'ಹರುಕಿ ಮುರಾಕಮಿ' } ); arr.push( { content: 'ಒಳ್ಳೆಯ ಪುಸ್ತಕದಲ್ಲಿ ಶ್ರೇಷ್ಠವಾದುದು ಸಾಲುಗಳ ನಡುವೆ ಇರುತ್ತದೆ', name: 'ಸ್ವೀಡಿಶ್ ಗಾದೆ' } ); arr.push( { content: 'ಸೇಡು ತೀರಿಸಿಕೊಳ್ಳಲು ಬಯಸುವುದಾದರೆ ನಿನ್ನ ಎದುರಾಳಿಯನ್ನು ಅಲಕ್ಷ್ಯ ಮಾಡು! ಅದೇ ಅತ್ಯುನ್ನತವಾದ ಮಾರ್ಗ', name: 'ಜಾರ್ಜ್ ಬರ್ನಾಡ್ ಷಾ' } ); arr.push( { content: 'ನಾವು ಅಪರೂಪದ ಬುದ್ಧಿಜೀವಿಯನ್ನು ಎದುರುಗೊಂಡರೆ ಅವರು ಯಾವ ಪುಸ್ತಕಗಳನ್ನು ಓದುತ್ತಾರೆ ಎಂದು ಕೇಳಬೇಕು', name: 'ರಾಲ್ಫ್ ವಾಲ್ಡೋ ಎಮರ್ಸನ್' } ); arr.push( { content: 'ಪುಸ್ತಕ ಓದುವುದನ್ನು ಮತ್ತೆಮತ್ತೆ ಆಸ್ವಾದಿಸಲಾರದವನು ಪುಸ್ತಕವನ್ನು ಓದುವುದರಲ್ಲಿ ಯಾವ ಪ್ರಯೋಜನವೂ ಇಲ್ಲ', name: 'ಆಸ್ಕರ್ ವೈಲ್ಡ್' } ); arr.push( { content: 'ನೀವು ಓದಿರದ ಪುಸ್ತಕವನ್ನು ನಿಮ್ಮ ಮಗುವಿಗೆ ಓದಲು ನೀಡುವುದಿಲ್ಲ ಎನ್ನುವ ನಿಯಮ ಹಾಕಿಕೊಳ್ಳಿ', name: 'ಜಾರ್ಜ್ ಬರ್ನಾಡ್ ಷಾ' } ); arr.push( { content: 'ಪುಸ್ತಕಗಳನ್ನು ಸುಟ್ಟುಹಾಕುವುದಕ್ಕಿಂತಲೂ ಘೋರವಾದ ಅಪರಾಧಗಳಿವೆ. ಅವುಗಳಲ್ಲಿ ಒಂದು ಪುಸ್ತಕಗಳನ್ನು ಓದದೇ ಇರುವುದು!', name: 'ಜೋಸೆಫ್ ಬ್ರಾಡ್ಸ್ಕಿ' } ); arr.push( { content: 'ಪುಸ್ತಕದ ಕೊನೆಯ ಪುಟವನ್ನು ತಿರುವಿದಾಗ ಒಬ್ಬ ಸ್ನೇಹಿತನನ್ನು ಕಳೆದುಕೊಂಡ ಭಾವ ನಿಮ್ಮನ್ನು ಆವರಿಸಿದರೆ ಆಗ ನೀವು ಒಂದು ಒಳ್ಳೆಯ ಪುಸ್ತಕವನ್ನು ಓದಿದ್ದೀರಿ ಎಂದರ್ಥ', name: 'ಪಾಲ್ ಸ್ವೀನೀ' } ); arr.push( { content: 'ಒಮ್ಮೆ ನೀವು ಓದಲು ಕಲಿತರೆ ನೀವು ಜೀವನಪರ್ಯಂತ ಆರಾಮಾಗಿರುತ್ತೀರಿ', name: 'ಫ್ರೆಡ್ರಿಕ್ ಡೌಗ್ಲಾಸ್' } ); function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; } return arr[ getRandomInt( 0, arr.length - 1 ) ]; } function getYoutubeVideo( videoUrl ) { /* https://developers.google.com/youtube/player_parameters */ return videoUrl ? videoUrl + ( videoUrl.indexOf('?') === -1 ? '?' : '&' ) + 'rel=0&amp;showinfo=0&amp;cc_load_policy=3' : null; }/* DataAccessor */ var DataAccessor = function() { var httpUtil = new HttpUtil(); var API_PREFIX = window.location.origin.indexOf( "localhost" ) > -1 ? "https://gamma.pratilipi.com" : "/api"; var READCOUNT_HOST = "https://analytics.pratilipi.com"; /*Readcount*/ var READCOUNT_API = '/readcount'; /* Search */ var SEARCH_PREFIX = "/search"; var SEARCH_TRENDING_API = "/trending_search"; var SEARCH_CORE_API = "/search"; /* Recommendation Api */ var RECOMMENDATION_PREFIX = "/recommendation"; var RECOMMENDATION_PRATILIPI_API = "/pratilipis"; var RECOMMENDATION_V2_API = "/recommendations/v2.1/pratilipis"; var PAGE_API = "/page"; var PAGE_CONTENT_API = "/page/content"; var PRATILIPI_API = "/pratilipi?_apiVer=2"; var PRATILIPI_LIST_API = "/pratilipi/list?_apiVer=3"; var PRATILIPI_CONTENT_API = "/pratilipi/content"; var PRATILIPI_CONTENT_INDEX_API = "/pratilipi/content/index"; var PRATILIPI_TAGS_UPDATE_API = "/pratilipi/tags/update"; var PRATILIPI_NEW_API = "/pratilipis"; var USER_PRATILIPI_API = "/userpratilipi"; var USER_PRATILIPI_LIBRARY_LIST_API = "/userpratilipi/library/list"; var AUTHOR_API = "/author"; var AUTHOR_NEW_API = "/authors"; var USER_AUTHOR_FOLLOW_API = "/userauthor/follow?_apiVer=2"; var USER_API = "/user?_apiVer=2"; var USER_LOGIN_API = "/user/login"; var USER_LOGIN_FACEBOOK_API = "/user/login/facebook"; var USER_LOGIN_GOOGLE_API = "/user/login/google"; var USER_REGISTER_API = "/user/register"; var USER_PASSWORD_UPDATE_API = "/user/passwordupdate"; var USER_LOGOUT_API = "/user/logout"; var USER_PRELOGIN_V2_API = "/users/v2.0/identifiers/is-valid"; var USER_LOGIN_V2_API = "/users/v2.0/sessions/login"; var USER_REGISTER_V2_API = "/users/v2.0/sessions/signup"; var USER_FORGOT_PASSWORD_V2_API = "/users/v2.0/passwords/forgot/intent"; var USER_RESET_PASSWORD_V2_API = "/users/v2.0/passwords/reset"; var USER_LOGOUT_V2_API = "/users/v2.0/sessions/logout"; var NOTIFICATION_API = "/notifications/v1.0"; var NOTIFICATION_LIST_API = "/notifications/v1.0"; var NAVIGATION_LIST_API = "/navigation/list"; var USER_PRATILIPI_REVIEW_LIST_API = "/userpratilipi/review/list"; var COMMENT_LIST_API = "/comment/list"; var USER_PRATILIPI_REVIEW_API = "/userpratilipi/review"; var USER_AUTHOR_FOLLOW_API = "/userauthor/follow?_apiVer=2"; var USER_PRATILIPI_LIBRARY_API = "/userpratilipi/library"; var COMMENT_API = "/comment"; var VOTE_API = "/vote"; var INIT_API = "/init/v2.0/init"; var INIT_BANNER_LIST_API = "/init/banner/list"; var INIT_VIDEOSERIES_LIST_API = "/init/v2.0/videoseries"; var INIT_VIDEOSERIES_API = "/init/v2.0/videoseries"; var INIT_VIDEOS_API = "/init/v2.0/videos"; var USER_AUTHOR_FOLLOW_LIST_API = "/userauthor/follow/list"; var EVENT_API = "/event"; var EVENTS_API = "/events/v2.0"; var EVENT_LIST_API = "/event/list"; var BLOG_POST_API = "/blogpost"; var BLOG_POST_LIST_API = "/blogpost/list"; var CONTACT_API = "/contact"; var TAGS_API = "/pratilipi/v2/categories/system"; var USER_EMAIL_API = "/user/email"; var TOP_AUTHORS_API = "/author/list/readcount"; var USER_FCM_TOKEN_API = "/user/accesstoken/fcmtoken"; var USER_PRATILIPI_READ_API = "/user_pratilipi/v2.0/user_pratilipis"; var request = function( name, api, params ) { return { "name": name, "api": api, "params": params != null ? encodeURIComponent( httpUtil.formatParams( params ) ) : null }; }; var processRequests = function( requests ) { var params = {}; for( var i = 0; i < requests.length; i++ ) { var request = requests[i]; params[ request.name ] = request.api; if( request.params != null ) params[ request.name ] += encodeURIComponent( request.api.indexOf( "?" ) > -1 ? "&" : "?" ) + request.params; } return JSON.stringify( params ); }; var processGetResponse = function( response, status, aCallBack ) { if( aCallBack != null ) { aCallBack( ( status === 200 ? response : null ), status ); } }; var processPostResponse = function( response, status, successCallBack, errorCallBack ) { if( status == 200 && successCallBack != null ) successCallBack( response, status ); else if( status != 200 && errorCallBack != null ) errorCallBack( response, status ); }; var processGetResponse_V2 = function( response, status, aCallBack ) { if( aCallBack != null ) { aCallBack( response, status ); } }; /* GET Methods */ this.getPratilipiByUri = function( pageUri, includeUserPratilipi, aCallBack ) { if( pageUri == null ) return; var requests = []; requests.push( new request( "req1", PAGE_API, { "uri": pageUri } ) ); requests.push( new request( "req2", PRATILIPI_API, { "pratilipiId": "$req1.primaryContentId" } ) ); if( includeUserPratilipi ) requests.push( new request( "req3", USER_PRATILIPI_API, { "pratilipiId": "$req1.primaryContentId" } ) ); httpUtil.get( API_PREFIX, null, { "requests": processRequests( requests ) }, function( response, status ) { if( aCallBack != null ) { if( status === 200 ) { var pratilipi = response.req2.status === 200 ? response.req2.response : null, userpratilipi = includeUserPratilipi ? ( response.req3.status === 200 ? response.req3.response : {} ) : null; aCallBack( pratilipi, userpratilipi, response.req2.status ); } else { aCallBack( null, null, status ); } } } ); }; this.getPratilipiBySlug = function( slug, includeUserPratilipi, aCallBack ) { if( slug == null ) return; var requests = []; requests.push( new request( "req1", PRATILIPI_NEW_API, { "slug": slug } ) ); if( includeUserPratilipi ) requests.push( new request( "req2", USER_PRATILIPI_API, { "pratilipiId": "$req1.pratilipiId" } ) ); httpUtil.get( API_PREFIX, null, { "requests": processRequests( requests ) }, function( response, status ) { if( aCallBack != null ) { if( status === 200 ) { var pratilipi = response.req1.status === 200 ? response.req1.response : null, userpratilipi = includeUserPratilipi ? ( response.req2.status === 200 ? response.req2.response : {} ) : null; aCallBack( pratilipi, userpratilipi, response.req1.status ); } else { aCallBack( null, null, status ); } } } ); }; this.getPratilipiById = function( pratilipiId, includeUserPratilipi, aCallBack ) { if( pratilipiId == null ) return; var requests = []; requests.push( new request( "req1", PRATILIPI_API, { "pratilipiId": pratilipiId } ) ); if( includeUserPratilipi ) requests.push( new request( "req2", USER_PRATILIPI_API, { "pratilipiId": pratilipiId } ) ); httpUtil.get( API_PREFIX, null, { "requests": processRequests( requests ) }, function( response, status ) { if( aCallBack != null ) { if( status === 200 ) { var pratilipi = response.req1.status === 200 ? response.req1.response : null, userpratilipi = includeUserPratilipi ? ( response.req2.status === 200 ? response.req2.response : {} ) : null; aCallBack( pratilipi, userpratilipi, response.req1.status ); } else { aCallBack( null, null, status ); } } } ); }; this.getPratilipiAndIndex = function( pratilipiId, includeUserPratilipi, aCallBack ) { if( pratilipiId == null ) return; var requests = []; requests.push( new request( "req1", PRATILIPI_API, { "pratilipiId": pratilipiId } ) ); requests.push( new request( "req2", PRATILIPI_CONTENT_INDEX_API, { "pratilipiId": pratilipiId } ) ); if( includeUserPratilipi ) requests.push( new request( "req3", USER_PRATILIPI_API, { "pratilipiId": pratilipiId } ) ); httpUtil.get( API_PREFIX, null, { "requests": processRequests( requests ) }, function( response, status ) { if( aCallBack != null ) { if( status === 200 ) { /* success only if pratilipi and index call passed */ if( response.req1.status === 200 && response.req2.status === 200 ) { var pratilipi = response.req1.response, index = response.req2.response, userpratilipi = includeUserPratilipi ? ( response.req3.status === 200 ? response.req3.response : {} ) : null; aCallBack( pratilipi, index, userpratilipi, 200 ); /* Either pratilipi call or index call failed => send the non-200 code */ } else { aCallBack( null, null, null, response.req1.status !== 200 ? response.req1.status : response.req2.status ); } } else { aCallBack( null, null, null, status ); } } } ); }; this.getAuthorByUri = function( pageUri, aCallBack ) { if( pageUri == null ) return; var requests = []; requests.push( new request( "req1", PAGE_API, { "uri": pageUri } ) ); requests.push( new request( "req2", AUTHOR_API, { "authorId": "$req1.primaryContentId" } ) ); httpUtil.get( API_PREFIX, null, { "requests": processRequests( requests ) }, function( response, status ) { if( aCallBack != null ) { if( status === 200 ) { aCallBack( response.req2.status === 200 ? response.req2.response : null, response.req2.status ); } else { aCallBack( null, status ); } } } ); }; this.getAuthorBySlug = function( pageUri, aCallBack ) { if( pageUri == null ) return; httpUtil.get( API_PREFIX + AUTHOR_NEW_API, null, { "slug": pageUri }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getAuthorById = function( authorId, aCallBack ) { if( authorId == null ) return; httpUtil.get( API_PREFIX + AUTHOR_API, null, { "authorId": authorId }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getEventByUri = function( pageUri, aCallBack ) { if( pageUri == null ) return; var requests = []; requests.push( new request( "req1", PAGE_API, { "uri": pageUri } ) ); requests.push( new request( "req2", EVENT_API, { "eventId": "$req1.primaryContentId" } ) ); httpUtil.get( API_PREFIX, null, { "requests": processRequests( requests ) }, function( response, status ) { if( aCallBack != null ) { if( status === 200 ) { aCallBack( response.req2.status === 200 ? response.req2.response : null, response.req2.status ); } else { aCallBack( null, status ); } } } ); }; this.getEventBySlug = function( slug, aCallBack ) { if( slug == null ) return; httpUtil.get( API_PREFIX + EVENTS_API, null, { "slug": slug }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getEventById = function( eventId, aCallBack ) { if( eventId == null ) return; httpUtil.get( API_PREFIX + EVENT_API, null, { "eventId": eventId }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getEventList = function( aCallBack ) { httpUtil.get( API_PREFIX + EVENT_LIST_API, null, { "language": "KANNADA" }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getBlogPostByUri = function( pageUri, aCallBack ) { if( pageUri == null ) return; var requests = []; requests.push( new request( "req1", PAGE_API, { "uri": pageUri } ) ); requests.push( new request( "req2", BLOG_POST_API, { "blogPostId": "$req1.primaryContentId" } ) ); httpUtil.get( API_PREFIX, null, { "requests": processRequests( requests ) }, function( response, status ) { if( aCallBack != null ) { if( status === 200 ) { aCallBack( response.req2.status === 200 ? response.req2.response : null, response.req2.status ); } else { aCallBack( null, status ); } } } ); }; this.getBlogPostListByUri = function( pageUri, state, cursor, resultCount, aCallBack ) { if( pageUri == null ) return; var requests = []; requests.push( new request( "req1", PAGE_API, { "uri": pageUri } ) ); requests.push( new request( "req2", BLOG_POST_LIST_API, { "blogId": "$req1.primaryContentId", "language": "KANNADA", "state": state || "PUBLISHED", "cursor": cursor, "resultCount": resultCount })); httpUtil.get( API_PREFIX, null, { "requests": processRequests( requests ) }, function( response, status ) { if( aCallBack != null ) { if( status === 200 ) { aCallBack( response.req2.status === 200 ? response.req2.response : null, response.req2.status ); } else { aCallBack( null, status ); } } } ); }; this.getUser = function( aCallBack ) { httpUtil.get( API_PREFIX + USER_API, null, null, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getUserById = function( userId, aCallBack ) { if( userId == null ) return; httpUtil.get( API_PREFIX + USER_API, null, { "userId": userId }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getNotificationList = function( cursor, resultCount, aCallBack ) { var params = { "language": "KANNADA" }; if( cursor != null ) params[ "cursor" ] = cursor; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + NOTIFICATION_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getNavigationList = function( aCallBack ) { httpUtil.get( API_PREFIX + NAVIGATION_LIST_API, null, { "language": "KANNADA" }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getReviewList = function( pratilipiId, cursor, offset, resultCount, aCallBack ) { if( pratilipiId == null ) return; var params = { "pratilipiId": pratilipiId }; if( cursor != null ) params[ "cursor" ] = cursor; if( offset != null ) params[ "offset" ] = offset; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + USER_PRATILIPI_REVIEW_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getReviewCommentList = function( userPratilipiId, cursor, resultCount, aCallBack ) { if( userPratilipiId == null ) return; var params = { "parentType": "REVIEW", "parentId": userPratilipiId }; if( cursor != null ) params[ "cursor" ] = cursor; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + COMMENT_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getPratilipiListByListName = function( listName, cursor, offset, resultCount, aCallBack ) { if( listName == null ) return; var params = { "listName": listName, "state": "PUBLISHED", "language": "KANNADA" }; if( cursor != null ) params[ "cursor" ] = cursor; if( offset != null ) params[ "offset" ] = offset; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + PRATILIPI_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getPratilipiListBySearchQuery = function( searchQuery, cursor, offset, resultCount, aCallBack ) { if( searchQuery == null ) return; var params = { "searchQuery": searchQuery, "state": "PUBLISHED", "language": "KANNADA" }; if( cursor != null ) params[ "cursor" ] = cursor; if( offset != null ) params[ "offset" ] = offset; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + PRATILIPI_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getPratilipiListByAuthor = function( authorId, state, cursor, offset, resultCount, aCallBack ) { if( authorId == null ) return; var params = { "authorId": authorId, "state": state != null ? state : "PUBLISHED" }; if( state == "DRAFTED" ) params[ "orderByListingDate" ] = false; if( cursor != null ) params[ "cursor" ] = cursor; if( offset != null ) params[ "offset" ] = offset; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + PRATILIPI_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getPratilipiListByEventId = function( eventId, cursor, offset, resultCount, aCallBack ) { if( eventId == null ) return; var params = { "eventId": eventId, "state": "PUBLISHED" }; if( cursor != null ) params[ "cursor" ] = cursor; if( offset != null ) params[ "offset" ] = offset; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + PRATILIPI_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getUserLibraryList = function( cursor, resultCount, aCallBack ) { var params = {}; if( cursor != null ) params[ "cursor" ] = cursor; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + USER_PRATILIPI_LIBRARY_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getHomePageSections = function( aCallBack ) { httpUtil.get( API_PREFIX + INIT_API, null, { "language": "KANNADA" }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getHomePageBanners = function( aCallBack ) { httpUtil.get( API_PREFIX + INIT_BANNER_LIST_API, null, { "language": "KANNADA" }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getVideoseriesList = function( aCallBack ) { httpUtil.get( API_PREFIX + INIT_VIDEOSERIES_LIST_API, null, { "language": "KANNADA" }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getVideoseries = function( slug, aCallBack ) { if( slug == null ) return; httpUtil.get( API_PREFIX + INIT_VIDEOSERIES_API + "/" + slug, null, null, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getVideoseriesLatest = function( slug, aCallBack ) { if( slug == null ) return; httpUtil.get( API_PREFIX + INIT_VIDEOS_API, null, { "slug": slug, "sortType": "latest", "offset": 0, "limit": 1 }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getVideoseriesAll = function( slug, offset, limit, aCallBack ) { if( slug == null ) return; var params = { "sortType": "all", "slug": slug }; if( offset != null ) params[ 'offset' ] = offset; if( limit != null ) params[ 'limit' ] = limit; httpUtil.get( API_PREFIX + INIT_VIDEOS_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getVideo = function( slug, aCallBack ) { if( slug == null ) return; httpUtil.get( API_PREFIX + INIT_VIDEOS_API + "/" + slug, null, null, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getVideoOtherList = function( slug, limit, aCallBack ) { if( slug == null ) return; var params = { "slug": slug }; if( limit != null ) params[ 'limit' ] = limit; httpUtil.get( API_PREFIX + INIT_VIDEOS_API + "/other", null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getAuthorFollowers = function( authorId, cursor, offset, resultCount, aCallBack ) { if( authorId == null ) return; var params = { "authorId": authorId }; if( cursor != null ) params[ "cursor" ] = cursor; if( offset != null ) params[ "offset" ] = offset; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + USER_AUTHOR_FOLLOW_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getUserFollowing = function( userId, cursor, offset, resultCount, aCallBack ) { if( userId == null ) return; var params = { "userId": userId }; if( cursor != null ) params[ "cursor" ] = cursor; if( offset != null ) params[ "offset" ] = offset; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + USER_AUTHOR_FOLLOW_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getPageContent = function( pageName, aCallBack ) { if( pageName == null ) return; httpUtil.get( API_PREFIX + PAGE_CONTENT_API, null, { "pageName": pageName, "language": "KANNADA" }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getPratilipiContent = function( pratilipiId, chapterNo, oldContent, aCallBack ) { if( pratilipiId == null ) return; /* chapterNo can be null for IMAGE contents */ httpUtil.get( API_PREFIX + PRATILIPI_CONTENT_API, null, { "pratilipiId": pratilipiId, "chapterNo": chapterNo, "_apiVer": oldContent ? 1 : 3 }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; /* Recommendation Service */ function getRecommendationHeaders() { return { "AccessToken": getCookie( "access_token" ), "Version": "1.0" }; }; this.getPratilipiRecommendation = function( contextId, context, resultCount, aCallBack ) { if( contextId == null ) return; httpUtil.get( API_PREFIX + RECOMMENDATION_PREFIX + RECOMMENDATION_PRATILIPI_API, getRecommendationHeaders(), { "contextId": contextId, "context": context, "resultCount": resultCount }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getPratilipiRecommendationV2 = function( contextId, context, resultCount, aCallBack ) { if( contextId == null ) return; httpUtil.get( API_PREFIX + RECOMMENDATION_V2_API, getRecommendationHeaders(), { "contextId": contextId, "context": context, "resultCount": resultCount }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; /* Search Service */ function getSearchHeaders() { return { "AccessToken": getCookie( "access_token" ), "Version": "1.0" }; }; this.getTrendingSearchKeywords = function( aCallBack ) { httpUtil.get( API_PREFIX + SEARCH_PREFIX + SEARCH_TRENDING_API, getSearchHeaders(), { "language": "KANNADA" }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getInitialSearchResults = function( searchQuery, aCallBack ) { if( searchQuery == null ) return; httpUtil.get( API_PREFIX + SEARCH_PREFIX + SEARCH_CORE_API, getSearchHeaders(), { "language": "KANNADA", "text": searchQuery.trim() }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getPratilipiSearchResults = function( searchQuery, cursor, resultCount, aCallBack ) { if( searchQuery == null || cursor == null ) return; httpUtil.get( API_PREFIX + SEARCH_PREFIX + SEARCH_CORE_API, getSearchHeaders(), { "language": "KANNADA", "text": searchQuery.trim(), "pratilipiCursor": cursor, "pratilipiResultCount": resultCount != null ? resultCount : 20, "authorResultCount": 0 }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getAuthorSearchResults = function( searchQuery, cursor, resultCount, aCallBack ) { if( searchQuery == null || cursor == null ) return; httpUtil.get( API_PREFIX + SEARCH_PREFIX + SEARCH_CORE_API, getSearchHeaders(), { "language": "KANNADA", "text": searchQuery.trim(), "authorCursor": cursor, "authorResultCount": resultCount != null ? resultCount : 10, "pratilipiResultCount": 0 }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; /* POST Methods */ this.postReadcount = function( slug, userId, successCallBack, errorCallBack ) { if(slug == null) return; var params = { "slug": slug, "tsFrontend": Date.now(), "websiteMode": "Standard" }; httpUtil.post( READCOUNT_HOST + READCOUNT_API, { "AccessToken": getCookie( "access_token" ), "UserId": userId }, params, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.createOrUpdateUser = function( userId, email, phone, successCallBack, errorCallBack ) { if( userId == null ) return; var params = { "userId": userId }; if( email != null ) params[ "email" ] = email; if( phone != null ) params[ "phone" ] = phone; httpUtil.post( API_PREFIX + USER_API, null, params, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.createOrUpdateAuthor = function( author, successCallBack, errorCallBack ) { if( author == null || isEmpty( author ) || author.authorId == null ) return; httpUtil.post( API_PREFIX + AUTHOR_API, null, author, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.createOrUpdateReview = function( pratilipiId, rating, review, successCallBack, errorCallBack ) { if( pratilipiId == null ) return; var params = { "pratilipiId": pratilipiId }; if( rating != null ) params[ "rating" ] = rating; if( review != null ) { params[ "review" ] = review; params[ "reviewState" ]= "PUBLISHED"; } httpUtil.post( API_PREFIX + USER_PRATILIPI_REVIEW_API, null, params, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.createOrUpdateReviewComment = function( userPratilipiId, commentId, content, successCallBack, errorCallBack ) { if( userPratilipiId == null && commentId == null ) return; var params = { "state": "ACTIVE" }; if( userPratilipiId != null ) { params[ "parentId" ] = userPratilipiId; params[ "parentType" ] = "REVIEW"; } if( commentId != null ) params[ "commentId" ] = commentId; if( content != null ) params[ "content" ] = content; httpUtil.post( API_PREFIX + COMMENT_API, null, params, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }, this.followOrUnfollowAuthor = function( authorId, following, successCallBack, errorCallBack ) { if( authorId == null || following == null ) return; httpUtil.post( API_PREFIX + USER_AUTHOR_FOLLOW_API, null, { "authorId": authorId, "state": following ? "FOLLOWING" : "UNFOLLOWED" }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.addOrRemoveFromLibrary = function( pratilipiId, addedToLib, successCallBack, errorCallBack ) { if( pratilipiId == null || addedToLib == null ) return; httpUtil.post( API_PREFIX + USER_PRATILIPI_LIBRARY_API, null, { "pratilipiId": pratilipiId, "addedToLib": addedToLib }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.likeOrDislikeReview = function( userPratilipiId, isLiked, successCallBack, errorCallBack ) { if( userPratilipiId == null || isLiked == null ) return; httpUtil.post( API_PREFIX + VOTE_API, null, { "parentId": userPratilipiId, "parentType": "REVIEW", "type": isLiked ? "LIKE" : "NONE" }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.likeOrDislikeComment = function( commentId, isLiked, successCallBack, errorCallBack ) { if( commentId == null || isLiked == null ) return; httpUtil.post( API_PREFIX + VOTE_API, null, { "parentId": commentId, "parentType": "COMMENT", "type": isLiked ? "LIKE" : "NONE" }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.deleteReview = function( pratilipiId, successCallBack, errorCallBack ) { if( pratilipiId == null ) return; var params = { "pratilipiId": pratilipiId, "reviewState": "DELETED" }; httpUtil.post( API_PREFIX + USER_PRATILIPI_REVIEW_API, null, params, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.deleteComment = function( commentId, successCallBack, errorCallBack ) { if( commentId == null ) return; httpUtil.post( API_PREFIX + COMMENT_API, null, { "commentId": commentId, "state": "DELETED" }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.createOrUpdatePratilipi = function( pratilipi, successCallBack, errorCallBack ) { if( pratilipi == null ) return; if( pratilipi[ "pratilipiId" ] == null ) pratilipi[ "oldContent" ] = false; httpUtil.post( API_PREFIX + PRATILIPI_API, null, pratilipi, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.loginUser = function( email, password, successCallBack, errorCallBack ) { if( email == null || password == null ) return; httpUtil.post( API_PREFIX + USER_LOGIN_API, null, { "email": email, "password": password }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.loginGoogleUser = function( googleIdToken, successCallBack, errorCallBack ) { if( googleIdToken == null ) return; httpUtil.post( API_PREFIX + USER_LOGIN_GOOGLE_API, null, { "googleIdToken": googleIdToken, "language": "KANNADA" }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.loginFacebookUser = function( fbUserAccessToken, successCallBack, errorCallBack ) { if( fbUserAccessToken == null ) return; httpUtil.post( API_PREFIX + USER_LOGIN_FACEBOOK_API, null, { "fbUserAccessToken": fbUserAccessToken, "language": "KANNADA" }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.registerUser = function( name, email, password, successCallBack, errorCallBack ) { if( name == null || email == null || password == null ) return; httpUtil.post( API_PREFIX + USER_REGISTER_API, null, { "name": name, "email": email, "password": password, "language": "KANNADA" }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.updateUserPassword = function( password, newPassword, successCallBack, errorCallBack ) { if( password == null || newPassword == null ) return; httpUtil.post( API_PREFIX + USER_PASSWORD_UPDATE_API, null, { "password": password, "newPassword": newPassword }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.forgotPassword = function( email, successCallBack, errorCallBack ) { if( email == null ) return; httpUtil.post( API_PREFIX + USER_EMAIL_API, null, { "email": email, "sendPasswordResetMail": true }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.resetUserPassword = function( email, verificationToken, newPassword, successCallBack, errorCallBack ) { if( email == null || verificationToken == null || newPassword == null ) return; httpUtil.post( API_PREFIX + USER_PASSWORD_UPDATE_API, null, { "email": email, "verificationToken": verificationToken, "newPassword": newPassword }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.logoutUser = function( successCallBack, errorCallBack ) { httpUtil.get( API_PREFIX + USER_LOGOUT_API, null, null, function( response, status ) { status == 200 ? successCallBack( response ) : errorCallBack( response ); /* Logout is different from all other cases */ }); }; /* User v2 apis */ this.preLoginUserV2 = function( email, aCallBack ) { if( email == null ) return; httpUtil.get( API_PREFIX + USER_PRELOGIN_V2_API, null, { "type": "EMAIL", "value": email }, function( response, status ) { processGetResponse_V2(response, status, aCallBack) }); }; this.googleLoginUserV2 = function( googleIdToken, successCallBack, errorCallBack ) { if( googleIdToken == null ) return; httpUtil.post( API_PREFIX + USER_LOGIN_V2_API, null, { "identifier": JSON.stringify({ "type": "GOOGLE", "value": googleIdToken }), language: "KANNADA" }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.facebookLoginUserV2 = function( fbUserAccessToken, successCallBack, errorCallBack ) { if( fbUserAccessToken == null ) return; httpUtil.post( API_PREFIX + USER_LOGIN_V2_API, null, { "identifier": JSON.stringify({ "type": "FACEBOOK", "value": fbUserAccessToken }), language: "KANNADA" }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.loginUserV2 = function( email, password, successCallBack, errorCallBack ) { if( email == null || password == null ) return; httpUtil.post( API_PREFIX + USER_LOGIN_V2_API, null, { "identifier": JSON.stringify({ "type": "EMAIL", "value": email }), "password": password, language: "KANNADA" }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.registerUserV2 = function( name, email, password, successCallBack, errorCallBack ) { if( name == null || email == null || password == null ) return; httpUtil.post( API_PREFIX + USER_REGISTER_V2_API, null, { "name": name, "identifier": JSON.stringify({ "type": "EMAIL", "value": email }), "password": password, language: "KANNADA" }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.forgotPasswordV2 = function( email, successCallBack, errorCallBack ) { if( email == null ) return; httpUtil.post( API_PREFIX + USER_FORGOT_PASSWORD_V2_API, null, { "identifier": JSON.stringify({ "type": "EMAIL", "value": email }) }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.resetPasswordWithTokenV2 = function( token, password, successCallBack, errorCallBack ) { if( token == null || password == null ) return; httpUtil.post( API_PREFIX + USER_RESET_PASSWORD_V2_API, null, { "token": token, "password": password }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.logoutUserV2 = function( successCallBack, errorCallBack ) { httpUtil.post( API_PREFIX + USER_LOGOUT_V2_API, null, null, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.updateNotificationState = function( notificationId, state, successCallBack, errorCallBack ) { if( notificationId == null || state == null ) return; httpUtil.patch( API_PREFIX + NOTIFICATION_API + "/" + notificationId, null, { "state": state }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.getTags = function( language, aCallBack ) { if( language == null ) return; httpUtil.get( API_PREFIX + TAGS_API, null, { "language": language }, function( response, status ) { processGetResponse(response, status, aCallBack) }); }; this.updatePratilipiTags = function( pratilipiId, type, tagIds, suggestedTags, successCallBack, errorCallBack ) { if( pratilipiId == null ) return; httpUtil.post( API_PREFIX + PRATILIPI_TAGS_UPDATE_API, null, { "pratilipiId": pratilipiId, "type": type, "tagIds": JSON.stringify( tagIds ), "suggestedTags": JSON.stringify( suggestedTags ) }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.reportContent = function( name, email, phone, message, dataType, dataId, successCallBack, errorCallBack ) { if( name == null || name.trim() == "" ) return; if( ( email == null || email.trim() == "" ) && ( phone == null || phone.trim() == "" ) ) return; if( message == null || message.trim() == "" ) return; var body = { "name": name, "team": "AEE_KANNADA", "message": message, "language": "KANNADA" }; if( email != null ) body[ "email" ] = email; if( phone != null ) body[ "phone" ] = phone; if( dataType != null && dataId != null ) { body[ "data" ] = JSON.stringify({ "type": dataType, "id": dataId }); } httpUtil.post( API_PREFIX + CONTACT_API, null, body, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.getYesterdayTopAuthors = function( language, resultCount, aCallBack ) { if( language == null ) return; httpUtil.get( API_PREFIX + TOP_AUTHORS_API, null, { "language": language, "resultCount": resultCount || 20 }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.updateFCMToken = function( fcmToken, aCallBack ) { if( fcmToken == null ) return; httpUtil.post( API_PREFIX + USER_FCM_TOKEN_API, null, { "fcmToken": fcmToken }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.updatePercentageReadData = function( pratilipiId, chapterNo, percentageScrolled, index, aCallBack ) { httpUtil.post( API_PREFIX + USER_PRATILIPI_READ_API, null, { "pratilipiId" : pratilipiId, "chapterNo" : chapterNo, "percentageScrolled" : percentageScrolled, "index" : index, "agent" : "Web" }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; }; ko.bindingHandlers.seeMore = { /* Used in summary page */ update: function( element, valueAccessor, allBindings, viewModel, bindingContext ) { var p = $( element ).find( "p" ); p.text( viewModel.originalText() ); setTimeout( function() { var pHeight = p.height(); var pAllowedLineHeight = parseFloat( p.css( "line-height" ) ) * 3; var isViewMoreVisible = pHeight > pAllowedLineHeight; viewModel.isViewMoreVisible( isViewMoreVisible ); viewModel.maxHeightPx( isViewMoreVisible ? pAllowedLineHeight + 'px' : 'initial' ); }, 0 ); } }; ko.bindingHandlers.seeMoreText = { /* Used in Author page */ update: function( element, valueAccessor, allBindings, viewModel, bindingContext ) { var text = valueAccessor().value; var numberOfLines = valueAccessor().lines != null ? valueAccessor().lines : 1; if( text == null ) { $( element ).css( "visibility", "hidden" ); return; } $( element ).css( "visibility", "visible" ); setTimeout( function() { var target_width = $( element ).parent().width(); var span = document.createElement( 'span' ); span.style.position = "absolute"; span.style.top = "-1000px"; span.style.whiteSpace = 'nowrap'; span.style.fontFamily = $( element ).css( "font-family" ); span.style.fontSize = $( element ).css( "font-size" ); span.innerHTML = " ... " + "(ಇನ್ನೂ ಹೆಚ್ಚು ತೋರಿಸಿ)"; document.body.appendChild( span ); var fit = text.length; for( var i = 0; i < fit; i++ ) { span.innerHTML += text[i]; if( span.clientWidth > target_width ) { fit = i - 1; break; } } document.body.removeChild( span ); var characterLimit = fit * numberOfLines; if( text.length <= characterLimit ) { $( element ).html( text ); $( element ).css( "white-space", "pre-wrap" ); return; } var observer = function() { $( element ).find( "a" ).click( function( e ) { var state = e.currentTarget.getAttribute( "data-shown" ); if( state == "less" ) showMore(); else if( state == "more" ) showLess( true ); }); }; var showMore = function() { var res = text + " " + "<a style='white-space: nowrap;' data-shown='more' href='#'>(ಕಡಿಮೆ ತೋರಿಸಿ)</a>"; $( element ).html( res ); $( element ).css( "white-space", "pre-wrap" ); observer(); }; var showLess = function( scrollToTop ) { var res = text.substring( 0, characterLimit ) + " ... " + "<a style='white-space: nowrap;' data-shown='less' href='#'>(ಇನ್ನೂ ಹೆಚ್ಚು ತೋರಿಸಿ)</a>"; $( element ).html( res ); $( element ).css( "white-space", "normal" ); observer(); if( scrollToTop ) { var pos = $( element ).position().top; if( pos < appViewModel.scrollTop() ) appViewModel.scrollToTop( pos ); } }; showLess( false ); }, 0 ); } }; ko.bindingHandlers.slideIn = { init: function( element, valueAccessor ) { var value = ko.utils.unwrapObservable( valueAccessor() ); $(element).toggle( value ); }, update: function( element, valueAccessor ) { var value = ko.utils.unwrapObservable( valueAccessor() ); value ? $(element).slideDown() : $(element).slideUp(); } }; ko.bindingHandlers.transliterate = { init: function( element, valueAccessor ) { var $content_object = $(element); var content_transliteration_object = new transliterationApp( $content_object, "kn" ); content_transliteration_object.init(); }, }; /* http://stackoverflow.com/questions/32957407/material-design-lite-how-to-programatically-reset-a-floating-label-input-text#32958279 */ ko.bindingHandlers.mdlFloatingInput = { init: function( element, valueAccessor, allBindingsAccessor, data, context ) { var $el = $(element), $enclosingDiv = $( '<div>' ).insertAfter( $el ), $label = $( '<label>' ), params = valueAccessor(); $el.attr( 'id', params.id ); $label.attr( 'for', params.id ).text( params.label ); $el.addClass( 'mdl-textfield__input' ); $label.addClass( 'mdl-textfield__label' ); $enclosingDiv.addClass( "mdl-textfield mdl-js-textfield mdl-textfield--floating-label" ).append( $el ).append( $label ); ko.bindingHandlers.value.init( element, function () { return params.value; }, allBindingsAccessor, data, context ); }, update: function( element, valueAccessor, allBindingsAccessor, data, context ) { var params = valueAccessor(), value = params.value(); ko.bindingHandlers.value.update( element, function () { return params.value; }, allBindingsAccessor, data, context ); $(element).parent()[ value ? 'addClass' : 'removeClass' ]( 'is-dirty' ); } }; ko.bindingHandlers.mdlInput = { init: function( element, valueAccessor, allBindingsAccessor, data, context ) { var $el = $(element), $enclosingDiv = $( '<div>' ).insertAfter( $el ), $label = $( '<label>' ), params = valueAccessor(); $el.attr( 'id', params.id ); $label.attr( 'for', params.id ).text( params.label ); $el.addClass( 'mdl-textfield__input' ); $label.addClass( 'mdl-textfield__label' ); $enclosingDiv.addClass( "mdl-textfield mdl-js-textfield" ).append( $el ).append( $label ); ko.bindingHandlers.value.init( element, function () { return params.value; }, allBindingsAccessor, data, context ); }, update: function( element, valueAccessor, allBindingsAccessor, data, context ) { var params = valueAccessor(), value = params.value(); ko.bindingHandlers.value.update( element, function () { return params.value; }, allBindingsAccessor, data, context ); $(element).parent()[ value ? 'addClass' : 'removeClass' ]( 'is-dirty' ); } }; /* HammerJs */ var hammerEvents = [ 'tap', 'doubletap', 'hold', 'rotate', 'drag', 'dragstart', 'dragend', 'dragleft', 'dragright', 'dragup', 'dragdown', 'transform', 'transformstart', 'transformend', 'swipe', 'swipeleft', 'swiperight', 'swipeup', 'swipedown', 'pinch', 'pinchin', 'pinchout' ]; ko.utils.arrayForEach( hammerEvents, function( eventName ) { ko.bindingHandlers[eventName] = { init: function( element, valueAccessor ) { var hammer = new Hammer( element ); var value = valueAccessor(); hammer.on( eventName, function(e) { value(e); }); } } }); ko.bindingHandlers.carousel = { update: function( element, valueAccessor, allBindingsAccessor, data, context ) { if( ! valueAccessor() ) return; setTimeout( function() { var carousel_wrapper = $( element ).find( '.carousel-wrapper' ); var carousel = $( carousel_wrapper ).find( '.carousel' ); var ul = $( carousel ).find( 'ul' ); var li_width = ul.find( 'li' ).outerWidth(); var button = $( element ).find( 'button[action]' ); var scrollWidth = $( carousel_wrapper )[0].scrollWidth; var width = $( carousel_wrapper ).width(); var visible_elements = parseInt( width / li_width ); var translateX = 0; var setTranslate = function() { $( carousel ).css({ '-webkit-transform' : 'translateX(' + translateX + 'px)', '-moz-transform' : 'translateX(' + translateX + 'px)', '-ms-transform' : 'translateX(' + translateX + 'px)', '-o-transform' : 'translateX(' + translateX + 'px)', 'transform' : 'translateX(' + translateX + 'px)' }); }; var showPrev = function() { var threshold = 0; if( translateX == threshold ) { translateX = 30; setTranslate(); setTimeout( function() { translateX = threshold; setTranslate(); }, 200 ); } else { translateX = Math.min( 0, translateX + ( visible_elements * li_width ) ); setTranslate(); } }; var showNext = function() { var threshold = width - scrollWidth; if( translateX == threshold ) { translateX = threshold - 30; setTranslate(); setTimeout( function() { translateX = threshold; setTranslate(); }, 200 ); } else { translateX = Math.max( width - scrollWidth, translateX - ( visible_elements * li_width ) ); setTranslate(); } }; var hammer = new Hammer( element ); hammer.on( 'swipeleft', function(e) { showNext(); }); hammer.on( 'swiperight', function(e) { showPrev(); }); $( button ).click( function(e) { var action = $( e.currentTarget ).attr( 'action' ); if( action == "prev" ) showPrev(); else if( action == "next" ) showNext(); }); }, 0 ); } };/* Google Analytics */ /* * GA has 4 parameters to record: * Category, Action, Label, Value * * https://drive.google.com/drive/u/1/folders/0B1GuDK5-Y90aVE0zVldHRm95RU0 * Event Category => The entity being tracked - pratilipi, author, notification, review etc. * Event Action => The action the user is taking. * Event Label => The page / location from where it is taken. * Event Value => Search Keyword only * * * Function Names and Definition: * ga_CALV => category, action, location, value * ga_CAL => category, action, location * ga_CA => category, action * */ function ga_CALV( category, action, location, value ) { if( category == null || action == null || location == null || value == null ) { console.log( "ga_CALV", category, action, location, value ); return; } ga( 'send', 'event', category, action, location, value ); return true; } function ga_CAL( category, action, location ) { if( category == null || action == null || location == null ) { console.log( "ga_CAL", category, action, location ); return; } ga( 'send', 'event', category, action, location ); return true; } function ga_CA( category, action ) { if( category == null || action == null ) { console.log( "ga_CA", category, action ); return; } ga_CAL( category, action, getLocation().ga_value ); } function ga_CAV( category, action, value ) { if( category == null || action == null || value == null ) { console.log( "ga_CAV", category, action ); return; } ga_CALV( category, action, getLocation().ga_value, value ); }var FBEvents = { "DISMISS_APPBANNER_GLOBAL": { "FB_EVENT_NAME": "DISMISS_APPBANNER_GLOBAL", "LOCATION": "APPBANNER", "ACTION": "DISMISS", "EXPERIMENT_ID": "CONTROL" }, "GETANDROID_APPBANNER_GLOBAL": { "FB_EVENT_NAME": "GETANDROID_APPBANNER_GLOBAL", "LOCATION": "APPBANNER", "ACTION": "GETANDROID", "EXPERIMENT_ID": "CONTROL" }, "VIEWED_APPBANNER_GLOBAL": { "FB_EVENT_NAME": "VIEWED_APPBANNER_GLOBAL", "LOCATION": "APPBANNER", "ACTION": "VIEWED", "EXPERIMENT_ID": "CONTROL" }, "GETANDROID_FOOTER_GLOBAL": { "FB_EVENT_NAME": "GETANDROID_FOOTER_GLOBAL", "LOCATION": "FOOTER", "ACTION": "GETANDROID", "EXPERIMENT_ID": "CONTROL" }, "LIKEPRATFB_FOOTER_GLOBAL": { "FB_EVENT_NAME": "LIKEPRATFB_FOOTER_GLOBAL", "LOCATION": "FOOTER", "ACTION": "LIKEPRATFB", "EXPERIMENT_ID": "CONTROL" }, "LIKEPRATGP_FOOTER_GLOBAL": { "FB_EVENT_NAME": "LIKEPRATGP_FOOTER_GLOBAL", "LOCATION": "FOOTER", "ACTION": "LIKEPRATGP", "EXPERIMENT_ID": "CONTROL" }, "LIKEPRATLINKD_FOOTER_GLOBAL": { "FB_EVENT_NAME": "LIKEPRATLINKD_FOOTER_GLOBAL", "LOCATION": "FOOTER", "ACTION": "LIKEPRATLINKD", "EXPERIMENT_ID": "CONTROL" }, "LIKEPRATTW_FOOTER_GLOBAL": { "FB_EVENT_NAME": "LIKEPRATTW_FOOTER_GLOBAL", "LOCATION": "FOOTER", "ACTION": "LIKEPRATTW", "EXPERIMENT_ID": "CONTROL" }, "CLICKNOTIF_HEADER_GLOBAL": { "FB_EVENT_NAME": "CLICKNOTIF_HEADER_GLOBAL", "LOCATION": "HEADER", "ACTION": "CLICKNOTIF", "EXPERIMENT_ID": "CONTROL" }, "EXPANDNOTIFS_HEADER_GLOBAL": { "FB_EVENT_NAME": "EXPANDNOTIFS_HEADER_GLOBAL", "LOCATION": "HEADER", "ACTION": "EXPANDNOTIFS", "EXPERIMENT_ID": "CONTROL" }, "GOHOME_HEADER_GLOBAL": { "FB_EVENT_NAME": "GOHOME_HEADER_GLOBAL", "LOCATION": "HEADER", "ACTION": "GOHOME", "EXPERIMENT_ID": "CONTROL" }, "GOLANGUAGE_HEADER_GLOBAL": { "FB_EVENT_NAME": "GOLANGUAGE_HEADER_GLOBAL", "LOCATION": "HEADER", "ACTION": "GOLANGUAGE", "EXPERIMENT_ID": "CONTROL" }, "GOLIBRARY_HEADER_GLOBAL": { "FB_EVENT_NAME": "GOLIBRARY_HEADER_GLOBAL", "LOCATION": "HEADER", "ACTION": "GOLIBRARY", "EXPERIMENT_ID": "CONTROL" }, "GOLOGIN_HEADER_GLOBAL": { "FB_EVENT_NAME": "GOLOGIN_HEADER_GLOBAL", "LOCATION": "HEADER", "ACTION": "GOLOGIN", "EXPERIMENT_ID": "CONTROL" }, "GOMYPROFILE_HEADER_GLOBAL": { "FB_EVENT_NAME": "GOMYPROFILE_HEADER_GLOBAL", "LOCATION": "HEADER", "ACTION": "GOMYPROFILE", "EXPERIMENT_ID": "CONTROL" }, "GONOTIFPAGE_HEADER_GLOBAL": { "FB_EVENT_NAME": "GONOTIFPAGE_HEADER_GLOBAL", "LOCATION": "HEADER", "ACTION": "GONOTIFPAGE", "EXPERIMENT_ID": "CONTROL" }, "GOSEARCH_HEADER_GLOBAL": { "FB_EVENT_NAME": "GOSEARCH_HEADER_GLOBAL", "LOCATION": "HEADER", "ACTION": "GOSEARCH", "EXPERIMENT_ID": "CONTROL" }, "WRITENEWBOOK_HEADER_GLOBAL": { "FB_EVENT_NAME": "WRITENEWBOOK_HEADER_GLOBAL", "LOCATION": "HEADER", "ACTION": "WRITENEWBOOK", "EXPERIMENT_ID": "CONTROL" }, "CLICKCATEGORY_TOPICS_GLOBAL": { "FB_EVENT_NAME": "CLICKCATEGORY_TOPICS_GLOBAL", "LOCATION": "TOPICS", "ACTION": "CLICKCATEGORY", "EXPERIMENT_ID": "CONTROL" }, "CLICKCOLLECTION_TOPICS_GLOBAL": { "FB_EVENT_NAME": "CLICKCOLLECTION_TOPICS_GLOBAL", "LOCATION": "TOPICS", "ACTION": "CLICKCOLLECTION", "EXPERIMENT_ID": "CONTROL" }, "LANDED_TOPICS_GLOBAL": { "FB_EVENT_NAME": "LANDED_TOPICS_GLOBAL", "LOCATION": "TOPICS", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "CREATEAUTHOR_AUTHORS_ADMIN": { "FB_EVENT_NAME": "CREATEAUTHOR_AUTHORS_ADMIN", "SCREEN_NAME": "ADMIN", "LOCATION": "AUTHORS", "ACTION": "CREATEAUTHOR", "EXPERIMENT_ID": "CONTROL" }, "EDITAUTHORINFO_AUTHORS_ADMIN": { "FB_EVENT_NAME": "EDITAUTHORINFO_AUTHORS_ADMIN", "SCREEN_NAME": "ADMIN", "LOCATION": "AUTHORS", "ACTION": "EDITAUTHORINFO", "EXPERIMENT_ID": "CONTROL" }, "LANDED_AUTHORS_ADMIN": { "FB_EVENT_NAME": "LANDED_AUTHORS_ADMIN", "SCREEN_NAME": "ADMIN", "LOCATION": "AUTHORS", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "CLICKUSER_AUTHORDETAIL_BOOK": { "FB_EVENT_NAME": "CLICKUSER_AUTHORDETAIL_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "AUTHORDETAIL", "ACTION": "CLICKUSER", "EXPERIMENT_ID": "CONTROL" }, "FOLLOW_AUTHORDETAIL_BOOK": { "FB_EVENT_NAME": "FOLLOW_AUTHORDETAIL_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "AUTHORDETAIL", "ACTION": "FOLLOW", "EXPERIMENT_ID": "CONTROL" }, "UNFOLLOW_AUTHORDETAIL_BOOK": { "FB_EVENT_NAME": "UNFOLLOW_AUTHORDETAIL_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "AUTHORDETAIL", "ACTION": "UNFOLLOW", "EXPERIMENT_ID": "CONTROL" }, "VIEWED_AUTHORDETAIL_BOOK": { "FB_EVENT_NAME": "VIEWED_AUTHORDETAIL_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "AUTHORDETAIL", "ACTION": "VIEWED", "EXPERIMENT_ID": "CONTROL" }, "NEWBOOKINFO_BOOKCOVER_BOOK": { "FB_EVENT_NAME": "NEWBOOKINFO_BOOKCOVER_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKCOVER", "ACTION": "NEWBOOKINFO", "EXPERIMENT_ID": "CONTROL" }, "UPDATEBOOKINFO_BOOKCOVER_BOOK": { "FB_EVENT_NAME": "UPDATEBOOKINFO_BOOKCOVER_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKCOVER", "ACTION": "UPDATEBOOKINFO", "EXPERIMENT_ID": "CONTROL" }, "CLICKSHRBOOK_BOOKM_BOOK": { "FB_EVENT_NAME": "CLICKSHRBOOK_BOOKM_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKM", "ACTION": "CLICKSHRBOOK" }, "CLICKUSER_BOOKM_BOOK": { "FB_EVENT_NAME": "CLICKUSER_BOOKM_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKM", "ACTION": "CLICKUSER", "EXPERIMENT_ID": "CONTROL" }, "DELETEBOOK_BOOKM_BOOK": { "FB_EVENT_NAME": "DELETEBOOK_BOOKM_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKM", "ACTION": "DELETEBOOK" }, "EDITBOOK_BOOKM_BOOK": { "FB_EVENT_NAME": "EDITBOOK_BOOKM_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKM", "ACTION": "EDITBOOK", "EXPERIMENT_ID": "CONTROL" }, "LANDED_BOOKM_BOOK": { "FB_EVENT_NAME": "LANDED_BOOKM_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKM", "ACTION": "LANDED" }, "LIBRARYADD_BOOKM_BOOK": { "FB_EVENT_NAME": "LIBRARYADD_BOOKM_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKM", "ACTION": "LIBRARYADD" }, "LIBRARYREMOVE_BOOKM_BOOK": { "FB_EVENT_NAME": "LIBRARYREMOVE_BOOKM_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKM", "ACTION": "LIBRARYREMOVE" }, "PUBLISHBOOK_BOOKM_BOOK": { "FB_EVENT_NAME": "PUBLISHBOOK_BOOKM_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKM", "ACTION": "PUBLISHBOOK" }, "READBOOK_BOOKM_BOOK": { "FB_EVENT_NAME": "READBOOK_BOOKM_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKM", "ACTION": "READBOOK", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKFB_BOOKM_BOOK": { "FB_EVENT_NAME": "SHAREBOOKFB_BOOKM_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKM", "ACTION": "SHAREBOOKFB", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKGP_BOOKM_BOOK": { "FB_EVENT_NAME": "SHAREBOOKGP_BOOKM_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKM", "ACTION": "SHAREBOOKGP", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKOT_BOOKM_BOOK": { "FB_EVENT_NAME": "SHAREBOOKOT_BOOKM_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKM", "ACTION": "SHAREBOOKOT", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKTW_BOOKM_BOOK": { "FB_EVENT_NAME": "SHAREBOOKTW_BOOKM_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKM", "ACTION": "SHAREBOOKTW", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKWA_BOOKM_BOOK": { "FB_EVENT_NAME": "SHAREBOOKWA_BOOKM_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKM", "ACTION": "SHAREBOOKWA", "EXPERIMENT_ID": "CONTROL" }, "UNPUBLISHBOOK_BOOKM_BOOK": { "FB_EVENT_NAME": "UNPUBLISHBOOK_BOOKM_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKM", "ACTION": "UNPUBLISHBOOK" }, "EDITTITLE_BOOKTITLE_BOOK": { "FB_EVENT_NAME": "EDITTITLE_BOOKTITLE_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKTITLE", "ACTION": "EDITTITLE", "EXPERIMENT_ID": "CONTROL" }, "EDITTITLEENG_BOOKTITLE_BOOK": { "FB_EVENT_NAME": "EDITTITLEENG_BOOKTITLE_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "BOOKTITLE", "ACTION": "EDITTITLEENG", "EXPERIMENT_ID": "CONTROL" }, "ADDCATEGORY_CATTAG_BOOK": { "FB_EVENT_NAME": "ADDCATEGORY_CATTAG_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "CATTAG", "ACTION": "ADDCATEGORY", "EXPERIMENT_ID": "CONTROL" }, "ADDTAG_CATTAG_BOOK": { "FB_EVENT_NAME": "ADDTAG_CATTAG_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "CATTAG", "ACTION": "ADDTAG", "EXPERIMENT_ID": "CONTROL" }, "NEWBOOKINFO_CATTAG_BOOK": { "FB_EVENT_NAME": "NEWBOOKINFO_CATTAG_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "CATTAG", "ACTION": "NEWBOOKINFO", "EXPERIMENT_ID": "CONTROL" }, "REMOVECATEGORY_CATTAG_BOOK": { "FB_EVENT_NAME": "REMOVECATEGORY_CATTAG_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "CATTAG", "ACTION": "REMOVECATEGORY", "EXPERIMENT_ID": "CONTROL" }, "REMOVETAG_CATTAG_BOOK": { "FB_EVENT_NAME": "REMOVETAG_CATTAG_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "CATTAG", "ACTION": "REMOVETAG", "EXPERIMENT_ID": "CONTROL" }, "UPDATEBOOKINFO_CATTAG_BOOK": { "FB_EVENT_NAME": "UPDATEBOOKINFO_CATTAG_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "CATTAG", "ACTION": "UPDATEBOOKINFO", "EXPERIMENT_ID": "CONTROL" }, "VIEWED_CATTAG_BOOK": { "FB_EVENT_NAME": "VIEWED_CATTAG_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "CATTAG", "ACTION": "VIEWED", "EXPERIMENT_ID": "CONTROL" }, "CLICKUSER_COMMENTS_BOOK": { "FB_EVENT_NAME": "CLICKUSER_COMMENTS_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "COMMENTS", "ACTION": "CLICKUSER", "EXPERIMENT_ID": "CONTROL" }, "EDITCOMMENT_COMMENTS_BOOK": { "FB_EVENT_NAME": "EDITCOMMENT_COMMENTS_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "COMMENTS", "ACTION": "EDITCOMMENT", "EXPERIMENT_ID": "CONTROL" }, "LIKE_COMMENTS_BOOK": { "FB_EVENT_NAME": "LIKE_COMMENTS_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "COMMENTS", "ACTION": "LIKE", "EXPERIMENT_ID": "CONTROL" }, "REPLY_COMMENTS_BOOK": { "FB_EVENT_NAME": "REPLY_COMMENTS_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "COMMENTS", "ACTION": "REPLY", "EXPERIMENT_ID": "CONTROL" }, "UNLIKE_COMMENTS_BOOK": { "FB_EVENT_NAME": "UNLIKE_COMMENTS_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "COMMENTS", "ACTION": "UNLIKE", "EXPERIMENT_ID": "CONTROL" }, "EDITRATE_RATEREV_BOOK": { "FB_EVENT_NAME": "EDITRATE_RATEREV_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "RATEREV", "ACTION": "EDITRATE", "EXPERIMENT_ID": "CONTROL" }, "EDITREVIEW_RATEREV_BOOK": { "FB_EVENT_NAME": "EDITREVIEW_RATEREV_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "RATEREV", "ACTION": "EDITREVIEW", "EXPERIMENT_ID": "CONTROL" }, "RATE_RATEREV_BOOK": { "FB_EVENT_NAME": "RATE_RATEREV_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "RATEREV", "ACTION": "RATE", "EXPERIMENT_ID": "CONTROL" }, "REVIEW_RATEREV_BOOK": { "FB_EVENT_NAME": "REVIEW_RATEREV_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "RATEREV", "ACTION": "REVIEW", "EXPERIMENT_ID": "CONTROL" }, "VIEWED_RATEREV_BOOK": { "FB_EVENT_NAME": "VIEWED_RATEREV_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "RATEREV", "ACTION": "VIEWED", "EXPERIMENT_ID": "CONTROL" }, "CLICKBOOK_RECOMMENDBOOK_BOOK": { "FB_EVENT_NAME": "CLICKBOOK_RECOMMENDBOOK_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "RECOMMENDBOOK", "ACTION": "CLICKBOOK", "EXPERIMENT_ID": "CONTROL" }, "VIEWED_RECOMMENDBOOK_BOOK": { "FB_EVENT_NAME": "VIEWED_RECOMMENDBOOK_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "RECOMMENDBOOK", "ACTION": "VIEWED", "EXPERIMENT_ID": "CONTROL" }, "CLICKUSER_REVIEWS_BOOK": { "FB_EVENT_NAME": "CLICKUSER_REVIEWS_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "REVIEWS", "ACTION": "CLICKUSER", "EXPERIMENT_ID": "CONTROL" }, "COMMENT_REVIEWS_BOOK": { "FB_EVENT_NAME": "COMMENT_REVIEWS_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "REVIEWS", "ACTION": "COMMENT", "EXPERIMENT_ID": "CONTROL" }, "LIKE_REVIEWS_BOOK": { "FB_EVENT_NAME": "LIKE_REVIEWS_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "REVIEWS", "ACTION": "LIKE", "EXPERIMENT_ID": "CONTROL" }, "UNLIKE_REVIEWS_BOOK": { "FB_EVENT_NAME": "UNLIKE_REVIEWS_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "REVIEWS", "ACTION": "UNLIKE", "EXPERIMENT_ID": "CONTROL" }, "NEWBOOKINFO_SUMMARY_BOOK": { "FB_EVENT_NAME": "NEWBOOKINFO_SUMMARY_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "SUMMARY", "ACTION": "NEWBOOKINFO", "EXPERIMENT_ID": "CONTROL" }, "UPDATEBOOKINFO_SUMMARY_BOOK": { "FB_EVENT_NAME": "UPDATEBOOKINFO_SUMMARY_BOOK", "SCREEN_NAME": "BOOK", "LOCATION": "SUMMARY", "ACTION": "UPDATEBOOKINFO", "EXPERIMENT_ID": "CONTROL" }, "CLICKBOOK_CATEGORYM_CATEGORY": { "FB_EVENT_NAME": "CLICKBOOK_CATEGORYM_CATEGORY", "SCREEN_NAME": "CATEGORY", "LOCATION": "CATEGORYM", "ACTION": "CLICKBOOK", "EXPERIMENT_ID": "CONTROL" }, "CLICKSHRBOOK_CATEGORYM_CATEGORY": { "FB_EVENT_NAME": "CLICKSHRBOOK_CATEGORYM_CATEGORY", "SCREEN_NAME": "CATEGORY", "LOCATION": "CATEGORYM", "ACTION": "CLICKSHRBOOK", "EXPERIMENT_ID": "CONTROL" }, "LANDED_CATEGORYM_CATEGORY": { "FB_EVENT_NAME": "LANDED_CATEGORYM_CATEGORY", "SCREEN_NAME": "CATEGORY", "LOCATION": "CATEGORYM", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "LIBRARYADD_CATEGORYM_CATEGORY": { "FB_EVENT_NAME": "LIBRARYADD_CATEGORYM_CATEGORY", "SCREEN_NAME": "CATEGORY", "LOCATION": "CATEGORYM", "ACTION": "LIBRARYADD", "EXPERIMENT_ID": "CONTROL" }, "LIBRARYREMOVE_CATEGORYM_CATEGORY": { "FB_EVENT_NAME": "LIBRARYREMOVE_CATEGORYM_CATEGORY", "SCREEN_NAME": "CATEGORY", "LOCATION": "CATEGORYM", "ACTION": "LIBRARYREMOVE", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKFB_CATEGORYM_CATEGORY": { "FB_EVENT_NAME": "SHAREBOOKFB_CATEGORYM_CATEGORY", "SCREEN_NAME": "CATEGORY", "LOCATION": "CATEGORYM", "ACTION": "SHAREBOOKFB", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKGP_CATEGORYM_CATEGORY": { "FB_EVENT_NAME": "SHAREBOOKGP_CATEGORYM_CATEGORY", "SCREEN_NAME": "CATEGORY", "LOCATION": "CATEGORYM", "ACTION": "SHAREBOOKGP", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKOT_CATEGORYM_CATEGORY": { "FB_EVENT_NAME": "SHAREBOOKOT_CATEGORYM_CATEGORY", "SCREEN_NAME": "CATEGORY", "LOCATION": "CATEGORYM", "ACTION": "SHAREBOOKOT", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKTW_CATEGORYM_CATEGORY": { "FB_EVENT_NAME": "SHAREBOOKTW_CATEGORYM_CATEGORY", "SCREEN_NAME": "CATEGORY", "LOCATION": "CATEGORYM", "ACTION": "SHAREBOOKTW", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKWA_CATEGORYM_CATEGORY": { "FB_EVENT_NAME": "SHAREBOOKWA_CATEGORYM_CATEGORY", "SCREEN_NAME": "CATEGORY", "LOCATION": "CATEGORYM", "ACTION": "SHAREBOOKWA", "EXPERIMENT_ID": "CONTROL" }, "CLICKBOOK_COLLECTIONM_COLLECTION": { "FB_EVENT_NAME": "CLICKBOOK_COLLECTIONM_COLLECTION", "SCREEN_NAME": "COLLECTION", "LOCATION": "COLLECTIONM", "ACTION": "CLICKBOOK", "EXPERIMENT_ID": "CONTROL" }, "CLICKSHRBOOK_COLLECTIONM_COLLECTION": { "FB_EVENT_NAME": "CLICKSHRBOOK_COLLECTIONM_COLLECTION", "SCREEN_NAME": "COLLECTION", "LOCATION": "COLLECTIONM", "ACTION": "CLICKSHRBOOK", "EXPERIMENT_ID": "CONTROL" }, "LANDED_COLLECTIONM_COLLECTION": { "FB_EVENT_NAME": "LANDED_COLLECTIONM_COLLECTION", "SCREEN_NAME": "COLLECTION", "LOCATION": "COLLECTIONM", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "LIBRARYADD_COLLECTIONM_COLLECTION": { "FB_EVENT_NAME": "LIBRARYADD_COLLECTIONM_COLLECTION", "SCREEN_NAME": "COLLECTION", "LOCATION": "COLLECTIONM", "ACTION": "LIBRARYADD", "EXPERIMENT_ID": "CONTROL" }, "LIBRARYREMOVE_COLLECTIONM_COLLECTION": { "FB_EVENT_NAME": "LIBRARYREMOVE_COLLECTIONM_COLLECTION", "SCREEN_NAME": "COLLECTION", "LOCATION": "COLLECTIONM", "ACTION": "LIBRARYREMOVE", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKFB_COLLECTIONM_COLLECTION": { "FB_EVENT_NAME": "SHAREBOOKFB_COLLECTIONM_COLLECTION", "SCREEN_NAME": "COLLECTION", "LOCATION": "COLLECTIONM", "ACTION": "SHAREBOOKFB", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKGP_COLLECTIONM_COLLECTION": { "FB_EVENT_NAME": "SHAREBOOKGP_COLLECTIONM_COLLECTION", "SCREEN_NAME": "COLLECTION", "LOCATION": "COLLECTIONM", "ACTION": "SHAREBOOKGP", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKOT_COLLECTIONM_COLLECTION": { "FB_EVENT_NAME": "SHAREBOOKOT_COLLECTIONM_COLLECTION", "SCREEN_NAME": "COLLECTION", "LOCATION": "COLLECTIONM", "ACTION": "SHAREBOOKOT", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKTW_COLLECTIONM_COLLECTION": { "FB_EVENT_NAME": "SHAREBOOKTW_COLLECTIONM_COLLECTION", "SCREEN_NAME": "COLLECTION", "LOCATION": "COLLECTIONM", "ACTION": "SHAREBOOKTW", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKWA_COLLECTIONM_COLLECTION": { "FB_EVENT_NAME": "SHAREBOOKWA_COLLECTIONM_COLLECTION", "SCREEN_NAME": "COLLECTION", "LOCATION": "COLLECTIONM", "ACTION": "SHAREBOOKWA", "EXPERIMENT_ID": "CONTROL" }, "LANDED_EVENTM_EVENT": { "FB_EVENT_NAME": "LANDED_EVENTM_EVENT", "SCREEN_NAME": "EVENT", "LOCATION": "EVENTM", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "UPDATEEVENTINFO_EVENTM_EVENT": { "FB_EVENT_NAME": "UPDATEEVENTINFO_EVENTM_EVENT", "SCREEN_NAME": "EVENT", "LOCATION": "EVENTM", "ACTION": "UPDATEEVENTINFO", "EXPERIMENT_ID": "CONTROL" }, "CLICKBOOK_EVENTRIES_EVENT": { "FB_EVENT_NAME": "CLICKBOOK_EVENTRIES_EVENT", "SCREEN_NAME": "EVENT", "LOCATION": "EVENTRIES", "ACTION": "CLICKBOOK", "EXPERIMENT_ID": "CONTROL" }, "CLICKSHRBOOK_EVENTRIES_EVENT": { "FB_EVENT_NAME": "CLICKSHRBOOK_EVENTRIES_EVENT", "SCREEN_NAME": "EVENT", "LOCATION": "EVENTRIES", "ACTION": "CLICKSHRBOOK", "EXPERIMENT_ID": "CONTROL" }, "LIBRARYADD_EVENTRIES_EVENT": { "FB_EVENT_NAME": "LIBRARYADD_EVENTRIES_EVENT", "SCREEN_NAME": "EVENT", "LOCATION": "EVENTRIES", "ACTION": "LIBRARYADD", "EXPERIMENT_ID": "CONTROL" }, "LIBRARYREMOVE_EVENTRIES_EVENT": { "FB_EVENT_NAME": "LIBRARYREMOVE_EVENTRIES_EVENT", "SCREEN_NAME": "EVENT", "LOCATION": "EVENTRIES", "ACTION": "LIBRARYREMOVE", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKFB_EVENTRIES_EVENT": { "FB_EVENT_NAME": "SHAREBOOKFB_EVENTRIES_EVENT", "SCREEN_NAME": "EVENT", "LOCATION": "EVENTRIES", "ACTION": "SHAREBOOKFB", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKGP_EVENTRIES_EVENT": { "FB_EVENT_NAME": "SHAREBOOKGP_EVENTRIES_EVENT", "SCREEN_NAME": "EVENT", "LOCATION": "EVENTRIES", "ACTION": "SHAREBOOKGP", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKOT_EVENTRIES_EVENT": { "FB_EVENT_NAME": "SHAREBOOKOT_EVENTRIES_EVENT", "SCREEN_NAME": "EVENT", "LOCATION": "EVENTRIES", "ACTION": "SHAREBOOKOT", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKTW_EVENTRIES_EVENT": { "FB_EVENT_NAME": "SHAREBOOKTW_EVENTRIES_EVENT", "SCREEN_NAME": "EVENT", "LOCATION": "EVENTRIES", "ACTION": "SHAREBOOKTW", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKWA_EVENTRIES_EVENT": { "FB_EVENT_NAME": "SHAREBOOKWA_EVENTRIES_EVENT", "SCREEN_NAME": "EVENT", "LOCATION": "EVENTRIES", "ACTION": "SHAREBOOKWA", "EXPERIMENT_ID": "CONTROL" }, "CLICKEVENT_EVENTLISTM_EVENTLIST": { "FB_EVENT_NAME": "CLICKEVENT_EVENTLISTM_EVENTLIST", "SCREEN_NAME": "EVENTLIST", "LOCATION": "EVENTLISTM", "ACTION": "CLICKEVENT", "EXPERIMENT_ID": "CONTROL" }, "CREATEEVENT_EVENTLISTM_EVENTLIST": { "FB_EVENT_NAME": "CREATEEVENT_EVENTLISTM_EVENTLIST", "SCREEN_NAME": "EVENTLIST", "LOCATION": "EVENTLISTM", "ACTION": "CREATEEVENT", "EXPERIMENT_ID": "CONTROL" }, "LANDED_EVENTLISTM_EVENTLIST": { "FB_EVENT_NAME": "LANDED_EVENTLISTM_EVENTLIST", "SCREEN_NAME": "EVENTLIST", "LOCATION": "EVENTLISTM", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "REQUESTPASSWORD_EMAIL_FORGOTP": { "FB_EVENT_NAME": "REQUESTPASSWORD_EMAIL_FORGOTP", "SCREEN_NAME": "FORGOTP", "LOCATION": "EMAIL", "ACTION": "REQUESTPASSWORD", "EXPERIMENT_ID": "CONTROL" }, "TYPELOGINFIELD_EMAIL_FORGOTP": { "FB_EVENT_NAME": "TYPELOGINFIELD_EMAIL_FORGOTP", "SCREEN_NAME": "FORGOTP", "LOCATION": "EMAIL", "ACTION": "TYPELOGINFIELD", "EXPERIMENT_ID": "CONTROL" }, "LANDED_FORGOTPM_FORGOTP": { "FB_EVENT_NAME": "LANDED_FORGOTPM_FORGOTP", "SCREEN_NAME": "FORGOTP", "LOCATION": "FORGOTPM", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "CLICKBANNER_BANNERS_HOME": { "FB_EVENT_NAME": "CLICKBANNER_BANNERS_HOME", "SCREEN_NAME": "HOME", "LOCATION": "BANNERS", "ACTION": "CLICKBANNER", "EXPERIMENT_ID": "CONTROL" }, "SWIPE_BANNERS_HOME": { "FB_EVENT_NAME": "SWIPE_BANNERS_HOME", "SCREEN_NAME": "HOME", "LOCATION": "BANNERS", "ACTION": "SWIPE", "EXPERIMENT_ID": "CONTROL" }, "VIEWED_BANNERS_HOME": { "FB_EVENT_NAME": "VIEWED_BANNERS_HOME", "SCREEN_NAME": "HOME", "LOCATION": "BANNERS", "ACTION": "VIEWED", "EXPERIMENT_ID": "CONTROL" }, "CLICKBOOK_COLLECTIONS_HOME": { "FB_EVENT_NAME": "CLICKBOOK_COLLECTIONS_HOME", "SCREEN_NAME": "HOME", "LOCATION": "COLLECTIONS", "ACTION": "CLICKBOOK", "EXPERIMENT_ID": "CONTROL" }, "CLICKCOLLECTION_COLLECTIONS_HOME": { "FB_EVENT_NAME": "CLICKCOLLECTION_COLLECTIONS_HOME", "SCREEN_NAME": "HOME", "LOCATION": "COLLECTIONS", "ACTION": "CLICKCOLLECTION", "EXPERIMENT_ID": "CONTROL" }, "SWIPE_COLLECTIONS_HOME": { "FB_EVENT_NAME": "SWIPE_COLLECTIONS_HOME", "SCREEN_NAME": "HOME", "LOCATION": "COLLECTIONS", "ACTION": "SWIPE", "EXPERIMENT_ID": "CONTROL" }, "VIEWED_COLLECTIONS_HOME": { "FB_EVENT_NAME": "VIEWED_COLLECTIONS_HOME", "SCREEN_NAME": "HOME", "LOCATION": "COLLECTIONS", "ACTION": "VIEWED", "EXPERIMENT_ID": "CONTROL" }, "LIBRARYADD_COLLECTIONS_HOME": { "FB_EVENT_NAME": "LIBRARYADD_COLLECTIONS_HOME", "SCREEN_NAME": "HOME", "LOCATION": "COLLECTIONS", "ACTION": "LIBRARYADD", "EXPERIMENT_ID": "CONTROL" }, "LIBRARYREMOVE_COLLECTIONS_HOME": { "FB_EVENT_NAME": "LIBRARYREMOVE_COLLECTIONS_HOME", "SCREEN_NAME": "HOME", "LOCATION": "COLLECTIONS", "ACTION": "LIBRARYREMOVE", "EXPERIMENT_ID": "CONTROL" }, "CLICKSHRBOOK_COLLECTIONS_HOME": { "FB_EVENT_NAME": "CLICKSHRBOOK_COLLECTIONS_HOME", "SCREEN_NAME": "HOME", "LOCATION": "COLLECTIONS", "ACTION": "CLICKSHRBOOK", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKFB_COLLECTIONS_HOME": { "FB_EVENT_NAME": "SHAREBOOKFB_COLLECTIONS_HOME", "SCREEN_NAME": "HOME", "LOCATION": "COLLECTIONS", "ACTION": "SHAREBOOKFB", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKGP_COLLECTIONS_HOME": { "FB_EVENT_NAME": "SHAREBOOKGP_COLLECTIONS_HOME", "SCREEN_NAME": "HOME", "LOCATION": "COLLECTIONS", "ACTION": "SHAREBOOKGP", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKOT_COLLECTIONS_HOME": { "FB_EVENT_NAME": "SHAREBOOKOT_COLLECTIONS_HOME", "SCREEN_NAME": "HOME", "LOCATION": "COLLECTIONS", "ACTION": "SHAREBOOKOT", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKTW_COLLECTIONS_HOME": { "FB_EVENT_NAME": "SHAREBOOKTW_COLLECTIONS_HOME", "SCREEN_NAME": "HOME", "LOCATION": "COLLECTIONS", "ACTION": "SHAREBOOKTW", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKWA_COLLECTIONS_HOME": { "FB_EVENT_NAME": "SHAREBOOKWA_COLLECTIONS_HOME", "SCREEN_NAME": "HOME", "LOCATION": "COLLECTIONS", "ACTION": "SHAREBOOKWA", "EXPERIMENT_ID": "CONTROL" }, "LANDED_HOMEM_HOME": { "FB_EVENT_NAME": "LANDED_HOMEM_HOME", "SCREEN_NAME": "HOME", "LOCATION": "HOMEM", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "CLICKSHRBOOK_LIBRARYM_LIBRARY": { "FB_EVENT_NAME": "CLICKSHRBOOK_LIBRARYM_LIBRARY", "SCREEN_NAME": "LIBRARY", "LOCATION": "LIBRARYM", "ACTION": "CLICKSHRBOOK", "EXPERIMENT_ID": "CONTROL" }, "LANDED_LIBRARYM_LIBRARY": { "FB_EVENT_NAME": "LANDED_LIBRARYM_LIBRARY", "SCREEN_NAME": "LIBRARY", "LOCATION": "LIBRARYM", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "LIBRARYREMOVE_LIBRARYM_LIBRARY": { "FB_EVENT_NAME": "LIBRARYREMOVE_LIBRARYM_LIBRARY", "SCREEN_NAME": "LIBRARY", "LOCATION": "LIBRARYM", "ACTION": "LIBRARYREMOVE", "EXPERIMENT_ID": "CONTROL" }, "READBOOK_LIBRARYM_LIBRARY": { "FB_EVENT_NAME": "READBOOK_LIBRARYM_LIBRARY", "SCREEN_NAME": "LIBRARY", "LOCATION": "LIBRARYM", "ACTION": "READBOOK", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKFB_LIBRARYM_LIBRARY": { "FB_EVENT_NAME": "SHAREBOOKFB_LIBRARYM_LIBRARY", "SCREEN_NAME": "LIBRARY", "LOCATION": "LIBRARYM", "ACTION": "SHAREBOOKFB", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKGP_LIBRARYM_LIBRARY": { "FB_EVENT_NAME": "SHAREBOOKGP_LIBRARYM_LIBRARY", "SCREEN_NAME": "LIBRARY", "LOCATION": "LIBRARYM", "ACTION": "SHAREBOOKGP", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKOT_LIBRARYM_LIBRARY": { "FB_EVENT_NAME": "SHAREBOOKOT_LIBRARYM_LIBRARY", "SCREEN_NAME": "LIBRARY", "LOCATION": "LIBRARYM", "ACTION": "SHAREBOOKOT", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKTW_LIBRARYM_LIBRARY": { "FB_EVENT_NAME": "SHAREBOOKTW_LIBRARYM_LIBRARY", "SCREEN_NAME": "LIBRARY", "LOCATION": "LIBRARYM", "ACTION": "SHAREBOOKTW", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKWA_LIBRARYM_LIBRARY": { "FB_EVENT_NAME": "SHAREBOOKWA_LIBRARYM_LIBRARY", "SCREEN_NAME": "LIBRARY", "LOCATION": "LIBRARYM", "ACTION": "SHAREBOOKWA", "EXPERIMENT_ID": "CONTROL" }, "SIGNINERR_EMAIL_LOGIN": { "FB_EVENT_NAME": "SIGNINERR_EMAIL_LOGIN", "SCREEN_NAME": "LOGIN", "LOCATION": "EMAIL", "ACTION": "SIGNINERR", "EXPERIMENT_ID": "CONTROL" }, "SIGNINSUC_EMAIL_LOGIN": { "FB_EVENT_NAME": "SIGNINSUC_EMAIL_LOGIN", "SCREEN_NAME": "LOGIN", "LOCATION": "EMAIL", "ACTION": "SIGNINSUC", "EXPERIMENT_ID": "CONTROL" }, "TYPELOGINFIELD_EMAIL_LOGIN": { "FB_EVENT_NAME": "TYPELOGINFIELD_EMAIL_LOGIN", "SCREEN_NAME": "LOGIN", "LOCATION": "EMAIL", "ACTION": "TYPELOGINFIELD", "EXPERIMENT_ID": "CONTROL" }, "SIGNINERR_FACEBOOK_LOGIN": { "FB_EVENT_NAME": "SIGNINERR_FACEBOOK_LOGIN", "SCREEN_NAME": "LOGIN", "LOCATION": "FACEBOOK", "ACTION": "SIGNINERR", "EXPERIMENT_ID": "CONTROL" }, "SIGNINSUC_FACEBOOK_LOGIN": { "FB_EVENT_NAME": "SIGNINSUC_FACEBOOK_LOGIN", "SCREEN_NAME": "LOGIN", "LOCATION": "FACEBOOK", "ACTION": "SIGNINSUC", "EXPERIMENT_ID": "CONTROL" }, "SIGNINERR_GOOGLE_LOGIN": { "FB_EVENT_NAME": "SIGNINERR_GOOGLE_LOGIN", "SCREEN_NAME": "LOGIN", "LOCATION": "GOOGLE", "ACTION": "SIGNINERR", "EXPERIMENT_ID": "CONTROL" }, "SIGNINSUC_GOOGLE_LOGIN": { "FB_EVENT_NAME": "SIGNINSUC_GOOGLE_LOGIN", "SCREEN_NAME": "LOGIN", "LOCATION": "GOOGLE", "ACTION": "SIGNINSUC", "EXPERIMENT_ID": "CONTROL" }, "LANDED_LOGINM_LOGIN": { "FB_EVENT_NAME": "LANDED_LOGINM_LOGIN", "SCREEN_NAME": "LOGIN", "LOCATION": "LOGINM", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "TYPELOGINFIELD_PASSWORD_LOGIN": { "FB_EVENT_NAME": "TYPELOGINFIELD_PASSWORD_LOGIN", "SCREEN_NAME": "LOGIN", "LOCATION": "PASSWORD", "ACTION": "TYPELOGINFIELD", "EXPERIMENT_ID": "CONTROL" }, "NEWUSERINFO_COVERPIC_MYPROFILE": { "FB_EVENT_NAME": "NEWUSERINFO_COVERPIC_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "COVERPIC", "ACTION": "NEWUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "UPDATEUSERINFO_COVERPIC_MYPROFILE": { "FB_EVENT_NAME": "UPDATEUSERINFO_COVERPIC_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "COVERPIC", "ACTION": "UPDATEUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "CLICKBOOK_DRAFTS_MYPROFILE": { "FB_EVENT_NAME": "CLICKBOOK_DRAFTS_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "DRAFTS", "ACTION": "CLICKBOOK", "EXPERIMENT_ID": "CONTROL" }, "WRITENEWBOOK_DRAFTS_MYPROFILE": { "FB_EVENT_NAME": "WRITENEWBOOK_DRAFTS_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "DRAFTS", "ACTION": "WRITENEWBOOK", "EXPERIMENT_ID": "CONTROL" }, "CLICKUSER_FOLLOWERS_MYPROFILE": { "FB_EVENT_NAME": "CLICKUSER_FOLLOWERS_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "FOLLOWERS", "ACTION": "CLICKUSER", "EXPERIMENT_ID": "CONTROL" }, "FOLLOW_FOLLOWERS_MYPROFILE": { "FB_EVENT_NAME": "FOLLOW_FOLLOWERS_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "FOLLOWERS", "ACTION": "FOLLOW", "EXPERIMENT_ID": "CONTROL" }, "LANDED_FOLLOWERS_MYPROFILE": { "FB_EVENT_NAME": "LANDED_FOLLOWERS_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "FOLLOWERS", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "UNFOLLOW_FOLLOWERS_MYPROFILE": { "FB_EVENT_NAME": "UNFOLLOW_FOLLOWERS_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "FOLLOWERS", "ACTION": "UNFOLLOW", "EXPERIMENT_ID": "CONTROL" }, "CLICKUSER_FOLLOWINGS_MYPROFILE": { "FB_EVENT_NAME": "CLICKUSER_FOLLOWINGS_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "FOLLOWINGS", "ACTION": "CLICKUSER", "EXPERIMENT_ID": "CONTROL" }, "LANDED_FOLLOWINGS_MYPROFILE": { "FB_EVENT_NAME": "LANDED_FOLLOWINGS_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "FOLLOWINGS", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "UNFOLLOW_FOLLOWINGS_MYPROFILE": { "FB_EVENT_NAME": "UNFOLLOW_FOLLOWINGS_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "FOLLOWINGS", "ACTION": "UNFOLLOW", "EXPERIMENT_ID": "CONTROL" }, "FOLLOW_FOLLOWINGS_MYPROFILE": { "FB_EVENT_NAME": "FOLLOW_FOLLOWINGS_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "FOLLOWINGS", "ACTION": "FOLLOW", "EXPERIMENT_ID": "CONTROL" }, "CLICKSETTINGS_MYPROFILEM_MYPROFILE": { "FB_EVENT_NAME": "CLICKSETTINGS_MYPROFILEM_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "MYPROFILEM", "ACTION": "CLICKSETTINGS", "EXPERIMENT_ID": "CONTROL" }, "CLICKSHRUSER_MYPROFILEM_MYPROFILE": { "FB_EVENT_NAME": "CLICKSHRUSER_MYPROFILEM_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "MYPROFILEM", "ACTION": "CLICKSHRUSER", "EXPERIMENT_ID": "CONTROL" }, "CLICKSTATS_MYPROFILEM_MYPROFILE": { "FB_EVENT_NAME": "CLICKSTATS_MYPROFILEM_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "MYPROFILEM", "ACTION": "CLICKSTATS", "EXPERIMENT_ID": "CONTROL" }, "LANDED_MYPROFILEM_MYPROFILE": { "FB_EVENT_NAME": "LANDED_MYPROFILEM_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "MYPROFILEM", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "SHAREUSERFB_MYPROFILEM_MYPROFILE": { "FB_EVENT_NAME": "SHAREUSERFB_MYPROFILEM_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "MYPROFILEM", "ACTION": "SHAREUSERFB", "EXPERIMENT_ID": "CONTROL" }, "SHAREUSERGP_MYPROFILEM_MYPROFILE": { "FB_EVENT_NAME": "SHAREUSERGP_MYPROFILEM_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "MYPROFILEM", "ACTION": "SHAREUSERGP", "EXPERIMENT_ID": "CONTROL" }, "SHAREUSEROT_MYPROFILEM_MYPROFILE": { "FB_EVENT_NAME": "SHAREUSEROT_MYPROFILEM_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "MYPROFILEM", "ACTION": "SHAREUSEROT", "EXPERIMENT_ID": "CONTROL" }, "SHAREUSERTW_MYPROFILEM_MYPROFILE": { "FB_EVENT_NAME": "SHAREUSERTW_MYPROFILEM_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "MYPROFILEM", "ACTION": "SHAREUSERTW", "EXPERIMENT_ID": "CONTROL" }, "SHAREUSERWA_MYPROFILEM_MYPROFILE": { "FB_EVENT_NAME": "SHAREUSERWA_MYPROFILEM_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "MYPROFILEM", "ACTION": "SHAREUSERWA", "EXPERIMENT_ID": "CONTROL" }, "NEWUSERINFO_PROFILEPIC_MYPROFILE": { "FB_EVENT_NAME": "NEWUSERINFO_PROFILEPIC_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "PROFILEPIC", "ACTION": "NEWUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "UPDATEUSERINFO_PROFILEPIC_MYPROFILE": { "FB_EVENT_NAME": "UPDATEUSERINFO_PROFILEPIC_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "PROFILEPIC", "ACTION": "UPDATEUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "CLICKBOOK_PUBLISHED_MYPROFILE": { "FB_EVENT_NAME": "CLICKBOOK_PUBLISHED_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "PUBLISHED", "ACTION": "CLICKBOOK", "EXPERIMENT_ID": "CONTROL" }, "CLICKSHRBOOK_PUBLISHED_MYPROFILE": { "FB_EVENT_NAME": "CLICKSHRBOOK_PUBLISHED_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "PUBLISHED", "ACTION": "CLICKSHRBOOK", "EXPERIMENT_ID": "CONTROL" }, "LIBRARYADD_PUBLISHED_MYPROFILE": { "FB_EVENT_NAME": "LIBRARYADD_PUBLISHED_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "PUBLISHED", "ACTION": "LIBRARYADD", "EXPERIMENT_ID": "CONTROL" }, "LIBRARYREMOVE_PUBLISHED_MYPROFILE": { "FB_EVENT_NAME": "LIBRARYREMOVE_PUBLISHED_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "PUBLISHED", "ACTION": "LIBRARYREMOVE", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKFB_PUBLISHED_MYPROFILE": { "FB_EVENT_NAME": "SHAREBOOKFB_PUBLISHED_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "PUBLISHED", "ACTION": "SHAREBOOKFB", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKGP_PUBLISHED_MYPROFILE": { "FB_EVENT_NAME": "SHAREBOOKGP_PUBLISHED_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "PUBLISHED", "ACTION": "SHAREBOOKGP", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKOT_PUBLISHED_MYPROFILE": { "FB_EVENT_NAME": "SHAREBOOKOT_PUBLISHED_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "PUBLISHED", "ACTION": "SHAREBOOKOT", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKTW_PUBLISHED_MYPROFILE": { "FB_EVENT_NAME": "SHAREBOOKTW_PUBLISHED_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "PUBLISHED", "ACTION": "SHAREBOOKTW", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKWA_PUBLISHED_MYPROFILE": { "FB_EVENT_NAME": "SHAREBOOKWA_PUBLISHED_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "PUBLISHED", "ACTION": "SHAREBOOKWA", "EXPERIMENT_ID": "CONTROL" }, "CLICKUSER_RECOMMENDUSER_MYPROFILE": { "FB_EVENT_NAME": "CLICKUSER_RECOMMENDUSER_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "RECOMMENDUSER", "ACTION": "CLICKUSER", "EXPERIMENT_ID": "CONTROL" }, "DISMISSUSER_RECOMMENDUSER_MYPROFILE": { "FB_EVENT_NAME": "DISMISSUSER_RECOMMENDUSER_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "RECOMMENDUSER", "ACTION": "DISMISSUSER", "EXPERIMENT_ID": "CONTROL" }, "FOLLOW_RECOMMENDUSER_MYPROFILE": { "FB_EVENT_NAME": "FOLLOW_RECOMMENDUSER_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "RECOMMENDUSER", "ACTION": "FOLLOW", "EXPERIMENT_ID": "CONTROL" }, "VIEWED_RECOMMENDUSER_MYPROFILE": { "FB_EVENT_NAME": "VIEWED_RECOMMENDUSER_MYPROFILE", "SCREEN_NAME": "MYPROFILE", "LOCATION": "RECOMMENDUSER", "ACTION": "VIEWED", "EXPERIMENT_ID": "CONTROL" }, "CLICKNOTIF_NOTIFSM_NOTIFS": { "FB_EVENT_NAME": "CLICKNOTIF_NOTIFSM_NOTIFS", "SCREEN_NAME": "NOTIFS", "LOCATION": "NOTIFSM", "ACTION": "CLICKNOTIF", "EXPERIMENT_ID": "CONTROL" }, "GOSETTINGNOTIFY_NOTIFSM_NOTIFS": { "FB_EVENT_NAME": "GOSETTINGNOTIFY_NOTIFSM_NOTIFS", "SCREEN_NAME": "NOTIFS", "LOCATION": "NOTIFSM", "ACTION": "GOSETTINGNOTIFY", "EXPERIMENT_ID": "CONTROL" }, "LANDED_NOTIFSM_NOTIFS": { "FB_EVENT_NAME": "LANDED_NOTIFSM_NOTIFS", "SCREEN_NAME": "NOTIFS", "LOCATION": "NOTIFSM", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "GOLANGUAGE_LANGUAGE_PHOME": { "FB_EVENT_NAME": "GOLANGUAGE_LANGUAGE_PHOME", "SCREEN_NAME": "PHOME", "LOCATION": "LANGUAGE", "ACTION": "GOLANGUAGE", "EXPERIMENT_ID": "CONTROL" }, "VIEWED_LANGUAGE_PHOME": { "FB_EVENT_NAME": "VIEWED_LANGUAGE_PHOME", "SCREEN_NAME": "PHOME", "LOCATION": "LANGUAGE", "ACTION": "VIEWED", "EXPERIMENT_ID": "CONTROL" }, "GETANDROID_PHOMEM_PHOME": { "FB_EVENT_NAME": "GETANDROID_PHOMEM_PHOME", "SCREEN_NAME": "PHOME", "LOCATION": "PHOMEM", "ACTION": "GETANDROID", "EXPERIMENT_ID": "CONTROL" }, "LANDED_PHOMEM_PHOME": { "FB_EVENT_NAME": "LANDED_PHOMEM_PHOME", "SCREEN_NAME": "PHOME", "LOCATION": "PHOMEM", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "LIKEPRATFB_PHOMEM_PHOME": { "FB_EVENT_NAME": "LIKEPRATFB_PHOMEM_PHOME", "SCREEN_NAME": "PHOME", "LOCATION": "PHOMEM", "ACTION": "LIKEPRATFB", "EXPERIMENT_ID": "CONTROL" }, "LIKEPRATGP_PHOMEM_PHOME": { "FB_EVENT_NAME": "LIKEPRATGP_PHOMEM_PHOME", "SCREEN_NAME": "PHOME", "LOCATION": "PHOMEM", "ACTION": "LIKEPRATGP", "EXPERIMENT_ID": "CONTROL" }, "LIKEPRATLINKD_PHOMEM_PHOME": { "FB_EVENT_NAME": "LIKEPRATLINKD_PHOMEM_PHOME", "SCREEN_NAME": "PHOME", "LOCATION": "PHOMEM", "ACTION": "LIKEPRATLINKD", "EXPERIMENT_ID": "CONTROL" }, "LIKEPRATTW_PHOMEM_PHOME": { "FB_EVENT_NAME": "LIKEPRATTW_PHOMEM_PHOME", "SCREEN_NAME": "PHOME", "LOCATION": "PHOMEM", "ACTION": "LIKEPRATTW", "EXPERIMENT_ID": "CONTROL" }, "SUGGESTLANGAUGE_PHOMEM_PHOME": { "FB_EVENT_NAME": "SUGGESTLANGAUGE_PHOMEM_PHOME", "SCREEN_NAME": "PHOME", "LOCATION": "PHOMEM", "ACTION": "SUGGESTLANGAUGE", "EXPERIMENT_ID": "CONTROL" }, "GOLOGIN_BOOKEND_READER": { "FB_EVENT_NAME": "GOLOGIN_BOOKEND_READER", "SCREEN_NAME": "READER", "LOCATION": "BOOKEND", "ACTION": "GOLOGIN", "EXPERIMENT_ID": "CONTROL" }, "LANDED_BOOKEND_READER": { "FB_EVENT_NAME": "LANDED_BOOKEND_READER", "SCREEN_NAME": "READER", "LOCATION": "BOOKEND", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "RATE_BOOKEND_READER": { "FB_EVENT_NAME": "RATE_BOOKEND_READER", "SCREEN_NAME": "READER", "LOCATION": "BOOKEND", "ACTION": "RATE", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKFB_BOOKEND_READER": { "FB_EVENT_NAME": "SHAREBOOKFB_BOOKEND_READER", "SCREEN_NAME": "READER", "LOCATION": "BOOKEND", "ACTION": "SHAREBOOKFB", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKGP_BOOKEND_READER": { "FB_EVENT_NAME": "SHAREBOOKGP_BOOKEND_READER", "SCREEN_NAME": "READER", "LOCATION": "BOOKEND", "ACTION": "SHAREBOOKGP", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKOT_BOOKEND_READER": { "FB_EVENT_NAME": "SHAREBOOKOT_BOOKEND_READER", "SCREEN_NAME": "READER", "LOCATION": "BOOKEND", "ACTION": "SHAREBOOKOT", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKTW_BOOKEND_READER": { "FB_EVENT_NAME": "SHAREBOOKTW_BOOKEND_READER", "SCREEN_NAME": "READER", "LOCATION": "BOOKEND", "ACTION": "SHAREBOOKTW", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKWA_BOOKEND_READER": { "FB_EVENT_NAME": "SHAREBOOKWA_BOOKEND_READER", "SCREEN_NAME": "READER", "LOCATION": "BOOKEND", "ACTION": "SHAREBOOKWA", "EXPERIMENT_ID": "CONTROL" }, "CHANGECHAPTER_INDEX_READER": { "FB_EVENT_NAME": "CHANGECHAPTER_INDEX_READER", "SCREEN_NAME": "READER", "LOCATION": "INDEX", "ACTION": "CHANGECHAPTER", "EXPERIMENT_ID": "CONTROL" }, "CHANGECHAPTER_READERM_READER": { "FB_EVENT_NAME": "CHANGECHAPTER_READERM_READER", "SCREEN_NAME": "READER", "LOCATION": "READERM", "ACTION": "CHANGECHAPTER", "EXPERIMENT_ID": "CONTROL" }, "CLICKSHRBOOK_READERM_READER": { "FB_EVENT_NAME": "CLICKSHRBOOK_READERM_READER", "SCREEN_NAME": "READER", "LOCATION": "READERM", "ACTION": "CLICKSHRBOOK", "EXPERIMENT_ID": "CONTROL" }, "LANDED_READERM_READER": { "FB_EVENT_NAME": "LANDED_READERM_READER", "SCREEN_NAME": "READER", "LOCATION": "READERM", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "LIBRARYADD_READERM_READER": { "FB_EVENT_NAME": "LIBRARYADD_READERM_READER", "SCREEN_NAME": "READER", "LOCATION": "READERM", "ACTION": "LIBRARYADD", "EXPERIMENT_ID": "CONTROL" }, "LIBRARYREMOVE_READERM_READER": { "FB_EVENT_NAME": "LIBRARYREMOVE_READERM_READER", "SCREEN_NAME": "READER", "LOCATION": "READERM", "ACTION": "LIBRARYREMOVE", "EXPERIMENT_ID": "CONTROL" }, "REPORTBOOK_READERM_READER": { "FB_EVENT_NAME": "REPORTBOOK_READERM_READER", "SCREEN_NAME": "READER", "LOCATION": "READERM", "ACTION": "REPORTBOOK", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKFB_READERM_READER": { "FB_EVENT_NAME": "SHAREBOOKFB_READERM_READER", "SCREEN_NAME": "READER", "LOCATION": "READERM", "ACTION": "SHAREBOOKFB", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKGP_READERM_READER": { "FB_EVENT_NAME": "SHAREBOOKGP_READERM_READER", "SCREEN_NAME": "READER", "LOCATION": "READERM", "ACTION": "SHAREBOOKGP", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKOT_READERM_READER": { "FB_EVENT_NAME": "SHAREBOOKOT_READERM_READER", "SCREEN_NAME": "READER", "LOCATION": "READERM", "ACTION": "SHAREBOOKOT", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKTW_READERM_READER": { "FB_EVENT_NAME": "SHAREBOOKTW_READERM_READER", "SCREEN_NAME": "READER", "LOCATION": "READERM", "ACTION": "SHAREBOOKTW", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKWA_READERM_READER": { "FB_EVENT_NAME": "SHAREBOOKWA_READERM_READER", "SCREEN_NAME": "READER", "LOCATION": "READERM", "ACTION": "SHAREBOOKWA", "EXPERIMENT_ID": "CONTROL" }, "CLICKBOOK_RECOMMENDBOOK_READER": { "FB_EVENT_NAME": "CLICKBOOK_RECOMMENDBOOK_READER", "SCREEN_NAME": "READER", "LOCATION": "RECOMMENDBOOK", "ACTION": "CLICKBOOK", "EXPERIMENT_ID": "CONTROL" }, "VIEWED_RECOMMENDBOOK_READER": { "FB_EVENT_NAME": "VIEWED_RECOMMENDBOOK_READER", "SCREEN_NAME": "READER", "LOCATION": "RECOMMENDBOOK", "ACTION": "VIEWED", "EXPERIMENT_ID": "CONTROL" }, "LANDED_SETTINGS_READER": { "FB_EVENT_NAME": "LANDED_SETTINGS_READER", "SCREEN_NAME": "READER", "LOCATION": "SETTINGS", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "READERBACKGROUND_SETTINGS_READER": { "FB_EVENT_NAME": "READERBACKGROUND_SETTINGS_READER", "SCREEN_NAME": "READER", "LOCATION": "SETTINGS", "ACTION": "READERBACKGROUND", "EXPERIMENT_ID": "CONTROL" }, "READERFONT_SETTINGS_READER": { "FB_EVENT_NAME": "READERFONT_SETTINGS_READER", "SCREEN_NAME": "READER", "LOCATION": "SETTINGS", "ACTION": "READERFONT", "EXPERIMENT_ID": "CONTROL" }, "READERGAP_SETTINGS_READER": { "FB_EVENT_NAME": "READERGAP_SETTINGS_READER", "SCREEN_NAME": "READER", "LOCATION": "SETTINGS", "ACTION": "READERGAP", "EXPERIMENT_ID": "CONTROL" }, "TYPELOGINFIELD_CONFIRMPASS_REGISTER": { "FB_EVENT_NAME": "TYPELOGINFIELD_CONFIRMPASS_REGISTER", "SCREEN_NAME": "REGISTER", "LOCATION": "CONFIRMPASS", "ACTION": "TYPELOGINFIELD", "EXPERIMENT_ID": "CONTROL" }, "SIGNUPERR_EMAIL_REGISTER": { "FB_EVENT_NAME": "SIGNUPERR_EMAIL_REGISTER", "SCREEN_NAME": "REGISTER", "LOCATION": "EMAIL", "ACTION": "SIGNUPERR", "EXPERIMENT_ID": "CONTROL" }, "SIGNUPSUC_EMAIL_REGISTER": { "FB_EVENT_NAME": "SIGNUPSUC_EMAIL_REGISTER", "SCREEN_NAME": "REGISTER", "LOCATION": "EMAIL", "ACTION": "SIGNUPSUC", "EXPERIMENT_ID": "CONTROL" }, "TYPELOGINFIELD_EMAIL_REGISTER": { "FB_EVENT_NAME": "TYPELOGINFIELD_EMAIL_REGISTER", "SCREEN_NAME": "REGISTER", "LOCATION": "EMAIL", "ACTION": "TYPELOGINFIELD", "EXPERIMENT_ID": "CONTROL" }, "SIGNUPERR_FACEBOOK_REGISTER": { "FB_EVENT_NAME": "SIGNUPERR_FACEBOOK_REGISTER", "SCREEN_NAME": "REGISTER", "LOCATION": "FACEBOOK", "ACTION": "SIGNUPERR", "EXPERIMENT_ID": "CONTROL" }, "SIGNUPSUC_FACEBOOK_REGISTER": { "FB_EVENT_NAME": "SIGNUPSUC_FACEBOOK_REGISTER", "SCREEN_NAME": "REGISTER", "LOCATION": "FACEBOOK", "ACTION": "SIGNUPSUC", "EXPERIMENT_ID": "CONTROL" }, "SIGNUPERR_GOOGLE_REGISTER": { "FB_EVENT_NAME": "SIGNUPERR_GOOGLE_REGISTER", "SCREEN_NAME": "REGISTER", "LOCATION": "GOOGLE", "ACTION": "SIGNUPERR", "EXPERIMENT_ID": "CONTROL" }, "SIGNUPSUC_GOOGLE_REGISTER": { "FB_EVENT_NAME": "SIGNUPSUC_GOOGLE_REGISTER", "SCREEN_NAME": "REGISTER", "LOCATION": "GOOGLE", "ACTION": "SIGNUPSUC", "EXPERIMENT_ID": "CONTROL" }, "TYPELOGINFIELD_NAME_REGISTER": { "FB_EVENT_NAME": "TYPELOGINFIELD_NAME_REGISTER", "SCREEN_NAME": "REGISTER", "LOCATION": "NAME", "ACTION": "TYPELOGINFIELD", "EXPERIMENT_ID": "CONTROL" }, "TYPELOGINFIELD_PASSWORD_REGISTER": { "FB_EVENT_NAME": "TYPELOGINFIELD_PASSWORD_REGISTER", "SCREEN_NAME": "REGISTER", "LOCATION": "PASSWORD", "ACTION": "TYPELOGINFIELD", "EXPERIMENT_ID": "CONTROL" }, "LANDED_REGISTERM_REGISTER": { "FB_EVENT_NAME": "LANDED_REGISTERM_REGISTER", "SCREEN_NAME": "REGISTER", "LOCATION": "REGISTERM", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "CLICKCATEGORY_SEARCHM_SEARCH": { "FB_EVENT_NAME": "CLICKCATEGORY_SEARCHM_SEARCH", "SCREEN_NAME": "SEARCH", "LOCATION": "SEARCHM", "ACTION": "CLICKCATEGORY", "EXPERIMENT_ID": "CONTROL" }, "LANDED_SEARCHM_SEARCH": { "FB_EVENT_NAME": "LANDED_SEARCHM_SEARCH", "SCREEN_NAME": "SEARCH", "LOCATION": "SEARCHM", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "SEARCH_SEARCHM_SEARCH": { "FB_EVENT_NAME": "SEARCH_SEARCHM_SEARCH", "SCREEN_NAME": "SEARCH", "LOCATION": "SEARCHM", "ACTION": "SEARCH", "EXPERIMENT_ID": "CONTROL" }, "SEARCH_TRENDSEARCH_SEARCH": { "FB_EVENT_NAME": "SEARCH_TRENDSEARCH_SEARCH", "SCREEN_NAME": "SEARCH", "LOCATION": "TRENDSEARCH", "ACTION": "SEARCH", "EXPERIMENT_ID": "CONTROL" }, "UPDATEUSERINFO_CONTENTLANG_SETNGACC": { "FB_EVENT_NAME": "UPDATEUSERINFO_CONTENTLANG_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "CONTENTLANG", "ACTION": "UPDATEUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "NEWUSERINFO_DOB_SETNGACC": { "FB_EVENT_NAME": "NEWUSERINFO_DOB_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "DOB", "ACTION": "NEWUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "UPDATEUSERINFO_DOB_SETNGACC": { "FB_EVENT_NAME": "UPDATEUSERINFO_DOB_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "DOB", "ACTION": "UPDATEUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "NEWUSERINFO_EMAIL_SETNGACC": { "FB_EVENT_NAME": "NEWUSERINFO_EMAIL_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "EMAIL", "ACTION": "NEWUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "UPDATEUSERINFO_EMAIL_SETNGACC": { "FB_EVENT_NAME": "UPDATEUSERINFO_EMAIL_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "EMAIL", "ACTION": "UPDATEUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "NEWUSERINFO_FNAME_SETNGACC": { "FB_EVENT_NAME": "NEWUSERINFO_FNAME_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "FNAME", "ACTION": "NEWUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "UPDATEUSERINFO_FNAME_SETNGACC": { "FB_EVENT_NAME": "UPDATEUSERINFO_FNAME_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "FNAME", "ACTION": "UPDATEUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "NEWUSERINFO_FNAMEENG_SETNGACC": { "FB_EVENT_NAME": "NEWUSERINFO_FNAMEENG_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "FNAMEENG", "ACTION": "NEWUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "UPDATEUSERINFO_FNAMEENG_SETNGACC": { "FB_EVENT_NAME": "UPDATEUSERINFO_FNAMEENG_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "FNAMEENG", "ACTION": "UPDATEUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "NEWUSERINFO_GENDER_SETNGACC": { "FB_EVENT_NAME": "NEWUSERINFO_GENDER_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "GENDER", "ACTION": "NEWUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "UPDATEUSERINFO_GENDER_SETNGACC": { "FB_EVENT_NAME": "UPDATEUSERINFO_GENDER_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "GENDER", "ACTION": "UPDATEUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "NEWUSERINFO_LNAME_SETNGACC": { "FB_EVENT_NAME": "NEWUSERINFO_LNAME_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "LNAME", "ACTION": "NEWUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "UPDATEUSERINFO_LNAME_SETNGACC": { "FB_EVENT_NAME": "UPDATEUSERINFO_LNAME_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "LNAME", "ACTION": "UPDATEUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "NEWUSERINFO_LNAMEENG_SETNGACC": { "FB_EVENT_NAME": "NEWUSERINFO_LNAMEENG_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "LNAMEENG", "ACTION": "NEWUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "UPDATEUSERINFO_LNAMEENG_SETNGACC": { "FB_EVENT_NAME": "UPDATEUSERINFO_LNAMEENG_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "LNAMEENG", "ACTION": "UPDATEUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "NEWUSERINFO_PENNAME_SETNGACC": { "FB_EVENT_NAME": "NEWUSERINFO_PENNAME_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "PENNAME", "ACTION": "NEWUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "UPDATEUSERINFO_PENNAME_SETNGACC": { "FB_EVENT_NAME": "UPDATEUSERINFO_PENNAME_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "PENNAME", "ACTION": "UPDATEUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "NEWUSERINFO_PHONE_SETNGACC": { "FB_EVENT_NAME": "NEWUSERINFO_PHONE_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "PHONE", "ACTION": "NEWUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "UPDATEUSERINFO_PHONE_SETNGACC": { "FB_EVENT_NAME": "UPDATEUSERINFO_PHONE_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "PHONE", "ACTION": "UPDATEUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "NEWUSERINFO_USERBIO_SETNGACC": { "FB_EVENT_NAME": "NEWUSERINFO_USERBIO_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "USERBIO", "ACTION": "NEWUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "UPDATEUSERINFO_USERBIO_SETNGACC": { "FB_EVENT_NAME": "UPDATEUSERINFO_USERBIO_SETNGACC", "SCREEN_NAME": "SETNGACC", "LOCATION": "USERBIO", "ACTION": "UPDATEUSERINFO", "EXPERIMENT_ID": "CONTROL" }, "DND_COMMENTS_SETNGNOTIFY": { "FB_EVENT_NAME": "DND_COMMENTS_SETNGNOTIFY", "SCREEN_NAME": "SETNGNOTIFY", "LOCATION": "COMMENTS", "ACTION": "DND", "EXPERIMENT_ID": "CONTROL" }, "NOTIFY_COMMENTS_SETNGNOTIFY": { "FB_EVENT_NAME": "NOTIFY_COMMENTS_SETNGNOTIFY", "SCREEN_NAME": "SETNGNOTIFY", "LOCATION": "COMMENTS", "ACTION": "NOTIFY", "EXPERIMENT_ID": "CONTROL" }, "DND_EMAILFREQ_SETNGNOTIFY": { "FB_EVENT_NAME": "DND_EMAILFREQ_SETNGNOTIFY", "SCREEN_NAME": "SETNGNOTIFY", "LOCATION": "EMAILFREQ", "ACTION": "DND", "EXPERIMENT_ID": "CONTROL" }, "NOTIFY_EMAILFREQ_SETNGNOTIFY": { "FB_EVENT_NAME": "NOTIFY_EMAILFREQ_SETNGNOTIFY", "SCREEN_NAME": "SETNGNOTIFY", "LOCATION": "EMAILFREQ", "ACTION": "NOTIFY", "EXPERIMENT_ID": "CONTROL" }, "DND_FOLLOWERS_SETNGNOTIFY": { "FB_EVENT_NAME": "DND_FOLLOWERS_SETNGNOTIFY", "SCREEN_NAME": "SETNGNOTIFY", "LOCATION": "FOLLOWERS", "ACTION": "DND", "EXPERIMENT_ID": "CONTROL" }, "NOTIFY_FOLLOWERS_SETNGNOTIFY": { "FB_EVENT_NAME": "NOTIFY_FOLLOWERS_SETNGNOTIFY", "SCREEN_NAME": "SETNGNOTIFY", "LOCATION": "FOLLOWERS", "ACTION": "NOTIFY", "EXPERIMENT_ID": "CONTROL" }, "DND_LIKECOMMENT_SETNGNOTIFY": { "FB_EVENT_NAME": "DND_LIKECOMMENT_SETNGNOTIFY", "SCREEN_NAME": "SETNGNOTIFY", "LOCATION": "LIKECOMMENT", "ACTION": "DND", "EXPERIMENT_ID": "CONTROL" }, "NOTIFY_LIKECOMMENT_SETNGNOTIFY": { "FB_EVENT_NAME": "NOTIFY_LIKECOMMENT_SETNGNOTIFY", "SCREEN_NAME": "SETNGNOTIFY", "LOCATION": "LIKECOMMENT", "ACTION": "NOTIFY", "EXPERIMENT_ID": "CONTROL" }, "DND_LIKEREVIEW_SETNGNOTIFY": { "FB_EVENT_NAME": "DND_LIKEREVIEW_SETNGNOTIFY", "SCREEN_NAME": "SETNGNOTIFY", "LOCATION": "LIKEREVIEW", "ACTION": "DND", "EXPERIMENT_ID": "CONTROL" }, "NOTIFY_LIKEREVIEW_SETNGNOTIFY": { "FB_EVENT_NAME": "NOTIFY_LIKEREVIEW_SETNGNOTIFY", "SCREEN_NAME": "SETNGNOTIFY", "LOCATION": "LIKEREVIEW", "ACTION": "NOTIFY", "EXPERIMENT_ID": "CONTROL" }, "DND_PROMOTIONAL_SETNGNOTIFY": { "FB_EVENT_NAME": "DND_PROMOTIONAL_SETNGNOTIFY", "SCREEN_NAME": "SETNGNOTIFY", "LOCATION": "PROMOTIONAL", "ACTION": "DND", "EXPERIMENT_ID": "CONTROL" }, "NOTIFY_PROMOTIONAL_SETNGNOTIFY": { "FB_EVENT_NAME": "NOTIFY_PROMOTIONAL_SETNGNOTIFY", "SCREEN_NAME": "SETNGNOTIFY", "LOCATION": "PROMOTIONAL", "ACTION": "NOTIFY", "EXPERIMENT_ID": "CONTROL" }, "DND_PUBLISHED_SETNGNOTIFY": { "FB_EVENT_NAME": "DND_PUBLISHED_SETNGNOTIFY", "SCREEN_NAME": "SETNGNOTIFY", "LOCATION": "PUBLISHED", "ACTION": "DND", "EXPERIMENT_ID": "CONTROL" }, "NOTIFY_PUBLISHED_SETNGNOTIFY": { "FB_EVENT_NAME": "NOTIFY_PUBLISHED_SETNGNOTIFY", "SCREEN_NAME": "SETNGNOTIFY", "LOCATION": "PUBLISHED", "ACTION": "NOTIFY", "EXPERIMENT_ID": "CONTROL" }, "DND_REVIEWS_SETNGNOTIFY": { "FB_EVENT_NAME": "DND_REVIEWS_SETNGNOTIFY", "SCREEN_NAME": "SETNGNOTIFY", "LOCATION": "REVIEWS", "ACTION": "DND", "EXPERIMENT_ID": "CONTROL" }, "NOTIFY_REVIEWS_SETNGNOTIFY": { "FB_EVENT_NAME": "NOTIFY_REVIEWS_SETNGNOTIFY", "SCREEN_NAME": "SETNGNOTIFY", "LOCATION": "REVIEWS", "ACTION": "NOTIFY", "EXPERIMENT_ID": "CONTROL" }, "RESETPASSWORD_PASSWORD_SETNGPRI": { "FB_EVENT_NAME": "RESETPASSWORD_PASSWORD_SETNGPRI", "SCREEN_NAME": "SETNGPRI", "LOCATION": "PASSWORD", "ACTION": "RESETPASSWORD", "EXPERIMENT_ID": "CONTROL" }, "GOSETNGACC_SETTINGSM_SETTINGS": { "FB_EVENT_NAME": "GOSETNGACC_SETTINGSM_SETTINGS", "SCREEN_NAME": "SETTINGS", "LOCATION": "SETTINGSM", "ACTION": "GOSETNGACC", "EXPERIMENT_ID": "CONTROL" }, "GOSETNGNOTIFY_SETTINGSM_SETTINGS": { "FB_EVENT_NAME": "GOSETNGNOTIFY_SETTINGSM_SETTINGS", "SCREEN_NAME": "SETTINGS", "LOCATION": "SETTINGSM", "ACTION": "GOSETNGNOTIFY", "EXPERIMENT_ID": "CONTROL" }, "GOSETNGSEC_SETTINGSM_SETTINGS": { "FB_EVENT_NAME": "GOSETNGSEC_SETTINGSM_SETTINGS", "SCREEN_NAME": "SETTINGS", "LOCATION": "SETTINGSM", "ACTION": "GOSETNGSEC", "EXPERIMENT_ID": "CONTROL" }, "LANDED_SETTINGSM_SETTINGS": { "FB_EVENT_NAME": "LANDED_SETTINGSM_SETTINGS", "SCREEN_NAME": "SETTINGS", "LOCATION": "SETTINGSM", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "LOGOUT_SETTINGSM_SETTINGS": { "FB_EVENT_NAME": "LOGOUT_SETTINGSM_SETTINGS", "SCREEN_NAME": "SETTINGS", "LOCATION": "SETTINGSM", "ACTION": "LOGOUT", "EXPERIMENT_ID": "CONTROL" }, "CLICKBOOK_TAGM_TAG": { "FB_EVENT_NAME": "CLICKBOOK_TAGM_TAG", "SCREEN_NAME": "TAG", "LOCATION": "TAGM", "ACTION": "CLICKBOOK", "EXPERIMENT_ID": "CONTROL" }, "CLICKSHRBOOK_TAGM_TAG": { "FB_EVENT_NAME": "CLICKSHRBOOK_TAGM_TAG", "SCREEN_NAME": "TAG", "LOCATION": "TAGM", "ACTION": "CLICKSHRBOOK", "EXPERIMENT_ID": "CONTROL" }, "LANDED_TAGM_TAG": { "FB_EVENT_NAME": "LANDED_TAGM_TAG", "SCREEN_NAME": "TAG", "LOCATION": "TAGM", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "LIBRARYADD_TAGM_TAG": { "FB_EVENT_NAME": "LIBRARYADD_TAGM_TAG", "SCREEN_NAME": "TAG", "LOCATION": "TAGM", "ACTION": "LIBRARYADD", "EXPERIMENT_ID": "CONTROL" }, "LIBRARYREMOVE_TAGM_TAG": { "FB_EVENT_NAME": "LIBRARYREMOVE_TAGM_TAG", "SCREEN_NAME": "TAG", "LOCATION": "TAGM", "ACTION": "LIBRARYREMOVE", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKFB_TAGM_TAG": { "FB_EVENT_NAME": "SHAREBOOKFB_TAGM_TAG", "SCREEN_NAME": "TAG", "LOCATION": "TAGM", "ACTION": "SHAREBOOKFB", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKGP_TAGM_TAG": { "FB_EVENT_NAME": "SHAREBOOKGP_TAGM_TAG", "SCREEN_NAME": "TAG", "LOCATION": "TAGM", "ACTION": "SHAREBOOKGP", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKOT_TAGM_TAG": { "FB_EVENT_NAME": "SHAREBOOKOT_TAGM_TAG", "SCREEN_NAME": "TAG", "LOCATION": "TAGM", "ACTION": "SHAREBOOKOT", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKTW_TAGM_TAG": { "FB_EVENT_NAME": "SHAREBOOKTW_TAGM_TAG", "SCREEN_NAME": "TAG", "LOCATION": "TAGM", "ACTION": "SHAREBOOKTW", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKWA_TAGM_TAG": { "FB_EVENT_NAME": "SHAREBOOKWA_TAGM_TAG", "SCREEN_NAME": "TAG", "LOCATION": "TAGM", "ACTION": "SHAREBOOKWA", "EXPERIMENT_ID": "CONTROL" }, "CLICKUSER_FOLLOWERS_USER": { "FB_EVENT_NAME": "CLICKUSER_FOLLOWERS_USER", "SCREEN_NAME": "USER", "LOCATION": "FOLLOWERS", "ACTION": "CLICKUSER", "EXPERIMENT_ID": "CONTROL" }, "FOLLOW_FOLLOWERS_USER": { "FB_EVENT_NAME": "FOLLOW_FOLLOWERS_USER", "SCREEN_NAME": "USER", "LOCATION": "FOLLOWERS", "ACTION": "FOLLOW", "EXPERIMENT_ID": "CONTROL" }, "LANDED_FOLLOWERS_USER": { "FB_EVENT_NAME": "LANDED_FOLLOWERS_USER", "SCREEN_NAME": "USER", "LOCATION": "FOLLOWERS", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "UNFOLLOW_FOLLOWERS_USER": { "FB_EVENT_NAME": "UNFOLLOW_FOLLOWERS_USER", "SCREEN_NAME": "USER", "LOCATION": "FOLLOWERS", "ACTION": "UNFOLLOW", "EXPERIMENT_ID": "CONTROL" }, "CLICKUSER_FOLLOWINGS_USER": { "FB_EVENT_NAME": "CLICKUSER_FOLLOWINGS_USER", "SCREEN_NAME": "USER", "LOCATION": "FOLLOWINGS", "ACTION": "CLICKUSER", "EXPERIMENT_ID": "CONTROL" }, "FOLLOW_FOLLOWINGS_USER": { "FB_EVENT_NAME": "FOLLOW_FOLLOWINGS_USER", "SCREEN_NAME": "USER", "LOCATION": "FOLLOWINGS", "ACTION": "FOLLOW", "EXPERIMENT_ID": "CONTROL" }, "LANDED_FOLLOWINGS_USER": { "FB_EVENT_NAME": "LANDED_FOLLOWINGS_USER", "SCREEN_NAME": "USER", "LOCATION": "FOLLOWINGS", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "UNFOLLOW_FOLLOWINGS_USER": { "FB_EVENT_NAME": "UNFOLLOW_FOLLOWINGS_USER", "SCREEN_NAME": "USER", "LOCATION": "FOLLOWINGS", "ACTION": "UNFOLLOW", "EXPERIMENT_ID": "CONTROL" }, "CLICKBOOK_PUBLISHED_USER": { "FB_EVENT_NAME": "CLICKBOOK_PUBLISHED_USER", "SCREEN_NAME": "USER", "LOCATION": "PUBLISHED", "ACTION": "CLICKBOOK", "EXPERIMENT_ID": "CONTROL" }, "CLICKSHRBOOK_PUBLISHED_USER": { "FB_EVENT_NAME": "CLICKSHRBOOK_PUBLISHED_USER", "SCREEN_NAME": "USER", "LOCATION": "PUBLISHED", "ACTION": "CLICKSHRBOOK", "EXPERIMENT_ID": "CONTROL" }, "LIBRARYADD_PUBLISHED_USER": { "FB_EVENT_NAME": "LIBRARYADD_PUBLISHED_USER", "SCREEN_NAME": "USER", "LOCATION": "PUBLISHED", "ACTION": "LIBRARYADD", "EXPERIMENT_ID": "CONTROL" }, "LIBRARYREMOVE_PUBLISHED_USER": { "FB_EVENT_NAME": "LIBRARYREMOVE_PUBLISHED_USER", "SCREEN_NAME": "USER", "LOCATION": "PUBLISHED", "ACTION": "LIBRARYREMOVE", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKFB_PUBLISHED_USER": { "FB_EVENT_NAME": "SHAREBOOKFB_PUBLISHED_USER", "SCREEN_NAME": "USER", "LOCATION": "PUBLISHED", "ACTION": "SHAREBOOKFB", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKGP_PUBLISHED_USER": { "FB_EVENT_NAME": "SHAREBOOKGP_PUBLISHED_USER", "SCREEN_NAME": "USER", "LOCATION": "PUBLISHED", "ACTION": "SHAREBOOKGP", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKOT_PUBLISHED_USER": { "FB_EVENT_NAME": "SHAREBOOKOT_PUBLISHED_USER", "SCREEN_NAME": "USER", "LOCATION": "PUBLISHED", "ACTION": "SHAREBOOKOT", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKTW_PUBLISHED_USER": { "FB_EVENT_NAME": "SHAREBOOKTW_PUBLISHED_USER", "SCREEN_NAME": "USER", "LOCATION": "PUBLISHED", "ACTION": "SHAREBOOKTW", "EXPERIMENT_ID": "CONTROL" }, "SHAREBOOKWA_PUBLISHED_USER": { "FB_EVENT_NAME": "SHAREBOOKWA_PUBLISHED_USER", "SCREEN_NAME": "USER", "LOCATION": "PUBLISHED", "ACTION": "SHAREBOOKWA", "EXPERIMENT_ID": "CONTROL" }, "CLICKUSER_RECOMMENDUSER_USER": { "FB_EVENT_NAME": "CLICKUSER_RECOMMENDUSER_USER", "SCREEN_NAME": "USER", "LOCATION": "RECOMMENDUSER", "ACTION": "CLICKUSER", "EXPERIMENT_ID": "CONTROL" }, "DISMISSUSER_RECOMMENDUSER_USER": { "FB_EVENT_NAME": "DISMISSUSER_RECOMMENDUSER_USER", "SCREEN_NAME": "USER", "LOCATION": "RECOMMENDUSER", "ACTION": "DISMISSUSER", "EXPERIMENT_ID": "CONTROL" }, "FOLLOW_RECOMMENDUSER_USER": { "FB_EVENT_NAME": "FOLLOW_RECOMMENDUSER_USER", "SCREEN_NAME": "USER", "LOCATION": "RECOMMENDUSER", "ACTION": "FOLLOW", "EXPERIMENT_ID": "CONTROL" }, "VIEWED_RECOMMENDUSER_USER": { "FB_EVENT_NAME": "VIEWED_RECOMMENDUSER_USER", "SCREEN_NAME": "USER", "LOCATION": "RECOMMENDUSER", "ACTION": "VIEWED", "EXPERIMENT_ID": "CONTROL" }, "CLICKSHRUSER_USERM_USER": { "FB_EVENT_NAME": "CLICKSHRUSER_USERM_USER", "SCREEN_NAME": "USER", "LOCATION": "USERM", "ACTION": "CLICKSHRUSER", "EXPERIMENT_ID": "CONTROL" }, "CLICKSTATS_USERM_USER": { "FB_EVENT_NAME": "CLICKSTATS_USERM_USER", "SCREEN_NAME": "USER", "LOCATION": "USERM", "ACTION": "CLICKSTATS", "EXPERIMENT_ID": "CONTROL" }, "FOLLOW_USERM_USER": { "FB_EVENT_NAME": "FOLLOW_USERM_USER", "SCREEN_NAME": "USER", "LOCATION": "USERM", "ACTION": "FOLLOW", "EXPERIMENT_ID": "CONTROL" }, "UNFOLLOW_USERM_USER": { "FB_EVENT_NAME": "UNFOLLOW_USERM_USER", "SCREEN_NAME": "USER", "LOCATION": "USERM", "ACTION": "UNFOLLOW", "EXPERIMENT_ID": "CONTROL" }, "LANDED_USERM_USER": { "FB_EVENT_NAME": "LANDED_USERM_USER", "SCREEN_NAME": "USER", "LOCATION": "USERM", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "SHAREUSERFB_USERM_USER": { "FB_EVENT_NAME": "SHAREUSERFB_USERM_USER", "SCREEN_NAME": "USER", "LOCATION": "USERM", "ACTION": "SHAREUSERFB", "EXPERIMENT_ID": "CONTROL" }, "SHAREUSERGP_USERM_USER": { "FB_EVENT_NAME": "SHAREUSERGP_USERM_USER", "SCREEN_NAME": "USER", "LOCATION": "USERM", "ACTION": "SHAREUSERGP", "EXPERIMENT_ID": "CONTROL" }, "SHAREUSEROT_USERM_USER": { "FB_EVENT_NAME": "SHAREUSEROT_USERM_USER", "SCREEN_NAME": "USER", "LOCATION": "USERM", "ACTION": "SHAREUSEROT", "EXPERIMENT_ID": "CONTROL" }, "SHAREUSERTW_USERM_USER": { "FB_EVENT_NAME": "SHAREUSERTW_USERM_USER", "SCREEN_NAME": "USER", "LOCATION": "USERM", "ACTION": "SHAREUSERTW", "EXPERIMENT_ID": "CONTROL" }, "SHAREUSERWA_USERM_USER": { "FB_EVENT_NAME": "SHAREUSERWA_USERM_USER", "SCREEN_NAME": "USER", "LOCATION": "USERM", "ACTION": "SHAREUSERWA", "EXPERIMENT_ID": "CONTROL" }, "LANDED_BOOKCOVER_WRITER": { "FB_EVENT_NAME": "LANDED_BOOKCOVER_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "BOOKCOVER", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "NEWBOOKINFO_BOOKCOVER_WRITER": { "FB_EVENT_NAME": "NEWBOOKINFO_BOOKCOVER_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "BOOKCOVER", "ACTION": "NEWBOOKINFO", "EXPERIMENT_ID": "CONTROL" }, "UPDATEBOOKINFO_BOOKCOVER_WRITER": { "FB_EVENT_NAME": "UPDATEBOOKINFO_BOOKCOVER_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "BOOKCOVER", "ACTION": "UPDATEBOOKINFO", "EXPERIMENT_ID": "CONTROL" }, "EDITTITLE_BOOKTITLE_WRITER": { "FB_EVENT_NAME": "EDITTITLE_BOOKTITLE_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "BOOKTITLE", "ACTION": "EDITTITLE", "EXPERIMENT_ID": "CONTROL" }, "EDITTITLEENG_BOOKTITLE_WRITER": { "FB_EVENT_NAME": "EDITTITLEENG_BOOKTITLE_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "BOOKTITLE", "ACTION": "EDITTITLEENG", "EXPERIMENT_ID": "CONTROL" }, "LANDED_BOOKTITLE_WRITER": { "FB_EVENT_NAME": "LANDED_BOOKTITLE_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "BOOKTITLE", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "TYPETITLE_BOOKTITLE_WRITER": { "FB_EVENT_NAME": "TYPETITLE_BOOKTITLE_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "BOOKTITLE", "ACTION": "TYPETITLE", "EXPERIMENT_ID": "CONTROL" }, "TYPETITLEENG_BOOKTITLE_WRITER": { "FB_EVENT_NAME": "TYPETITLEENG_BOOKTITLE_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "BOOKTITLE", "ACTION": "TYPETITLEENG", "EXPERIMENT_ID": "CONTROL" }, "ADDCATEGORY_CATTAG_WRITER": { "FB_EVENT_NAME": "ADDCATEGORY_CATTAG_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "CATTAG", "ACTION": "ADDCATEGORY", "EXPERIMENT_ID": "CONTROL" }, "ADDTAG_CATTAG_WRITER": { "FB_EVENT_NAME": "ADDTAG_CATTAG_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "CATTAG", "ACTION": "ADDTAG", "EXPERIMENT_ID": "CONTROL" }, "LANDED_CATTAG_WRITER": { "FB_EVENT_NAME": "LANDED_CATTAG_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "CATTAG", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "NEWBOOKINFO_CATTAG_WRITER": { "FB_EVENT_NAME": "NEWBOOKINFO_CATTAG_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "CATTAG", "ACTION": "NEWBOOKINFO", "EXPERIMENT_ID": "CONTROL" }, "REMOVECATEGORY_CATTAG_WRITER": { "FB_EVENT_NAME": "REMOVECATEGORY_CATTAG_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "CATTAG", "ACTION": "REMOVECATEGORY", "EXPERIMENT_ID": "CONTROL" }, "REMOVETAG_CATTAG_WRITER": { "FB_EVENT_NAME": "REMOVETAG_CATTAG_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "CATTAG", "ACTION": "REMOVETAG", "EXPERIMENT_ID": "CONTROL" }, "UPDATEBOOKINFO_CATTAG_WRITER": { "FB_EVENT_NAME": "UPDATEBOOKINFO_CATTAG_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "CATTAG", "ACTION": "UPDATEBOOKINFO", "EXPERIMENT_ID": "CONTROL" }, "LANDED_CHAPTER_WRITER": { "FB_EVENT_NAME": "LANDED_CHAPTER_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "CHAPTER", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "TYPECHCONTENT_CHAPTER_WRITER": { "FB_EVENT_NAME": "TYPECHCONTENT_CHAPTER_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "CHAPTER", "ACTION": "TYPECHCONTENT", "EXPERIMENT_ID": "CONTROL" }, "TYPECHTITLE_CHAPTER_WRITER": { "FB_EVENT_NAME": "TYPECHTITLE_CHAPTER_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "CHAPTER", "ACTION": "TYPECHTITLE", "EXPERIMENT_ID": "CONTROL" }, "ADDIMAGE_EDITORBAR_WRITER": { "FB_EVENT_NAME": "ADDIMAGE_EDITORBAR_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "EDITORBAR", "ACTION": "ADDIMAGE", "EXPERIMENT_ID": "CONTROL" }, "ADDLINK_EDITORBAR_WRITER": { "FB_EVENT_NAME": "ADDLINK_EDITORBAR_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "EDITORBAR", "ACTION": "ADDLINK", "EXPERIMENT_ID": "CONTROL" }, "ALIGN_EDITORBAR_WRITER": { "FB_EVENT_NAME": "ALIGN_EDITORBAR_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "EDITORBAR", "ACTION": "ALIGN", "EXPERIMENT_ID": "CONTROL" }, "TEXTSTYLE_EDITORBAR_WRITER": { "FB_EVENT_NAME": "TEXTSTYLE_EDITORBAR_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "EDITORBAR", "ACTION": "TEXTSTYLE", "EXPERIMENT_ID": "CONTROL" }, "CHANGECHAPTER_INDEX_WRITER": { "FB_EVENT_NAME": "CHANGECHAPTER_INDEX_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "INDEX", "ACTION": "CHANGECHAPTER", "EXPERIMENT_ID": "CONTROL" }, "DELTECHAPTER_INDEX_WRITER": { "FB_EVENT_NAME": "DELTECHAPTER_INDEX_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "INDEX", "ACTION": "DELTECHAPTER", "EXPERIMENT_ID": "CONTROL" }, "EDITTITLE_INDEX_WRITER": { "FB_EVENT_NAME": "EDITTITLE_INDEX_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "INDEX", "ACTION": "EDITTITLE", "EXPERIMENT_ID": "CONTROL" }, "NEWCHAPTER_INDEX_WRITER": { "FB_EVENT_NAME": "NEWCHAPTER_INDEX_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "INDEX", "ACTION": "NEWCHAPTER", "EXPERIMENT_ID": "CONTROL" }, "NEWBOOKINFO_SUMMARY_WRITER": { "FB_EVENT_NAME": "NEWBOOKINFO_SUMMARY_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "SUMMARY", "ACTION": "NEWBOOKINFO", "EXPERIMENT_ID": "CONTROL" }, "UPDATEBOOKINFO_SUMMARY_WRITER": { "FB_EVENT_NAME": "UPDATEBOOKINFO_SUMMARY_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "SUMMARY", "ACTION": "UPDATEBOOKINFO", "EXPERIMENT_ID": "CONTROL" }, "CHANGECHAPTER_WRITERM_WRITER": { "FB_EVENT_NAME": "CHANGECHAPTER_WRITERM_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "WRITERM", "ACTION": "CHANGECHAPTER", "EXPERIMENT_ID": "CONTROL" }, "FINISHWRITING_WRITERM_WRITER": { "FB_EVENT_NAME": "FINISHWRITING_WRITERM_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "WRITERM", "ACTION": "FINISHWRITING", "EXPERIMENT_ID": "CONTROL" }, "LANDED_WRITERM_WRITER": { "FB_EVENT_NAME": "LANDED_WRITERM_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "WRITERM", "ACTION": "LANDED", "EXPERIMENT_ID": "CONTROL" }, "PREVIEWRITING_WRITERM_WRITER": { "FB_EVENT_NAME": "PREVIEWRITING_WRITERM_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "WRITERM", "ACTION": "PREVIEWRITING", "EXPERIMENT_ID": "CONTROL" }, "PUBLISHBOOK_WRITERM_WRITER": { "FB_EVENT_NAME": "PUBLISHBOOK_WRITERM_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "WRITERM", "ACTION": "PUBLISHBOOK", "EXPERIMENT_ID": "CONTROL" }, "SAVEWRITING_WRITERM_WRITER": { "FB_EVENT_NAME": "SAVEWRITING_WRITERM_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "WRITERM", "ACTION": "SAVEWRITING", "EXPERIMENT_ID": "CONTROL" }, "STARTWRITING_WRITERM_WRITER": { "FB_EVENT_NAME": "STARTWRITING_WRITERM_WRITER", "SCREEN_NAME": "WRITER", "LOCATION": "WRITERM", "ACTION": "STARTWRITING", "EXPERIMENT_ID": "CONTROL" }, "DISMISS_OPENAPP_READER": { "FB_EVENT_NAME": "DISMISS_OPENAPP_READER", "SCREEN_NAME": "READER", "ACTION": "DISMISS", "LOCATION": "OPENAPP" }, "GETANDROID_OPENAPP_READER": { "FB_EVENT_NAME": "GETANDROID_OPENAPP_READER", "SCREEN_NAME": "READER", "ACTION": "GETANDROID", "LOCATION": "OPENAPP" }, "VIEWANDROID_OPENAPP_READER": { "FB_EVENT_NAME": "VIEWANDROID_OPENAPP_READER", "SCREEN_NAME": "READER", "ACTION": "VIEWANDROID", "LOCATION": "OPENAPP" }, }; var REFERRER_DATA = { REFER_ACTION: 'DIRECT', REFER_LOCATION: 'DIRECT', REFER_SCREEN: 'DIRECT', REFER_EXPID: 'DIRECT' }; var FacebookEventTriggerUtil = (function () { return { triggerFacebookEventByName: function( eventName ) { this.triggerFacebookEventWithAllParams( eventName, "", "", "", "", "", ""); }, triggerFacebookEventByNameAndMetaData: function( eventName, metaData ) { this.triggerFacebookEventWithAllParams(eventName, "", "", "", "", "", "", "", metaData); }, triggerFacebookEventByNameAndState(eventName, state) { this.triggerFacebookEventWithAllParams(eventName, state, "", "", "", "", "", ""); }, triggerFacebookEventByNameAndValue(eventName, value) { this.triggerFacebookEventWithAllParams(eventName, "", value, "", "", "", "", ""); }, triggerFacebookEventByNameAndPratilipi(eventName, pratilipi) { this.triggerFacebookEventWithAllParams(eventName, "", "", "", pratilipi.type(), pratilipi.pratilipiId(), pratilipi.author.authorId(), ""); }, triggerFacebookEventByNameExperimentIdAndPratilipi(eventName, experimentId, pratilipi) { this.triggerFacebookEventWithAllParams(eventName, "", "", "", pratilipi.type(), pratilipi.pratilipiId(), pratilipi.author.authorId(), experimentId); }, triggerFacebookEventByNameAndParentId(eventName, parentId) { this.triggerFacebookEventWithAllParams(eventName, "", "", parentId, "", "", "", ""); }, triggerFacebookEventByNameStateValueAndParentId(eventName, state, value, parentId) { this.triggerFacebookEventWithAllParams(eventName, state, value, parentId, "", "", "", ""); }, triggerFacebookEventByNamePratilipiAndState(eventName, pratilipi, state) { this.triggerFacebookEventWithAllParams(eventName, state, "", "", pratilipi.type(), pratilipi.pratilipiId(), pratilipi.author.authorId(), ""); }, triggerFacebookEventByNameExperimentIdPratilipiAndState(eventName, experimentId, pratilipi, state) { this.triggerFacebookEventWithAllParams(eventName, state, "", "", pratilipi.type(), pratilipi.pratilipiId(), pratilipi.author.authorId(), experimentId); }, triggerFacebookEventByNamePratilipiAndValue(eventName, pratilipi, value) { this.triggerFacebookEventWithAllParams(eventName, "", value, "", pratilipi.type(), pratilipi.pratilipiId(), pratilipi.author.authorId(), ""); }, triggerFacebookEventByNamePratilipiAndParentId(eventName, pratilipi, parentId) { this.triggerFacebookEventWithAllParams(eventName, "", "", parentId, pratilipi.type(), pratilipi.pratilipiId(), pratilipi.author.authorId(), ""); }, triggerFacebookEventByNamePratilipiParentIdAndRecommendationMeta( eventName, pratilipi, parentId, metaData ) { this.triggerFacebookEventWithAllParams(eventName, "", "", parentId, pratilipi.type(), pratilipi.pratilipiId(), pratilipi.author.authorId(), "", metaData); }, triggerFacebookEventByNamePratilipiStateAndValue( eventName, pratilipi, state, value ) { this.triggerFacebookEventWithAllParams(eventName, state, value, "", pratilipi.type(), pratilipi.pratilipiId(), pratilipi.author.authorId()); }, triggerFacebookEventByNamePratilipiParentIdAndRecommendationMeta( eventName, pratilipi, parentId, metaData ) { this.triggerFacebookEventWithAllParams(eventName, "", "", parentId, pratilipi.type(), pratilipi.pratilipiId(), pratilipi.author.authorId(), "", metaData); }, triggerFacebookEventByNamePratilipiStateAndParentId( eventName, pratilipi, state, parentId ) { this.triggerFacebookEventWithAllParams(eventName, state, "", parentId, pratilipi.type(), pratilipi.pratilipiId(), pratilipi.author.authorId()); }, triggerFacebookEventByNamePratilipiAndMeta( eventName, pratilipi, metaData ) { this.triggerFacebookEventWithAllParams(eventName, pratilipi.state(), "", "", pratilipi.type(), pratilipi.pratilipiId(), pratilipi.author.authorId(), "", metaData); }, triggerFacebookEventByNameParentIdAndValue( eventName, parentId, value ) { this.triggerFacebookEventWithAllParams(eventName, "", value, parentId, "", "", ""); }, triggerFacebookEventByNamePratilipiValueAndParentId(eventName, pratilipi, value, parentId) { this.triggerFacebookEventWithAllParams(eventName, "", value, parentId, pratilipi.type(), pratilipi.pratilipiId(), pratilipi.author.authorId(), ""); }, triggerFacebookEventByNamePratilipiParentIdAndValue(eventName, pratilipi, parentId, value) { this.triggerFacebookEventWithAllParams(eventName, "", value, parentId, pratilipi.type(), pratilipi.pratilipiId(), pratilipi.author.authorId(), ""); }, triggerFacebookEventWithAllParams( eventName, state, value, parentId, type, contentId, authorId, experimentId, metaData) { if (!eventName) { return; }; var eventPreProperties = $.extend({}, FBEvents[eventName]); if (!eventPreProperties) { console.log('Invalid Eventname', 'background: #222; color: #bada55'); return; }; if (!eventPreProperties.SCREEN_NAME) { eventPreProperties.SCREEN_NAME = getLocation().fb_screen_name; if (!eventPreProperties.SCREEN_NAME) { console.log('Screen Name not present', 'background: #222; color: #bada55'); } }; var eventObj = { 'FB_EVENT_NAME': eventName, 'SCREEN_NAME': eventPreProperties.SCREEN_NAME, 'LOCATION': eventPreProperties.LOCATION, 'ACTION': eventPreProperties.ACTION, 'SCREEN_LOCATION': eventPreProperties.SCREEN_NAME + '_' + eventPreProperties.LOCATION, 'ENTITY_STATE': state || "", 'ENTITY_VALUE': value || "", 'PARENT_ID': parentId || "", 'PRATILIPI_TYPE': type || "", 'CONTENT_ID': contentId || "", 'AUTHOR_ID': authorId || "", 'EXPERIMENT_ID': experimentId || eventPreProperties.EXPERIMENT_ID || "" }; if (eventName.indexOf('LANDED') > -1) { eventObj.REFER_ACTION = REFERRER_DATA.REFER_ACTION; eventObj.REFER_LOCATION = REFERRER_DATA.REFER_LOCATION; eventObj.REFER_SCREEN = REFERRER_DATA.REFER_SCREEN; eventObj.REFER_EXPID = REFERRER_DATA.REFER_EXPID; } if (eventName !== 'VIEWED_APPBANNER_GLOBAL') { REFERRER_DATA = { REFER_ACTION: eventPreProperties.ACTION, REFER_LOCATION: eventPreProperties.LOCATION, REFER_SCREEN: eventPreProperties.SCREEN_NAME, REFER_EXPID: experimentId || eventPreProperties.EXPERIMENT_ID } } if (metaData) { for(var property in metaData){ eventObj[property] = metaData[property]; }; } this.triggerFacebookEvent(eventObj); }, triggerFacebookEvent: function (eventObj) { eventObj['CONTENT_LANGUAGE'] = appViewModel.language, eventObj['DEVICE_TYPE'] = isMobile() ? 'MOBILE': 'DESKTOP', eventObj['WEBSITE_TYPE'] = 'MAIN_WEBSITE', eventObj['ENVIRONMENT'] = 'PROD_BRIDGE', eventObj['USER_ID'] = appViewModel.user.userId(); console.log('EVENT NAME: ', eventObj['FB_EVENT_NAME']); console.log('EVENT DATA: ', eventObj); if (eventObj['ACTION'] == 'LOGOUT') { amplitude.getInstance().setUserId(null); amplitude.getInstance().regenerateDeviceId(); } if (!window.FB) { setTimeout(function () { amplitude.getInstance().logEvent(eventObj['FB_EVENT_NAME'], eventObj); FB.AppEvents.logEvent(eventObj['FB_EVENT_NAME'], null, eventObj); }, 15000); return; } setTimeout(function () { amplitude.getInstance().logEvent(eventObj['FB_EVENT_NAME'], eventObj); FB.AppEvents.logEvent(eventObj['FB_EVENT_NAME'], null, eventObj); }, 0); }, isScrolledIntoView: function (element, fullyInView) { if (!element || element.length === 0) { return false; } var pageTop = $(window).scrollTop(); var pageBottom = pageTop + $(window).height(); var elementTop = $(element).offset().top; var elementBottom = elementTop + $(element).height(); if (fullyInView === true) { return ((pageBottom > elementBottom)); } else { return ((elementTop <= pageBottom) && (elementBottom >= pageTop)); } }, setUserProperties: function (propertyName, value) { if (!propertyName || !value) { return; } var propertyObject = {}; propertyObject[propertyName] = value; if (!window.FB) { setTimeout(function () { var identify = new amplitude.Identify(); identify.set(propertyName, value); amplitude.getInstance().identify(identify); FB.AppEvents.updateUserProperties(propertyObject, function (res) { /* console.log(res); */ } ); }, 15000); return; } setTimeout(function () { var identify = new amplitude.Identify(); identify.set(propertyName, value); amplitude.getInstance().identify(identify); FB.AppEvents.updateUserProperties(propertyObject, function (res) { /* console.log(res); */ } ); }, 0); } }; })(); function Timer( fn, t ) { /* http://stackoverflow.com/questions/8126466/javascript-reset-setinterval-back-to-0 */ var timerObj = setInterval( fn, t ); this.stop = function() { if( timerObj ) { clearInterval( timerObj ); timerObj = null; } return this; }; /* start timer using current settings (if it's not already running) */ this.start = function() { if( !timerObj ) { this.stop(); timerObj = setInterval( fn, t ); } return this; }; /* start with new interval, stop current interval */ this.reset = function( newT ) { if( newT ) t = newT; return this.stop().start(); }; }(function($, ko) { /* https://github.com/seantimm/Knockout.LazyLoad/blob/master/ko.lazyload.js */ 'use strict'; function KoLazyLoad() { var self = this; var updatebit = ko.observable(true).extend({ throttle: 50 }); var handlers = { img: updateImage }; function flagForLoadCheck() { updatebit( !updatebit() ); } $(window).on( 'scroll', flagForLoadCheck ); $(window).on( 'resize', flagForLoadCheck ); function isInViewport(element) { var rect = element.getBoundingClientRect(); return rect.bottom > 0 && rect.right > 0 && rect.top < (window.innerHeight || document.documentElement.clientHeight) && rect.left < (window.innerWidth || document.documentElement.clientWidth); } function updateImage(element, valueAccessor, allBindings, viewModel, bindingContext) { var value = ko.unwrap( valueAccessor() ); if( isInViewport(element) ) { element.src = value; $(element).data('kolazy', true); } } function init(element, valueAccessor, allBindings, viewModel, bindingContext) { var initArgs = arguments; updatebit.subscribe(function() { update.apply(self, initArgs); }); } function update(element, valueAccessor, allBindings, viewModel, bindingContext) { var $element = $(element); if ($element.is(':hidden') || $element.css('visibility') == 'hidden' || $element.data('kolazy')) { return; } var handlerName = element.tagName.toLowerCase(); if (handlers.hasOwnProperty(handlerName)) { return handlers[handlerName].apply(this, arguments); } else { throw new Error('No lazy handler defined for "' + handlerName + '"'); } } return { handlers: handlers, init: init, update: update } } ko.bindingHandlers.lazyload = new KoLazyLoad(); })(jQuery, ko);/* Global Variables */ var ga_category = null; var shareUrl = null; var shareWhatsappText = null; var authorForEvent = null; var fbEventParams = null; /* Share Modal */ function viewModel() { var self = this; self.shareOnFacebook = function() { ga_CA( ga_category, 'FB-Share' ); if (fbEventParams.pratilipi) self.triggerFacebookEvent('SHAREBOOKFB'); if (fbEventParams.author) self.triggerFacebookEvent('SHAREUSERFB'); window.open( "http://www.facebook.com/sharer.php?u=" + shareUrl, "share", "width=1100,height=500,left=70px,top=60px" ); }; self.shareOnTwitter = function() { ga_CA( ga_category, 'Twitter-Share' ); if (fbEventParams.pratilipi) self.triggerFacebookEvent('SHAREBOOKTW'); if (fbEventParams.author) self.triggerFacebookEvent('SHAREUSERTW'); window.open( "http://twitter.com/share?url=" + shareUrl, "share", "width=1100,height=500,left=70px,top=60px" ); }; self.shareOnGplus = function() { ga_CA( ga_category, 'G+-Share' ); if (fbEventParams.pratilipi) self.triggerFacebookEvent('SHAREBOOKGP'); if (fbEventParams.author) self.triggerFacebookEvent('SHAREUSERGP'); window.open( "https://plus.google.com/share?url=" + shareUrl, "share", "width=1100,height=500,left=70px,top=60px" ); }; self.shareOnWhatsapp = function() { ga_CA( ga_category, 'Whatsapp-Share' ); if (fbEventParams.pratilipi) self.triggerFacebookEvent('SHAREBOOKWA'); if (fbEventParams.author) self.triggerFacebookEvent('SHAREUSERWA'); window.open( "whatsapp://send?text=" + shareWhatsappText ); }; /** * Facebook events */ this.triggerFacebookEvent = function(eventName) { if ( (!fbEventParams.pratilipi && !fbEventParams.author) || !fbEventParams.screenName) { return; } switch (eventName) { case 'SHAREBOOKFB': var finalEventName = eventName + '_' + fbEventParams.screenName; FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndValue(finalEventName, fbEventParams.pratilipi, 'FACEBOOK'); break; case 'SHAREBOOKGP': var finalEventName = eventName + '_' + fbEventParams.screenName; FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndValue(finalEventName, fbEventParams.pratilipi, 'GOOGLEPLUS'); break; case 'SHAREBOOKOT': break; case 'SHAREBOOKTW': var finalEventName = eventName + '_' + fbEventParams.screenName; FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndValue(finalEventName, fbEventParams.pratilipi, 'TWITTER'); break; case 'SHAREBOOKWA': var finalEventName = eventName + '_' + fbEventParams.screenName; FacebookEventTriggerUtil.triggerFacebookEventByNamePratilipiAndValue(finalEventName, fbEventParams.pratilipi, 'WHATSAPP'); break; case 'SHAREUSERFB': var finalEventName = eventName + '_' + fbEventParams.screenName; FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue(finalEventName, fbEventParams.author.authorId(), 'FACEBOOK'); break; case 'SHAREUSERGP': var finalEventName = eventName + '_' + fbEventParams.screenName; FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue(finalEventName, fbEventParams.author.authorId(), 'GOOGLEPLUS'); break; case 'SHAREUSEROT': break; case 'SHAREUSERTW': var finalEventName = eventName + '_' + fbEventParams.screenName; FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue(finalEventName, fbEventParams.author.authorId(), 'TWITTER'); break; case 'SHAREUSERWA': var finalEventName = eventName + '_' + fbEventParams.screenName; FacebookEventTriggerUtil.triggerFacebookEventByNameParentIdAndValue(finalEventName, fbEventParams.author.authorId(), 'WHATSAPP'); break; default: console.log('INVALID EVENT TRIGGERED: ', eventName); } return true; }; } ko.components.register( 'pratilipi-share-dialog', { viewModel: viewModel, template: `<div class="modal common-modal fade" id="pratilipi-share-dialog" tabindex="-1" role="dialog" aria-labelledby="pratilipi-share-dialog"><div class="modal-dialog" style="max-width: 350px;" role="document"><div class="modal-content"><div class="modal-header"><button class="mdl-button mdl-js-button mdl-button--icon close" class="close" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button><h6 style="margin: 0;" class="material-title">ಶೇರ್</h6></div><div class="modal-body" style="padding: 15px;"><ul class="mdl-list"><li data-bind="click: shareOnFacebook" class="mdl-list__item clickable-element"><span class="mdl-list__item-primary-content"><span class="sprites-icon mdl-list__item-icon facebook-icon"></span><span class="font-m">ಫೇಸ್ಬುಕ್</span></span></li><li data-bind="click: shareOnTwitter" class="mdl-list__item clickable-element"><span class="mdl-list__item-primary-content"><span class="sprites-icon mdl-list__item-icon twitter-icon"></span><span class="font-m">ಟ್ವಿಟರ್</span></span></li><li data-bind="click: shareOnGplus" class="mdl-list__item clickable-element"><span class="mdl-list__item-primary-content"><span class="sprites-icon mdl-list__item-icon google-plus-icon"></span><span class="font-m">ಗೂಗಲ್ ಪ್ಲಸ್</span></span></li><li onclick="ga_CA( 'Pratilipi', 'Whatsapp-Share' )"data-bind="{ click: shareOnWhatsapp, visible: isMobile() }" class="mdl-list__item clickable-element"><span class="mdl-list__item-primary-content"><span class="sprites-icon mdl-list__item-icon whatsapp-icon"></span><span class="font-m">ವಾಟ್ಸಪ್</span></span></li></ul></div></div></div></div>` }); var shareDialog = document.createElement( 'pratilipi-share-dialog' ); shareDialog.style.zIndex = "1051"; shareDialog.style.display = "none"; document.body.appendChild( shareDialog ); var ShareUtil = (function() { return { sharePratilipi: function( koPratilipiObject, utmParams, screenName ) { var pratilipi = ko.mapping.toJS(koPratilipiObject); var getShareUrl = function() { return window.location.origin + '/' + pratilipi.pageUrl.split('/')[1] + '/' + pratilipi.pageUrl.split('/').pop().split('-').pop(); }; var getWhatsappText = function() { return '"' + pratilipi.title + '", ಪ್ರತಿಲಿಪಿಯಲ್ಲಿ ಓದಿರಿ : ' + getShareUrl() +" ಅನಿಯಮಿತ ಕಥೆ, ಕವನ, ಲೇಖನಗಳನ್ನು ಭಾರತೀಯ ಭಾಷೆಗಳಲ್ಲಿ ಉಚಿತವಾಗಿ ಓದಿರಿ!"; }; /* MetaTagUtil.setMetaTagsForPratilipi( pratilipi ); */ ga_category = "Pratilipi"; if (getLocation().ga_value == "PratilipiPage") { /* fbEvent("LANDED_SHARE_CONTENT", null); */ } this.share( getShareUrl(), getWhatsappText(), utmParams, { pratilipi: koPratilipiObject, screenName: screenName } ); }, shareAuthor: function( koAuthorObject, utmParams, eventParams, screenName ) { var author = ko.mapping.toJS(koAuthorObject); var getShareUrl = function() { return window.location.origin + '/' + author.pageUrl.split('/')[1] + '/' + author.pageUrl.split('/').pop().split('-').pop(); }; var getWhatsappText = function() { return '"' + author.name + '", ಪ್ರತಿಲಿಪಿಯಲ್ಲಿ ಓದಿರಿ : ' + getShareUrl() +" ಅನಿಯಮಿತ ಕಥೆ, ಕವನ, ಲೇಖನಗಳನ್ನು ಭಾರತೀಯ ಭಾಷೆಗಳಲ್ಲಿ ಉಚಿತವಾಗಿ ಓದಿರಿ!"; }; /* MetaTagUtil.setMetaTagsForAuthor( author ); */ ga_category = "Author"; authorForEvent = author; fbEventParams = eventParams; if (getLocation().fb_value) { /* fbAuthorEvent("LANDED_SHARE_AUTHOR", null); */ } this.share( getShareUrl(), getWhatsappText(), utmParams, { author: koAuthorObject, screenName: screenName } ); }, share: function( url, whatsappText, utmParams, fbEventDetails ) { shareDialog.style.display = "block"; shareUrl = encodeURIComponent( url + ( utmParams != null ? "?" + new HttpUtil().formatParams( utmParams ) : "" ) ); shareWhatsappText = whatsappText != null ? encodeURIComponent( whatsappText ) : null; fbEventParams = fbEventDetails; $( "#pratilipi-share-dialog" ).modal(); } }; })();/* http://knockoutjs.com/documentation/component-registration.html#a-shared-object-instance */ var reportViewModel = function( params ) { var self = this; var dataAccessor = new DataAccessor(); /* fields */ this.name = ko.observable( "" ); this.hasName = ko.observable(); this.email = ko.observable( "" ); this.hasEmail = ko.observable(); /* this.phone = ko.observable( "" ); this.hasPhone = ko.observable(); */ this.message = ko.observable( "" ); /* data */ this.dataType = null; this.dataId = null; /* flight */ this.requestOnFlight = ko.observable( false ); /* private functions */ this._openModal = function() { $( "#pratilipi-report-dialog" ).modal( 'show' ); }; this._closeModal = function() { $( "#pratilipi-report-dialog" ).modal( 'hide' ); }; this._submit = function() { if( self.requestOnFlight() ) return; if( !validateEmail( self.email() ) ) { ToastUtil.toast( "ದಯವಿಟ್ಟು ಸರಿಯಾಗಿರುವ ಇಮೇಲ್'ಅನ್ನು ನಮೂದಿಸಿ" ); return; } /* if( !validatePhone( self.phone() ) ) { ToastUtil.toast( "ಮೊಬೈಲ್ ಸಂಖ್ಯೆಯು ತಪ್ಪಾಗಿ ನಮೂದಾಗಿದೆ" ); return; } */ self.requestOnFlight( true ); ToastUtil.toastUp( "ಕಾರ್ಯ ನಿರ್ವಹಿಸುತ್ತಿದೆ..." ); dataAccessor.reportContent( self.name(), self.email(), null, /* phone */ self.message(), self.dataType, self.dataId, function( success ) { self.requestOnFlight( false ); ToastUtil.toast( "ಯಶಸ್ವಿ!" ); self._closeModal(); }, function( error ) { self.requestOnFlight( false ); ToastUtil.toast( error.message != null ? error.message : "ಏನೋ ಸಮಸ್ಯೆ ಆಗಿದೆ! ದಯವಿಟ್ಟು ಮತ್ತೆ ಪ್ರಯತ್ನಿಸಿ!" ); } ); }; /* public functions */ this.report = function( dataType, dataId, dataObject, analyticsEvent ) { if( appViewModel.user.isGuest() ) { goToLoginPage( { "action": "reportContent", "dataType": dataType, "dataId": dataId } ); return; } /* Set dataType and dataId */ self.dataType = dataType; self.dataId = dataId; /* Fire analytics event */ if( dataObject ) { switch( dataType ) { case "PRATILIPI": FacebookEventTriggerUtil.triggerFacebookEventByNameAndPratilipi( analyticsEvent, dataObject ); break; case "AUTHOR": break; case "REVIEW": break; case "COMMENT": break; default: break; }; } /* set name */ self.hasName( appViewModel.user.displayName() != null && appViewModel.user.displayName().trim() != "" ); self.name( self.hasName() ? appViewModel.user.displayName() : "" ); /* set email */ self.hasEmail( appViewModel.user.email() != null && appViewModel.user.email().trim() != "" ); self.email( self.hasEmail() ? appViewModel.user.email() : "" ); /* set phone */ /* self.hasPhone( appViewModel.user.phone() != null && appViewModel.user.phone().trim() != "" ); self.phone( self.hasPhone() ? appViewModel.user.phone() : "" ); */ /* set message */ self.message( "" ); /* Open Modal */ setTimeout(function() { self._openModal() }); }; /* Clicking anywhere outside the screen */ $( "#pratilipi-report-dialog" ).on( 'hidden.bs.modal', function(e) { self._closeModal(); }); /* Computed observables */ this._canReport = ko.computed( function() { return ! self.requestOnFlight() && self.name().trim() != '' && self.email().trim() != '' && self.message().trim() != ''; }, this ); setTimeout(function() { /* async -> allow appViewModel to initialise */ self.userObserver = ko.computed( function() { if( ! appViewModel.user.isGuest() ) { setTimeout(function() { var dataType = getUrlParameter( 'dataType' ), dataId = getUrlParameter( 'dataId' ); if( getUrlParameter( 'action' ) == "reportContent" && dataType != null && dataId != null ) self.report( dataType, dataId ); }); } }, self ); }); } ; var reportViewModelInstance = new reportViewModel(); ko.components.register( 'pratilipi-report-dialog', { viewModel: { instance: reportViewModelInstance }, template: `<div class="pratilipi-report-dialog modal common-modal fade"id="pratilipi-report-dialog"tabindex="-1"role="dialog"aria-labelledby="pratilipi-report-dialog"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><span class="material-title">ಸಮಸ್ಯೆಯನ್ನು ವರದಿ ಮಾಡಿ</span><button class="mdl-button mdl-js-button mdl-button--icon close" data-bind="click: _closeModal"><i class="material-icons">close</i></button></div><div class="modal-body"><!-- ko if: !hasName() --><input type="text" data-bind="mdlFloatingInput: { label: 'ಹೆಸರು', value: name, id: 'pratilipi_report_dialog_name' }, valueUpdate: ['input'], transliterate: true" /><!-- /ko --><!-- ko if: !hasEmail() --><input type="email" data-bind="mdlFloatingInput: { label: 'ಇಮೇಲ್', value: email, id: 'pratilipi_report_dialog_email' }, valueUpdate: ['input']" /><!-- /ko --><textarea rows="4"data-bind="{ mdlFloatingInput: { label: 'ಸಮಸ್ಯೆ', value: message, id: 'pratilipi_report_dialog_message' },valueUpdate: ['input'],transliterate: true }"></textarea></div><div class="modal-footer"><button data-bind="click: _closeModal"class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin">ರದ್ದುಗೊಳಿಸಿ</button><button data-bind="click: _submit, enable: _canReport"class="mdl-button mdl-js-button mdl-button--colored mdl-js-ripple-effect mdl-button--raised">ಸಬ್ಮಿಟ್ ಮಾಡಿ</button></div></div></div></div>` }); var reportDialog = document.createElement( 'pratilipi-report-dialog' ); reportDialog.style.zIndex = "1051"; document.body.appendChild( reportDialog ); var ReportUtil = (function() { return { report: function( dataType, dataId, dataObject, analyticsEvent ) { if( dataType != null || dataId != null ) { reportViewModelInstance.report( dataType, dataId, dataObject, analyticsEvent ); } else { if( dataType == null ) console.error( "ReportUtil: dataType Required" ); if( dataId == null ) console.error( "ReportUtil: dataId Required" ); } } }; })(); </script> <script> /* Test Environment */ var isTestEnvironment = false; var aEEUserIdList = []; aEEUserIdList.push( 5644707593977856 );aEEUserIdList.push( 6243664397336576 );aEEUserIdList.push( 4900189601005568 );aEEUserIdList.push( 4790800105865216 );aEEUserIdList.push( 6755388383982685 );aEEUserIdList.push( 5664902681198592 );aEEUserIdList.push( 4900071594262528 );aEEUserIdList.push( 5694768648552448 );aEEUserIdList.push( 6264191547604992 );aEEUserIdList.push( 5187684625547264 );aEEUserIdList.push( 5715256422694912 );aEEUserIdList.push( 6311393362968576 );aEEUserIdList.push( 5373377891008512 );aEEUserIdList.push( 5743817900687360 );aEEUserIdList.push( 5666355716030464 );aEEUserIdList.push( 5124071978172416 );aEEUserIdList.push( 4793124336435200 );aEEUserIdList.push( 5013864096727040 );aEEUserIdList.push( 6046961763352576 );aEEUserIdList.push( 5991416564023296 );aEEUserIdList.push( 4908348089565184 );aEEUserIdList.push( 5073076857339904 ); /* Location */ var LOCATION = { HOME: { ga_value: "HomePage", ko_element: "pratilipi-home-page", fb_value: "HOME", fb_screen_name: "HOME" }, LIST: { ga_value: "ListPage", ko_element: "pratilipi-list-page", fb_screen_name: "CATEGORY" }, LIBRARY: { ga_value: "LibraryPage", ko_element: "pratilipi-library-page", fb_screen_name: "LIBRARY" }, SEARCH : { ga_value: "SearchPage", ko_element: "pratilipi-search-page", fb_screen_name: "SEARCH" }, SEARCH_V2: { ga_value: "SearchPage", ko_element: "pratilipi-search-page-v2", hide_appshell: true, fb_screen_name: "SEARCH" }, EVENTS: { ga_value: "AllEventsPage", ko_element: "pratilipi-event-list-page", fb_screen_name: "EVENTLIST" }, EVENT: { ga_value: "EventPage", ko_element: "pratilipi-event-page", fb_screen_name: "EVENT" }, AUTHOR: { ga_value: "AuthorPage", ko_element: "pratilipi-author-page", fb_value: "AUTHOR_PAGE", fb_screen_name: "USER" }, USER: { ga_value: "UserPage", ko_element: "pratilipi-author-page", fb_screen_name: "MYPROFILE" }, PRATILIPI: { ga_value: "PratilipiPage", ko_element: "pratilipi-pratilipi-page", fb_value: "PRATILIPI_PAGE", fb_screen_name: "BOOK" }, LOGIN: { ga_value: "LoginPage", ko_element: "pratilipi-login-page", hide_appshell: true, fb_screen_name: "LOGIN" }, REGISTER: { ga_value: "RegisterPage", ko_element: "pratilipi-register-page", hide_appshell: true, fb_screen_name: "REGISTER" }, FORGOT_PASSWORD: { ga_value: "ForgotPasswordPage", ko_element: "pratilipi-forgot-password-page", hide_appshell: true, fb_screen_name: "FORGOTP" }, RESET_PASSWORD: { ga_value: "ResetPasswordPage", ko_element: "pratilipi-reset-password-page", hide_appshell: true, fb_screen_name: "SETNGPRI" }, VERIFY_USER: { ga_value: "VerifyUserPage", ko_element: "pratilipi-verify-user-page", hide_appshell: true, fb_screen_name: "VERIFYU" }, LOGIN_V2: { ga_value: "LoginPage", ko_element: "pratilipi-login-page-v2", hide_appshell: true, fb_screen_name: "LOGIN" }, NOTIFICATIONS: { ga_value: "NotificationsPage", ko_element: "pratilipi-notifications-page", fb_screen_name: "NOTIFS" }, SETTINGS: { ga_value: "UserSettings", ko_element: "pratilipi-settings-page", fb_screen_name: "SETTINGS" }, BLOG: { ga_value: "AllBlogsPage", ko_element: "pratilipi-blog-page", fb_screen_name: "BLOGLIST" }, AUTHOR_INTERVIEWS: { ga_value: "AllAuthorInterviewsPage", ko_element: "pratilipi-blog-page", fb_screen_name: "AUTHORINT" }, BLOG_POST: { ga_value: "BlogPage", ko_element: "pratilipi-blog-post-page", fb_screen_name: "BLOG" }, AUTHOR_INTERVIEW_POST: { ga_value: "AuthorInterviewPage", ko_element: "pratilipi-blog-post-page", fb_screen_name: "VERIFYU" }, PRATILIPI_2016: { ga_value: "Pratilipi2016Page", ko_element: "pratilipi-pratilipi2016-page", fb_screen_name: "PRATILIPI2016" }, STATIC: { ga_value: "StaticPage", ko_element: "pratilipi-static-page", fb_screen_name: "STATIC" }, MY_PROFILE: { ga_value: "MyProfilePage", ko_element: "pratilipi-myprofile-page", fb_screen_name: "MYPROFILE" }, PAGE_NOT_FOUND: { ga_value: "PageNotFound", ko_element: "pratilipi-pagenotfound-page", fb_screen_name: "NOTFOUND" }, SERVER_ERROR: { ga_value: "ServerError", ko_element: "pratilipi-servererror-page", fb_screen_name: "SERVERERROR" }, DRAFTS_ACCESS_ERROR: { ga_value: "DraftsAccessError", ko_element: "pratilipi-drafts-access-error", fb_screen_name: "DRAFTSACCESSERROR" }, READER: { ga_value: "Reader", ko_element: "pratilipi-reader", hide_appshell: true, fb_screen_name: "READER" }, WRITER: { ga_value: "Writer", ko_element: null, fb_value: "WRITER_PANEL", fb_screen_name: "WRITER" }, VIDEOSERIES_LIST: { ga_value: "VideoSeriesListPage", ko_element: "pratilipi-videoseries-list-page", fb_screen_name: "VIDEOSERIESLIST" }, VIDEOSERIES: { ga_value: "VideoSeriesPage", ko_element: "pratilipi-videoseries-page", fb_screen_name: "VIDEOSERIES" }, VIDEO: { ga_value: "VideoPage", ko_element: "pratilipi-video-page", fb_screen_name: "VIDEO" }, MESSAGES: { ga_value: "Messages", ko_element: "pratilipi-messages", hide_appshell: true, fb_screen_name: "MESSAGES" }, MESSAGES_USER: { ga_value: "MessagesUser", ko_element: "pratilipi-message-user", hide_appshell: true, fb_screen_name: "MESSAGES_USER" } }; function getLocation( location ) { String.prototype.count = function( s1 ) { return ( this.length - this.replace( new RegExp(s1,"g"), '' ).length ) / s1.length; }; if( location == null ) location = window.location.pathname; if( location == "/" ) return LOCATION.HOME; else if( location == "/library" ) return LOCATION.LIBRARY; else if( location == "/search" ) return LOCATION.SEARCH_V2; /* return appViewModel && appViewModel.isAEETestEnvironment() ? LOCATION.SEARCH_V2 : LOCATION.SEARCH; */ else if( location == "/login" ) return isTestEnvironment ? LOCATION.LOGIN_V2 : LOCATION.LOGIN; else if( location == "/register" ) return LOCATION.REGISTER; else if( location == "/forgot-password" ) return LOCATION.FORGOT_PASSWORD; else if( location == "/reset-password" ) return LOCATION.RESET_PASSWORD; else if( location == "/verify-user" ) return LOCATION.VERIFY_USER; else if( location == "/notifications" ) return LOCATION.NOTIFICATIONS; else if( location == "/settings" ) return LOCATION.SETTINGS; else if( location == "/event" ) return LOCATION.EVENTS; else if( location.startsWith( "/event/" ) && location.count( '/' ) == 2 ) return LOCATION.EVENT; else if( location == "/blog" ) return LOCATION.BLOG; else if( location == "/author-interviews" ) return LOCATION.AUTHOR_INTERVIEWS; else if( location.startsWith( "/blog/" ) && location.count( '/' ) == 2 ) return LOCATION.BLOG_POST; else if( location.startsWith( "/author-interviews/" ) && location.count( '/' ) == 2 ) return LOCATION.AUTHOR_INTERVIEW_POST; else if( location.startsWith( "/blogpost/" ) && location.count( '/' ) == 2 ) return LOCATION.BLOG_POST; else if( location == "/pratilipi-2016" ) return LOCATION.PRATILIPI_2016; else if( location == "/my-profile" ) return LOCATION.MY_PROFILE; else if( location.startsWith( "/messages" ) && location.count( '/' ) == 1 ) return LOCATION.MESSAGES; else if( location.startsWith( "/messages" ) && location.count( '/' ) == 2 ) return LOCATION.MESSAGES_USER; /* List pages */ else if( location == "/5kreads" ) return LOCATION.LIST; else if( location == "/horrorhome" ) return LOCATION.LIST; else if( location == "/letterbox-banner" ) return LOCATION.LIST; else if( location == "/editorschoice" ) return LOCATION.LIST; else if( location == "/life" ) return LOCATION.LIST; else if( location == "/editors-choice" ) return LOCATION.LIST; else if( location == "/satire" ) return LOCATION.LIST; else if( location == "/homewomen" ) return LOCATION.LIST; else if( location == "/homelove" ) return LOCATION.LIST; else if( location == "/books" ) return LOCATION.LIST; else if( location == "/mostreaddec" ) return LOCATION.LIST; else if( location == "/relationship" ) return LOCATION.LIST; else if( location == "/winterdec" ) return LOCATION.LIST; else if( location == "/nonfiction" ) return LOCATION.LIST; else if( location == "/splarticles" ) return LOCATION.LIST; else if( location == "/friendship" ) return LOCATION.LIST; else if( location == "/articles-home" ) return LOCATION.LIST; else if( location == "/inspirational" ) return LOCATION.LIST; else if( location == "/festival-stories" ) return LOCATION.LIST; else if( location == "/horror-suspense-crime-oct" ) return LOCATION.LIST; else if( location == "/current-event" ) return LOCATION.LIST; else if( location == "/kavyadhare" ) return LOCATION.LIST; else if( location == "/diwali" ) return LOCATION.LIST; else if( location == "/otherstories" ) return LOCATION.LIST; else if( location == "/travel-companion" ) return LOCATION.LIST; else if( location == "/newcontents" ) return LOCATION.LIST; else if( location == "/science" ) return LOCATION.LIST; else if( location == "/teatimecollection" ) return LOCATION.LIST; else if( location == "/love" ) return LOCATION.LIST; else if( location == "/aow" ) return LOCATION.LIST; else if( location == "/editorialcollectionnov" ) return LOCATION.LIST; else if( location == "/latest-stories" ) return LOCATION.LIST; else if( location == "/homelife" ) return LOCATION.LIST; else if( location == "/society" ) return LOCATION.LIST; else if( location == "/2minstories" ) return LOCATION.LIST; else if( location == "/newold" ) return LOCATION.LIST; else if( location == "/2kreads" ) return LOCATION.LIST; else if( location == "/spiritual" ) return LOCATION.LIST; else if( location == "/homepoems" ) return LOCATION.LIST; else if( location == "/mothers-day" ) return LOCATION.LIST; else if( location == "/articles" ) return LOCATION.LIST; else if( location == "/longform" ) return LOCATION.LIST; else if( location == "/poems" ) return LOCATION.LIST; else if( location == "/most-read" ) return LOCATION.LIST; else if( location == "/hidden-gems" ) return LOCATION.LIST; else if( location == "/3am" ) return LOCATION.LIST; else if( location == "/monsoon" ) return LOCATION.LIST; else if( location == "/stories" ) return LOCATION.LIST; else if( location == "/thriller" ) return LOCATION.LIST; else if( location == "/deceditorial" ) return LOCATION.LIST; else if( location == "/politics" ) return LOCATION.LIST; else if( location == "/dhaaraavaahi" ) return LOCATION.LIST; else if( location == "/horror" ) return LOCATION.LIST; else if( location == "/classic-sahitya" ) return LOCATION.LIST; else if( location == "/poems-home" ) return LOCATION.LIST; else if( location == "/comedy" ) return LOCATION.LIST; else if( location == "/bannerpoems" ) return LOCATION.LIST; else if( location == "/classicandcontemporary-oct" ) return LOCATION.LIST; else if( location == "/newyear2017" ) return LOCATION.LIST; else if( location == "/love-stories" ) return LOCATION.LIST; else if( location == "/women" ) return LOCATION.LIST; else if( location == "/rated" ) return LOCATION.LIST; else if( location == "/fiction" ) return LOCATION.LIST; else if( location == "/recommended" ) return LOCATION.LIST; else if( location == "/2minstoriesnov" ) return LOCATION.LIST; else if( location == "/cinema" ) return LOCATION.LIST; else if( location == "/popular-stories" ) return LOCATION.LIST; else if( location == "/specialcollectionnov" ) return LOCATION.LIST; else if( location == "/selfpublished" ) return LOCATION.LIST; else if( location == "/most-read-stories" ) return LOCATION.LIST; else if( location == "/homearticles" ) return LOCATION.LIST; else if( location == "/relationshipstories" ) return LOCATION.LIST; /* Static pages */ else if( location == "/about/pratilipi" ) return LOCATION.STATIC; else if( location == "/terms-of-service" ) return LOCATION.STATIC; else if( location == "/privacy-policy" ) return LOCATION.STATIC; else if( location == "/work-with-us" ) return LOCATION.STATIC; /* Error pages */ else if( location == "/error/servererror" ) return LOCATION.SERVER_ERROR; else if( location == "/error/pagenotfound" ) return LOCATION.PAGE_NOT_FOUND; else if( location == "/error/draftedcontent" ) return LOCATION.DRAFTS_ACCESS_ERROR; /* Reader */ else if( location == "/read" ) return LOCATION.READER; /* Writer */ else if( location == "/write" || location == "/pratilipi-write" ) return LOCATION.WRITER; /* Video Series */ else if( location == "/videoseries" ) return LOCATION.VIDEOSERIES_LIST; else if( location.startsWith( "/videoseries/" ) && location.count( '/' ) == 2 ) return LOCATION.VIDEOSERIES; else if( location.startsWith( "/video/" ) && location.count( '/' ) == 2 ) return LOCATION.VIDEO; /* Author */ else if( location.startsWith( "/user/" ) && location.count( '/' ) == 2) return appViewModel == null ? LOCATION.AUTHOR : ( appViewModel.isUserPage() ? LOCATION.USER : LOCATION.AUTHOR ); /* Setting for the first time in case routing is not supported */ else if( location.startsWith( "/author/" ) && location.count( '/' ) == 2 ) return appViewModel == null ? LOCATION.AUTHOR : ( appViewModel.isUserPage() ? LOCATION.USER : LOCATION.AUTHOR ); else if( location.count( '/' ) == 1 ) return appViewModel == null ? LOCATION.AUTHOR : ( appViewModel.isUserPage() ? LOCATION.USER : LOCATION.AUTHOR ); else if( location.startsWith( "/pratilipi/" ) && location.count( '/' ) == 2 ) return LOCATION.PRATILIPI; else if( location.startsWith( "/book/" ) && location.count( '/' ) == 2 ) return LOCATION.PRATILIPI; else if( location.startsWith( "/story/" ) && location.count( '/' ) == 2 ) return LOCATION.PRATILIPI; else if( location.startsWith( "/article/" ) && location.count( '/' ) == 2 ) return LOCATION.PRATILIPI; else if( location.startsWith( "/poem/" ) && location.count( '/' ) == 2 ) return LOCATION.PRATILIPI; else if( location.count( '/' ) == 2 ) return LOCATION.PRATILIPI; else return LOCATION.PAGE_NOT_FOUND; } /* KO App Initialisation */ var AppViewModel = function() { var defaultUser = { "userId": null, "author": { "authorId": null }, "displayName": null, "email": null, "phone": null, "state": null, "isGuest": true, "isEmailVerified": false, "profilePageUrl": null, "profileImageUrl": null, "firebaseToken": null }; var self = this; this.user = ko.mapping.fromJS( defaultUser, {}, this.user ); this.notificationCount = ko.observable( -1 ); this.searchQuery = ko.observable(); this.pratilipiWriteAuthorId = ko.observable(); this.userPreferences = ko.observable( {} ); this.metaTags = ko.observableArray(); this.pageTitle = ko.observable(); this.pageDescription = ko.observable(); this.randomQuote = ko.observable( getRandomQuote() ); this.scrollTop = ko.observable(); this.firebaseGrowthDB = ko.observable(); this.scrollTopObserver = ko.computed( function() { self.scrollTop(); setTimeout( function() { $(window).scroll(); /* Trigger scroll event on window */ } ); }, this ); this.notifyOfScrollEvent = function() { self.scrollTop( Math.max( $( ".mdl-layout" ).scrollTop(), $( ".mdl-layout__content" ).scrollTop() ) ); }; this.scrollToTop = function( scrollTop ) { $( ".mdl-layout" ).animate({ scrollTop: scrollTop != null ? scrollTop : 0 }, 200 ); $( ".mdl-layout__content" ).animate({ scrollTop: scrollTop != null ? scrollTop : 0 }, 200 ); }; this.isUserPage = ko.observable(); /* Used for GA tracking -> When Author is visiting his/her own page. */ /* Routing */ this.hideAppShell = ko.observable( getLocation()[ "hide_appshell" ] != null ? getLocation()[ "hide_appshell" ] : false ); this.currentView = ko.observable( getLocation()[ "ko_element" ] ); this.currentLocation = ko.observable(); /* Reader - Persisting Settings as cookies alone might not work well */ this.readerFontSize = ko.observable(); /* Font Size: 12px - 32px */ this.readerImageSize = ko.observable(); /* Image Size: 300px - 1500px */ this.readerTheme = ko.observable(); /* 3 States: NORMAL, NIGHT, SEPIA */ this.readerLineHeight = ko.observable(); /* 3 States: SMALL, MEDIUM, LARGE */ /* Test Environment */ this.isTestEnvironment = isTestEnvironment; this.isAEETestEnvironment = ko.computed( function() { return this.isTestEnvironment || aEEUserIdList.indexOf( this.user.userId() ) !== -1; }, this ); this.locationObserver = ko.computed( function() { if (self.currentLocation()) { var timeOutDelay = 0; if (!window.FB) { timeOutDelay = 3000; } setTimeout(function() { FB.AppEvents.logPageView(); }, timeOutDelay); } /* Setting searchQuery */ this.searchQuery( this.currentLocation() == "/search" && getUrlParameter( "q" ) != null ? decodeURI( getUrlParameter( "q" ) ) : null ); /* Resetting title, description and metaTags */ this.pageTitle( "ಪ್ರತಿಲಿಪಿ | Pratilipi" ); this.pageDescription( "A platform to discover, read and share your favorite stories, poems and books in a language, device and format of your choice." ); this.metaTags([]); }, this ); /* Setting language */ this.language = "KANNADA"; }; var appViewModel = new AppViewModel(); /* Random Quote */ var randomQuoteTimer = new Timer( function() { /* Refer TimerUtil.js */ appViewModel.randomQuote( getRandomQuote() ); }, 5000); var initFirebase = function() { if( appViewModel.user.isGuest() ) return; var firebaseLibrary = document.createElement( 'script' ); firebaseLibrary.setAttribute( "src", "https://www.gstatic.com/firebasejs/4.10.1/firebase.js" ); firebaseLibrary.onload = function() { var config = { apiKey: "AIzaSyAAnK0-vDmY1UEcrRRbCzXgdpF2oQn-E0w", authDomain: "prod-pratilipi.firebaseapp.com", databaseURL: "https://prod-pratilipi.firebaseio.com", projectId: "prod-pratilipi", storageBucket: "prod-pratilipi.appspot.com", }; firebase.initializeApp( config ); firebase.auth().onAuthStateChanged( function( fbUser ) { if( fbUser ) { var newNotificationCountNode = firebase.database().ref( "NOTIFICATION" ).child( fbUser.uid ).child( "newNotificationCount" ); newNotificationCountNode.on( 'value', function( snapshot ) { var newNotificationCount = snapshot.val() != null ? snapshot.val() : 0; appViewModel.notificationCount( newNotificationCount ); }); var userPreferencesNode = firebase.database().ref( "PREFERENCE" ).child( fbUser.uid ); userPreferencesNode.on( 'value', function( snapshot ) { var userPreferences = snapshot.val() != null ? snapshot.val() : {}; appViewModel.userPreferences( userPreferences ); }); } else { firebase.auth().signInWithCustomToken( appViewModel.user.firebaseToken() ); } }); var configGrowth = { apiKey: "AIzaSyAAnK0-vDmY1UEcrRRbCzXgdpF2oQn-E0w", authDomain: "prod-pratilipi.firebaseapp.com", databaseURL: "https://gr-pratilipi.firebaseio.com", projectId: "prod-pratilipi", storageBucket: "prod-pratilipi.appspot.com", }; var firebaseGrowthApp = firebase.initializeApp( configGrowth, "FirebaseGrowth" ); firebaseGrowthApp.auth().onAuthStateChanged( function( fbUser ) { if( !fbUser ) { firebaseGrowthApp.auth().signInWithCustomToken( appViewModel.user.firebaseToken() ); } }); console.log("Firebase Growth App : ", firebaseGrowthApp); appViewModel.firebaseGrowthDB( firebaseGrowthApp.database() ); }; document.body.appendChild( firebaseLibrary ); }; var initGoogleLogin = function() { if( appViewModel.user.userId() !== 0 ) return; var domId = "pratilipi-google-sdk"; if( document.getElementById( domId ) == null ) { var googleAuth2 = document.createElement( 'script' ); googleAuth2.setAttribute( "src", "https://apis.google.com/js/api:client.js" ); googleAuth2.setAttribute( "id", domId ); googleAuth2.onload = function() { gapi.load( 'auth2', function() { auth2 = gapi.auth2.init({ client_id: '659873510744-kfim969enh181h4gbctffrjg5j47tfuq.apps.googleusercontent.com', cookiepolicy: 'single_host_origin', }); }); }; document.body.appendChild( googleAuth2 ); } }; var logoutFirebase = function(aCallback) { if( ! appViewModel.user.isGuest() ) aCallback( false ); firebase.auth().signOut().then(function() { console.log( 'Firebase logout success!' ); aCallback( true ); }, function() { console.log( 'Firebase logout fail!' ); aCallback( false ); }); }; var setFbAnalyticsUser = function() { FB.AppEvents.setUserID(appViewModel.user.userId().toString()); }; var resetFbNotificationCount = function() { var node = firebase.database().ref( "NOTIFICATION" ).child( appViewModel.user.userId() ).child( "newNotificationCount" ); node.set( 0 ); }; var setUserPreferences = function( userPreferences ) { var node = firebase.database().ref( "PREFERENCE" ).child( appViewModel.user.userId() ); node.set({ "emailFrequency": userPreferences[ "emailFrequency" ], "newsletterFrequency": userPreferences[ "newsletterFrequency" ], "notificationSubscriptions": userPreferences[ "notificationSubscriptions" ], "lastUpdated": firebase.database.ServerValue.TIMESTAMP }); }; var updateUser = function () { var dataAccessor = new DataAccessor(); dataAccessor.getUser(function (user) { ko.mapping.fromJS(user, {}, appViewModel.user); initFirebase(); initGoogleLogin(); var timeOutDelay = 0; if (!window.FB) { timeOutDelay = 3000; } setTimeout(function () { FB.AppEvents.setUserID(user.userId.toString()); if (user.userId != 0 && user.userId != "0") { amplitude.getInstance().setUserId(user.userId.toString()); FacebookEventTriggerUtil.setUserProperties('IS_LOGGED_IN', "YES"); } else { FacebookEventTriggerUtil.setUserProperties('IS_LOGGED_IN', "NO"); } }, timeOutDelay); FacebookEventTriggerUtil.setUserProperties('USER_ID', String(user.userId)); FacebookEventTriggerUtil.setUserProperties('AUTHOR_ID', String(user.author.authorId)); }); }; FacebookEventTriggerUtil.setUserProperties('IS_LOGGED_IN', "NO"); FacebookEventTriggerUtil.setUserProperties('ENVIRONMENT', 'PROD_BRIDGE'); FacebookEventTriggerUtil.setUserProperties('CONTENT_LANGUAGE', "KANNADA"); ko.applyBindings( appViewModel, document.getElementsByTagName("html")[0] ); updateUser(); /* Routing */ var sammy = Sammy(function () { var regex = "^(?!\/pratilipi-write$|\/write$|\/admin$|\/admin\/.*|\/edit-event$|\/edit-blog$).*$"; this.get( regex, function () { /* Hack - Followers page not implemented yet */ if( window.location.pathname == "/followers" ) { redirect( "/my-profile", true ); } var location = getLocation(); appViewModel.currentView( location[ "ko_element" ] ); appViewModel.currentLocation( window.location.pathname + window.location.search ); appViewModel.hideAppShell( location.hide_appshell != null ? location.hide_appshell : false ); /* Scroll to Top */ appViewModel.scrollToTop(); /* Random Quote */ appViewModel.randomQuote( getRandomQuote() ); randomQuoteTimer.reset(); /* Mdl sucks */ setTimeout( function() { if( typeof( componentHandler ) !== 'undefined' ) componentHandler.upgradeDom(); }, 0 ); /* GoogleAnalytics Pageview */ if( ! appViewModel.user.isGuest() ) ga( 'set', 'userId', appViewModel.user.userId() ); ga( 'set', 'page', window.location.pathname + window.location.search ); ga( 'set', 'dimension1', appViewModel.user.userId() == null ? 0 : appViewModel.user.userId() ); ga( 'set', 'dimension2', 'PWA' ); ga( 'set', 'dimension3', 'Standard' ); ga( 'set', 'dimension4', 'Mark-7' ); ga( 'set', 'dimension6', getCookie( "access_token" ) ); ga( 'send', 'pageview' ); /* Notification Read */ if( getUrlParameter( "notifId" ) != null ) new DataAccessor().updateNotificationState( getUrlParameter( "notifId" ), "READ" ); } ); this.post( '.*', function() { return false; }); this._checkFormSubmission = function( form ) { return (false); }; }).run(); /* Service worker Registration */ if( 'serviceWorker' in navigator ) { navigator.serviceWorker.register( '/pwa-sw-KANNADA.js' ) .then( function(serviceWorkerReg) { /* Push Notifications */ /* TODO: Implementation */ /* Reference: https://docs.google.com/document/d/1Jj1-X0pgMReSeYbpN_cbz8VBg0kpNA5yryl4xEdoPCI */ if( 'PushManager' in window && 'Notification' in window && appViewModel.isTestEnvironment && false ) { var _updateServerFCMToken = function( fcmToken ) { var dataAccessor = new DataAccessor(); dataAccessor.updateFCMToken( JSON.stringify( fcmToken ) ); }; serviceWorkerReg.pushManager.getSubscription() .then( function( sub ) { if( sub === null ) { serviceWorkerReg.pushManager.subscribe( { userVisibleOnly: true } ) .then( function( res ) { _updateServerFCMToken( res ); }).catch( function(e) { if( Notification.permission === 'denied' ) { console.warn( 'Permission for notifications was denied!' ); } else { console.error( 'Unable to subscribe to push', e ); } }) ; } else { _updateServerFCMToken( sub ); } }) ; } }) ; } </script> <script src="https://www.ptlp.co/resource-all/pwa/js/bmg.js"></script> <style> .word-suggester { position: absolute; padding: 10px; border: whitesmoke 1px solid; display: inline-block; min-width: 100px; display: none; background: white; z-index: 65538; font-size: 16px; } .word-input { border: none; display: inline-block; border-right: 2px grey solid; } .suggestion { cursor: pointer; line-height: 24px; } .highlight-suggestion { background: lightgrey; font-weight: 700; } </style> </html>
